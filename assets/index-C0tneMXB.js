import{f as x,u as N,aa as p,af as m,M as Z,N as ee,e as M,a1 as _e,ac as we,i as k,aC as be,ab as De,V as W,ah as Se,E as ye}from"./rx-query-helper-BrSngD3C.js";import{Q as Ce,T as te,I as Re,f as I,i as Me,a as E,z as Ie,V as $,a7 as Ee,A as B,a5 as Oe,M as O,k as Te,p as xe,n as Ne,v as Pe,Z as ke,ae as Ae,j as We}from"./plugin-DTC-2ba9.js";import{g as ae,B as $e,d as ne,P as re,W as Be,u as Fe,aa as Qe,K as Ke,f as g,e as je,$ as v,a9 as A,a7 as F,x as Q,a8 as se,w as He,ab as Ve,m as K}from"./rx-query-BLha2BXq.js";import{y as ie,z as Ue,P as oe,A as w,C as Ge,B as ze,x as C,k as ce,n as j,r as Je,m as Ye,l as qe}from"./broadcast-channel-D4yYrDWZ.js";import"./tslib.es6-D3hF0DQN.js";function Xe(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function Ze(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var et=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",tt=et?Ze:Xe,b=new Set,H=!1;function at(){H||(H=!0,tt(rt))}function nt(e){if(at(),typeof e!="function")throw new Error("Listener is no function");b.add(e);var t={remove:function(){return b.delete(e)},run:function(){return b.delete(e),e()}};return t}function rt(){var e=[];return b.forEach(function(t){e.push(t()),b.delete(t)}),Promise.all(e)}function L(e,t){var a={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(a)}function ue(e){e.isLeader=!0,e._hasLeader=!0;var t=nt(function(){return e.die()});e._unl.push(t);var a=function(r){r.context==="leader"&&r.action==="apply"&&L(e,"tell"),r.context==="leader"&&r.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),L(e,"tell"))};return e.broadcastChannel.addEventListener("internal",a),e._lstns.push(a),L(e,"tell")}var le=function(t,a){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=a,this.isLeader=!1,this.isDead=!1,this.token=ie(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};le.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(a){var n=a.held?a.held.filter(function(r){return r.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var a=new Promise(function(n,r){t._wKMC.res=n,t._wKMC.rej=r});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,ue(t),n(),a}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(a){return t.broadcastChannel.removeEventListener("internal",a)}),this._lstns=[],this._unl.forEach(function(a){return a.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),L(this,"death")}};var he=function(t,a){var n=this;this.broadcastChannel=t,this._options=a,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=ie(),this._aplQ=oe,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var r=function(i){i.context==="leader"&&(i.action==="death"&&(n._hasLeader=!1),i.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",r),this._lstns.push(r)};he.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var a=this;if(this.isLeader)return w(0,!0);if(this.isDead)return w(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(a.isLeader)return Ge;var s=!1,i,u=new Promise(function(o){i=function(){s=!0,o()}}),h=function(c){c.context==="leader"&&c.token!=a.token&&(c.action==="apply"&&c.token>a.token&&i(),c.action==="tell"&&(i(),a._hasLeader=!0))};a.broadcastChannel.addEventListener("internal",h);var l=t?a._options.responseTime*4:a._options.responseTime;return L(a,"apply").then(function(){return Promise.race([w(l),u.then(function(){return Promise.reject(new Error)})])}).then(function(){return L(a,"apply")}).then(function(){return Promise.race([w(l),u.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return a.broadcastChannel.removeEventListener("internal",h),s?!1:ue(a).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){a._aplQC=a._aplQC-1}),this._aplQ.then(function(){return a.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=st(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(a){return t.broadcastChannel.removeEventListener("internal",a)}),this._lstns=[],this._unl.forEach(function(a){return a.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,L(this,"death")}};function st(e){return e.isLeader?oe:new Promise(function(t){var a=!1;function n(){a||(a=!0,e.broadcastChannel.removeEventListener("internal",s),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var r=function i(){return w(e._options.fallbackInterval).then(function(){if(!(e.isDead||a))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():i()})})};r();var s=function(u){u.context==="leader"&&u.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",s),e._lstns.push(s)})}function it(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function ot(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=it(t,e);var a=Ue()?new le(e,t):new he(e,t);return e._befC.push(function(){return a.die()}),e._leaderElector=a,a}async function de(e){var t=Ce(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),a=await e.database.internalStore.findDocumentsById(t.map(n=>te(n,Re)),!1);if(a.length>1)throw new Error("more than one old collection meta found");return a[0]}function ct(e,t,a){var n=x(a._attachments),r=N(a),s=r._meta;delete r._meta,r._attachments=n;for(var i=t+1,u=Promise.resolve(r),h=function(){var l=i;u=u.then(o=>ut(e,l,o)),i++};i<=e.schema.version;)h();return u.then(l=>l===null?ne:(l._meta=s,l))}function ut(e,t,a){if(a===null)return ne;var n=e.migrationStrategies[t](a,e),r=Be(n);return r}async function me(e){if(e.collection.schema.version===0)return re;var t=await de(e);return!!t}var lt=200,fe=new WeakMap;function ht(e){var t=ve(e.database),a=t.getValue().slice(0);a.push(e),t.next(a)}function ve(e){return ae(fe,e,()=>new $e([]))}function dt(e){var t=fe.get(e);t&&t.complete()}var mt=(function(){function e(a,n,r=[a.name,"v",a.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=je,this.collection=a,this.migrationStrategies=n,this.statusDocKey=r,this.database=a.database,this.oldCollectionMeta=de(this),this.mustMigrate=me(this),this.statusDocId=te(this.statusDocKey,E),ht(this),this.$=Je(this.database.internalStore,this.statusDocId).pipe(g(s=>!!s),v(s=>M(s).data),A(k))}var t=e.prototype;return t.getStatus=function(){return I(this.$)},t.startMigration=async function(n=lt){var r=await this.mustMigrate;if(r){if(this.started)throw p("DM1");this.started=!0;var s=void 0;if(this.database.multiInstance){s=new ze(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var i=ot(s);await i.awaitLeadership()}var u=await this.oldCollectionMeta,h=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:u.data.schema,password:this.database.password,devMode:m.isDevMode()}),l=await this.getConnectedStorageInstances(),o=await this.countAllDoucments([h].concat(l.map(c=>c.oldStorage)));await this.updateStatus(c=>(c.count.total=o,c));try{await Promise.all(l.map(async c=>{await Me(this.collection,c.newStorage.collectionName,c.newStorage.schema),await this.migrateStorage(c.oldStorage,c.newStorage,n),await c.newStorage.close()})),await this.migrateStorage(h,this.collection.storageInstance.originalStorageInstance,n)}catch(c){await h.close(),await this.updateStatus(d=>(d.status="ERROR",d.error=Fe(c),d));return}await C(this.database.internalStore,{previous:u,document:Object.assign({},u,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(c=>(c.status="DONE",c)),s&&await s.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var r=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var s=await ce(this.database.internalStore,this.statusDocId),i=N(s);s||(i={id:this.statusDocId,key:this.statusDocKey,context:E,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:ee(),_rev:Z(),_attachments:{}});var u=M(i).data;for(var h of r)u=h(u);if(u.count.percent=Math.round(u.count.handled/u.count.total*100),i&&s&&Ie(i.data,s.data))break;try{await C(this.database.internalStore,{previous:s,document:M(i)},E);break}catch(l){if(!_e(l))throw l}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,r,s){var i=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+this.collection.name+"-"+this.collection.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:$(n.schema,j(n.schema)),password:this.database.password,devMode:m.isDevMode()}),u=Ee(r,B,this.database.token,!0),h=Oe({keepMeta:!0,identifier:["rx-migration-state",this.collection.name,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async o=>{o=await Promise.all(o.map(async d=>{var y=d.newDocumentState;if(r.schema.title===O&&(y=d.newDocumentState.docData,d.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:d.newDocumentState};var f=await ct(this.collection,n.schema.version,y),_={assumedMasterState:void 0,newDocumentState:r.schema.title===O?Object.assign({},d.newDocumentState,{docData:f}):f};return _})),o=o.filter(d=>!!d.newDocumentState);var c=await u.masterWrite(o);return c},masterChangeStream$:new Qe().asObservable()},forkInstance:n,metaInstance:i,pushBatchSize:s,pullBatchSize:0,conflictHandler:B,hashFunction:this.database.hashFunction}),l=!1;if(h.events.error.subscribe(o=>l=o),h.events.processed.up.subscribe(()=>{this.updateStatus(o=>(o.count.handled=o.count.handled+1,o))}),await Te(h),await xe(h),await this.updateStatusQueue,l)throw await i.close(),l;await Promise.all([n.remove(),i.remove()])},t.countAllDoucments=async function(n){var r=0;return await Promise.all(n.map(async s=>{var i=Ke(s.schema,we(s.schema,{selector:{}})),u=await s.count(i);r+=u.count})),r},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,r=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async s=>{if(s.schema.title!==O)throw new Error("unknown migration handling for schema");var i=$(N(this.collection.schema.jsonSchema),j(s.schema));i.version=this.collection.schema.version;var[u,h]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:m.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:s.schema,password:this.database.password,collectionName:s.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:m.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:i,password:this.database.password,collectionName:s.collectionName})]);r.push({oldStorage:u,newStorage:h})}))),r},t.migratePromise=async function(n){this.startMigration(n);var r=await this.mustMigrate;if(!r)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var s=await Promise.race([I(this.$.pipe(g(i=>i.status==="DONE"))),I(this.$.pipe(g(i=>i.status==="ERROR")))]);if(s.status==="ERROR")throw p("DM4",{collection:this.collection.name,error:s.error});return s},e})(),ft=Pe(),vt=(function(e){function t(a,n,r){var s;return s=e.call(this,null,n)||this,s.id=a,s.parent=r,s}return be(t,e),t})(ft),D={get isLocal(){return!0},get allAttachments$(){throw p("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=Q(P,this.parent);return e.parent.$.pipe(g(a=>a.documentId===this.primary),g(a=>a.isLocal),v(a=>He(a)),se(t.docCache.getLatestDocumentData(this.primary)),F((a,n)=>a._rev===n._rev),v(a=>t.docCache.getCachedRxDocument(a)),A(k))},get $$(){var e=this,t=T(e),a=t.getReactivityFactory();return a.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=T(e),a=t.getReactivityFactory();return a.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=Q(P,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw De("LD2",{objPath:e});var t=W(this._data,e);return t=m.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,m.isDevMode()){if(e.includes(".item."))throw p("LD3",{objPath:e});if(e===this.primaryPath)throw p("LD4")}return this.$.pipe(v(t=>t._data),v(t=>W(t,e)),F())},get$$(e){var t=T(this),a=t.getReactivityFactory();return a.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await S(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async a=>(a.data=await e(a.data,this),a)).then(a=>t.docCache.getCachedRxDocument(a))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([a,n])=>{t[a]=n}),t))},async _saveData(e){var t=await S(this.parent),a=this._data;e.id=this.id;var n=[{previous:a,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(r=>{if(r.error[0])throw r.error[0];var s=Ye(this.collection.schema.primaryPath,n,r)[0];e=x(e),e._rev=s._rev})},async remove(){var e=await S(this.parent),t=x(this._data);return t._deleted=!0,C(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(a=>e.docCache.getCachedRxDocument(a))}},V=!1,pt=()=>{if(!V){V=!0;var e=Ne,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var r=Object.getOwnPropertyDescriptor(D,n);if(!r){var s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(D,n,s)}});var a=n=>()=>{throw p("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>D[n]=a(n))}};function gt(e,t){pt();var a=new vt(e.id,e,t);return Object.setPrototypeOf(a,D),a.prototype=D,a}function T(e){var t=e.parent;return ke(t)?t:t.database}var R=new WeakMap,P=new WeakMap;function U(e){var t=e.database?e.database:e,a=e.database?e.name:"",n=(async()=>{var r=await pe(t.token,t.storage,t.name,a,t.instanceCreationOptions,t.multiInstance);r=qe(t,r,ge);var s=new Ve("id",t.eventBulks$.pipe(g(o=>{var c=!1;return(a===""&&!o.collectionName||a!==""&&o.collectionName===a)&&(c=!0),c&&o.events[0].isLocal}),v(o=>o.events)),o=>gt(o,e)),i=new Ae(r,"id",()=>{},()=>{}),u=await t.storageToken,h=r.changeStream().subscribe(o=>{for(var c=new Array(o.events.length),d=o.events,y=e.database?e.name:void 0,f=0;f<d.length;f++){var _=d[f];c[f]={documentId:_.documentId,collectionName:y,isLocal:!0,operation:_.operation,documentData:m.deepFreezeWhenDevMode(_.documentData),previousDocumentData:m.deepFreezeWhenDevMode(_.previousDocumentData)}}var Le={id:o.id,internal:!1,collectionName:e.database?e.name:void 0,storageToken:u,events:c,databaseToken:t.token,checkpoint:o.checkpoint,context:o.context,endTime:o.endTime,startTime:o.startTime};t.$emit(Le)});e._subs.push(h);var l={database:t,parent:e,storageInstance:r,docCache:s,incrementalWriteQueue:i};return P.set(e,l),l})();R.set(e,n)}function S(e){var t=R.get(e);if(!t){var a=e.database?e.database:e,n=e.database?e.name:"";throw p("LD8",{database:a.name,collection:n})}return t}function pe(e,t,a,n,r,s){return t.createStorageInstance({databaseInstanceToken:e,databaseName:a,collectionName:Lt(n),schema:ge,options:r,multiInstance:s,devMode:m.isDevMode()})}function G(e){var t=R.get(e);if(t)return R.delete(e),t.then(a=>a.storageInstance.close())}async function z(e,t,a){var n=Se(10),r=await pe(n,e,t,a,{},!1);await r.remove()}function Lt(e){return"plugin-local-documents-"+e}var ge=ye({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function J(e,t){var a=await S(this),n={id:e,data:t,_deleted:!1,_meta:ee(),_rev:Z(),_attachments:{}};return C(a.storageInstance,{document:n},"local-document-insert").then(r=>a.docCache.getCachedRxDocument(r))}function Y(e,t){return this.getLocal(e).then(a=>{if(a)return a.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function q(e){var t=await S(this),a=t.docCache,n=a.getLatestDocumentDataIfExists(e);return n?Promise.resolve(a.getCachedRxDocument(n)):ce(t.storageInstance,e).then(r=>r?t.docCache.getCachedRxDocument(r):null)}function X(e){return this.$.pipe(se(null),K(async t=>{if(t)return{changeEvent:t};var a=await this.getLocal(e);return{doc:a}}),K(async t=>{if(t.changeEvent){var a=t.changeEvent;if(!a.isLocal||a.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),g(t=>t.use),v(t=>t.doc))}var _t={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=J,e.upsertLocal=Y,e.getLocal=q,e.getLocal$=X},RxDatabase:e=>{e.insertLocal=J,e.upsertLocal=Y,e.getLocal=q,e.getLocal$=X}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&U(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&U(e.collection)}},preDestroyRxDatabase:{after:e=>G(e)},postDestroyRxCollection:{after:e=>G(e)},postRemoveRxDatabase:{after:e=>z(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>z(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},wt=new WeakMap,bt={name:"migration-schema",rxdb:!0,init(){We(_t)},hooks:{preDestroyRxDatabase:{after:dt}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return ve(this).pipe(A(k))}},RxCollection:e=>{e.getMigrationState=function(){return ae(wt,this,()=>new mt(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?re:me(this.getMigrationState())}}}},Mt=bt;export{fe as DATA_MIGRATION_STATE_SUBJECT_BY_DATABASE,wt as DATA_MIGRATOR_BY_COLLECTION,lt as MIGRATION_DEFAULT_BATCH_SIZE,bt as RxDBMigrationPlugin,Mt as RxDBMigrationSchemaPlugin,mt as RxMigrationState,ht as addMigrationStateToDatabase,ve as getMigrationStateByDatabase,de as getOldCollectionMeta,ct as migrateDocumentData,me as mustMigrate,dt as onDatabaseDestroy,ut as runStrategyIfNotNull};
