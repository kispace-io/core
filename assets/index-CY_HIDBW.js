import{n as a,a as _,c as M,o as S}from"./rx-query-helper-B5IGKrLX.js";import{c as P}from"./rx-query-FXZmDUEV.js";var R=["__proto__","constructor","prototype"];function f(s,n){Object.keys(n).forEach(i=>{R.includes(i)||(typeof s[i]>"u"?s[i]=n[i]:c(n[i])?f(s[i],n[i]):s[i]=n[i])})}function c(s){return s.toString()==="[object Object]"}var p=(function(){function s(i,t){if(this.options={},this._conditions={},this._fields={},this._path=t,i){var r=this;i.selector&&r.find(i.selector),i.limit&&r.limit(i.limit),i.skip&&r.skip(i.skip),i.sort&&i.sort.forEach(e=>r.sort(e))}}var n=s.prototype;return n.where=function(t,r){if(!arguments.length)return this;var e=typeof arguments[0];if(e==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(e==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw a("MQ1",{path:arguments[0]})},n.equals=function(t){this._ensurePath("equals");var r=this._path;return this._conditions[r]=t,this},n.eq=function(t){this._ensurePath("eq");var r=this._path;return this._conditions[r]=t,this},n.or=function(t){var r=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(t)||(t=[t]),r.push.apply(r,t),this},n.nor=function(t){var r=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(t)||(t=[t]),r.push.apply(r,t),this},n.and=function(t){var r=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(t)||(t=[t]),r.push.apply(r,t),this},n.mod=function(t,r){var e,o;arguments.length===1?(this._ensurePath("mod"),e=arguments[0],o=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),e=arguments.slice(),o=this._path):arguments.length===3?(e=arguments.slice(1),o=arguments[0]):(e=arguments[1],o=arguments[0]);var h=this._conditions[o]||(this._conditions[o]={});return h.$mod=e,this},n.exists=function(t,r){var e,o;arguments.length===0?(this._ensurePath("exists"),e=this._path,o=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),e=this._path,o=arguments[0]):(e=arguments[0],o=!0):arguments.length===2&&(e=arguments[0],o=arguments[1]);var h=this._conditions[e]||(this._conditions[e]={});return h.$exists=o,this},n.elemMatch=function(t,r){if(arguments[0]===null)throw a("MQ2");var e,o,h;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),o=this._path,e=arguments[0];else if(c(arguments[0]))this._ensurePath("elemMatch"),o=this._path,h=arguments[0];else if(typeof arguments[1]=="function")o=arguments[0],e=arguments[1];else if(arguments[1]&&c(arguments[1]))o=arguments[0],h=arguments[1];else throw a("MQ2");e&&(h=new s,e(h),h=h._conditions);var u=this._conditions[o]||(this._conditions[o]={});return u.$elemMatch=h,this},n.sort=function(t){if(!t)return this;var r,e=typeof t;if(Array.isArray(t)){r=t.length;for(var o=0;o<t.length;++o)$(this.options,t[o][0],t[o][1]);return this}if(arguments.length===1&&e==="string"){t=t.split(/\s+/),r=t.length;for(var h=0;h<r;++h){var u=t[h];if(u){var m=u[0]==="-"?-1:1;m===-1&&(u=u.substring(1)),d(this.options,u,m)}}return this}if(c(t)){var E=Object.keys(t);return E.forEach(g=>d(this.options,g,t[g])),this}throw a("MQ3",{args:arguments})},n.merge=function(t){if(!t)return this;if(!v(t))throw a("MQ4",{source:t});return t instanceof s?(t._conditions&&f(this._conditions,t._conditions),t._fields&&(this._fields||(this._fields={}),f(this._fields,t._fields)),t.options&&(this.options||(this.options={}),f(this.options,t.options)),t._distinct&&(this._distinct=t._distinct),this):(f(this._conditions,t),this)},n.find=function(t){return v(t)&&this.merge(t),this},n._ensurePath=function(t){if(!this._path)throw _("MQ5",{method:t})},n.toJSON=function(){var t={selector:this._conditions};return this.options.skip&&(t.skip=this.options.skip),this.options.limit&&(t.limit=this.options.limit),this.options.sort&&(t.sort=O(this.options.sort)),{query:t,path:this._path}},s})();function O(s){return Object.entries(s).map(([n,i])=>{var t=i===1?"asc":"desc",r={[n]:t};return r})}var A=["limit","skip","maxScan","batchSize","comment"];A.forEach(function(s){p.prototype[s]=function(n){return this.options[s]=n,this}});var w=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];w.forEach(function(s){p.prototype[s]=function(){var n,i;arguments.length===1?(this._ensurePath(s),i=arguments[0],n=this._path):(i=arguments[1],n=arguments[0]);var t=this._conditions[n]===null||typeof this._conditions[n]=="object"?this._conditions[n]:this._conditions[n]={};if(s==="regex"){if(i instanceof RegExp)throw _("QU16",{field:n,query:this._conditions});typeof i=="string"?t["$"+s]=i:(t["$"+s]=i.$regex,i.$options&&(t.$options=i.$options))}else t["$"+s]=i;return this}});function d(s,n,i){if(Array.isArray(s.sort))throw a("MQ6",{opts:s,field:n,value:i});if(i&&i.$meta){var t=s.sort||(s.sort={});t[n]={$meta:i.$meta};return}var r=String(i||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(r))throw Array.isArray(i)&&(i="["+i+"]"),a("MQ7",{field:n,value:i});var e=s.sort||(s.sort={}),o=i.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");e[n]=parseInt(o,10)}function $(s,n,i){if(s.sort=s.sort||[],!Array.isArray(s.sort))throw a("MQ8",{opts:s,field:n,value:i});s.sort.push([n,i])}function v(s){return s instanceof p||c(s)}function q(s,n){return new p(s,n)}var y="queryBuilderPath";function x(s,n,i){var t=q(M(s.mangoQuery),s.other[y]);t[n](i);var r=t.toJSON();return P(s.op,r.query,s.collection,{...s.other,[y]:r.path})}function l(s,n){s[n]=function(i){if(S.isDevMode()&&this.op==="findByIds")throw _("QU17",{collection:this.collection.name,query:this.mangoQuery});return x(this,n,i)}}var T={name:"query-builder",rxdb:!0,prototypes:{RxQuery(s){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(n=>{l(s,n)}),A.forEach(n=>{l(s,n)}),w.forEach(n=>{l(s,n)})}}};export{p as NoSqlQueryBuilderClass,A as OTHER_MANGO_ATTRIBUTES,w as OTHER_MANGO_OPERATORS,T as RxDBQueryBuilderPlugin,l as applyBuildingStep,v as canMerge,q as createQueryBuilder,O as mQuerySortToRxDBSort,x as runBuildingStep};
