import{n as oe,b as w,d as ra,e as Wr,f as Gr,h as na,i as Kr,p as aa,j as Qr,c as Yr,k as oa,l as sa,m as ia,q as la,r as ca,u as da,v as ua,w as pa,x as ma,y as wr,z as fa,A as ha,B as ga,C as ya,D as _a,E as wa,F as Sa,G as ba,H as va,I as ka,J as Ta,K as $a,L as Ra,M as Pa,N as Ia,O as Ea,P as Oa,Q as xa,R as Ca,S as Aa,T as Ma,U as Na,V as Za,W as ja,X as qa,Y as za,a0 as Sr,a1 as Da,a2 as br,a3 as Ha,a4 as Ua,a5 as La,g as Ge,a6 as Fa,a7 as Ja,a8 as Va,a9 as Ba,aa as Xr,ab as Wa,ac as en,ad as Ga,ae as Ka,af as Qa,ag as Ya,ah as Xa,ai as eo,aj as to,ak as ro,al as no,am as ao,an as oo,ao as so,ap as io,aq as lo,ar as co,as as uo,at as po,au as mo,av as fo,aw as ho,ax as go,ay as yo,az as _o,aA as wo,aB as So,aC as bo,aD as vo,aE as ko,aF as To,aG as $o,aH as tn,aI as Ro,aJ as Po,aK as Io,aL as Eo,aM as vr,aN as Oo,aO as xo,aP as Co,aQ as Ao,aR as Mo,aS as No,aT as Zo,aU as jo,aV as qo,aW as zo,aX as Do,aY as Ho,aZ as Uo,a_ as Lo,a$ as Fo,b0 as Jo,b1 as Vo,b2 as Bo,b3 as Wo,b4 as kr,b5 as kt,b6 as Tr,b7 as Tt,b8 as $r,b9 as Go,ba as Ko,bb as Qo,bc as Yo,bd as Xo,be as es,bf as ts,bg as rs,bh as Xe,bi as rn,bj as nn,_ as ns,bk as as,bl as os,bm as ss,bn as is,bo as ls,bp as cs,bq as ds,br as us,bs as ps,bt as ms,bu as fs,bv as hs,bw as gs,bx as ys,by as _s,$ as ws,bz as Ss,bA as bs,bB as vs,bC as ks,bD as Ts,bE as $s,bF as Rs,bG as Ps,bH as Is,bI as Es,bJ as Os,bK as xs,bL as Cs,bM as As,bN as Ms,bO as Ns,bP as Zs,bQ as js,bR as qs,bS as zs,bT as Ds,bU as Hs,Z as $,t as Us,o as Ls}from"./types-DFQuOAyJ.js";function Oe(e,t){const r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let a=0;a<n;a++)if(!Oe(e[a],t[a]))return!1;return!0}if(r==="object"){if(!e||!t)return e===t;const n=Object.keys(e),a=Object.keys(t);if(n.length!==a.length)return!1;for(const s of n)if(!Oe(e[s],t[s]))return!1;return!0}return e===t}function ae(e){return encodeURI(Fs(e))}function Fs(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}const Js={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},Vs={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},Bs={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let Ws=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function we(e,t=Object.create(null),r=Ws,n=""){if(e&&typeof e=="object"&&!Array.isArray(e)){const o=e.$id||e.id;if(o){const s=new URL(o,r.href);s.hash.length>1?t[s.href]=e:(s.hash="",n===""?r=s:we(e,t,r))}}else if(e!==!0&&e!==!1)return t;const a=r.href+(n?"#"+n:"");if(t[a]!==void 0)throw new Error(`Duplicate schema URI "${a}".`);if(t[a]=e,e===!0||e===!1)return t;if(e.__absolute_uri__===void 0&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:a}),e.$ref&&e.__absolute_ref__===void 0){const o=new URL(e.$ref,r.href);o.hash=o.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:o.href})}if(e.$recursiveRef&&e.__absolute_recursive_ref__===void 0){const o=new URL(e.$recursiveRef,r.href);o.hash=o.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:o.href})}if(e.$anchor){const o=new URL("#"+e.$anchor,r.href);t[o.href]=e}for(let o in e){if(Bs[o])continue;const s=`${n}/${ae(o)}`,i=e[o];if(Array.isArray(i)){if(Js[o]){const c=i.length;for(let p=0;p<c;p++)we(i[p],t,r,`${s}/${p}`)}}else if(Vs[o])for(let c in i)we(i[c],t,r,`${s}/${ae(c)}`);else we(i,t,r,s)}return t}const Gs=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,Ks=[0,31,28,31,30,31,30,31,31,30,31,30,31],Qs=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,Ys=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,Xs=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,ei=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,ti=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,ri=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,ni=/^(?:\/(?:[^~/]|~0|~1)*)*$/,ai=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,oi=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,si=e=>{if(e[0]==='"')return!1;const[t,r,...n]=e.split("@");return!t||!r||n.length!==0||t.length>64||r.length>253||t[0]==="."||t.endsWith(".")||t.includes("..")||!/^[a-z0-9.-]+$/i.test(r)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t)?!1:r.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},ii=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,li=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,ci=e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e));function ie(e){return e.test.bind(e)}const Rr={date:an,time:on.bind(void 0,!1),"date-time":pi,duration:ci,uri:hi,"uri-reference":ie(Xs),"uri-template":ie(ei),url:ie(ti),email:si,hostname:ie(Ys),ipv4:ie(ii),ipv6:ie(li),regex:yi,uuid:ie(ri),"json-pointer":ie(ni),"json-pointer-uri-fragment":ie(ai),"relative-json-pointer":ie(oi)};function di(e){return e%4===0&&(e%100!==0||e%400===0)}function an(e){const t=e.match(Gs);if(!t)return!1;const r=+t[1],n=+t[2],a=+t[3];return n>=1&&n<=12&&a>=1&&a<=(n==2&&di(r)?29:Ks[n])}function on(e,t){const r=t.match(Qs);if(!r)return!1;const n=+r[1],a=+r[2],o=+r[3],s=!!r[5];return(n<=23&&a<=59&&o<=59||n==23&&a==59&&o==60)&&(!e||s)}const ui=/t|\s/i;function pi(e){const t=e.split(ui);return t.length==2&&an(t[0])&&on(!0,t[1])}const mi=/\/|:/,fi=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function hi(e){return mi.test(e)&&fi.test(e)}const gi=/[^\\]\\Z/;function yi(e){if(gi.test(e))return!1;try{return new RegExp(e,"u"),!0}catch{return!1}}function _i(e){let t=0,r=e.length,n=0,a;for(;n<r;)t++,a=e.charCodeAt(n++),a>=55296&&a<=56319&&n<r&&(a=e.charCodeAt(n),(a&64512)==56320&&n++);return t}function A(e,t,r="2019-09",n=we(t),a=!0,o=null,s="#",i="#",c=Object.create(null)){if(t===!0)return{valid:!0,errors:[]};if(t===!1)return{valid:!1,errors:[{instanceLocation:s,keyword:"false",keywordLocation:s,error:"False boolean schema."}]};const p=typeof e;let d;switch(p){case"boolean":case"number":case"string":d=p;break;case"object":e===null?d="null":Array.isArray(e)?d="array":d="object";break;default:throw new Error(`Instances of "${p}" type are not supported.`)}const{$ref:P,$recursiveRef:z,$recursiveAnchor:se,type:G,const:fe,enum:pe,required:q,not:J,anyOf:Se,allOf:pt,oneOf:sr,if:ir,then:lr,else:cr,format:Ue,properties:mt,patternProperties:ft,additionalProperties:dr,unevaluatedProperties:ur,minProperties:ht,maxProperties:gt,propertyNames:pr,dependentRequired:yt,dependentSchemas:_t,dependencies:wt,prefixItems:St,items:Re,additionalItems:mr,unevaluatedItems:fr,contains:hr,minContains:ue,maxContains:Le,minItems:bt,maxItems:vt,uniqueItems:ea,minimum:he,maximum:ge,exclusiveMinimum:Pe,exclusiveMaximum:Ie,multipleOf:Fe,minLength:Je,maxLength:Ve,pattern:gr,__absolute_ref__:Be,__absolute_recursive_ref__:ta}=t,f=[];if(se===!0&&o===null&&(o=t),z==="#"){const b=o===null?n[ta]:o,y=`${i}/$recursiveRef`,T=A(e,o===null?t:o,r,n,a,b,s,y,c);T.valid||f.push({instanceLocation:s,keyword:"$recursiveRef",keywordLocation:y,error:"A subschema had errors."},...T.errors)}if(P!==void 0){const y=n[Be||P];if(y===void 0){let u=`Unresolved $ref "${P}".`;throw Be&&Be!==P&&(u+=`  Absolute URI "${Be}".`),u+=`
Known schemas:
- ${Object.keys(n).join(`
- `)}`,new Error(u)}const T=`${i}/$ref`,h=A(e,y,r,n,a,o,s,T,c);if(h.valid||f.push({instanceLocation:s,keyword:"$ref",keywordLocation:T,error:"A subschema had errors."},...h.errors),r==="4"||r==="7")return{valid:f.length===0,errors:f}}if(Array.isArray(G)){let b=G.length,y=!1;for(let T=0;T<b;T++)if(d===G[T]||G[T]==="integer"&&d==="number"&&e%1===0&&e===e){y=!0;break}y||f.push({instanceLocation:s,keyword:"type",keywordLocation:`${i}/type`,error:`Instance type "${d}" is invalid. Expected "${G.join('", "')}".`})}else G==="integer"?(d!=="number"||e%1||e!==e)&&f.push({instanceLocation:s,keyword:"type",keywordLocation:`${i}/type`,error:`Instance type "${d}" is invalid. Expected "${G}".`}):G!==void 0&&d!==G&&f.push({instanceLocation:s,keyword:"type",keywordLocation:`${i}/type`,error:`Instance type "${d}" is invalid. Expected "${G}".`});if(fe!==void 0&&(d==="object"||d==="array"?Oe(e,fe)||f.push({instanceLocation:s,keyword:"const",keywordLocation:`${i}/const`,error:`Instance does not match ${JSON.stringify(fe)}.`}):e!==fe&&f.push({instanceLocation:s,keyword:"const",keywordLocation:`${i}/const`,error:`Instance does not match ${JSON.stringify(fe)}.`})),pe!==void 0&&(d==="object"||d==="array"?pe.some(b=>Oe(e,b))||f.push({instanceLocation:s,keyword:"enum",keywordLocation:`${i}/enum`,error:`Instance does not match any of ${JSON.stringify(pe)}.`}):pe.some(b=>e===b)||f.push({instanceLocation:s,keyword:"enum",keywordLocation:`${i}/enum`,error:`Instance does not match any of ${JSON.stringify(pe)}.`})),J!==void 0){const b=`${i}/not`;A(e,J,r,n,a,o,s,b).valid&&f.push({instanceLocation:s,keyword:"not",keywordLocation:b,error:'Instance matched "not" schema.'})}let We=[];if(Se!==void 0){const b=`${i}/anyOf`,y=f.length;let T=!1;for(let h=0;h<Se.length;h++){const u=Se[h],k=Object.create(c),v=A(e,u,r,n,a,se===!0?o:null,s,`${b}/${h}`,k);f.push(...v.errors),T=T||v.valid,v.valid&&We.push(k)}T?f.length=y:f.splice(y,0,{instanceLocation:s,keyword:"anyOf",keywordLocation:b,error:"Instance does not match any subschemas."})}if(pt!==void 0){const b=`${i}/allOf`,y=f.length;let T=!0;for(let h=0;h<pt.length;h++){const u=pt[h],k=Object.create(c),v=A(e,u,r,n,a,se===!0?o:null,s,`${b}/${h}`,k);f.push(...v.errors),T=T&&v.valid,v.valid&&We.push(k)}T?f.length=y:f.splice(y,0,{instanceLocation:s,keyword:"allOf",keywordLocation:b,error:"Instance does not match every subschema."})}if(sr!==void 0){const b=`${i}/oneOf`,y=f.length,T=sr.filter((h,u)=>{const k=Object.create(c),v=A(e,h,r,n,a,se===!0?o:null,s,`${b}/${u}`,k);return f.push(...v.errors),v.valid&&We.push(k),v.valid}).length;T===1?f.length=y:f.splice(y,0,{instanceLocation:s,keyword:"oneOf",keywordLocation:b,error:`Instance does not match exactly one subschema (${T} matches).`})}if((d==="object"||d==="array")&&Object.assign(c,...We),ir!==void 0){const b=`${i}/if`;if(A(e,ir,r,n,a,o,s,b,c).valid){if(lr!==void 0){const T=A(e,lr,r,n,a,o,s,`${i}/then`,c);T.valid||f.push({instanceLocation:s,keyword:"if",keywordLocation:b,error:'Instance does not match "then" schema.'},...T.errors)}}else if(cr!==void 0){const T=A(e,cr,r,n,a,o,s,`${i}/else`,c);T.valid||f.push({instanceLocation:s,keyword:"if",keywordLocation:b,error:'Instance does not match "else" schema.'},...T.errors)}}if(d==="object"){if(q!==void 0)for(const h of q)h in e||f.push({instanceLocation:s,keyword:"required",keywordLocation:`${i}/required`,error:`Instance does not have required property "${h}".`});const b=Object.keys(e);if(ht!==void 0&&b.length<ht&&f.push({instanceLocation:s,keyword:"minProperties",keywordLocation:`${i}/minProperties`,error:`Instance does not have at least ${ht} properties.`}),gt!==void 0&&b.length>gt&&f.push({instanceLocation:s,keyword:"maxProperties",keywordLocation:`${i}/maxProperties`,error:`Instance does not have at least ${gt} properties.`}),pr!==void 0){const h=`${i}/propertyNames`;for(const u in e){const k=`${s}/${ae(u)}`,v=A(u,pr,r,n,a,o,k,h);v.valid||f.push({instanceLocation:s,keyword:"propertyNames",keywordLocation:h,error:`Property name "${u}" does not match schema.`},...v.errors)}}if(yt!==void 0){const h=`${i}/dependantRequired`;for(const u in yt)if(u in e){const k=yt[u];for(const v of k)v in e||f.push({instanceLocation:s,keyword:"dependentRequired",keywordLocation:h,error:`Instance has "${u}" but does not have "${v}".`})}}if(_t!==void 0)for(const h in _t){const u=`${i}/dependentSchemas`;if(h in e){const k=A(e,_t[h],r,n,a,o,s,`${u}/${ae(h)}`,c);k.valid||f.push({instanceLocation:s,keyword:"dependentSchemas",keywordLocation:u,error:`Instance has "${h}" but does not match dependant schema.`},...k.errors)}}if(wt!==void 0){const h=`${i}/dependencies`;for(const u in wt)if(u in e){const k=wt[u];if(Array.isArray(k))for(const v of k)v in e||f.push({instanceLocation:s,keyword:"dependencies",keywordLocation:h,error:`Instance has "${u}" but does not have "${v}".`});else{const v=A(e,k,r,n,a,o,s,`${h}/${ae(u)}`);v.valid||f.push({instanceLocation:s,keyword:"dependencies",keywordLocation:h,error:`Instance has "${u}" but does not match dependant schema.`},...v.errors)}}}const y=Object.create(null);let T=!1;if(mt!==void 0){const h=`${i}/properties`;for(const u in mt){if(!(u in e))continue;const k=`${s}/${ae(u)}`,v=A(e[u],mt[u],r,n,a,o,k,`${h}/${ae(u)}`);if(v.valid)c[u]=y[u]=!0;else if(T=a,f.push({instanceLocation:s,keyword:"properties",keywordLocation:h,error:`Property "${u}" does not match schema.`},...v.errors),T)break}}if(!T&&ft!==void 0){const h=`${i}/patternProperties`;for(const u in ft){const k=new RegExp(u,"u"),v=ft[u];for(const V in e){if(!k.test(V))continue;const yr=`${s}/${ae(V)}`,_r=A(e[V],v,r,n,a,o,yr,`${h}/${ae(u)}`);_r.valid?c[V]=y[V]=!0:(T=a,f.push({instanceLocation:s,keyword:"patternProperties",keywordLocation:h,error:`Property "${V}" matches pattern "${u}" but does not match associated schema.`},..._r.errors))}}}if(!T&&dr!==void 0){const h=`${i}/additionalProperties`;for(const u in e){if(y[u])continue;const k=`${s}/${ae(u)}`,v=A(e[u],dr,r,n,a,o,k,h);v.valid?c[u]=!0:(T=a,f.push({instanceLocation:s,keyword:"additionalProperties",keywordLocation:h,error:`Property "${u}" does not match additional properties schema.`},...v.errors))}}else if(!T&&ur!==void 0){const h=`${i}/unevaluatedProperties`;for(const u in e)if(!c[u]){const k=`${s}/${ae(u)}`,v=A(e[u],ur,r,n,a,o,k,h);v.valid?c[u]=!0:f.push({instanceLocation:s,keyword:"unevaluatedProperties",keywordLocation:h,error:`Property "${u}" does not match unevaluated properties schema.`},...v.errors)}}}else if(d==="array"){vt!==void 0&&e.length>vt&&f.push({instanceLocation:s,keyword:"maxItems",keywordLocation:`${i}/maxItems`,error:`Array has too many items (${e.length} > ${vt}).`}),bt!==void 0&&e.length<bt&&f.push({instanceLocation:s,keyword:"minItems",keywordLocation:`${i}/minItems`,error:`Array has too few items (${e.length} < ${bt}).`});const b=e.length;let y=0,T=!1;if(St!==void 0){const h=`${i}/prefixItems`,u=Math.min(St.length,b);for(;y<u;y++){const k=A(e[y],St[y],r,n,a,o,`${s}/${y}`,`${h}/${y}`);if(c[y]=!0,!k.valid&&(T=a,f.push({instanceLocation:s,keyword:"prefixItems",keywordLocation:h,error:"Items did not match schema."},...k.errors),T))break}}if(Re!==void 0){const h=`${i}/items`;if(Array.isArray(Re)){const u=Math.min(Re.length,b);for(;y<u;y++){const k=A(e[y],Re[y],r,n,a,o,`${s}/${y}`,`${h}/${y}`);if(c[y]=!0,!k.valid&&(T=a,f.push({instanceLocation:s,keyword:"items",keywordLocation:h,error:"Items did not match schema."},...k.errors),T))break}}else for(;y<b;y++){const u=A(e[y],Re,r,n,a,o,`${s}/${y}`,h);if(c[y]=!0,!u.valid&&(T=a,f.push({instanceLocation:s,keyword:"items",keywordLocation:h,error:"Items did not match schema."},...u.errors),T))break}if(!T&&mr!==void 0){const u=`${i}/additionalItems`;for(;y<b;y++){const k=A(e[y],mr,r,n,a,o,`${s}/${y}`,u);c[y]=!0,k.valid||(T=a,f.push({instanceLocation:s,keyword:"additionalItems",keywordLocation:u,error:"Items did not match additional items schema."},...k.errors))}}}if(hr!==void 0)if(b===0&&ue===void 0)f.push({instanceLocation:s,keyword:"contains",keywordLocation:`${i}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(ue!==void 0&&b<ue)f.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${i}/minContains`,error:`Array has less items (${b}) than minContains (${ue}).`});else{const h=`${i}/contains`,u=f.length;let k=0;for(let v=0;v<b;v++){const V=A(e[v],hr,r,n,a,o,`${s}/${v}`,h);V.valid?(c[v]=!0,k++):f.push(...V.errors)}k>=(ue||0)&&(f.length=u),ue===void 0&&Le===void 0&&k===0?f.splice(u,0,{instanceLocation:s,keyword:"contains",keywordLocation:h,error:"Array does not contain item matching schema."}):ue!==void 0&&k<ue?f.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${i}/minContains`,error:`Array must contain at least ${ue} items matching schema. Only ${k} items were found.`}):Le!==void 0&&k>Le&&f.push({instanceLocation:s,keyword:"maxContains",keywordLocation:`${i}/maxContains`,error:`Array may contain at most ${Le} items matching schema. ${k} items were found.`})}if(!T&&fr!==void 0){const h=`${i}/unevaluatedItems`;for(y;y<b;y++){if(c[y])continue;const u=A(e[y],fr,r,n,a,o,`${s}/${y}`,h);c[y]=!0,u.valid||f.push({instanceLocation:s,keyword:"unevaluatedItems",keywordLocation:h,error:"Items did not match unevaluated items schema."},...u.errors)}}if(ea)for(let h=0;h<b;h++){const u=e[h],k=typeof u=="object"&&u!==null;for(let v=0;v<b;v++){if(h===v)continue;const V=e[v];(u===V||k&&(typeof V=="object"&&V!==null)&&Oe(u,V))&&(f.push({instanceLocation:s,keyword:"uniqueItems",keywordLocation:`${i}/uniqueItems`,error:`Duplicate items at indexes ${h} and ${v}.`}),h=Number.MAX_SAFE_INTEGER,v=Number.MAX_SAFE_INTEGER)}}}else if(d==="number"){if(r==="4"?(he!==void 0&&(Pe===!0&&e<=he||e<he)&&f.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${i}/minimum`,error:`${e} is less than ${Pe?"or equal to ":""} ${he}.`}),ge!==void 0&&(Ie===!0&&e>=ge||e>ge)&&f.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${i}/maximum`,error:`${e} is greater than ${Ie?"or equal to ":""} ${ge}.`})):(he!==void 0&&e<he&&f.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${i}/minimum`,error:`${e} is less than ${he}.`}),ge!==void 0&&e>ge&&f.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${i}/maximum`,error:`${e} is greater than ${ge}.`}),Pe!==void 0&&e<=Pe&&f.push({instanceLocation:s,keyword:"exclusiveMinimum",keywordLocation:`${i}/exclusiveMinimum`,error:`${e} is less than ${Pe}.`}),Ie!==void 0&&e>=Ie&&f.push({instanceLocation:s,keyword:"exclusiveMaximum",keywordLocation:`${i}/exclusiveMaximum`,error:`${e} is greater than or equal to ${Ie}.`})),Fe!==void 0){const b=e%Fe;Math.abs(0-b)>=11920929e-14&&Math.abs(Fe-b)>=11920929e-14&&f.push({instanceLocation:s,keyword:"multipleOf",keywordLocation:`${i}/multipleOf`,error:`${e} is not a multiple of ${Fe}.`})}}else if(d==="string"){const b=Je===void 0&&Ve===void 0?0:_i(e);Je!==void 0&&b<Je&&f.push({instanceLocation:s,keyword:"minLength",keywordLocation:`${i}/minLength`,error:`String is too short (${b} < ${Je}).`}),Ve!==void 0&&b>Ve&&f.push({instanceLocation:s,keyword:"maxLength",keywordLocation:`${i}/maxLength`,error:`String is too long (${b} > ${Ve}).`}),gr!==void 0&&!new RegExp(gr,"u").test(e)&&f.push({instanceLocation:s,keyword:"pattern",keywordLocation:`${i}/pattern`,error:"String does not match pattern."}),Ue!==void 0&&Rr[Ue]&&!Rr[Ue](e)&&f.push({instanceLocation:s,keyword:"format",keywordLocation:`${i}/format`,error:`String does not match format "${Ue}".`})}return{valid:f.length===0,errors:f}}class wi{schema;draft;shortCircuit;lookup;constructor(t,r="2019-09",n=!0){this.schema=t,this.draft=r,this.shortCircuit=n,this.lookup=we(t)}validate(t){return A(t,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(t,r){r&&(t={...t,$id:r}),we(t,this.lookup)}}const Si=w("ZodMiniType",(e,t)=>{if(!e._zod)throw new Error("Uninitialized schema in ZodMiniType.");Gr.init(e,t),e.def=t,e.type=t.type,e.parse=(r,n)=>na(e,r,n,{callee:e.parse}),e.safeParse=(r,n)=>Kr(e,r,n),e.parseAsync=async(r,n)=>aa(e,r,n,{callee:e.parseAsync}),e.safeParseAsync=async(r,n)=>Qr(e,r,n),e.check=(...r)=>e.clone({...t,checks:[...t.checks??[],...r.map(n=>typeof n=="function"?{_zod:{check:n,def:{check:"custom"},onattach:[]}}:n)]},{parent:!0}),e.with=e.check,e.clone=(r,n)=>Yr(e,r,n),e.brand=()=>e,e.register=((r,n)=>(r.add(e,n),e)),e.apply=r=>r(e)}),bi=w("ZodMiniObject",(e,t)=>{ra.init(e,t),Si.init(e,t),Wr(e,"shape",()=>t.shape)});function Pr(e,t){const r={type:"object",shape:e??{},...oe(t)};return new bi(r)}const vi=w("ZodISODateTime",(e,t)=>{ca.init(e,t),Z.init(e,t)});function sn(e){return oa(vi,e)}const ki=w("ZodISODate",(e,t)=>{da.init(e,t),Z.init(e,t)});function Ti(e){return sa(ki,e)}const $i=w("ZodISOTime",(e,t)=>{ua.init(e,t),Z.init(e,t)});function Ri(e){return ia($i,e)}const Pi=w("ZodISODuration",(e,t)=>{pa.init(e,t),Z.init(e,t)});function Ii(e){return la(Pi,e)}const Ei=(e,t)=>{ma.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:r=>ha(e,r)},flatten:{value:r=>fa(e,r)},addIssue:{value:r=>{e.issues.push(r),e.message=JSON.stringify(e.issues,wr,2)}},addIssues:{value:r=>{e.issues.push(...r),e.message=JSON.stringify(e.issues,wr,2)}},isEmpty:{get(){return e.issues.length===0}}})},X=w("ZodError",Ei,{Parent:Error}),Oi=ga(X),xi=_a(X),Ci=ya(X),Ai=wa(X),Mi=Sa(X),Ni=ba(X),Zi=va(X),ji=ka(X),qi=Ta(X),zi=$a(X),Di=Ra(X),Hi=Pa(X),C=w("ZodType",(e,t)=>(Gr.init(e,t),Object.assign(e["~standard"],{jsonSchema:{input:br(e,"input"),output:br(e,"output")}}),e.toJSONSchema=Ha(e,{}),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...r)=>e.clone(Ua(t,{checks:[...t.checks??[],...r.map(n=>typeof n=="function"?{_zod:{check:n,def:{check:"custom"},onattach:[]}}:n)]}),{parent:!0}),e.with=e.check,e.clone=(r,n)=>Yr(e,r,n),e.brand=()=>e,e.register=((r,n)=>(r.add(e,n),e)),e.parse=(r,n)=>Oi(e,r,n,{callee:e.parse}),e.safeParse=(r,n)=>Ci(e,r,n),e.parseAsync=async(r,n)=>xi(e,r,n,{callee:e.parseAsync}),e.safeParseAsync=async(r,n)=>Ai(e,r,n),e.spa=e.safeParseAsync,e.encode=(r,n)=>Mi(e,r,n),e.decode=(r,n)=>Ni(e,r,n),e.encodeAsync=async(r,n)=>Zi(e,r,n),e.decodeAsync=async(r,n)=>ji(e,r,n),e.safeEncode=(r,n)=>qi(e,r,n),e.safeDecode=(r,n)=>zi(e,r,n),e.safeEncodeAsync=async(r,n)=>Di(e,r,n),e.safeDecodeAsync=async(r,n)=>Hi(e,r,n),e.refine=(r,n)=>e.check(Cl(r,n)),e.superRefine=r=>e.check(Al(r)),e.overwrite=r=>e.check(La(r)),e.optional=()=>j(e),e.exactOptional=()=>wl(e),e.nullable=()=>Or(e),e.nullish=()=>j(Or(e)),e.nonoptional=r=>$l(e,r),e.array=()=>R(e),e.or=r=>x([e,r]),e.and=r=>qt(e,r),e.transform=r=>Et(e,fn(r)),e.default=r=>vl(e,r),e.prefault=r=>Tl(e,r),e.catch=r=>Pl(e,r),e.pipe=r=>Et(e,r),e.readonly=()=>Ol(e),e.describe=r=>{const n=e.clone();return Ge.add(n,{description:r}),n},Object.defineProperty(e,"description",{get(){return Ge.get(e)?.description},configurable:!0}),e.meta=(...r)=>{if(r.length===0)return Ge.get(e);const n=e.clone();return Ge.add(n,r[0]),n},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e.apply=r=>r(e),e)),ln=w("_ZodString",(e,t)=>{tn.init(e,t),C.init(e,t),e._zod.processJSONSchema=(n,a,o)=>ss(e,n,a);const r=e._zod.bag;e.format=r.format??null,e.minLength=r.minimum??null,e.maxLength=r.maximum??null,e.regex=(...n)=>e.check(is(...n)),e.includes=(...n)=>e.check(ls(...n)),e.startsWith=(...n)=>e.check(cs(...n)),e.endsWith=(...n)=>e.check(ds(...n)),e.min=(...n)=>e.check(Xe(...n)),e.max=(...n)=>e.check(rn(...n)),e.length=(...n)=>e.check(nn(...n)),e.nonempty=(...n)=>e.check(Xe(1,...n)),e.lowercase=n=>e.check(us(n)),e.uppercase=n=>e.check(ps(n)),e.trim=()=>e.check(ms()),e.normalize=(...n)=>e.check(fs(...n)),e.toLowerCase=()=>e.check(hs()),e.toUpperCase=()=>e.check(gs()),e.slugify=()=>e.check(ys())}),Ui=w("ZodString",(e,t)=>{tn.init(e,t),ln.init(e,t),e.email=r=>e.check(Ro(Li,r)),e.url=r=>e.check(Po(Fi,r)),e.jwt=r=>e.check(Io(ol,r)),e.emoji=r=>e.check(Eo(Ji,r)),e.guid=r=>e.check(vr(Ir,r)),e.uuid=r=>e.check(Oo(Ke,r)),e.uuidv4=r=>e.check(xo(Ke,r)),e.uuidv6=r=>e.check(Co(Ke,r)),e.uuidv7=r=>e.check(Ao(Ke,r)),e.nanoid=r=>e.check(Mo(Vi,r)),e.guid=r=>e.check(vr(Ir,r)),e.cuid=r=>e.check(No(Bi,r)),e.cuid2=r=>e.check(Zo(Wi,r)),e.ulid=r=>e.check(jo(Gi,r)),e.base64=r=>e.check(qo(rl,r)),e.base64url=r=>e.check(zo(nl,r)),e.xid=r=>e.check(Do(Ki,r)),e.ksuid=r=>e.check(Ho(Qi,r)),e.ipv4=r=>e.check(Uo(Yi,r)),e.ipv6=r=>e.check(Lo(Xi,r)),e.cidrv4=r=>e.check(Fo(el,r)),e.cidrv6=r=>e.check(Jo(tl,r)),e.e164=r=>e.check(Vo(al,r)),e.datetime=r=>e.check(sn(r)),e.date=r=>e.check(Ti(r)),e.time=r=>e.check(Ri(r)),e.duration=r=>e.check(Ii(r))});function l(e){return Ia(Ui,e)}const Z=w("ZodStringFormat",(e,t)=>{bs.init(e,t),ln.init(e,t)}),Li=w("ZodEmail",(e,t)=>{vs.init(e,t),Z.init(e,t)}),Ir=w("ZodGUID",(e,t)=>{ks.init(e,t),Z.init(e,t)}),Ke=w("ZodUUID",(e,t)=>{Ts.init(e,t),Z.init(e,t)}),Fi=w("ZodURL",(e,t)=>{$s.init(e,t),Z.init(e,t)}),Ji=w("ZodEmoji",(e,t)=>{Rs.init(e,t),Z.init(e,t)}),Vi=w("ZodNanoID",(e,t)=>{Ps.init(e,t),Z.init(e,t)}),Bi=w("ZodCUID",(e,t)=>{Is.init(e,t),Z.init(e,t)}),Wi=w("ZodCUID2",(e,t)=>{Es.init(e,t),Z.init(e,t)}),Gi=w("ZodULID",(e,t)=>{Os.init(e,t),Z.init(e,t)}),Ki=w("ZodXID",(e,t)=>{xs.init(e,t),Z.init(e,t)}),Qi=w("ZodKSUID",(e,t)=>{Cs.init(e,t),Z.init(e,t)}),Yi=w("ZodIPv4",(e,t)=>{As.init(e,t),Z.init(e,t)}),Xi=w("ZodIPv6",(e,t)=>{Ms.init(e,t),Z.init(e,t)}),el=w("ZodCIDRv4",(e,t)=>{Ns.init(e,t),Z.init(e,t)}),tl=w("ZodCIDRv6",(e,t)=>{Zs.init(e,t),Z.init(e,t)}),rl=w("ZodBase64",(e,t)=>{js.init(e,t),Z.init(e,t)}),nl=w("ZodBase64URL",(e,t)=>{qs.init(e,t),Z.init(e,t)}),al=w("ZodE164",(e,t)=>{zs.init(e,t),Z.init(e,t)}),ol=w("ZodJWT",(e,t)=>{Ds.init(e,t),Z.init(e,t)}),cn=w("ZodNumber",(e,t)=>{Bo.init(e,t),C.init(e,t),e._zod.processJSONSchema=(n,a,o)=>Wo(e,n,a),e.gt=(n,a)=>e.check(kr(n,a)),e.gte=(n,a)=>e.check(kt(n,a)),e.min=(n,a)=>e.check(kt(n,a)),e.lt=(n,a)=>e.check(Tr(n,a)),e.lte=(n,a)=>e.check(Tt(n,a)),e.max=(n,a)=>e.check(Tt(n,a)),e.int=n=>e.check(Er(n)),e.safe=n=>e.check(Er(n)),e.positive=n=>e.check(kr(0,n)),e.nonnegative=n=>e.check(kt(0,n)),e.negative=n=>e.check(Tr(0,n)),e.nonpositive=n=>e.check(Tt(0,n)),e.multipleOf=(n,a)=>e.check($r(n,a)),e.step=(n,a)=>e.check($r(n,a)),e.finite=()=>e;const r=e._zod.bag;e.minValue=Math.max(r.minimum??Number.NEGATIVE_INFINITY,r.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(r.maximum??Number.POSITIVE_INFINITY,r.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(r.format??"").includes("int")||Number.isSafeInteger(r.multipleOf??.5),e.isFinite=!0,e.format=r.format??null});function O(e){return xa(cn,e)}const sl=w("ZodNumberFormat",(e,t)=>{Hs.init(e,t),cn.init(e,t)});function Er(e){return _s(sl,e)}const il=w("ZodBoolean",(e,t)=>{Go.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>Ko(e,r,n)});function D(e){return Aa(il,e)}const ll=w("ZodNull",(e,t)=>{Qo.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>Yo(e,r,n)});function dn(e){return Ca(ll,e)}const cl=w("ZodUnknown",(e,t)=>{Xo.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>es()});function M(){return Oa(cl)}const dl=w("ZodNever",(e,t)=>{ws.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>Ss(e,r,n)});function ul(e){return ns(dl,e)}const pl=w("ZodArray",(e,t)=>{ts.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>rs(e,r,n,a),e.element=t.element,e.min=(r,n)=>e.check(Xe(r,n)),e.nonempty=r=>e.check(Xe(1,r)),e.max=(r,n)=>e.check(rn(r,n)),e.length=(r,n)=>e.check(nn(r,n)),e.unwrap=()=>e.element});function R(e,t){return Ea(pl,e,t)}const un=w("ZodObject",(e,t)=>{io.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>lo(e,r,n,a),Wr(e,"shape",()=>t.shape),e.keyof=()=>Q(Object.keys(e._zod.def.shape)),e.catchall=r=>e.clone({...e._zod.def,catchall:r}),e.passthrough=()=>e.clone({...e._zod.def,catchall:M()}),e.loose=()=>e.clone({...e._zod.def,catchall:M()}),e.strict=()=>e.clone({...e._zod.def,catchall:ul()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=r=>co(e,r),e.safeExtend=r=>uo(e,r),e.merge=r=>po(e,r),e.pick=r=>mo(e,r),e.omit=r=>fo(e,r),e.partial=(...r)=>ho(zt,e,r[0]),e.required=(...r)=>go(hn,e,r[0])});function m(e,t){const r={type:"object",shape:e??{},...oe(t)};return new un(r)}function B(e,t){return new un({type:"object",shape:e,catchall:M(),...oe(t)})}const pn=w("ZodUnion",(e,t)=>{yo.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>_o(e,r,n,a),e.options=t.options});function x(e,t){return new pn({type:"union",options:e,...oe(t)})}const ml=w("ZodDiscriminatedUnion",(e,t)=>{pn.init(e,t),Ma.init(e,t)});function mn(e,t,r){return new ml({type:"union",options:t,discriminator:e,...oe(r)})}const fl=w("ZodIntersection",(e,t)=>{Fa.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>Ja(e,r,n,a)});function qt(e,t){return new fl({type:"intersection",left:e,right:t})}const hl=w("ZodRecord",(e,t)=>{wo.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>So(e,r,n,a),e.keyType=t.keyType,e.valueType=t.valueType});function N(e,t,r){return new hl({type:"record",keyType:e,valueType:t,...oe(r)})}const It=w("ZodEnum",(e,t)=>{bo.init(e,t),C.init(e,t),e._zod.processJSONSchema=(n,a,o)=>vo(e,n,a),e.enum=t.entries,e.options=Object.values(t.entries);const r=new Set(Object.keys(t.entries));e.extract=(n,a)=>{const o={};for(const s of n)if(r.has(s))o[s]=t.entries[s];else throw new Error(`Key ${s} not found in enum`);return new It({...t,checks:[],...oe(a),entries:o})},e.exclude=(n,a)=>{const o={...t.entries};for(const s of n)if(r.has(s))delete o[s];else throw new Error(`Key ${s} not found in enum`);return new It({...t,checks:[],...oe(a),entries:o})}});function Q(e,t){const r=Array.isArray(e)?Object.fromEntries(e.map(n=>[n,n])):e;return new It({type:"enum",entries:r,...oe(t)})}const gl=w("ZodLiteral",(e,t)=>{ko.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>To(e,r,n),e.values=new Set(t.values),Object.defineProperty(e,"value",{get(){if(t.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return t.values[0]}})});function g(e,t){return new gl({type:"literal",values:Array.isArray(e)?e:[e],...oe(t)})}const yl=w("ZodTransform",(e,t)=>{ja.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>qa(e,r),e._zod.parse=(r,n)=>{if(n.direction==="backward")throw new za(e.constructor.name);r.addIssue=o=>{if(typeof o=="string")r.issues.push(Sr(o,r.value,t));else{const s=o;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=r.value),s.inst??(s.inst=e),r.issues.push(Sr(s))}};const a=t.transform(r.value,r);return a instanceof Promise?a.then(o=>(r.value=o,r)):(r.value=a,r)}});function fn(e){return new yl({type:"transform",transform:e})}const zt=w("ZodOptional",(e,t)=>{$o.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>en(e,r,n,a),e.unwrap=()=>e._zod.def.innerType});function j(e){return new zt({type:"optional",innerType:e})}const _l=w("ZodExactOptional",(e,t)=>{Wa.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>en(e,r,n,a),e.unwrap=()=>e._zod.def.innerType});function wl(e){return new _l({type:"optional",innerType:e})}const Sl=w("ZodNullable",(e,t)=>{Ga.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>Ka(e,r,n,a),e.unwrap=()=>e._zod.def.innerType});function Or(e){return new Sl({type:"nullable",innerType:e})}const bl=w("ZodDefault",(e,t)=>{Xa.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>eo(e,r,n,a),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function vl(e,t){return new bl({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():Xr(t)}})}const kl=w("ZodPrefault",(e,t)=>{to.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>ro(e,r,n,a),e.unwrap=()=>e._zod.def.innerType});function Tl(e,t){return new kl({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():Xr(t)}})}const hn=w("ZodNonOptional",(e,t)=>{Qa.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>Ya(e,r,n,a),e.unwrap=()=>e._zod.def.innerType});function $l(e,t){return new hn({type:"nonoptional",innerType:e,...oe(t)})}const Rl=w("ZodCatch",(e,t)=>{no.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>ao(e,r,n,a),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function Pl(e,t){return new Rl({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}const Il=w("ZodPipe",(e,t)=>{Na.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>Za(e,r,n,a),e.in=t.in,e.out=t.out});function Et(e,t){return new Il({type:"pipe",in:e,out:t})}const El=w("ZodReadonly",(e,t)=>{oo.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>so(e,r,n,a),e.unwrap=()=>e._zod.def.innerType});function Ol(e){return new El({type:"readonly",innerType:e})}const gn=w("ZodCustom",(e,t)=>{as.init(e,t),C.init(e,t),e._zod.processJSONSchema=(r,n,a)=>os(e,r)});function xl(e,t){return Da(gn,e??(()=>!0),t)}function Cl(e,t={}){return Va(gn,e,t)}function Al(e){return Ba(e)}function yn(e,t){return Et(fn(e),t)}const Ml=Symbol("Let zodToJsonSchema decide on which parser to use"),xr={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Nl=e=>typeof e=="string"?{...xr,name:e}:{...xr,...e},Zl=e=>{const t=Nl(e),r=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([n,a])=>[a._def,{def:a._def,path:[...t.basePath,t.definitionPath,n],jsonSchema:void 0}]))}};function _n(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function E(e,t,r,n,a){e[t]=r,_n(e,t,n,a)}const wn=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function W(e){if(e.target!=="openAi")return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:e.$refStrategy==="relative"?wn(t,e.currentPath):t.join("/")}}function jl(e,t){const r={type:"array"};return e.type?._def&&e.type?._def?.typeName!==$.ZodAny&&(r.items=I(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&E(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&E(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(E(r,"minItems",e.exactLength.value,e.exactLength.message,t),E(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}function ql(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"min":t.target==="jsonSchema7"?n.inclusive?E(r,"minimum",n.value,n.message,t):E(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),E(r,"minimum",n.value,n.message,t));break;case"max":t.target==="jsonSchema7"?n.inclusive?E(r,"maximum",n.value,n.message,t):E(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),E(r,"maximum",n.value,n.message,t));break;case"multipleOf":E(r,"multipleOf",n.value,n.message,t);break}return r}function zl(){return{type:"boolean"}}function Sn(e,t){return I(e.type._def,t)}const Dl=(e,t)=>I(e.innerType._def,t);function bn(e,t,r){const n=r??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((a,o)=>bn(e,t,a))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Hl(e,t)}}const Hl=(e,t)=>{const r={type:"integer",format:"unix-time"};if(t.target==="openApi3")return r;for(const n of e.checks)switch(n.kind){case"min":E(r,"minimum",n.value,n.message,t);break;case"max":E(r,"maximum",n.value,n.message,t);break}return r};function Ul(e,t){return{...I(e.innerType._def,t),default:e.defaultValue()}}function Ll(e,t){return t.effectStrategy==="input"?I(e.schema._def,t):W(t)}function Fl(e){return{type:"string",enum:Array.from(e.values)}}const Jl=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function Vl(e,t){const r=[I(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),I(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(o=>!!o);let n=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return r.forEach(o=>{if(Jl(o))a.push(...o.allOf),o.unevaluatedProperties===void 0&&(n=void 0);else{let s=o;if("additionalProperties"in o&&o.additionalProperties===!1){const{additionalProperties:i,...c}=o;s=c}else n=void 0;a.push(s)}}),a.length?{allOf:a,...n}:void 0}function Bl(e,t){const r=typeof e.value;return r!=="bigint"&&r!=="number"&&r!=="boolean"&&r!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:r==="bigint"?"integer":r,enum:[e.value]}:{type:r==="bigint"?"integer":r,const:e.value}}let $t;const re={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>($t===void 0&&($t=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),$t),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function vn(e,t){const r={type:"string"};if(e.checks)for(const n of e.checks)switch(n.kind){case"min":E(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,t);break;case"max":E(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":ne(r,"email",n.message,t);break;case"format:idn-email":ne(r,"idn-email",n.message,t);break;case"pattern:zod":F(r,re.email,n.message,t);break}break;case"url":ne(r,"uri",n.message,t);break;case"uuid":ne(r,"uuid",n.message,t);break;case"regex":F(r,n.regex,n.message,t);break;case"cuid":F(r,re.cuid,n.message,t);break;case"cuid2":F(r,re.cuid2,n.message,t);break;case"startsWith":F(r,RegExp(`^${Rt(n.value,t)}`),n.message,t);break;case"endsWith":F(r,RegExp(`${Rt(n.value,t)}$`),n.message,t);break;case"datetime":ne(r,"date-time",n.message,t);break;case"date":ne(r,"date",n.message,t);break;case"time":ne(r,"time",n.message,t);break;case"duration":ne(r,"duration",n.message,t);break;case"length":E(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,t),E(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"includes":{F(r,RegExp(Rt(n.value,t)),n.message,t);break}case"ip":{n.version!=="v6"&&ne(r,"ipv4",n.message,t),n.version!=="v4"&&ne(r,"ipv6",n.message,t);break}case"base64url":F(r,re.base64url,n.message,t);break;case"jwt":F(r,re.jwt,n.message,t);break;case"cidr":{n.version!=="v6"&&F(r,re.ipv4Cidr,n.message,t),n.version!=="v4"&&F(r,re.ipv6Cidr,n.message,t);break}case"emoji":F(r,re.emoji(),n.message,t);break;case"ulid":{F(r,re.ulid,n.message,t);break}case"base64":{switch(t.base64Strategy){case"format:binary":{ne(r,"binary",n.message,t);break}case"contentEncoding:base64":{E(r,"contentEncoding","base64",n.message,t);break}case"pattern:zod":{F(r,re.base64,n.message,t);break}}break}case"nanoid":F(r,re.nanoid,n.message,t)}return r}function Rt(e,t){return t.patternStrategy==="escape"?Gl(e):e}const Wl=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Gl(e){let t="";for(let r=0;r<e.length;r++)Wl.has(e[r])||(t+="\\"),t+=e[r];return t}function ne(e,t,r,n){e.format||e.anyOf?.some(a=>a.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):E(e,"format",t,r,n)}function F(e,t,r,n){e.pattern||e.allOf?.some(a=>a.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:Cr(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):E(e,"pattern",Cr(t,n),r,n)}function Cr(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},n=r.i?e.source.toLowerCase():e.source;let a="",o=!1,s=!1,i=!1;for(let c=0;c<n.length;c++){if(o){a+=n[c],o=!1;continue}if(r.i){if(s){if(n[c].match(/[a-z]/)){i?(a+=n[c],a+=`${n[c-2]}-${n[c]}`.toUpperCase(),i=!1):n[c+1]==="-"&&n[c+2]?.match(/[a-z]/)?(a+=n[c],i=!0):a+=`${n[c]}${n[c].toUpperCase()}`;continue}}else if(n[c].match(/[a-z]/)){a+=`[${n[c]}${n[c].toUpperCase()}]`;continue}}if(r.m){if(n[c]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(n[c]==="$"){a+=`($|(?=[\r
]))`;continue}}if(r.s&&n[c]==="."){a+=s?`${n[c]}\r
`:`[${n[c]}\r
]`;continue}a+=n[c],n[c]==="\\"?o=!0:s&&n[c]==="]"?s=!1:!s&&n[c]==="["&&(s=!0)}try{new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return a}function kn(e,t){if(t.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),t.target==="openApi3"&&e.keyType?._def.typeName===$.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,a)=>({...n,[a]:I(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??W(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const r={type:"object",additionalProperties:I(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if(t.target==="openApi3")return r;if(e.keyType?._def.typeName===$.ZodString&&e.keyType._def.checks?.length){const{type:n,...a}=vn(e.keyType._def,t);return{...r,propertyNames:a}}else{if(e.keyType?._def.typeName===$.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===$.ZodBranded&&e.keyType._def.type._def.typeName===$.ZodString&&e.keyType._def.type._def.checks?.length){const{type:n,...a}=Sn(e.keyType._def,t);return{...r,propertyNames:a}}}return r}function Kl(e,t){if(t.mapStrategy==="record")return kn(e,t);const r=I(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||W(t),n=I(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||W(t);return{type:"array",maxItems:125,items:{type:"array",items:[r,n],minItems:2,maxItems:2}}}function Ql(e){const t=e.values,n=Object.keys(e.values).filter(o=>typeof t[t[o]]!="number").map(o=>t[o]),a=Array.from(new Set(n.map(o=>typeof o)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:n}}function Yl(e){return e.target==="openAi"?void 0:{not:W({...e,currentPath:[...e.currentPath,"not"]})}}function Xl(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const et={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function ec(e,t){if(t.target==="openApi3")return Ar(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every(n=>n._def.typeName in et&&(!n._def.checks||!n._def.checks.length))){const n=r.reduce((a,o)=>{const s=et[o._def.typeName];return s&&!a.includes(s)?[...a,s]:a},[]);return{type:n.length>1?n:n[0]}}else if(r.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=r.reduce((a,o)=>{const s=typeof o._def.value;switch(s){case"string":case"number":case"boolean":return[...a,s];case"bigint":return[...a,"integer"];case"object":if(o._def.value===null)return[...a,"null"];default:return a}},[]);if(n.length===r.length){const a=n.filter((o,s,i)=>i.indexOf(o)===s);return{type:a.length>1?a:a[0],enum:r.reduce((o,s)=>o.includes(s._def.value)?o:[...o,s._def.value],[])}}}else if(r.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:r.reduce((n,a)=>[...n,...a._def.values.filter(o=>!n.includes(o))],[])};return Ar(e,t)}const Ar=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((n,a)=>I(n._def,{...t,currentPath:[...t.currentPath,"anyOf",`${a}`]})).filter(n=>!!n&&(!t.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return r.length?{anyOf:r}:void 0};function tc(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"?{type:et[e.innerType._def.typeName],nullable:!0}:{type:[et[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){const n=I(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const r=I(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function rc(e,t){const r={type:"number"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"int":r.type="integer",_n(r,"type",n.message,t);break;case"min":t.target==="jsonSchema7"?n.inclusive?E(r,"minimum",n.value,n.message,t):E(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),E(r,"minimum",n.value,n.message,t));break;case"max":t.target==="jsonSchema7"?n.inclusive?E(r,"maximum",n.value,n.message,t):E(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),E(r,"maximum",n.value,n.message,t));break;case"multipleOf":E(r,"multipleOf",n.value,n.message,t);break}return r}function nc(e,t){const r=t.target==="openAi",n={type:"object",properties:{}},a=[],o=e.shape();for(const i in o){let c=o[i];if(c===void 0||c._def===void 0)continue;let p=oc(c);p&&r&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),p=!1);const d=I(c._def,{...t,currentPath:[...t.currentPath,"properties",i],propertyPath:[...t.currentPath,"properties",i]});d!==void 0&&(n.properties[i]=d,p||a.push(i))}a.length&&(n.required=a);const s=ac(e,t);return s!==void 0&&(n.additionalProperties=s),n}function ac(e,t){if(e.catchall._def.typeName!=="ZodNever")return I(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return t.removeAdditionalStrategy==="strict"?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}function oc(e){try{return e.isOptional()}catch{return!0}}const sc=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return I(e.innerType._def,t);const r=I(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:W(t)},r]}:W(t)},ic=(e,t)=>{if(t.pipeStrategy==="input")return I(e.in._def,t);if(t.pipeStrategy==="output")return I(e.out._def,t);const r=I(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),n=I(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]});return{allOf:[r,n].filter(a=>a!==void 0)}};function lc(e,t){return I(e.type._def,t)}function cc(e,t){const n={type:"array",uniqueItems:!0,items:I(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&E(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&E(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}function dc(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((r,n)=>I(r._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[]),additionalItems:I(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((r,n)=>I(r._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[])}}function uc(e){return{not:W(e)}}function pc(e){return W(e)}const mc=(e,t)=>I(e.innerType._def,t),fc=(e,t,r)=>{switch(t){case $.ZodString:return vn(e,r);case $.ZodNumber:return rc(e,r);case $.ZodObject:return nc(e,r);case $.ZodBigInt:return ql(e,r);case $.ZodBoolean:return zl();case $.ZodDate:return bn(e,r);case $.ZodUndefined:return uc(r);case $.ZodNull:return Xl(r);case $.ZodArray:return jl(e,r);case $.ZodUnion:case $.ZodDiscriminatedUnion:return ec(e,r);case $.ZodIntersection:return Vl(e,r);case $.ZodTuple:return dc(e,r);case $.ZodRecord:return kn(e,r);case $.ZodLiteral:return Bl(e,r);case $.ZodEnum:return Fl(e);case $.ZodNativeEnum:return Ql(e);case $.ZodNullable:return tc(e,r);case $.ZodOptional:return sc(e,r);case $.ZodMap:return Kl(e,r);case $.ZodSet:return cc(e,r);case $.ZodLazy:return()=>e.getter()._def;case $.ZodPromise:return lc(e,r);case $.ZodNaN:case $.ZodNever:return Yl(r);case $.ZodEffects:return Ll(e,r);case $.ZodAny:return W(r);case $.ZodUnknown:return pc(r);case $.ZodDefault:return Ul(e,r);case $.ZodBranded:return Sn(e,r);case $.ZodReadonly:return mc(e,r);case $.ZodCatch:return Dl(e,r);case $.ZodPipeline:return ic(e,r);case $.ZodFunction:case $.ZodVoid:case $.ZodSymbol:return;default:return(n=>{})()}};function I(e,t,r=!1){const n=t.seen.get(e);if(t.override){const i=t.override?.(e,t,n,r);if(i!==Ml)return i}if(n&&!r){const i=hc(n,t);if(i!==void 0)return i}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const o=fc(e,e.typeName,t),s=typeof o=="function"?I(o(),t):o;if(s&&gc(e,t,s),t.postProcess){const i=t.postProcess(s,e,t);return a.jsonSchema=s,i}return a.jsonSchema=s,s}const hc=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:wn(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((r,n)=>t.currentPath[n]===r)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),W(t)):t.$refStrategy==="seen"?W(t):void 0}},gc=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),yc=(e,t)=>{const r=Zl(t);let n=typeof t=="object"&&t.definitions?Object.entries(t.definitions).reduce((c,[p,d])=>({...c,[p]:I(d._def,{...r,currentPath:[...r.basePath,r.definitionPath,p]},!0)??W(r)}),{}):void 0;const a=typeof t=="string"?t:t?.nameStrategy==="title"?void 0:t?.name,o=I(e._def,a===void 0?r:{...r,currentPath:[...r.basePath,r.definitionPath,a]},!1)??W(r),s=typeof t=="object"&&t.name!==void 0&&t.nameStrategy==="title"?t.name:void 0;s!==void 0&&(o.title=s),r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:r.$refStrategy==="relative"?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const i=a===void 0?n?{...o,[r.definitionPath]:n}:o:{$ref:[...r.$refStrategy==="relative"?[]:r.basePath,r.definitionPath,a].join("/"),[r.definitionPath]:{...n,[a]:o}};return r.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(r.target==="jsonSchema2019-09"||r.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),r.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i},Mr="Failed to parse input arguments",tt="Tool was executed but the invocation failed. For example, the script function threw an error",Ot="Tool was cancelled",Nr={type:"object",properties:{}},_c=["draft-2020-12","draft-07"],wc="__isWebMCPPolyfill",Tn=Symbol("standardValidator"),le={installed:!1,previousModelContextDescriptor:void 0,previousModelContextTestingDescriptor:void 0};var Sc=class{tools=new Map;toolsChangedCallback=null;provideContext(e={}){const t=new Map;for(const r of e.tools??[]){const n=Zr(r,t);t.set(n.name,n)}this.tools=t,this.notifyToolsChanged()}clearContext(){this.tools.clear(),this.notifyToolsChanged()}registerTool(e){const t=Zr(e,this.tools);this.tools.set(t.name,t),this.notifyToolsChanged()}unregisterTool(e){this.tools.delete(e)&&this.notifyToolsChanged()}getTestingShim(){return{listTools:()=>[...this.tools.values()].map(e=>{const t={name:e.name,description:e.description};try{t.inputSchema=JSON.stringify(e.inputSchema)}catch{}return t}),executeTool:(e,t,r)=>this.executeToolForTesting(e,t,r),registerToolsChangedCallback:e=>{if(typeof e!="function")throw new TypeError("Failed to execute 'registerToolsChangedCallback' on 'ModelContextTesting': parameter 1 is not of type 'Function'.");this.toolsChangedCallback=e},getCrossDocumentScriptToolResult:async()=>"[]"}}async executeToolForTesting(e,t,r){if(r?.signal?.aborted)throw ce(Ot);const n=this.tools.get(e);if(!n)throw ce(`Tool not found: ${e}`);const a=bc(t),o=await Ic(a,n);if(o)throw ce(o);let s=!0;const i={requestUserInteraction:async c=>{if(!s)throw new Error(`ModelContextClient for tool "${e}" is no longer active after execute() resolved`);if(typeof c!="function")throw new TypeError("requestUserInteraction(callback) requires a function callback");return c()}};try{const c=n.execute(a,i);return Oc(await xc(Promise.resolve(c),r?.signal))}catch(c){throw ce(c instanceof Error?`${tt}: ${c.message}`:tt)}finally{s=!1}}notifyToolsChanged(){this.toolsChangedCallback&&queueMicrotask(()=>{try{this.toolsChangedCallback?.()}catch(e){console.warn("[WebMCPPolyfill] toolsChanged callback threw:",e)}})}};function ce(e){try{return new DOMException(e,"UnknownError")}catch{const t=new Error(e);return t.name="UnknownError",t}}function bc(e){let t;try{t=JSON.parse(e)}catch{throw ce(Mr)}if(!t||typeof t!="object"||Array.isArray(t))throw ce(Mr);return t}function K(e){return!!e&&typeof e=="object"&&!Array.isArray(e)}function $n(e){if(!K(e))return null;const t=e["~standard"];return K(t)?t:null}function vc(e){const t=$n(e);return!!(t&&t.version===1&&typeof t.validate=="function")}function kc(e){const t=$n(e);return!t||t.version!==1||!K(t.jsonSchema)?!1:typeof t.jsonSchema.input=="function"}function Pt(e){return{"~standard":{version:1,vendor:"@mcp-b/webmcp-polyfill-json-schema",validate(t){if(!K(t))return{issues:[{message:"expected object arguments"}]};const r=Pn(t,e);return r?{issues:[r]}:{value:t}}}}}function Tc(e){for(const t of _c)try{const r=e["~standard"].jsonSchema.input({target:t});return Rn(r),r}catch(r){console.warn(`[WebMCPPolyfill] Standard JSON Schema conversion failed for target "${t}":`,r)}throw new Error("Failed to convert Standard JSON Schema inputSchema to a JSON Schema object")}function $c(e){if(e===void 0){const t=Nr;return{inputSchema:t,standardValidator:Pt(t)}}if(kc(e)){const t=Tc(e);return{inputSchema:t,standardValidator:Pt(t)}}return vc(e)?{inputSchema:Nr,standardValidator:e}:(Rn(e),{inputSchema:e,standardValidator:Pt(e)})}function Rn(e){if(!K(e))throw new Error("inputSchema must be a JSON Schema object");be(e,"$")}function be(e,t){const r=e.type;if(r!==void 0&&typeof r!="string"&&!(Array.isArray(r)&&r.every(i=>typeof i=="string"&&i.length>0)))throw new Error(`Invalid JSON Schema at ${t}: "type" must be a string or string[]`);const n=e.required;if(n!==void 0&&!(Array.isArray(n)&&n.every(i=>typeof i=="string")))throw new Error(`Invalid JSON Schema at ${t}: "required" must be an array of strings`);const a=e.properties;if(a!==void 0){if(!K(a))throw new Error(`Invalid JSON Schema at ${t}: "properties" must be an object`);for(const[i,c]of Object.entries(a)){if(!K(c))throw new Error(`Invalid JSON Schema at ${t}.properties.${i}: expected object schema`);be(c,`${t}.properties.${i}`)}}const o=e.items;if(o!==void 0)if(Array.isArray(o))for(const[i,c]of o.entries()){if(!K(c))throw new Error(`Invalid JSON Schema at ${t}.items[${i}]: expected object schema`);be(c,`${t}.items[${i}]`)}else if(K(o))be(o,`${t}.items`);else throw new Error(`Invalid JSON Schema at ${t}: "items" must be an object or object[]`);for(const i of["allOf","anyOf","oneOf"]){const c=e[i];if(c!==void 0){if(!Array.isArray(c))throw new Error(`Invalid JSON Schema at ${t}: "${i}" must be an array`);for(const[p,d]of c.entries()){if(!K(d))throw new Error(`Invalid JSON Schema at ${t}.${i}[${p}]: expected object schema`);be(d,`${t}.${i}[${p}]`)}}}const s=e.not;if(s!==void 0){if(!K(s))throw new Error(`Invalid JSON Schema at ${t}: "not" must be an object schema`);be(s,`${t}.not`)}try{JSON.stringify(e)}catch{throw new Error(`Invalid JSON Schema at ${t}: schema must be JSON-serializable`)}}function Zr(e,t){if(!e||typeof e!="object")throw new TypeError("registerTool(tool) requires a tool object");if(typeof e.name!="string"||e.name.length===0)throw new TypeError('Tool "name" must be a non-empty string');if(typeof e.description!="string"||e.description.length===0)throw new TypeError('Tool "description" must be a non-empty string');if(typeof e.execute!="function")throw new TypeError('Tool "execute" must be a function');if(t.has(e.name))throw new Error(`Tool already registered: ${e.name}`);const r=$c(e.inputSchema);return{...e,inputSchema:r.inputSchema,[Tn]:r.standardValidator}}function Pn(e,t){const r=new wi(t,"2020-12",!0).validate(e);if(r.valid)return null;const n=r.errors[r.errors.length-1];return n?{message:n.error}:{message:"Input validation failed"}}function Rc(e){if(!e||e.length===0)return null;const t=e.map(r=>K(r)&&"key"in r?r.key:r).map(r=>String(r)).filter(r=>r.length>0);return t.length===0?null:t.join(".")}async function Pc(e,t){let r;try{r=await Promise.resolve(t["~standard"].validate(e))}catch(o){const s=o instanceof Error?`: ${o.message}`:"";return console.error("[WebMCPPolyfill] Standard Schema validation threw unexpectedly:",o),`Input validation error: schema validation failed${s}`}if(!r.issues||r.issues.length===0)return null;const n=r.issues[0];if(!n)return"Input validation error";const a=Rc(n?.path);return a?`Input validation error: ${n.message} at ${a}`:`Input validation error: ${n.message}`}async function Ic(e,t){return Pc(e,t[Tn])}function Ec(e){for(const t of e.content??[])if(t.type==="text"&&"text"in t&&typeof t.text=="string")return t.text;return null}function Oc(e){if(e.isError)throw ce(Ec(e)?.replace(/^Error:\s*/i,"").trim()||tt);const t=e.metadata;if(t&&typeof t=="object"&&t.willNavigate)return null;try{return JSON.stringify(e)}catch{throw ce(tt)}}function xc(e,t){return t?t.aborted?Promise.reject(ce(Ot)):new Promise((r,n)=>{const a=()=>{o(),n(ce(Ot))},o=()=>{t.removeEventListener("abort",a)};t.addEventListener("abort",a,{once:!0}),e.then(s=>{o(),r(s)},s=>{o(),n(s)})}):e}function In(){return typeof navigator<"u"?navigator:null}function jr(e,t,r){Object.defineProperty(e,t,{configurable:!0,enumerable:!0,writable:!1,value:r})}function En(e){const t=In();if(!t||t.modelContext)return;le.installed&&Cc();const r=new Sc,n=r;n[wc]=!0,le.previousModelContextDescriptor=Object.getOwnPropertyDescriptor(t,"modelContext"),le.previousModelContextTestingDescriptor=Object.getOwnPropertyDescriptor(t,"modelContextTesting"),jr(t,"modelContext",n);const a=e?.installTestingShim??"if-missing",o=!!t.modelContextTesting;(a==="always"||(a===!0||a==="if-missing")&&!o)&&jr(t,"modelContextTesting",r.getTestingShim()),le.installed=!0}function Cc(){const e=In();if(!e||!le.installed)return;const t=(r,n)=>{if(n){Object.defineProperty(e,r,n);return}delete e[r]};t("modelContext",le.previousModelContextDescriptor),t("modelContextTesting",le.previousModelContextTestingDescriptor),le.installed=!1,le.previousModelContextDescriptor=void 0,le.previousModelContextTestingDescriptor=void 0}if(typeof window<"u"&&typeof document<"u"){const e=window.__webMCPPolyfillOptions;if(e?.autoInitialize!==!1)try{En(e)}catch(t){console.error("[WebMCPPolyfill] Auto-initialization failed:",t)}}function de(e){return!!e._zod}function ke(e){const t=Object.values(e);if(t.length===0)return Pr({});const r=t.every(de),n=t.every(a=>!de(a));if(r)return Pr(e);if(n)return Ls(e);throw new Error("Mixed Zod versions detected in object shape.")}function xe(e,t){return de(e)?Kr(e,t):e.safeParse(t)}async function Ce(e,t){return de(e)?await Qr(e,t):await e.safeParseAsync(t)}function Ne(e){if(!e)return;let t;if(de(e)?t=e._zod?.def?.shape:t=e.shape,!!t){if(typeof t=="function")try{return t()}catch{return}return t}}function ve(e){if(e){if(typeof e=="object"){const t=e,r=e;if(!t._def&&!r._zod){const n=Object.values(e);if(n.length>0&&n.every(a=>typeof a=="object"&&a!==null&&(a._def!==void 0||a._zod!==void 0||typeof a.parse=="function")))return ke(e)}}if(de(e)){const t=e._zod?.def;if(t&&(t.type==="object"||t.shape!==void 0))return e}else if(e.shape!==void 0)return e}}function Ae(e){if(e&&typeof e=="object"){if("message"in e&&typeof e.message=="string")return e.message;if("issues"in e&&Array.isArray(e.issues)&&e.issues.length>0){const t=e.issues[0];if(t&&typeof t=="object"&&"message"in t)return String(t.message)}try{return JSON.stringify(e)}catch{return String(e)}}return String(e)}function Ac(e){return e.description}function Mc(e){if(de(e))return e._zod?.def?.type==="optional";const t=e;return typeof e.isOptional=="function"?e.isOptional():t._def?.typeName==="ZodOptional"}function On(e){if(de(e)){const n=e._zod?.def;if(n){if(n.value!==void 0)return n.value;if(Array.isArray(n.values)&&n.values.length>0)return n.values[0]}}const t=e._def;if(t){if(t.value!==void 0)return t.value;if(Array.isArray(t.values)&&t.values.length>0)return t.values[0]}const r=e.value;if(r!==void 0)return r}const xn="2025-11-25",Nc=[xn,"2025-06-18","2025-03-26","2024-11-05","2024-10-07"],_e="io.modelcontextprotocol/related-task",ct="2.0",H=xl(e=>e!==null&&(typeof e=="object"||typeof e=="function")),Cn=x([l(),O().int()]),An=l();B({ttl:x([O(),dn()]).optional(),pollInterval:O().optional()});const Zc=m({ttl:O().optional()}),jc=m({taskId:l()}),Dt=B({progressToken:Cn.optional(),[_e]:jc.optional()}),Y=m({_meta:Dt.optional()}),Ze=Y.extend({task:Zc.optional()}),qc=e=>Ze.safeParse(e).success,U=m({method:l(),params:Y.loose().optional()}),ee=m({_meta:Dt.optional()}),te=m({method:l(),params:ee.loose().optional()}),L=B({_meta:Dt.optional()}),dt=x([l(),O().int()]),Mn=m({jsonrpc:g(ct),id:dt,...U.shape}).strict(),qr=e=>Mn.safeParse(e).success,Nn=m({jsonrpc:g(ct),...te.shape}).strict(),zc=e=>Nn.safeParse(e).success,Ht=m({jsonrpc:g(ct),id:dt,result:L}).strict(),Qe=e=>Ht.safeParse(e).success;var S;(function(e){e[e.ConnectionClosed=-32e3]="ConnectionClosed",e[e.RequestTimeout=-32001]="RequestTimeout",e[e.ParseError=-32700]="ParseError",e[e.InvalidRequest=-32600]="InvalidRequest",e[e.MethodNotFound=-32601]="MethodNotFound",e[e.InvalidParams=-32602]="InvalidParams",e[e.InternalError=-32603]="InternalError",e[e.UrlElicitationRequired=-32042]="UrlElicitationRequired"})(S||(S={}));const Ut=m({jsonrpc:g(ct),id:dt.optional(),error:m({code:O().int(),message:l(),data:M().optional()})}).strict(),Dc=e=>Ut.safeParse(e).success,Zn=x([Mn,Nn,Ht,Ut]);x([Ht,Ut]);const Lt=L.strict(),Hc=ee.extend({requestId:dt.optional(),reason:l().optional()}),Ft=te.extend({method:g("notifications/cancelled"),params:Hc}),Uc=m({src:l(),mimeType:l().optional(),sizes:R(l()).optional(),theme:Q(["light","dark"]).optional()}),je=m({icons:R(Uc).optional()}),Te=m({name:l(),title:l().optional()}),jn=Te.extend({...Te.shape,...je.shape,version:l(),websiteUrl:l().optional(),description:l().optional()}),Lc=qt(m({applyDefaults:D().optional()}),N(l(),M())),Fc=yn(e=>e&&typeof e=="object"&&!Array.isArray(e)&&Object.keys(e).length===0?{form:{}}:e,qt(m({form:Lc.optional(),url:H.optional()}),N(l(),M()).optional())),Jc=B({list:H.optional(),cancel:H.optional(),requests:B({sampling:B({createMessage:H.optional()}).optional(),elicitation:B({create:H.optional()}).optional()}).optional()}),Vc=B({list:H.optional(),cancel:H.optional(),requests:B({tools:B({call:H.optional()}).optional()}).optional()}),Bc=m({experimental:N(l(),H).optional(),sampling:m({context:H.optional(),tools:H.optional()}).optional(),elicitation:Fc.optional(),roots:m({listChanged:D().optional()}).optional(),tasks:Jc.optional()}),Wc=Y.extend({protocolVersion:l(),capabilities:Bc,clientInfo:jn}),qn=U.extend({method:g("initialize"),params:Wc}),Gc=m({experimental:N(l(),H).optional(),logging:H.optional(),completions:H.optional(),prompts:m({listChanged:D().optional()}).optional(),resources:m({subscribe:D().optional(),listChanged:D().optional()}).optional(),tools:m({listChanged:D().optional()}).optional(),tasks:Vc.optional()}),Kc=L.extend({protocolVersion:l(),capabilities:Gc,serverInfo:jn,instructions:l().optional()}),zn=te.extend({method:g("notifications/initialized"),params:ee.optional()}),Jt=U.extend({method:g("ping"),params:Y.optional()}),Qc=m({progress:O(),total:j(O()),message:j(l())}),Yc=m({...ee.shape,...Qc.shape,progressToken:Cn}),Vt=te.extend({method:g("notifications/progress"),params:Yc}),Xc=Y.extend({cursor:An.optional()}),qe=U.extend({params:Xc.optional()}),ze=L.extend({nextCursor:An.optional()}),ed=Q(["working","input_required","completed","failed","cancelled"]),De=m({taskId:l(),status:ed,ttl:x([O(),dn()]),createdAt:l(),lastUpdatedAt:l(),pollInterval:j(O()),statusMessage:j(l())}),ut=L.extend({task:De}),td=ee.merge(De),rt=te.extend({method:g("notifications/tasks/status"),params:td}),Bt=U.extend({method:g("tasks/get"),params:Y.extend({taskId:l()})}),Wt=L.merge(De),Gt=U.extend({method:g("tasks/result"),params:Y.extend({taskId:l()})});L.loose();const Kt=qe.extend({method:g("tasks/list")}),Qt=ze.extend({tasks:R(De)}),Yt=U.extend({method:g("tasks/cancel"),params:Y.extend({taskId:l()})}),rd=L.merge(De),Dn=m({uri:l(),mimeType:j(l()),_meta:N(l(),M()).optional()}),Hn=Dn.extend({text:l()}),Xt=l().refine(e=>{try{return atob(e),!0}catch{return!1}},{message:"Invalid Base64 string"}),Un=Dn.extend({blob:Xt}),He=Q(["user","assistant"]),$e=m({audience:R(He).optional(),priority:O().min(0).max(1).optional(),lastModified:sn({offset:!0}).optional()}),Ln=m({...Te.shape,...je.shape,uri:l(),description:j(l()),mimeType:j(l()),annotations:$e.optional(),_meta:j(B({}))}),nd=m({...Te.shape,...je.shape,uriTemplate:l(),description:j(l()),mimeType:j(l()),annotations:$e.optional(),_meta:j(B({}))}),xt=qe.extend({method:g("resources/list")}),ad=ze.extend({resources:R(Ln)}),Ct=qe.extend({method:g("resources/templates/list")}),od=ze.extend({resourceTemplates:R(nd)}),er=Y.extend({uri:l()}),sd=er,At=U.extend({method:g("resources/read"),params:sd}),id=L.extend({contents:R(x([Hn,Un]))}),ld=te.extend({method:g("notifications/resources/list_changed"),params:ee.optional()}),cd=er,dd=U.extend({method:g("resources/subscribe"),params:cd}),ud=er,pd=U.extend({method:g("resources/unsubscribe"),params:ud}),md=ee.extend({uri:l()}),fd=te.extend({method:g("notifications/resources/updated"),params:md}),hd=m({name:l(),description:j(l()),required:j(D())}),gd=m({...Te.shape,...je.shape,description:j(l()),arguments:j(R(hd)),_meta:j(B({}))}),nt=qe.extend({method:g("prompts/list")}),yd=ze.extend({prompts:R(gd)}),_d=Y.extend({name:l(),arguments:N(l(),l()).optional()}),at=U.extend({method:g("prompts/get"),params:_d}),tr=m({type:g("text"),text:l(),annotations:$e.optional(),_meta:N(l(),M()).optional()}),rr=m({type:g("image"),data:Xt,mimeType:l(),annotations:$e.optional(),_meta:N(l(),M()).optional()}),nr=m({type:g("audio"),data:Xt,mimeType:l(),annotations:$e.optional(),_meta:N(l(),M()).optional()}),wd=m({type:g("tool_use"),name:l(),id:l(),input:N(l(),M()),_meta:N(l(),M()).optional()}),Sd=m({type:g("resource"),resource:x([Hn,Un]),annotations:$e.optional(),_meta:N(l(),M()).optional()}),bd=Ln.extend({type:g("resource_link")}),ar=x([tr,rr,nr,bd,Sd]),vd=m({role:He,content:ar}),kd=L.extend({description:l().optional(),messages:R(vd)}),Td=te.extend({method:g("notifications/prompts/list_changed"),params:ee.optional()}),$d=m({title:l().optional(),readOnlyHint:D().optional(),destructiveHint:D().optional(),idempotentHint:D().optional(),openWorldHint:D().optional()}),Rd=m({taskSupport:Q(["required","optional","forbidden"]).optional()}),Fn=m({...Te.shape,...je.shape,description:l().optional(),inputSchema:m({type:g("object"),properties:N(l(),H).optional(),required:R(l()).optional()}).catchall(M()),outputSchema:m({type:g("object"),properties:N(l(),H).optional(),required:R(l()).optional()}).catchall(M()).optional(),annotations:$d.optional(),execution:Rd.optional(),_meta:N(l(),M()).optional()}),ot=qe.extend({method:g("tools/list")}),Pd=ze.extend({tools:R(Fn)}),or=L.extend({content:R(ar).default([]),structuredContent:N(l(),M()).optional(),isError:D().optional()});or.or(L.extend({toolResult:M()}));const Id=Ze.extend({name:l(),arguments:N(l(),M()).optional()}),st=U.extend({method:g("tools/call"),params:Id}),Ed=te.extend({method:g("notifications/tools/list_changed"),params:ee.optional()});m({autoRefresh:D().default(!0),debounceMs:O().int().nonnegative().default(300)});const it=Q(["debug","info","notice","warning","error","critical","alert","emergency"]),Od=Y.extend({level:it}),Jn=U.extend({method:g("logging/setLevel"),params:Od}),xd=ee.extend({level:it,logger:l().optional(),data:M()}),Cd=te.extend({method:g("notifications/message"),params:xd}),Ad=m({name:l().optional()}),Md=m({hints:R(Ad).optional(),costPriority:O().min(0).max(1).optional(),speedPriority:O().min(0).max(1).optional(),intelligencePriority:O().min(0).max(1).optional()}),Nd=m({mode:Q(["auto","required","none"]).optional()}),Zd=m({type:g("tool_result"),toolUseId:l().describe("The unique identifier for the corresponding tool call."),content:R(ar).default([]),structuredContent:m({}).loose().optional(),isError:D().optional(),_meta:N(l(),M()).optional()}),jd=mn("type",[tr,rr,nr]),lt=mn("type",[tr,rr,nr,wd,Zd]),qd=m({role:He,content:x([lt,R(lt)]),_meta:N(l(),M()).optional()}),zd=Ze.extend({messages:R(qd),modelPreferences:Md.optional(),systemPrompt:l().optional(),includeContext:Q(["none","thisServer","allServers"]).optional(),temperature:O().optional(),maxTokens:O().int(),stopSequences:R(l()).optional(),metadata:H.optional(),tools:R(Fn).optional(),toolChoice:Nd.optional()}),Dd=U.extend({method:g("sampling/createMessage"),params:zd}),Vn=L.extend({model:l(),stopReason:j(Q(["endTurn","stopSequence","maxTokens"]).or(l())),role:He,content:jd}),Bn=L.extend({model:l(),stopReason:j(Q(["endTurn","stopSequence","maxTokens","toolUse"]).or(l())),role:He,content:x([lt,R(lt)])}),Hd=m({type:g("boolean"),title:l().optional(),description:l().optional(),default:D().optional()}),Ud=m({type:g("string"),title:l().optional(),description:l().optional(),minLength:O().optional(),maxLength:O().optional(),format:Q(["email","uri","date","date-time"]).optional(),default:l().optional()}),Ld=m({type:Q(["number","integer"]),title:l().optional(),description:l().optional(),minimum:O().optional(),maximum:O().optional(),default:O().optional()}),Fd=m({type:g("string"),title:l().optional(),description:l().optional(),enum:R(l()),default:l().optional()}),Jd=m({type:g("string"),title:l().optional(),description:l().optional(),oneOf:R(m({const:l(),title:l()})),default:l().optional()}),Vd=m({type:g("string"),title:l().optional(),description:l().optional(),enum:R(l()),enumNames:R(l()).optional(),default:l().optional()}),Bd=x([Fd,Jd]),Wd=m({type:g("array"),title:l().optional(),description:l().optional(),minItems:O().optional(),maxItems:O().optional(),items:m({type:g("string"),enum:R(l())}),default:R(l()).optional()}),Gd=m({type:g("array"),title:l().optional(),description:l().optional(),minItems:O().optional(),maxItems:O().optional(),items:m({anyOf:R(m({const:l(),title:l()}))}),default:R(l()).optional()}),Kd=x([Wd,Gd]),Qd=x([Vd,Bd,Kd]),Yd=x([Qd,Hd,Ud,Ld]),Xd=Ze.extend({mode:g("form").optional(),message:l(),requestedSchema:m({type:g("object"),properties:N(l(),Yd),required:R(l()).optional()})}),eu=Ze.extend({mode:g("url"),message:l(),elicitationId:l(),url:l().url()}),tu=x([Xd,eu]),ru=U.extend({method:g("elicitation/create"),params:tu}),nu=ee.extend({elicitationId:l()}),au=te.extend({method:g("notifications/elicitation/complete"),params:nu}),Mt=L.extend({action:Q(["accept","decline","cancel"]),content:yn(e=>e===null?void 0:e,N(l(),x([l(),O(),D(),R(l())])).optional())}),ou=m({type:g("ref/resource"),uri:l()}),su=m({type:g("ref/prompt"),name:l()}),iu=Y.extend({ref:x([su,ou]),argument:m({name:l(),value:l()}),context:m({arguments:N(l(),l()).optional()}).optional()}),Nt=U.extend({method:g("completion/complete"),params:iu});function lu(e){if(e.params.ref.type!=="ref/prompt")throw new TypeError(`Expected CompleteRequestPrompt, but got ${e.params.ref.type}`)}function cu(e){if(e.params.ref.type!=="ref/resource")throw new TypeError(`Expected CompleteRequestResourceTemplate, but got ${e.params.ref.type}`)}const du=L.extend({completion:B({values:R(l()).max(100),total:j(O().int()),hasMore:j(D())})}),uu=m({uri:l().startsWith("file://"),name:l().optional(),_meta:N(l(),M()).optional()}),pu=U.extend({method:g("roots/list"),params:Y.optional()}),Wn=L.extend({roots:R(uu)}),mu=te.extend({method:g("notifications/roots/list_changed"),params:ee.optional()});x([Jt,qn,Nt,Jn,at,nt,xt,Ct,At,dd,pd,st,ot,Bt,Gt,Kt,Yt]);x([Ft,Vt,zn,mu,rt]);x([Lt,Vn,Bn,Mt,Wn,Wt,Qt,ut]);x([Jt,Dd,ru,pu,Bt,Gt,Kt,Yt]);x([Ft,Vt,Cd,fd,ld,Ed,Td,rt,au]);x([Lt,Kc,du,kd,yd,ad,od,id,or,Pd,Wt,Qt,ut]);var _=class Gn extends Error{constructor(t,r,n){super(`MCP error ${t}: ${r}`),this.code=t,this.data=n,this.name="McpError"}static fromError(t,r,n){if(t===S.UrlElicitationRequired&&n){const a=n;if(a.elicitations)return new fu(a.elicitations,r)}return new Gn(t,r,n)}},fu=class extends _{constructor(e,t=`URL elicitation${e.length>1?"s":""} required`){super(S.UrlElicitationRequired,t,{elicitations:e})}get elicitations(){return this.data?.elicitations??[]}};function ye(e){return e==="completed"||e==="failed"||e==="cancelled"}function hu(e){return!e||e==="jsonSchema7"||e==="draft-7"?"draft-7":e==="jsonSchema2019-09"||e==="draft-2020-12"?"draft-2020-12":"draft-7"}function Zt(e,t){return de(e)?Us(e,{target:hu(t?.target),io:t?.pipeStrategy??"input"}):yc(e,{strictUnions:t?.strictUnions??!0,pipeStrategy:t?.pipeStrategy??"input"})}function zr(e){const t=Ne(e)?.method;if(!t)throw new Error("Schema is missing a method literal");const r=On(t);if(typeof r!="string")throw new Error("Schema method literal must be a string");return r}function Dr(e,t){const r=xe(e,t);if(!r.success)throw r.error;return r.data}const gu=6e4;var yu=class{constructor(e){this._options=e,this._requestMessageId=0,this._requestHandlers=new Map,this._requestHandlerAbortControllers=new Map,this._notificationHandlers=new Map,this._responseHandlers=new Map,this._progressHandlers=new Map,this._timeoutInfo=new Map,this._pendingDebouncedNotifications=new Set,this._taskProgressTokens=new Map,this._requestResolvers=new Map,this.setNotificationHandler(Ft,t=>{this._oncancel(t)}),this.setNotificationHandler(Vt,t=>{this._onprogress(t)}),this.setRequestHandler(Jt,t=>({})),this._taskStore=e?.taskStore,this._taskMessageQueue=e?.taskMessageQueue,this._taskStore&&(this.setRequestHandler(Bt,async(t,r)=>{const n=await this._taskStore.getTask(t.params.taskId,r.sessionId);if(!n)throw new _(S.InvalidParams,"Failed to retrieve task: Task not found");return{...n}}),this.setRequestHandler(Gt,async(t,r)=>{const n=async()=>{const a=t.params.taskId;if(this._taskMessageQueue){let s;for(;s=await this._taskMessageQueue.dequeue(a,r.sessionId);){if(s.type==="response"||s.type==="error"){const i=s.message,c=i.id,p=this._requestResolvers.get(c);if(p)if(this._requestResolvers.delete(c),s.type==="response")p(i);else{const d=i;p(new _(d.error.code,d.error.message,d.error.data))}else{const d=s.type==="response"?"Response":"Error";this._onerror(new Error(`${d} handler missing for request ${c}`))}continue}await this._transport?.send(s.message,{relatedRequestId:r.requestId})}}const o=await this._taskStore.getTask(a,r.sessionId);if(!o)throw new _(S.InvalidParams,`Task not found: ${a}`);if(!ye(o.status))return await this._waitForTaskUpdate(a,r.signal),await n();if(ye(o.status)){const s=await this._taskStore.getTaskResult(a,r.sessionId);return this._clearTaskQueue(a),{...s,_meta:{...s._meta,[_e]:{taskId:a}}}}return await n()};return await n()}),this.setRequestHandler(Kt,async(t,r)=>{try{const{tasks:n,nextCursor:a}=await this._taskStore.listTasks(t.params?.cursor,r.sessionId);return{tasks:n,nextCursor:a,_meta:{}}}catch(n){throw new _(S.InvalidParams,`Failed to list tasks: ${n instanceof Error?n.message:String(n)}`)}}),this.setRequestHandler(Yt,async(t,r)=>{try{const n=await this._taskStore.getTask(t.params.taskId,r.sessionId);if(!n)throw new _(S.InvalidParams,`Task not found: ${t.params.taskId}`);if(ye(n.status))throw new _(S.InvalidParams,`Cannot cancel task in terminal status: ${n.status}`);await this._taskStore.updateTaskStatus(t.params.taskId,"cancelled","Client cancelled task execution.",r.sessionId),this._clearTaskQueue(t.params.taskId);const a=await this._taskStore.getTask(t.params.taskId,r.sessionId);if(!a)throw new _(S.InvalidParams,`Task not found after cancellation: ${t.params.taskId}`);return{_meta:{},...a}}catch(n){throw n instanceof _?n:new _(S.InvalidRequest,`Failed to cancel task: ${n instanceof Error?n.message:String(n)}`)}}))}async _oncancel(e){e.params.requestId&&this._requestHandlerAbortControllers.get(e.params.requestId)?.abort(e.params.reason)}_setupTimeout(e,t,r,n,a=!1){this._timeoutInfo.set(e,{timeoutId:setTimeout(n,t),startTime:Date.now(),timeout:t,maxTotalTimeout:r,resetTimeoutOnProgress:a,onTimeout:n})}_resetTimeout(e){const t=this._timeoutInfo.get(e);if(!t)return!1;const r=Date.now()-t.startTime;if(t.maxTotalTimeout&&r>=t.maxTotalTimeout)throw this._timeoutInfo.delete(e),_.fromError(S.RequestTimeout,"Maximum total timeout exceeded",{maxTotalTimeout:t.maxTotalTimeout,totalElapsed:r});return clearTimeout(t.timeoutId),t.timeoutId=setTimeout(t.onTimeout,t.timeout),!0}_cleanupTimeout(e){const t=this._timeoutInfo.get(e);t&&(clearTimeout(t.timeoutId),this._timeoutInfo.delete(e))}async connect(e){if(this._transport)throw new Error("Already connected to a transport. Call close() before connecting to a new transport, or use a separate Protocol instance per connection.");this._transport=e;const t=this.transport?.onclose;this._transport.onclose=()=>{t?.(),this._onclose()};const r=this.transport?.onerror;this._transport.onerror=a=>{r?.(a),this._onerror(a)};const n=this._transport?.onmessage;this._transport.onmessage=(a,o)=>{n?.(a,o),Qe(a)||Dc(a)?this._onresponse(a):qr(a)?this._onrequest(a,o):zc(a)?this._onnotification(a):this._onerror(new Error(`Unknown message type: ${JSON.stringify(a)}`))},await this._transport.start()}_onclose(){const e=this._responseHandlers;this._responseHandlers=new Map,this._progressHandlers.clear(),this._taskProgressTokens.clear(),this._pendingDebouncedNotifications.clear();for(const r of this._requestHandlerAbortControllers.values())r.abort();this._requestHandlerAbortControllers.clear();const t=_.fromError(S.ConnectionClosed,"Connection closed");this._transport=void 0,this.onclose?.();for(const r of e.values())r(t)}_onerror(e){this.onerror?.(e)}_onnotification(e){const t=this._notificationHandlers.get(e.method)??this.fallbackNotificationHandler;t!==void 0&&Promise.resolve().then(()=>t(e)).catch(r=>this._onerror(new Error(`Uncaught error in notification handler: ${r}`)))}_onrequest(e,t){const r=this._requestHandlers.get(e.method)??this.fallbackRequestHandler,n=this._transport,a=e.params?._meta?.[_e]?.taskId;if(r===void 0){const p={jsonrpc:"2.0",id:e.id,error:{code:S.MethodNotFound,message:"Method not found"}};a&&this._taskMessageQueue?this._enqueueTaskMessage(a,{type:"error",message:p,timestamp:Date.now()},n?.sessionId).catch(d=>this._onerror(new Error(`Failed to enqueue error response: ${d}`))):n?.send(p).catch(d=>this._onerror(new Error(`Failed to send an error response: ${d}`)));return}const o=new AbortController;this._requestHandlerAbortControllers.set(e.id,o);const s=qc(e.params)?e.params.task:void 0,i=this._taskStore?this.requestTaskStore(e,n?.sessionId):void 0,c={signal:o.signal,sessionId:n?.sessionId,_meta:e.params?._meta,sendNotification:async p=>{if(o.signal.aborted)return;const d={relatedRequestId:e.id};a&&(d.relatedTask={taskId:a}),await this.notification(p,d)},sendRequest:async(p,d,P)=>{if(o.signal.aborted)throw new _(S.ConnectionClosed,"Request was cancelled");const z={...P,relatedRequestId:e.id};a&&!z.relatedTask&&(z.relatedTask={taskId:a});const se=z.relatedTask?.taskId??a;return se&&i&&await i.updateTaskStatus(se,"input_required"),await this.request(p,d,z)},authInfo:t?.authInfo,requestId:e.id,requestInfo:t?.requestInfo,taskId:a,taskStore:i,taskRequestedTtl:s?.ttl,closeSSEStream:t?.closeSSEStream,closeStandaloneSSEStream:t?.closeStandaloneSSEStream};Promise.resolve().then(()=>{s&&this.assertTaskHandlerCapability(e.method)}).then(()=>r(e,c)).then(async p=>{if(o.signal.aborted)return;const d={result:p,jsonrpc:"2.0",id:e.id};a&&this._taskMessageQueue?await this._enqueueTaskMessage(a,{type:"response",message:d,timestamp:Date.now()},n?.sessionId):await n?.send(d)},async p=>{if(o.signal.aborted)return;const d={jsonrpc:"2.0",id:e.id,error:{code:Number.isSafeInteger(p.code)?p.code:S.InternalError,message:p.message??"Internal error",...p.data!==void 0&&{data:p.data}}};a&&this._taskMessageQueue?await this._enqueueTaskMessage(a,{type:"error",message:d,timestamp:Date.now()},n?.sessionId):await n?.send(d)}).catch(p=>this._onerror(new Error(`Failed to send response: ${p}`))).finally(()=>{this._requestHandlerAbortControllers.delete(e.id)})}_onprogress(e){const{progressToken:t,...r}=e.params,n=Number(t),a=this._progressHandlers.get(n);if(!a){this._onerror(new Error(`Received a progress notification for an unknown token: ${JSON.stringify(e)}`));return}const o=this._responseHandlers.get(n),s=this._timeoutInfo.get(n);if(s&&o&&s.resetTimeoutOnProgress)try{this._resetTimeout(n)}catch(i){this._responseHandlers.delete(n),this._progressHandlers.delete(n),this._cleanupTimeout(n),o(i);return}a(r)}_onresponse(e){const t=Number(e.id),r=this._requestResolvers.get(t);if(r){this._requestResolvers.delete(t),Qe(e)?r(e):r(new _(e.error.code,e.error.message,e.error.data));return}const n=this._responseHandlers.get(t);if(n===void 0){this._onerror(new Error(`Received a response for an unknown message ID: ${JSON.stringify(e)}`));return}this._responseHandlers.delete(t),this._cleanupTimeout(t);let a=!1;if(Qe(e)&&e.result&&typeof e.result=="object"){const o=e.result;if(o.task&&typeof o.task=="object"){const s=o.task;typeof s.taskId=="string"&&(a=!0,this._taskProgressTokens.set(s.taskId,t))}}a||this._progressHandlers.delete(t),Qe(e)?n(e):n(_.fromError(e.error.code,e.error.message,e.error.data))}get transport(){return this._transport}async close(){await this._transport?.close()}async*requestStream(e,t,r){const{task:n}=r??{};if(!n){try{yield{type:"result",result:await this.request(e,t,r)}}catch(o){yield{type:"error",error:o instanceof _?o:new _(S.InternalError,String(o))}}return}let a;try{const o=await this.request(e,ut,r);if(o.task)a=o.task.taskId,yield{type:"taskCreated",task:o.task};else throw new _(S.InternalError,"Task creation did not return a task");for(;;){const s=await this.getTask({taskId:a},r);if(yield{type:"taskStatus",task:s},ye(s.status)){s.status==="completed"?yield{type:"result",result:await this.getTaskResult({taskId:a},t,r)}:s.status==="failed"?yield{type:"error",error:new _(S.InternalError,`Task ${a} failed`)}:s.status==="cancelled"&&(yield{type:"error",error:new _(S.InternalError,`Task ${a} was cancelled`)});return}if(s.status==="input_required"){yield{type:"result",result:await this.getTaskResult({taskId:a},t,r)};return}const i=s.pollInterval??this._options?.defaultTaskPollInterval??1e3;await new Promise(c=>setTimeout(c,i)),r?.signal?.throwIfAborted()}}catch(o){yield{type:"error",error:o instanceof _?o:new _(S.InternalError,String(o))}}}request(e,t,r){const{relatedRequestId:n,resumptionToken:a,onresumptiontoken:o,task:s,relatedTask:i}=r??{};return new Promise((c,p)=>{const d=q=>{p(q)};if(!this._transport){d(new Error("Not connected"));return}if(this._options?.enforceStrictCapabilities===!0)try{this.assertCapabilityForMethod(e.method),s&&this.assertTaskCapability(e.method)}catch(q){d(q);return}r?.signal?.throwIfAborted();const P=this._requestMessageId++,z={...e,jsonrpc:"2.0",id:P};r?.onprogress&&(this._progressHandlers.set(P,r.onprogress),z.params={...e.params,_meta:{...e.params?._meta||{},progressToken:P}}),s&&(z.params={...z.params,task:s}),i&&(z.params={...z.params,_meta:{...z.params?._meta||{},[_e]:i}});const se=q=>{this._responseHandlers.delete(P),this._progressHandlers.delete(P),this._cleanupTimeout(P),this._transport?.send({jsonrpc:"2.0",method:"notifications/cancelled",params:{requestId:P,reason:String(q)}},{relatedRequestId:n,resumptionToken:a,onresumptiontoken:o}).catch(J=>this._onerror(new Error(`Failed to send cancellation: ${J}`))),p(q instanceof _?q:new _(S.RequestTimeout,String(q)))};this._responseHandlers.set(P,q=>{if(!r?.signal?.aborted){if(q instanceof Error)return p(q);try{const J=xe(t,q.result);J.success?c(J.data):p(J.error)}catch(J){p(J)}}}),r?.signal?.addEventListener("abort",()=>{se(r?.signal?.reason)});const G=r?.timeout??gu,fe=()=>se(_.fromError(S.RequestTimeout,"Request timed out",{timeout:G}));this._setupTimeout(P,G,r?.maxTotalTimeout,fe,r?.resetTimeoutOnProgress??!1);const pe=i?.taskId;if(pe){const q=J=>{const Se=this._responseHandlers.get(P);Se?Se(J):this._onerror(new Error(`Response handler missing for side-channeled request ${P}`))};this._requestResolvers.set(P,q),this._enqueueTaskMessage(pe,{type:"request",message:z,timestamp:Date.now()}).catch(J=>{this._cleanupTimeout(P),p(J)})}else this._transport.send(z,{relatedRequestId:n,resumptionToken:a,onresumptiontoken:o}).catch(q=>{this._cleanupTimeout(P),p(q)})})}async getTask(e,t){return this.request({method:"tasks/get",params:e},Wt,t)}async getTaskResult(e,t,r){return this.request({method:"tasks/result",params:e},t,r)}async listTasks(e,t){return this.request({method:"tasks/list",params:e},Qt,t)}async cancelTask(e,t){return this.request({method:"tasks/cancel",params:e},rd,t)}async notification(e,t){if(!this._transport)throw new Error("Not connected");this.assertNotificationCapability(e.method);const r=t?.relatedTask?.taskId;if(r){const a={...e,jsonrpc:"2.0",params:{...e.params,_meta:{...e.params?._meta||{},[_e]:t.relatedTask}}};await this._enqueueTaskMessage(r,{type:"notification",message:a,timestamp:Date.now()});return}if((this._options?.debouncedNotificationMethods??[]).includes(e.method)&&!e.params&&!t?.relatedRequestId&&!t?.relatedTask){if(this._pendingDebouncedNotifications.has(e.method))return;this._pendingDebouncedNotifications.add(e.method),Promise.resolve().then(()=>{if(this._pendingDebouncedNotifications.delete(e.method),!this._transport)return;let a={...e,jsonrpc:"2.0"};t?.relatedTask&&(a={...a,params:{...a.params,_meta:{...a.params?._meta||{},[_e]:t.relatedTask}}}),this._transport?.send(a,t).catch(o=>this._onerror(o))});return}let n={...e,jsonrpc:"2.0"};t?.relatedTask&&(n={...n,params:{...n.params,_meta:{...n.params?._meta||{},[_e]:t.relatedTask}}}),await this._transport.send(n,t)}setRequestHandler(e,t){const r=zr(e);this.assertRequestHandlerCapability(r),this._requestHandlers.set(r,(n,a)=>{const o=Dr(e,n);return Promise.resolve(t(o,a))})}removeRequestHandler(e){this._requestHandlers.delete(e)}assertCanSetRequestHandler(e){if(this._requestHandlers.has(e))throw new Error(`A request handler for ${e} already exists, which would be overridden`)}setNotificationHandler(e,t){const r=zr(e);this._notificationHandlers.set(r,n=>{const a=Dr(e,n);return Promise.resolve(t(a))})}removeNotificationHandler(e){this._notificationHandlers.delete(e)}_cleanupTaskProgressHandler(e){const t=this._taskProgressTokens.get(e);t!==void 0&&(this._progressHandlers.delete(t),this._taskProgressTokens.delete(e))}async _enqueueTaskMessage(e,t,r){if(!this._taskStore||!this._taskMessageQueue)throw new Error("Cannot enqueue task message: taskStore and taskMessageQueue are not configured");const n=this._options?.maxTaskQueueSize;await this._taskMessageQueue.enqueue(e,t,r,n)}async _clearTaskQueue(e,t){if(this._taskMessageQueue){const r=await this._taskMessageQueue.dequeueAll(e,t);for(const n of r)if(n.type==="request"&&qr(n.message)){const a=n.message.id,o=this._requestResolvers.get(a);o?(o(new _(S.InternalError,"Task cancelled or completed")),this._requestResolvers.delete(a)):this._onerror(new Error(`Resolver missing for request ${a} during task ${e} cleanup`))}}}async _waitForTaskUpdate(e,t){let r=this._options?.defaultTaskPollInterval??1e3;try{const n=await this._taskStore?.getTask(e);n?.pollInterval&&(r=n.pollInterval)}catch{}return new Promise((n,a)=>{if(t.aborted){a(new _(S.InvalidRequest,"Request cancelled"));return}const o=setTimeout(n,r);t.addEventListener("abort",()=>{clearTimeout(o),a(new _(S.InvalidRequest,"Request cancelled"))},{once:!0})})}requestTaskStore(e,t){const r=this._taskStore;if(!r)throw new Error("No task store configured");return{createTask:async n=>{if(!e)throw new Error("No request provided");return await r.createTask(n,e.id,{method:e.method,params:e.params},t)},getTask:async n=>{const a=await r.getTask(n,t);if(!a)throw new _(S.InvalidParams,"Failed to retrieve task: Task not found");return a},storeTaskResult:async(n,a,o)=>{await r.storeTaskResult(n,a,o,t);const s=await r.getTask(n,t);if(s){const i=rt.parse({method:"notifications/tasks/status",params:s});await this.notification(i),ye(s.status)&&this._cleanupTaskProgressHandler(n)}},getTaskResult:n=>r.getTaskResult(n,t),updateTaskStatus:async(n,a,o)=>{const s=await r.getTask(n,t);if(!s)throw new _(S.InvalidParams,`Task "${n}" not found - it may have been cleaned up`);if(ye(s.status))throw new _(S.InvalidParams,`Cannot update task "${n}" from terminal status "${s.status}" to "${a}". Terminal states (completed, failed, cancelled) cannot transition to other states.`);await r.updateTaskStatus(n,a,o,t);const i=await r.getTask(n,t);if(i){const c=rt.parse({method:"notifications/tasks/status",params:i});await this.notification(c),ye(i.status)&&this._cleanupTaskProgressHandler(n)}},listTasks:n=>r.listTasks(n,t)}}};function Hr(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}function Kn(e,t){const r={...e};for(const n in t){const a=n,o=t[a];if(o===void 0)continue;const s=r[a];Hr(s)&&Hr(o)?r[a]={...s,...o}:r[a]=o}return r}var _u=class{compile(e){throw new Error("[WebMCP] Ajv stub was invoked. This indicates the MCP SDK is bypassing PolyfillJsonSchemaValidator. Please report this as a bug.")}getSchema(e){}errorsText(e){return""}},wu=_u;function Su(){return new wu({strict:!1,validateFormats:!0,validateSchema:!1,allErrors:!0})}var bu=class{constructor(e){this._ajv=e??Su()}getValidator(e){const t="$id"in e&&typeof e.$id=="string"?this._ajv.getSchema(e.$id)??this._ajv.compile(e):this._ajv.compile(e);return r=>t(r)?{valid:!0,data:r,errorMessage:void 0}:{valid:!1,data:void 0,errorMessage:this._ajv.errorsText(t.errors)}}};function vu(e,t,r){if(!e)throw new Error(`${r} does not support task creation (required for ${t})`);switch(t){case"tools/call":if(!e.tools?.call)throw new Error(`${r} does not support task creation for tools/call (required for ${t})`);break}}function ku(e,t,r){if(!e)throw new Error(`${r} does not support task creation (required for ${t})`);switch(t){case"sampling/createMessage":if(!e.sampling?.createMessage)throw new Error(`${r} does not support task creation for sampling/createMessage (required for ${t})`);break;case"elicitation/create":if(!e.elicitation?.create)throw new Error(`${r} does not support task creation for elicitation/create (required for ${t})`);break}}var Tu=class{constructor(e){this._server=e}requestStream(e,t,r){return this._server.requestStream(e,t,r)}async getTask(e,t){return this._server.getTask({taskId:e},t)}async getTaskResult(e,t,r){return this._server.getTaskResult({taskId:e},t,r)}async listTasks(e,t){return this._server.listTasks(e?{cursor:e}:void 0,t)}async cancelTask(e,t){return this._server.cancelTask({taskId:e},t)}},$u=class extends yu{constructor(e,t){super(t),this._serverInfo=e,this._loggingLevels=new Map,this.LOG_LEVEL_SEVERITY=new Map(it.options.map((r,n)=>[r,n])),this.isMessageIgnored=(r,n)=>{const a=this._loggingLevels.get(n);return a?this.LOG_LEVEL_SEVERITY.get(r)<this.LOG_LEVEL_SEVERITY.get(a):!1},this._capabilities=t?.capabilities??{},this._instructions=t?.instructions,this._jsonSchemaValidator=t?.jsonSchemaValidator??new bu,this.setRequestHandler(qn,r=>this._oninitialize(r)),this.setNotificationHandler(zn,()=>this.oninitialized?.()),this._capabilities.logging&&this.setRequestHandler(Jn,async(r,n)=>{const a=n.sessionId||n.requestInfo?.headers["mcp-session-id"]||void 0,{level:o}=r.params,s=it.safeParse(o);return s.success&&this._loggingLevels.set(a,s.data),{}})}get experimental(){return this._experimental||(this._experimental={tasks:new Tu(this)}),this._experimental}registerCapabilities(e){if(this.transport)throw new Error("Cannot register capabilities after connecting to transport");this._capabilities=Kn(this._capabilities,e)}setRequestHandler(e,t){const r=Ne(e)?.method;if(!r)throw new Error("Schema is missing a method literal");let n;if(de(r)){const a=r;n=a._zod?.def?.value??a.value}else{const a=r;n=a._def?.value??a.value}if(typeof n!="string")throw new Error("Schema method literal must be a string");if(n==="tools/call"){const a=async(o,s)=>{const i=xe(st,o);if(!i.success){const P=i.error instanceof Error?i.error.message:String(i.error);throw new _(S.InvalidParams,`Invalid tools/call request: ${P}`)}const{params:c}=i.data,p=await Promise.resolve(t(o,s));if(c.task){const P=xe(ut,p);if(!P.success){const z=P.error instanceof Error?P.error.message:String(P.error);throw new _(S.InvalidParams,`Invalid task creation result: ${z}`)}return P.data}const d=xe(or,p);if(!d.success){const P=d.error instanceof Error?d.error.message:String(d.error);throw new _(S.InvalidParams,`Invalid tools/call result: ${P}`)}return d.data};return super.setRequestHandler(e,a)}return super.setRequestHandler(e,t)}assertCapabilityForMethod(e){switch(e){case"sampling/createMessage":if(!this._clientCapabilities?.sampling)throw new Error(`Client does not support sampling (required for ${e})`);break;case"elicitation/create":if(!this._clientCapabilities?.elicitation)throw new Error(`Client does not support elicitation (required for ${e})`);break;case"roots/list":if(!this._clientCapabilities?.roots)throw new Error(`Client does not support listing roots (required for ${e})`);break}}assertNotificationCapability(e){switch(e){case"notifications/message":if(!this._capabilities.logging)throw new Error(`Server does not support logging (required for ${e})`);break;case"notifications/resources/updated":case"notifications/resources/list_changed":if(!this._capabilities.resources)throw new Error(`Server does not support notifying about resources (required for ${e})`);break;case"notifications/tools/list_changed":if(!this._capabilities.tools)throw new Error(`Server does not support notifying of tool list changes (required for ${e})`);break;case"notifications/prompts/list_changed":if(!this._capabilities.prompts)throw new Error(`Server does not support notifying of prompt list changes (required for ${e})`);break;case"notifications/elicitation/complete":if(!this._clientCapabilities?.elicitation?.url)throw new Error(`Client does not support URL elicitation (required for ${e})`);break}}assertRequestHandlerCapability(e){if(this._capabilities)switch(e){case"completion/complete":if(!this._capabilities.completions)throw new Error(`Server does not support completions (required for ${e})`);break;case"logging/setLevel":if(!this._capabilities.logging)throw new Error(`Server does not support logging (required for ${e})`);break;case"prompts/get":case"prompts/list":if(!this._capabilities.prompts)throw new Error(`Server does not support prompts (required for ${e})`);break;case"resources/list":case"resources/templates/list":case"resources/read":if(!this._capabilities.resources)throw new Error(`Server does not support resources (required for ${e})`);break;case"tools/call":case"tools/list":if(!this._capabilities.tools)throw new Error(`Server does not support tools (required for ${e})`);break;case"tasks/get":case"tasks/list":case"tasks/result":case"tasks/cancel":if(!this._capabilities.tasks)throw new Error(`Server does not support tasks capability (required for ${e})`);break}}assertTaskCapability(e){ku(this._clientCapabilities?.tasks?.requests,e,"Client")}assertTaskHandlerCapability(e){this._capabilities&&vu(this._capabilities.tasks?.requests,e,"Server")}async _oninitialize(e){const t=e.params.protocolVersion;return this._clientCapabilities=e.params.capabilities,this._clientVersion=e.params.clientInfo,{protocolVersion:Nc.includes(t)?t:xn,capabilities:this.getCapabilities(),serverInfo:this._serverInfo,...this._instructions&&{instructions:this._instructions}}}getClientCapabilities(){return this._clientCapabilities}getClientVersion(){return this._clientVersion}getCapabilities(){return this._capabilities}async ping(){return this.request({method:"ping"},Lt)}async createMessage(e,t){if((e.tools||e.toolChoice)&&!this._clientCapabilities?.sampling?.tools)throw new Error("Client does not support sampling tools capability.");if(e.messages.length>0){const r=e.messages[e.messages.length-1],n=Array.isArray(r.content)?r.content:[r.content],a=n.some(c=>c.type==="tool_result"),o=e.messages.length>1?e.messages[e.messages.length-2]:void 0,s=o?Array.isArray(o.content)?o.content:[o.content]:[],i=s.some(c=>c.type==="tool_use");if(a){if(n.some(c=>c.type!=="tool_result"))throw new Error("The last message must contain only tool_result content if any is present");if(!i)throw new Error("tool_result blocks are not matching any tool_use from the previous message")}if(i){const c=new Set(s.filter(d=>d.type==="tool_use").map(d=>d.id)),p=new Set(n.filter(d=>d.type==="tool_result").map(d=>d.toolUseId));if(c.size!==p.size||![...c].every(d=>p.has(d)))throw new Error("ids of tool_result blocks and tool_use blocks from previous message do not match")}}return e.tools?this.request({method:"sampling/createMessage",params:e},Bn,t):this.request({method:"sampling/createMessage",params:e},Vn,t)}async elicitInput(e,t){switch(e.mode??"form"){case"url":{if(!this._clientCapabilities?.elicitation?.url)throw new Error("Client does not support url elicitation.");const r=e;return this.request({method:"elicitation/create",params:r},Mt,t)}case"form":{if(!this._clientCapabilities?.elicitation?.form)throw new Error("Client does not support form elicitation.");const r=e.mode==="form"?e:{...e,mode:"form"},n=await this.request({method:"elicitation/create",params:r},Mt,t);if(n.action==="accept"&&n.content&&r.requestedSchema)try{const a=this._jsonSchemaValidator.getValidator(r.requestedSchema)(n.content);if(!a.valid)throw new _(S.InvalidParams,`Elicitation response content does not match requested schema: ${a.errorMessage}`)}catch(a){throw a instanceof _?a:new _(S.InternalError,`Error validating elicitation response: ${a instanceof Error?a.message:String(a)}`)}return n}}}createElicitationCompletionNotifier(e,t){if(!this._clientCapabilities?.elicitation?.url)throw new Error("Client does not support URL elicitation (required for notifications/elicitation/complete)");return()=>this.notification({method:"notifications/elicitation/complete",params:{elicitationId:e}},t)}async listRoots(e,t){return this.request({method:"roots/list",params:e},Wn,t)}async sendLoggingMessage(e,t){if(this._capabilities.logging&&!this.isMessageIgnored(e.level,t))return this.notification({method:"notifications/message",params:e})}async sendResourceUpdated(e){return this.notification({method:"notifications/resources/updated",params:e})}async sendResourceListChanged(){return this.notification({method:"notifications/resources/list_changed"})}async sendToolListChanged(){return this.notification({method:"notifications/tools/list_changed"})}async sendPromptListChanged(){return this.notification({method:"notifications/prompts/list_changed"})}};const Qn=Symbol.for("mcp.completable");function Ur(e){return!!e&&typeof e=="object"&&Qn in e}function Ru(e){return e[Qn]?.complete}var Lr;(function(e){e.Completable="McpCompletable"})(Lr||(Lr={}));const Pu=/^[A-Za-z0-9._-]{1,128}$/;function Iu(e){const t=[];if(e.length===0)return{isValid:!1,warnings:["Tool name cannot be empty"]};if(e.length>128)return{isValid:!1,warnings:[`Tool name exceeds maximum length of 128 characters (current: ${e.length})`]};if(e.includes(" ")&&t.push("Tool name contains spaces, which may cause parsing issues"),e.includes(",")&&t.push("Tool name contains commas, which may cause parsing issues"),(e.startsWith("-")||e.endsWith("-"))&&t.push("Tool name starts or ends with a dash, which may cause parsing issues in some contexts"),(e.startsWith(".")||e.endsWith("."))&&t.push("Tool name starts or ends with a dot, which may cause parsing issues in some contexts"),!Pu.test(e)){const r=e.split("").filter(n=>!/[A-Za-z0-9._-]/.test(n)).filter((n,a,o)=>o.indexOf(n)===a);return t.push(`Tool name contains invalid characters: ${r.map(n=>`"${n}"`).join(", ")}`,"Allowed characters are: A-Z, a-z, 0-9, underscore (_), dash (-), and dot (.)"),{isValid:!1,warnings:t}}return{isValid:!0,warnings:t}}function Eu(e,t){if(t.length>0){console.warn(`Tool name validation warning for "${e}":`);for(const r of t)console.warn(`  - ${r}`);console.warn("Tool registration will proceed, but this may cause compatibility issues."),console.warn("Consider updating the tool name to conform to the MCP tool naming standard."),console.warn("See SEP: Specify Format for Tool Names (https://github.com/modelcontextprotocol/modelcontextprotocol/issues/986) for more details.")}}function Fr(e){const t=Iu(e);return Eu(e,t.warnings),t.isValid}var Ou=class{constructor(e){this._mcpServer=e}registerToolTask(e,t,r){const n={taskSupport:"required",...t.execution};if(n.taskSupport==="forbidden")throw new Error(`Cannot register task-based tool '${e}' with taskSupport 'forbidden'. Use registerTool() instead.`);return this._mcpServer._createRegisteredTool(e,t.title,t.description,t.inputSchema,t.outputSchema,t.annotations,n,t._meta,r)}},xu=class{constructor(e,t){this._registeredResources={},this._registeredResourceTemplates={},this._registeredTools={},this._registeredPrompts={},this._toolHandlersInitialized=!1,this._completionHandlerInitialized=!1,this._resourceHandlersInitialized=!1,this._promptHandlersInitialized=!1,this.server=new $u(e,t)}get experimental(){return this._experimental||(this._experimental={tasks:new Ou(this)}),this._experimental}async connect(e){return await this.server.connect(e)}async close(){await this.server.close()}setToolRequestHandlers(){this._toolHandlersInitialized||(this.server.assertCanSetRequestHandler(me(ot)),this.server.assertCanSetRequestHandler(me(st)),this.server.registerCapabilities({tools:{listChanged:!0}}),this.server.setRequestHandler(ot,()=>({tools:Object.entries(this._registeredTools).filter(([,e])=>e.enabled).map(([e,t])=>{const r={name:e,title:t.title,description:t.description,inputSchema:(()=>{const n=ve(t.inputSchema);return n?Zt(n,{strictUnions:!0,pipeStrategy:"input"}):Cu})(),annotations:t.annotations,execution:t.execution,_meta:t._meta};if(t.outputSchema){const n=ve(t.outputSchema);n&&(r.outputSchema=Zt(n,{strictUnions:!0,pipeStrategy:"output"}))}return r})})),this.server.setRequestHandler(st,async(e,t)=>{try{const r=this._registeredTools[e.params.name];if(!r)throw new _(S.InvalidParams,`Tool ${e.params.name} not found`);if(!r.enabled)throw new _(S.InvalidParams,`Tool ${e.params.name} disabled`);const n=!!e.params.task,a=r.execution?.taskSupport,o="createTask"in r.handler;if((a==="required"||a==="optional")&&!o)throw new _(S.InternalError,`Tool ${e.params.name} has taskSupport '${a}' but was not registered with registerToolTask`);if(a==="required"&&!n)throw new _(S.MethodNotFound,`Tool ${e.params.name} requires task augmentation (taskSupport: 'required')`);if(a==="optional"&&!n&&o)return await this.handleAutomaticTaskPolling(r,e,t);const s=await this.validateToolInput(r,e.params.arguments,e.params.name),i=await this.executeToolHandler(r,s,t);return n||await this.validateToolOutput(r,i,e.params.name),i}catch(r){if(r instanceof _&&r.code===S.UrlElicitationRequired)throw r;return this.createToolError(r instanceof Error?r.message:String(r))}}),this._toolHandlersInitialized=!0)}createToolError(e){return{content:[{type:"text",text:e}],isError:!0}}async validateToolInput(e,t,r){if(!e.inputSchema)return;const n=await Ce(ve(e.inputSchema)??e.inputSchema,t);if(!n.success){const a=Ae("error"in n?n.error:"Unknown error");throw new _(S.InvalidParams,`Input validation error: Invalid arguments for tool ${r}: ${a}`)}return n.data}async validateToolOutput(e,t,r){if(!e.outputSchema||!("content"in t)||t.isError)return;if(!t.structuredContent)throw new _(S.InvalidParams,`Output validation error: Tool ${r} has an output schema but no structured content was provided`);const n=await Ce(ve(e.outputSchema),t.structuredContent);if(!n.success){const a=Ae("error"in n?n.error:"Unknown error");throw new _(S.InvalidParams,`Output validation error: Invalid structured content for tool ${r}: ${a}`)}}async executeToolHandler(e,t,r){const n=e.handler;if("createTask"in n){if(!r.taskStore)throw new Error("No task store provided.");const a={...r,taskStore:r.taskStore};if(e.inputSchema){const o=n;return await Promise.resolve(o.createTask(t,a))}else{const o=n;return await Promise.resolve(o.createTask(a))}}if(e.inputSchema){const a=n;return await Promise.resolve(a(t,r))}else{const a=n;return await Promise.resolve(a(r))}}async handleAutomaticTaskPolling(e,t,r){if(!r.taskStore)throw new Error("No task store provided for task-capable tool.");const n=await this.validateToolInput(e,t.params.arguments,t.params.name),a=e.handler,o={...r,taskStore:r.taskStore},s=n?await Promise.resolve(a.createTask(n,o)):await Promise.resolve(a.createTask(o)),i=s.task.taskId;let c=s.task;const p=c.pollInterval??5e3;for(;c.status!=="completed"&&c.status!=="failed"&&c.status!=="cancelled";){await new Promise(P=>setTimeout(P,p));const d=await r.taskStore.getTask(i);if(!d)throw new _(S.InternalError,`Task ${i} not found during polling`);c=d}return await r.taskStore.getTaskResult(i)}setCompletionRequestHandler(){this._completionHandlerInitialized||(this.server.assertCanSetRequestHandler(me(Nt)),this.server.registerCapabilities({completions:{}}),this.server.setRequestHandler(Nt,async e=>{switch(e.params.ref.type){case"ref/prompt":return lu(e),this.handlePromptCompletion(e,e.params.ref);case"ref/resource":return cu(e),this.handleResourceCompletion(e,e.params.ref);default:throw new _(S.InvalidParams,`Invalid completion reference: ${e.params.ref}`)}}),this._completionHandlerInitialized=!0)}async handlePromptCompletion(e,t){const r=this._registeredPrompts[t.name];if(!r)throw new _(S.InvalidParams,`Prompt ${t.name} not found`);if(!r.enabled)throw new _(S.InvalidParams,`Prompt ${t.name} disabled`);if(!r.argsSchema)return Ee;const n=Ne(r.argsSchema)?.[e.params.argument.name];if(!Ur(n))return Ee;const a=Ru(n);return a?Vr(await a(e.params.argument.value,e.params.context)):Ee}async handleResourceCompletion(e,t){const r=Object.values(this._registeredResourceTemplates).find(a=>a.resourceTemplate.uriTemplate.toString()===t.uri);if(!r){if(this._registeredResources[t.uri])return Ee;throw new _(S.InvalidParams,`Resource template ${e.params.ref.uri} not found`)}const n=r.resourceTemplate.completeCallback(e.params.argument.name);return n?Vr(await n(e.params.argument.value,e.params.context)):Ee}setResourceRequestHandlers(){this._resourceHandlersInitialized||(this.server.assertCanSetRequestHandler(me(xt)),this.server.assertCanSetRequestHandler(me(Ct)),this.server.assertCanSetRequestHandler(me(At)),this.server.registerCapabilities({resources:{listChanged:!0}}),this.server.setRequestHandler(xt,async(e,t)=>{const r=Object.entries(this._registeredResources).filter(([a,o])=>o.enabled).map(([a,o])=>({uri:a,name:o.name,...o.metadata})),n=[];for(const a of Object.values(this._registeredResourceTemplates)){if(!a.resourceTemplate.listCallback)continue;const o=await a.resourceTemplate.listCallback(t);for(const s of o.resources)n.push({...a.metadata,...s})}return{resources:[...r,...n]}}),this.server.setRequestHandler(Ct,async()=>({resourceTemplates:Object.entries(this._registeredResourceTemplates).map(([e,t])=>({name:e,uriTemplate:t.resourceTemplate.uriTemplate.toString(),...t.metadata}))})),this.server.setRequestHandler(At,async(e,t)=>{const r=new URL(e.params.uri),n=this._registeredResources[r.toString()];if(n){if(!n.enabled)throw new _(S.InvalidParams,`Resource ${r} disabled`);return n.readCallback(r,t)}for(const a of Object.values(this._registeredResourceTemplates)){const o=a.resourceTemplate.uriTemplate.match(r.toString());if(o)return a.readCallback(r,o,t)}throw new _(S.InvalidParams,`Resource ${r} not found`)}),this._resourceHandlersInitialized=!0)}setPromptRequestHandlers(){this._promptHandlersInitialized||(this.server.assertCanSetRequestHandler(me(nt)),this.server.assertCanSetRequestHandler(me(at)),this.server.registerCapabilities({prompts:{listChanged:!0}}),this.server.setRequestHandler(nt,()=>({prompts:Object.entries(this._registeredPrompts).filter(([,e])=>e.enabled).map(([e,t])=>({name:e,title:t.title,description:t.description,arguments:t.argsSchema?Mu(t.argsSchema):void 0}))})),this.server.setRequestHandler(at,async(e,t)=>{const r=this._registeredPrompts[e.params.name];if(!r)throw new _(S.InvalidParams,`Prompt ${e.params.name} not found`);if(!r.enabled)throw new _(S.InvalidParams,`Prompt ${e.params.name} disabled`);if(r.argsSchema){const n=await Ce(ve(r.argsSchema),e.params.arguments);if(!n.success){const s=Ae("error"in n?n.error:"Unknown error");throw new _(S.InvalidParams,`Invalid arguments for prompt ${e.params.name}: ${s}`)}const a=n.data,o=r.callback;return await Promise.resolve(o(a,t))}else{const n=r.callback;return await Promise.resolve(n(t))}}),this._promptHandlersInitialized=!0)}resource(e,t,...r){let n;typeof r[0]=="object"&&(n=r.shift());const a=r[0];if(typeof t=="string"){if(this._registeredResources[t])throw new Error(`Resource ${t} is already registered`);const o=this._createRegisteredResource(e,void 0,t,n,a);return this.setResourceRequestHandlers(),this.sendResourceListChanged(),o}else{if(this._registeredResourceTemplates[e])throw new Error(`Resource template ${e} is already registered`);const o=this._createRegisteredResourceTemplate(e,void 0,t,n,a);return this.setResourceRequestHandlers(),this.sendResourceListChanged(),o}}registerResource(e,t,r,n){if(typeof t=="string"){if(this._registeredResources[t])throw new Error(`Resource ${t} is already registered`);const a=this._createRegisteredResource(e,r.title,t,r,n);return this.setResourceRequestHandlers(),this.sendResourceListChanged(),a}else{if(this._registeredResourceTemplates[e])throw new Error(`Resource template ${e} is already registered`);const a=this._createRegisteredResourceTemplate(e,r.title,t,r,n);return this.setResourceRequestHandlers(),this.sendResourceListChanged(),a}}_createRegisteredResource(e,t,r,n,a){const o={name:e,title:t,metadata:n,readCallback:a,enabled:!0,disable:()=>o.update({enabled:!1}),enable:()=>o.update({enabled:!0}),remove:()=>o.update({uri:null}),update:s=>{typeof s.uri<"u"&&s.uri!==r&&(delete this._registeredResources[r],s.uri&&(this._registeredResources[s.uri]=o)),typeof s.name<"u"&&(o.name=s.name),typeof s.title<"u"&&(o.title=s.title),typeof s.metadata<"u"&&(o.metadata=s.metadata),typeof s.callback<"u"&&(o.readCallback=s.callback),typeof s.enabled<"u"&&(o.enabled=s.enabled),this.sendResourceListChanged()}};return this._registeredResources[r]=o,o}_createRegisteredResourceTemplate(e,t,r,n,a){const o={resourceTemplate:r,title:t,metadata:n,readCallback:a,enabled:!0,disable:()=>o.update({enabled:!1}),enable:()=>o.update({enabled:!0}),remove:()=>o.update({name:null}),update:i=>{typeof i.name<"u"&&i.name!==e&&(delete this._registeredResourceTemplates[e],i.name&&(this._registeredResourceTemplates[i.name]=o)),typeof i.title<"u"&&(o.title=i.title),typeof i.template<"u"&&(o.resourceTemplate=i.template),typeof i.metadata<"u"&&(o.metadata=i.metadata),typeof i.callback<"u"&&(o.readCallback=i.callback),typeof i.enabled<"u"&&(o.enabled=i.enabled),this.sendResourceListChanged()}};this._registeredResourceTemplates[e]=o;const s=r.uriTemplate.variableNames;return Array.isArray(s)&&s.some(i=>!!r.completeCallback(i))&&this.setCompletionRequestHandler(),o}_createRegisteredPrompt(e,t,r,n,a){const o={title:t,description:r,argsSchema:n===void 0?void 0:ke(n),callback:a,enabled:!0,disable:()=>o.update({enabled:!1}),enable:()=>o.update({enabled:!0}),remove:()=>o.update({name:null}),update:s=>{typeof s.name<"u"&&s.name!==e&&(delete this._registeredPrompts[e],s.name&&(this._registeredPrompts[s.name]=o)),typeof s.title<"u"&&(o.title=s.title),typeof s.description<"u"&&(o.description=s.description),typeof s.argsSchema<"u"&&(o.argsSchema=ke(s.argsSchema)),typeof s.callback<"u"&&(o.callback=s.callback),typeof s.enabled<"u"&&(o.enabled=s.enabled),this.sendPromptListChanged()}};return this._registeredPrompts[e]=o,n&&Object.values(n).some(s=>Ur(s instanceof zt?s._def?.innerType:s))&&this.setCompletionRequestHandler(),o}_createRegisteredTool(e,t,r,n,a,o,s,i,c){Fr(e);const p={title:t,description:r,inputSchema:Jr(n),outputSchema:Jr(a),annotations:o,execution:s,_meta:i,handler:c,enabled:!0,disable:()=>p.update({enabled:!1}),enable:()=>p.update({enabled:!0}),remove:()=>p.update({name:null}),update:d=>{typeof d.name<"u"&&d.name!==e&&(typeof d.name=="string"&&Fr(d.name),delete this._registeredTools[e],d.name&&(this._registeredTools[d.name]=p)),typeof d.title<"u"&&(p.title=d.title),typeof d.description<"u"&&(p.description=d.description),typeof d.paramsSchema<"u"&&(p.inputSchema=ke(d.paramsSchema)),typeof d.outputSchema<"u"&&(p.outputSchema=ke(d.outputSchema)),typeof d.callback<"u"&&(p.handler=d.callback),typeof d.annotations<"u"&&(p.annotations=d.annotations),typeof d._meta<"u"&&(p._meta=d._meta),typeof d.enabled<"u"&&(p.enabled=d.enabled),this.sendToolListChanged()}};return this._registeredTools[e]=p,this.setToolRequestHandlers(),this.sendToolListChanged(),p}tool(e,...t){if(this._registeredTools[e])throw new Error(`Tool ${e} is already registered`);let r,n,a,o;if(typeof t[0]=="string"&&(r=t.shift()),t.length>1){const i=t[0];jt(i)?(n=t.shift(),t.length>1&&typeof t[0]=="object"&&t[0]!==null&&!jt(t[0])&&(o=t.shift())):typeof i=="object"&&i!==null&&(o=t.shift())}const s=t[0];return this._createRegisteredTool(e,void 0,r,n,a,o,{taskSupport:"forbidden"},void 0,s)}registerTool(e,t,r){if(this._registeredTools[e])throw new Error(`Tool ${e} is already registered`);const{title:n,description:a,inputSchema:o,outputSchema:s,annotations:i,_meta:c}=t;return this._createRegisteredTool(e,n,a,o,s,i,{taskSupport:"forbidden"},c,r)}prompt(e,...t){if(this._registeredPrompts[e])throw new Error(`Prompt ${e} is already registered`);let r;typeof t[0]=="string"&&(r=t.shift());let n;t.length>1&&(n=t.shift());const a=t[0],o=this._createRegisteredPrompt(e,void 0,r,n,a);return this.setPromptRequestHandlers(),this.sendPromptListChanged(),o}registerPrompt(e,t,r){if(this._registeredPrompts[e])throw new Error(`Prompt ${e} is already registered`);const{title:n,description:a,argsSchema:o}=t,s=this._createRegisteredPrompt(e,n,a,o,r);return this.setPromptRequestHandlers(),this.sendPromptListChanged(),s}isConnected(){return this.server.transport!==void 0}async sendLoggingMessage(e,t){return this.server.sendLoggingMessage(e,t)}sendResourceListChanged(){this.isConnected()&&this.server.sendResourceListChanged()}sendToolListChanged(){this.isConnected()&&this.server.sendToolListChanged()}sendPromptListChanged(){this.isConnected()&&this.server.sendPromptListChanged()}};const Cu={type:"object",properties:{}};function Yn(e){return e!==null&&typeof e=="object"&&"parse"in e&&typeof e.parse=="function"&&"safeParse"in e&&typeof e.safeParse=="function"}function Au(e){return"_def"in e||"_zod"in e||Yn(e)}function jt(e){return typeof e!="object"||e===null||Au(e)?!1:Object.keys(e).length===0?!0:Object.values(e).some(Yn)}function Jr(e){if(e)return jt(e)?ke(e):e}function Mu(e){const t=Ne(e);return t?Object.entries(t).map(([r,n])=>({name:r,description:Ac(n),required:!Mc(n)})):[]}function me(e){const t=Ne(e)?.method;if(!t)throw new Error("Schema is missing a method literal");const r=On(t);if(typeof r=="string")return r;throw new Error("Schema method literal must be a string")}function Vr(e){return{completion:{values:e.slice(0,100),total:e.length,hasMore:e.length>100}}}const Ee={completion:{values:[],hasMore:!1}};var Nu=class{getValidator(e){return t=>{if(!K(t))return{valid:!1,data:void 0,errorMessage:"expected object arguments"};const r=Pn(t,e);return r?{valid:!1,data:void 0,errorMessage:r.message}:{valid:!0,data:t,errorMessage:void 0}}}};const Ye={type:"object",properties:{}},Zu=1e4;function Br(e){return e?.signal?e:{...e,signal:AbortSignal.timeout(Zu)}}var ju=class extends xu{native;_promptSchemas=new Map;_jsonValidator;_publicMethodsBound=!1;constructor(e,t){const r=new Nu,n={capabilities:Kn(t?.capabilities||{},{tools:{listChanged:!0},resources:{listChanged:!0},prompts:{listChanged:!0}}),jsonSchemaValidator:t?.jsonSchemaValidator??r};super(e,n),this._jsonValidator=r,this.native=t?.native,this.bindPublicApiMethods()}bindPublicApiMethods(){this._publicMethodsBound||(this.registerTool=this.registerTool.bind(this),this.unregisterTool=this.unregisterTool.bind(this),this.provideContext=this.provideContext.bind(this),this.clearContext=this.clearContext.bind(this),this.listTools=this.listTools.bind(this),this.callTool=this.callTool.bind(this),this.executeTool=this.executeTool.bind(this),this.registerResource=this.registerResource.bind(this),this.listResources=this.listResources.bind(this),this.readResource=this.readResource.bind(this),this.registerPrompt=this.registerPrompt.bind(this),this.listPrompts=this.listPrompts.bind(this),this.getPrompt=this.getPrompt.bind(this),this.createMessage=this.createMessage.bind(this),this.elicitInput=this.elicitInput.bind(this),this._publicMethodsBound=!0)}get _parentTools(){return this._registeredTools}get _parentResources(){return this._registeredResources}get _parentPrompts(){return this._registeredPrompts}toTransportSchema(e){if(!e||typeof e!="object")return Ye;const t=ve(e);return t?Zt(t,{strictUnions:!0,pipeStrategy:"input"}):e}isZodSchema(e){if(!e||typeof e!="object")return!1;const t=e;return"_zod"in t||"_def"in t}getNativeToolsApi(){if(!this.native)return;const e=this.native;if(!(typeof e.listTools!="function"||typeof e.callTool!="function"))return e}registerToolInServer(e){const t=e.inputSchema??Ye;return super.registerTool(e.name,{description:e.description,inputSchema:t,...e.outputSchema?{outputSchema:e.outputSchema}:{},...e.annotations?{annotations:e.annotations}:{}},async r=>e.execute(r,{requestUserInteraction:async n=>n()})),{unregister:()=>this.unregisterTool(e.name)}}backfillTools(e,t){let r=0;for(const n of e){if(!n?.name||this._parentTools[n.name])continue;const a={name:n.name,description:n.description??"",inputSchema:n.inputSchema??Ye,execute:async o=>t(n.name,o)};n.outputSchema&&(a.outputSchema=n.outputSchema),n.annotations&&(a.annotations=n.annotations),this.registerToolInServer(a),r++}return r}registerTool(e){this.native&&this.native.registerTool(e);try{return this.registerToolInServer(e)}catch(t){if(this.native)try{this.native.unregisterTool(e.name)}catch(r){console.error("[BrowserMcpServer] Rollback of native tool registration failed:",r)}throw t}}syncNativeTools(){const e=this.getNativeToolsApi();if(!e)return 0;const t=e.callTool.bind(e);return this.backfillTools(e.listTools(),async(r,n)=>t({name:r,arguments:n}))}unregisterTool(e){this._parentTools[e]?.remove(),this.native&&this.native.unregisterTool(e)}registerResource(e){const t=super.registerResource(e.name,e.uri,{...e.description!==void 0&&{description:e.description},...e.mimeType!==void 0&&{mimeType:e.mimeType}},async r=>({contents:(await e.read(r)).contents}));return{unregister:()=>t.remove()}}registerPrompt(e){e.argsSchema&&this._promptSchemas.set(e.name,e.argsSchema);const t=super.registerPrompt(e.name,{...e.description!==void 0&&{description:e.description}},async r=>({messages:(await e.get(r)).messages}));return{unregister:()=>{this._promptSchemas.delete(e.name),t.remove()}}}provideContext(e){for(const t of Object.values(this._parentTools))t.remove();this.native&&this.native.clearContext();for(const t of e?.tools??[])this.registerTool(t)}clearContext(){for(const e of Object.values(this._parentTools))e.remove();this.native&&this.native.clearContext()}listResources(){return Object.entries(this._parentResources).filter(([,e])=>e.enabled).map(([e,t])=>({uri:e,name:t.name,...t.metadata}))}async readResource(e){const t=this._parentResources[e];if(!t)throw new Error(`Resource not found: ${e}`);return t.readCallback(new URL(e),{})}listPrompts(){return Object.entries(this._parentPrompts).filter(([,e])=>e.enabled).map(([e,t])=>{const r=this._promptSchemas.get(e);return{name:e,...t.description!==void 0&&{description:t.description},...r?.properties?{arguments:Object.entries(r.properties).map(([n,a])=>({name:n,...typeof a=="object"&&a!==null&&"description"in a?{description:a.description}:{},...r.required?.includes(n)?{required:!0}:{}}))}:{}}})}async getPrompt(e,t={}){const r=this._parentPrompts[e];if(!r)throw new Error(`Prompt not found: ${e}`);const n=this._promptSchemas.get(e);if(n){const a=this._jsonValidator.getValidator(n)(t);if(!a.valid)throw new Error(`Invalid arguments for prompt ${e}: ${a.errorMessage}`)}return r.callback(t,{})}listTools(){return Object.entries(this._parentTools).filter(([,e])=>e.enabled).map(([e,t])=>{const r={name:e,description:t.description??"",inputSchema:this.toTransportSchema(t.inputSchema??Ye)};return t.outputSchema&&(r.outputSchema=this.toTransportSchema(t.outputSchema)),t.annotations&&(r.annotations=t.annotations),r})}async validateToolInput(e,t,r){if(!e.inputSchema)return;if(this.isZodSchema(e.inputSchema)){const a=await Ce(e.inputSchema,t??{});if(!a.success)throw new Error(`Invalid arguments for tool ${r}: ${Ae(a.error)}`);return a.data}const n=this._jsonValidator.getValidator(e.inputSchema)(t??{});if(!n.valid)throw new Error(`Invalid arguments for tool ${r}: ${n.errorMessage}`);return n.data}async validateToolOutput(e,t,r){if(!e.outputSchema)return;const n=t;if(!("content"in n)||n.isError||!n.structuredContent)return;if(this.isZodSchema(e.outputSchema)){const o=await Ce(e.outputSchema,n.structuredContent);if(!o.success)throw new Error(`Output validation error: Invalid structured content for tool ${r}: ${Ae(o.error)}`);return}const a=this._jsonValidator.getValidator(e.outputSchema)(n.structuredContent);if(!a.valid)throw new Error(`Output validation error: Invalid structured content for tool ${r}: ${a.errorMessage}`)}async callTool(e){const t=this._parentTools[e.name];if(!t)throw new Error(`Tool not found: ${e.name}`);return t.handler(e.arguments??{},{})}async executeTool(e,t={}){return this.callTool({name:e,arguments:t})}async connect(e){return this.setToolRequestHandlers(),this.setResourceRequestHandlers(),this.setPromptRequestHandlers(),this.server.setRequestHandler(ot,()=>({tools:this.listTools()})),this.server.setRequestHandler(nt,()=>({prompts:this.listPrompts()})),this.server.setRequestHandler(at,async t=>{const r=this._parentPrompts[t.params.name];if(!r)throw new Error(`Prompt ${t.params.name} not found`);if(!r.enabled)throw new Error(`Prompt ${t.params.name} disabled`);const n=this._promptSchemas.get(t.params.name);if(n){const a=this._jsonValidator.getValidator(n)(t.params.arguments??{});if(!a.valid)throw new Error(`Invalid arguments for prompt ${t.params.name}: ${a.errorMessage}`);return r.callback(t.params.arguments,{})}return r.callback({},{})}),super.connect(e)}async createMessage(e,t){return this.server.createMessage(e,Br(t))}async elicitInput(e,t){return this.server.elicitInput(e,Br(t))}};(function(e){return e.START="start",e.STARTED="started",e.STOP="stop",e.STOPPED="stopped",e.PING="ping",e.PONG="pong",e.ERROR="error",e.LIST_TOOLS="list_tools",e.CALL_TOOL="call_tool",e.TOOL_LIST_UPDATED="tool_list_updated",e.TOOL_LIST_UPDATED_ACK="tool_list_updated_ack",e.PROCESS_DATA="process_data",e.SERVER_STARTED="server_started",e.SERVER_STOPPED="server_stopped",e.ERROR_FROM_NATIVE_HOST="error_from_native_host",e.CONNECT_NATIVE="connectNative",e.PING_NATIVE="ping_native",e.DISCONNECT_NATIVE="disconnect_native",e})({});var qu=class{_started=!1;_allowedOrigins;_channelId;_messageHandler;_clientOrigin;_serverReadyTimeout;_serverReadyRetryMs;onclose;onerror;onmessage;constructor(e){if(!e.allowedOrigins||e.allowedOrigins.length===0)throw Error("At least one allowed origin must be specified");this._allowedOrigins=e.allowedOrigins,this._channelId=e.channelId||"mcp-iframe",this._serverReadyRetryMs=e.serverReadyRetryMs??250}async start(){if(this._started)throw Error("Transport already started");this._messageHandler=e=>{if(!this._allowedOrigins.includes(e.origin)&&!this._allowedOrigins.includes("*")||e.data?.channel!==this._channelId||e.data?.type!=="mcp"||e.data?.direction!=="client-to-server")return;this._clientOrigin=e.origin;let t=e.data.payload;if(typeof t=="string"&&t==="mcp-check-ready"){this.broadcastServerReady();return}try{let r=Zn.parse(t);this.onmessage?.(r)}catch(r){this.onerror?.(Error(`Invalid message: ${r instanceof Error?r.message:String(r)}`))}},window.addEventListener("message",this._messageHandler),this._started=!0,this.broadcastServerReady()}broadcastServerReady(){window.parent&&window.parent!==window?(window.parent.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:"mcp-server-ready"},"*"),this.clearServerReadyRetry()):this.scheduleServerReadyRetry()}scheduleServerReadyRetry(){this._serverReadyTimeout||=setTimeout(()=>{this._serverReadyTimeout=void 0,this._started&&this.broadcastServerReady()},this._serverReadyRetryMs)}clearServerReadyRetry(){this._serverReadyTimeout&&=(clearTimeout(this._serverReadyTimeout),void 0)}async send(e){if(!this._started)throw Error("Transport not started");if(!this._clientOrigin){console.warn("[IframeChildTransport] No client connected, message not sent");return}window.parent&&window.parent!==window?window.parent.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:e},this._clientOrigin):console.warn("[IframeChildTransport] Not running in an iframe, message not sent")}async close(){this._messageHandler&&window.removeEventListener("message",this._messageHandler),this._started=!1,this._clientOrigin&&window.parent&&window.parent!==window&&window.parent.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:"mcp-server-stopped"},"*"),this.clearServerReadyRetry(),this.onclose?.()}},zu=class{_started=!1;_allowedOrigins;_channelId;_messageHandler;_clientOrigin;_beforeUnloadHandler;_cleanupInterval;_pendingRequests=new Map;REQUEST_TIMEOUT_MS=3e5;onclose;onerror;onmessage;_resolveTargetOrigin(e){return e&&e!=="null"?e:"*"}constructor(e){if(!e.allowedOrigins||e.allowedOrigins.length===0)throw Error("At least one allowed origin must be specified");this._allowedOrigins=e.allowedOrigins,this._channelId=e.channelId||"mcp-default"}async start(){if(this._started)throw Error("Transport already started");this._messageHandler=e=>{if(!this._allowedOrigins.includes(e.origin)&&!this._allowedOrigins.includes("*")||e.data?.channel!==this._channelId||e.data?.type!=="mcp"||e.data?.direction!=="client-to-server")return;this._clientOrigin=e.origin;let t=e.data.payload;if(typeof t=="string"&&t==="mcp-check-ready"){window.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:"mcp-server-ready"},this._resolveTargetOrigin(this._clientOrigin));return}try{let r=Zn.parse(t);"method"in r&&"id"in r&&r.id!==void 0&&this._pendingRequests.set(r.id,{request:r,receivedAt:Date.now(),interruptedSent:!1}),this.onmessage?.(r)}catch(r){this.onerror?.(Error(`Invalid message: ${r instanceof Error?r.message:String(r)}`))}},window.addEventListener("message",this._messageHandler),this._started=!0,this._beforeUnloadHandler=()=>{this._handleBeforeUnload()},window.addEventListener("beforeunload",this._beforeUnloadHandler),this._cleanupInterval=setInterval(()=>{this._cleanupStaleRequests()},6e4),window.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:"mcp-server-ready"},"*")}async send(e){if(!this._started)throw Error("Transport not started");if(("result"in e||"error"in e)&&e.id!==void 0){if(this._pendingRequests.get(e.id)?.interruptedSent){console.debug(`[TabServerTransport] Suppressing response for ${e.id} - interrupted response already sent`),this._pendingRequests.delete(e.id);return}this._pendingRequests.delete(e.id)}let t=this._resolveTargetOrigin(this._clientOrigin);this._clientOrigin||console.debug("[TabServerTransport] Sending to unknown client origin (backwards compatibility mode)"),window.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:e},t)}_handleBeforeUnload(){let e=Array.from(this._pendingRequests.entries()).reverse();for(let[t,r]of e){r.interruptedSent=!0;let n={jsonrpc:"2.0",id:t,result:{content:[{type:"text",text:"Tool execution interrupted by page navigation"}],metadata:{navigationInterrupted:!0,originalMethod:"method"in r.request?r.request.method:"unknown",timestamp:Date.now()}}};try{window.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:n},this._resolveTargetOrigin(this._clientOrigin))}catch(a){console.error("[TabServerTransport] Failed to send beforeunload response:",a)}}this._pendingRequests.clear()}_cleanupStaleRequests(){let e=Date.now(),t=[];for(let[r,n]of this._pendingRequests)e-n.receivedAt>this.REQUEST_TIMEOUT_MS&&t.push(r);if(t.length>0){console.warn(`[TabServerTransport] Cleaning up ${t.length} stale requests`);for(let r of t)this._pendingRequests.delete(r)}}async close(){this._messageHandler&&window.removeEventListener("message",this._messageHandler),this._beforeUnloadHandler&&window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._cleanupInterval!==void 0&&clearInterval(this._cleanupInterval),this._pendingRequests.clear(),this._started=!1,window.postMessage({channel:this._channelId,type:"mcp",direction:"server-to-client",payload:"mcp-server-stopped"},"*"),this.onclose?.()}};let Me=null;function Du(){return typeof window<"u"&&typeof window.navigator<"u"}function Xn(e){try{Object.defineProperty(navigator,"modelContext",{configurable:!0,enumerable:!0,writable:!1,value:e})}catch{Object.defineProperty(Object.getPrototypeOf(navigator),"modelContext",{configurable:!0,enumerable:!0,get(){return e}})}navigator.modelContext!==e&&console.error("[WebModelContext] Failed to replace navigator.modelContext.","Descriptor:",Object.getOwnPropertyDescriptor(navigator,"modelContext"))}function Hu(e){if(window.parent!==window&&e?.iframeServer!==!1){const{allowedOrigins:n,...a}=typeof e?.iframeServer=="object"?e.iframeServer:{};return new qu({allowedOrigins:n??["*"],...a})}if(e?.tabServer===!1)throw new Error("tabServer transport is disabled and iframe transport was not selected");const{allowedOrigins:t,...r}=typeof e?.tabServer=="object"?e.tabServer:{};return new zu({allowedOrigins:t??["*"],...r})}function Uu(e){if(e)try{const t=JSON.parse(e);return!t||typeof t!="object"||Array.isArray(t)?void 0:t}catch(t){console.warn("[WebMCP] Failed to parse testing inputSchema JSON:",t);return}}function Lu(){const e=navigator.modelContextTesting;if(e){if(typeof e.getRegisteredTools=="function")return{testingShim:e,tools:e.getRegisteredTools()};if(typeof e.listTools=="function")return{testingShim:e,tools:e.listTools().map(t=>({name:t.name,description:t.description??"",inputSchema:Uu(t.inputSchema)??{type:"object",properties:{}}}))}}}function Fu(e){const t=Lu();if(!t)return 0;const{testingShim:r,tools:n}=t;return e.backfillTools(n,async(a,o)=>{const s=await r.executeTool(a,JSON.stringify(o??{}));if(s===null)return{content:[{type:"text",text:"Tool execution interrupted by navigation"}],isError:!0};let i;try{i=JSON.parse(s)}catch(c){throw new Error(`Failed to parse serialized tool response for ${a}: ${c instanceof Error?c.message:String(c)}`)}if(!i||typeof i!="object"||Array.isArray(i))throw new Error(`Invalid serialized tool response for ${a}`);return i})}function Ju(e){if(!Du()||Me)return;En({installTestingShim:e?.installTestingShim??"if-missing"});const t=navigator.modelContext;if(!t)throw new Error("navigator.modelContext is not available");const r=new ju({name:`${window.location.hostname||"localhost"}-webmcp`,version:"1.0.0"},{native:t});r.syncNativeTools(),Fu(r),Xn(r);const n=Hu(e?.transport);Me={native:t,server:r,transport:n},r.connect(n).catch(a=>{console.error("[WebModelContext] Failed to connect MCP transport:",a)})}function Bu(){if(!Me)return;const{native:e,server:t,transport:r}=Me;Me=null,t.close(),r.close(),Xn(e)}if(typeof window<"u"&&typeof document<"u"){const e=window.__webModelContextOptions;if(e?.autoInitialize!==!1)try{Ju(e)}catch(t){console.error("[WebModelContext] Auto-initialization failed:",t)}}export{Bu as cleanupWebModelContext,Ju as initializeWebModelContext};
