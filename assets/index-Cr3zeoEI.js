import{h as Xt}from"./main-DA1jwneq.js";import{g as qe,p as bo,c as Ze,_ as Eo,$ as So,Z as D,t as Yn,a as ei,o as To,s as Io}from"./types-DFQuOAyJ.js";var ti=Object.defineProperty,Ao=(t,e)=>{let r={};for(var n in t)ti(r,n,{get:t[n],enumerable:!0});return ti(r,Symbol.toStringTag,{value:"Module"}),r},xo=class{pageContent;metadata;id;constructor(t){this.pageContent=t.pageContent!==void 0?t.pageContent.toString():"",this.metadata=t.metadata??{},this.id=t.id}};function Ro(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}var Oo=class extends Error{output;constructor(t,e){super(t),this.output=e}},or,ri;function Co(){return ri||(ri=1,or=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),or}var No=Co();const $o=Xt(No);var bt={exports:{}},ni;function Po(){if(ni)return bt.exports;ni=1;const t=/[\p{Lu}]/u,e=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,a=new RegExp("^"+i.source),s=new RegExp(i.source+n.source,"gu"),o=new RegExp("\\d+"+n.source,"gu"),c=(h,f,p)=>{let m=!1,g=!1,_=!1;for(let w=0;w<h.length;w++){const y=h[w];m&&t.test(y)?(h=h.slice(0,w)+"-"+h.slice(w),m=!1,_=g,g=!0,w++):g&&_&&e.test(y)?(h=h.slice(0,w-1)+"-"+h.slice(w-1),_=g,g=!1,m=!0):(m=f(y)===y&&p(y)!==y,_=g,g=p(y)===y&&f(y)!==y)}return h},l=(h,f)=>(r.lastIndex=0,h.replace(r,p=>f(p))),u=(h,f)=>(s.lastIndex=0,o.lastIndex=0,h.replace(s,(p,m)=>f(m)).replace(o,p=>f(p))),d=(h,f)=>{if(!(typeof h=="string"||Array.isArray(h)))throw new TypeError("Expected the input to be `string | string[]`");if(f={pascalCase:!1,preserveConsecutiveUppercase:!1,...f},Array.isArray(h)?h=h.map(_=>_.trim()).filter(_=>_.length).join("-"):h=h.trim(),h.length===0)return"";const p=f.locale===!1?_=>_.toLowerCase():_=>_.toLocaleLowerCase(f.locale),m=f.locale===!1?_=>_.toUpperCase():_=>_.toLocaleUpperCase(f.locale);return h.length===1?f.pascalCase?m(h):p(h):(h!==p(h)&&(h=c(h,p,m)),h=h.replace(a,""),f.preserveConsecutiveUppercase?h=l(h,p):h=p(h),f.pascalCase&&(h=m(h.charAt(0))+h.slice(1)),u(h,m))};return bt.exports=d,bt.exports.default=d,bt.exports}Po();function Lo(t,e){return e?.[t]||$o(t)}function ko(t,e,r){const n={};for(const i in t)Object.hasOwn(t,i)&&(n[e(i,r)]=t[i]);return n}const os="__lc_escaped__";function Mo(t){return"lc"in t||Object.keys(t).length===1&&os in t}function jo(t){return{[os]:t}}function Do(t){return t!==null&&typeof t=="object"&&"lc_serializable"in t&&typeof t.toJSON=="function"}function Uo(t){let e;return t!==null&&typeof t=="object"?"lc_id"in t&&Array.isArray(t.lc_id)?e=t.lc_id:e=[t.constructor?.name??"Object"]:e=[typeof t],{lc:1,type:"not_implemented",id:e}}function vn(t,e=new WeakSet){if(t!==null&&typeof t=="object"&&!Array.isArray(t)){if(e.has(t))return Uo(t);if(Do(t))return t;e.add(t);const r=t;if(Mo(r))return e.delete(t),jo(r);const n={};for(const[i,a]of Object.entries(r))n[i]=vn(a,e);return e.delete(t),n}return Array.isArray(t)?t.map(r=>vn(r,e)):t}function ii(t){return Array.isArray(t)?[...t]:{...t}}function Fo(t,e){const r=ii(t);for(const[n,i]of Object.entries(e)){const[a,...s]=n.split(".").reverse();let o=r;for(const c of s.reverse()){if(o[c]===void 0)break;o[c]=ii(o[c]),o=o[c]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[i]})}return r}function cs(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}var Ut=class ls{lc_serializable=!1;lc_kwargs;static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,cs(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...r){this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([n])=>this.lc_serializable_keys?.includes(n))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof ls||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},r={},n=Object.keys(this.lc_kwargs).reduce((o,c)=>(o[c]=c in this?this[c]:this.lc_kwargs[c],o),{});for(let o=Object.getPrototypeOf(this);o;o=Object.getPrototypeOf(o))Object.assign(e,Reflect.get(o,"lc_aliases",this)),Object.assign(r,Reflect.get(o,"lc_secrets",this)),Object.assign(n,Reflect.get(o,"lc_attributes",this));Object.keys(r).forEach(o=>{let c=this,l=n;const[u,...d]=o.split(".").reverse();for(const h of d.reverse()){if(!(h in c)||c[h]===void 0)return;(!(h in l)||l[h]===void 0)&&(typeof c[h]=="object"&&c[h]!=null?l[h]={}:Array.isArray(c[h])&&(l[h]=[])),c=c[h],l=l[h]}u in c&&c[u]!==void 0&&(l[u]=l[u]||c[u])});const i={},a=new WeakSet;a.add(this);for(const[o,c]of Object.entries(n))i[o]=vn(c,a);const s=ko(Object.keys(r).length?Fo(i,r):i,Lo,e);return{lc:1,type:"constructor",id:this.lc_id,kwargs:s}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};const us=Symbol.for("ls:tracing_async_local_storage"),kt=Symbol.for("lc:context_variables"),Bo=t=>{globalThis[us]=t},pt=()=>globalThis[us];function ds(t){const e=Symbol.for(t);return{brand(r,n){const i=n?Symbol.for(`${t}.${n}`):e;class a extends r{[i]=!0;constructor(...o){super(...o)}static isInstance(o){return typeof o=="object"&&o!==null&&i in o&&o[i]===!0}}return Object.defineProperty(a,"name",{value:r.name}),a},sub(r){return ds(`${t}.${r}`)},isInstance(r){return typeof r=="object"&&r!==null&&e in r&&r[e]===!0}}}const zo=ds("langchain"),Mn=zo.sub("error");var hs=class extends Mn.brand(Error){name="LangChainError";constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}};(class extends Mn.brand(hs,"model-abort"){name="ModelAbortError";partialOutput;constructor(t,e){super(t),this.partialOutput=e}});(class fs extends Mn.brand(hs,"context-overflow"){name="ContextOverflowError";cause;constructor(e){super(e??"Input exceeded the model's context window.")}static fromError(e){const r=new fs(e.message);return r.cause=e,r}});function qo(t){try{return JSON.parse(t)}catch{}const e=t.trim();if(e.length===0)throw new Error("Unexpected end of JSON input");let r=0;function n(){for(;r<e.length&&/\s/.test(e[r]);)r+=1}function i(){if(e[r]!=='"')throw new Error(`Expected '"' at position ${r}, got '${e[r]}'`);r+=1;let u="",d=!1;for(;r<e.length;){const h=e[r];if(d){if(h==="n")u+=`
`;else if(h==="t")u+="	";else if(h==="r")u+="\r";else if(h==="\\")u+="\\";else if(h==='"')u+='"';else if(h==="b")u+="\b";else if(h==="f")u+="\f";else if(h==="/")u+="/";else if(h==="u"){const f=e.substring(r+1,r+5);if(/^[0-9A-Fa-f]{0,4}$/.test(f))f.length===4?u+=String.fromCharCode(Number.parseInt(f,16)):u+=`u${f}`,r+=f.length;else throw new Error(`Invalid unicode escape sequence '\\u${f}' at position ${r}`)}else throw new Error(`Invalid escape sequence '\\${h}' at position ${r}`);d=!1}else if(h==="\\")d=!0;else{if(h==='"')return r+=1,u;u+=h}r+=1}return d&&(u+="\\"),u}function a(){const u=r;let d="";if(e[r]==="-"&&(d+="-",r+=1),r<e.length&&e[r]==="0"&&(d+="0",r+=1,e[r]>="0"&&e[r]<="9"))throw new Error(`Invalid number at position ${u}`);if(r<e.length&&e[r]>="1"&&e[r]<="9")for(;r<e.length&&e[r]>="0"&&e[r]<="9";)d+=e[r],r+=1;if(r<e.length&&e[r]===".")for(d+=".",r+=1;r<e.length&&e[r]>="0"&&e[r]<="9";)d+=e[r],r+=1;if(r<e.length&&(e[r]==="e"||e[r]==="E"))for(d+=e[r],r+=1,r<e.length&&(e[r]==="+"||e[r]==="-")&&(d+=e[r],r+=1);r<e.length&&e[r]>="0"&&e[r]<="9";)d+=e[r],r+=1;if(d==="-")return-0;const h=Number.parseFloat(d);if(Number.isNaN(h))throw r=u,new Error(`Invalid number '${d}' at position ${u}`);return h}function s(){if(n(),r>=e.length)throw new Error(`Unexpected end of input at position ${r}`);const u=e[r];if(u==="{")return c();if(u==="[")return o();if(u==='"')return i();if("null".startsWith(e.substring(r,r+4)))return r+=Math.min(4,e.length-r),null;if("true".startsWith(e.substring(r,r+4)))return r+=Math.min(4,e.length-r),!0;if("false".startsWith(e.substring(r,r+5)))return r+=Math.min(5,e.length-r),!1;if(u==="-"||u>="0"&&u<="9")return a();throw new Error(`Unexpected character '${u}' at position ${r}`)}function o(){if(e[r]!=="[")throw new Error(`Expected '[' at position ${r}, got '${e[r]}'`);const u=[];if(r+=1,n(),r>=e.length)return u;if(e[r]==="]")return r+=1,u;for(;r<e.length;){if(n(),r>=e.length||(u.push(s()),n(),r>=e.length))return u;if(e[r]==="]")return r+=1,u;if(e[r]===","){r+=1;continue}throw new Error(`Expected ',' or ']' at position ${r}, got '${e[r]}'`)}return u}function c(){if(e[r]!=="{")throw new Error(`Expected '{' at position ${r}, got '${e[r]}'`);const u={};if(r+=1,n(),r>=e.length)return u;if(e[r]==="}")return r+=1,u;for(;r<e.length;){if(n(),r>=e.length)return u;const d=i();if(n(),r>=e.length)return u;if(e[r]!==":")throw new Error(`Expected ':' at position ${r}, got '${e[r]}'`);if(r+=1,n(),r>=e.length||(u[d]=s(),n(),r>=e.length))return u;if(e[r]==="}")return r+=1,u;if(e[r]===","){r+=1;continue}throw new Error(`Expected ',' or '}' at position ${r}, got '${e[r]}'`)}return u}const l=s();if(n(),r<e.length)throw new Error(`Unexpected character '${e[r]}' at position ${r}`);return l}function Go(t){try{return typeof t>"u"?null:qo(t)}catch{return null}}function mt(t){return typeof t=="object"&&t!==null&&"type"in t&&typeof t.type=="string"&&"source_type"in t&&(t.source_type==="url"||t.source_type==="base64"||t.source_type==="text"||t.source_type==="id")}function Ho(t){return mt(t)&&t.source_type==="url"&&"url"in t&&typeof t.url=="string"}function Vo(t){return mt(t)&&t.source_type==="base64"&&"data"in t&&typeof t.data=="string"}function Jo(t){return mt(t)&&t.source_type==="id"&&"id"in t&&typeof t.id=="string"}function ai({dataUrl:t,asTypedArray:e=!1}){const r=t.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let n;if(r){n=r[1].toLowerCase();const i=e?Uint8Array.from(atob(r[2]),a=>a.charCodeAt(0)):r[2];return{mime_type:n,data:i}}}function x(t,e){return N(t)&&t.type===e}function N(t){return typeof t=="object"&&t!==null}function he(t){return Array.isArray(t)}function b(t){return typeof t=="string"}function ye(t){return typeof t=="number"}function jn(t){return t instanceof Uint8Array}function si(t){try{return JSON.parse(t)}catch{return}}const ke=t=>t();function Zo(t){if(t.type==="char_location"&&b(t.document_title)&&ye(t.start_char_index)&&ye(t.end_char_index)&&b(t.cited_text)){const{document_title:e,start_char_index:r,end_char_index:n,cited_text:i,...a}=t;return{...a,type:"citation",source:"char",title:e??void 0,startIndex:r,endIndex:n,citedText:i}}if(t.type==="page_location"&&b(t.document_title)&&ye(t.start_page_number)&&ye(t.end_page_number)&&b(t.cited_text)){const{document_title:e,start_page_number:r,end_page_number:n,cited_text:i,...a}=t;return{...a,type:"citation",source:"page",title:e??void 0,startIndex:r,endIndex:n,citedText:i}}if(t.type==="content_block_location"&&b(t.document_title)&&ye(t.start_block_index)&&ye(t.end_block_index)&&b(t.cited_text)){const{document_title:e,start_block_index:r,end_block_index:n,cited_text:i,...a}=t;return{...a,type:"citation",source:"block",title:e??void 0,startIndex:r,endIndex:n,citedText:i}}if(t.type==="web_search_result_location"&&b(t.url)&&b(t.title)&&b(t.encrypted_index)&&b(t.cited_text)){const{url:e,title:r,encrypted_index:n,cited_text:i,...a}=t;return{...a,type:"citation",source:"url",url:e,title:r,startIndex:Number(n),endIndex:Number(n),citedText:i}}if(t.type==="search_result_location"&&b(t.source)&&b(t.title)&&ye(t.start_block_index)&&ye(t.end_block_index)&&b(t.cited_text)){const{source:e,title:r,start_block_index:n,end_block_index:i,cited_text:a,...s}=t;return{...s,type:"citation",source:"search",url:e,title:r??void 0,startIndex:n,endIndex:i,citedText:a}}}function ps(t){if(x(t,"document")&&N(t.source)&&"type"in t.source){if(t.source.type==="base64"&&b(t.source.media_type)&&b(t.source.data))return{type:"file",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&b(t.source.url))return{type:"file",url:t.source.url};if(t.source.type==="file"&&b(t.source.file_id))return{type:"file",fileId:t.source.file_id};if(t.source.type==="text"&&b(t.source.data))return{type:"file",mimeType:String(t.source.media_type??"text/plain"),data:t.source.data}}else if(x(t,"image")&&N(t.source)&&"type"in t.source){if(t.source.type==="base64"&&b(t.source.media_type)&&b(t.source.data))return{type:"image",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&b(t.source.url))return{type:"image",url:t.source.url};if(t.source.type==="file"&&b(t.source.file_id))return{type:"image",fileId:t.source.file_id}}}function Ko(t){function*e(){for(const r of t){const n=ps(r);n?yield n:yield r}}return Array.from(e())}function oi(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(x(n,"text")&&b(n.text)){const{text:i,citations:a,...s}=n;if(he(a)&&a.length){const o=a.reduce((c,l)=>{const u=Zo(l);return u?[...c,u]:c},[]);yield{...s,type:"text",text:i,annotations:o};continue}else{yield{...s,type:"text",text:i};continue}}else if(x(n,"thinking")&&b(n.thinking)){const{thinking:i,signature:a,...s}=n;yield{...s,type:"reasoning",reasoning:i,signature:a};continue}else if(x(n,"redacted_thinking")){yield{type:"non_standard",value:n};continue}else if(x(n,"tool_use")&&b(n.name)&&b(n.id)){yield{type:"tool_call",id:n.id,name:n.name,args:n.input};continue}else if(x(n,"input_json_delta")){if(Xo(t)&&t.tool_call_chunks?.length){const i=t.tool_call_chunks[0];yield{type:"tool_call_chunk",id:i.id,name:i.name,args:i.args,index:i.index};continue}}else if(x(n,"server_tool_use")&&b(n.name)&&b(n.id)){const{name:i,id:a}=n;if(i==="web_search"){yield{id:a,type:"server_tool_call",name:"web_search",args:{query:ke(()=>{if(typeof n.input=="string")return n.input;if(N(n.input)&&b(n.input.query))return n.input.query;if(b(n.partial_json)){const s=si(n.partial_json);if(s?.query)return s.query}return""})}};continue}else if(n.name==="code_execution"){yield{id:a,type:"server_tool_call",name:"code_execution",args:{code:ke(()=>{if(typeof n.input=="string")return n.input;if(N(n.input)&&b(n.input.code))return n.input.code;if(b(n.partial_json)){const s=si(n.partial_json);if(s?.code)return s.code}return""})}};continue}}else if(x(n,"web_search_tool_result")&&b(n.tool_use_id)&&he(n.content)){const{content:i,tool_use_id:a}=n;yield{type:"server_tool_call_result",name:"web_search",toolCallId:a,status:"success",output:{urls:i.reduce((s,o)=>x(o,"web_search_result")?[...s,o.url]:s,[])}};continue}else if(x(n,"code_execution_tool_result")&&b(n.tool_use_id)&&N(n.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}else if(x(n,"mcp_tool_use")){yield{id:n.id,type:"server_tool_call",name:"mcp_tool_use",args:n.input};continue}else if(x(n,"mcp_tool_result")&&b(n.tool_use_id)&&N(n.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}else if(x(n,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:n.input};continue}else if(x(n,"search_result")){yield{id:n.id,type:"non_standard",value:n};continue}else if(x(n,"tool_result")){yield{id:n.id,type:"non_standard",value:n};continue}else{const i=ps(n);if(i){yield i;continue}}yield{type:"non_standard",value:n}}}return Array.from(e())}const Wo={translateContent:oi,translateContentChunk:oi};function Xo(t){return typeof t?._getType=="function"&&typeof t.concat=="function"&&t._getType()==="ai"}function Qo(t){return Ho(t)?{type:t.type,mimeType:t.mime_type,url:t.url,metadata:t.metadata}:Vo(t)?{type:t.type,mimeType:t.mime_type??"application/octet-stream",data:t.data,metadata:t.metadata}:Jo(t)?{type:t.type,mimeType:t.mime_type,fileId:t.id,metadata:t.metadata}:t}function Yo(t){return t.map(Qo)}function ec(t){return!!(x(t,"image_url")&&N(t.image_url)||x(t,"input_audio")&&N(t.input_audio)||x(t,"file")&&N(t.file))}function tc(t){if(x(t,"image_url")&&N(t.image_url)&&b(t.image_url.url)){const e=ai({dataUrl:t.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:t.image_url.url}}else{if(x(t,"input_audio")&&N(t.input_audio)&&b(t.input_audio.data)&&b(t.input_audio.format))return{type:"audio",data:t.input_audio.data,mimeType:`audio/${t.input_audio.format}`};if(x(t,"file")&&N(t.file)&&b(t.file.data)){const e=ai({dataUrl:t.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(b(t.file.file_id))return{type:"file",fileId:t.file.file_id}}}return t}function rc(t){const e=[];typeof t.content=="string"?t.content.length>0&&e.push({type:"text",text:t.content}):e.push(...Dn(t.content));for(const r of t.tool_calls??[])e.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return e}function nc(t){const e=[];typeof t.content=="string"?t.content.length>0&&e.push({type:"text",text:t.content}):e.push(...Dn(t.content));for(const r of t.tool_calls??[])e.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return e}function Dn(t){const e=[];for(const r of t)ec(r)?e.push(tc(r)):e.push(r);return e}function ic(t){if(t.type==="url_citation"){const{url:e,title:r,start_index:n,end_index:i}=t;return{type:"citation",url:e,title:r,startIndex:n,endIndex:i}}if(t.type==="file_citation"){const{file_id:e,filename:r,index:n}=t;return{type:"citation",title:r,startIndex:n,endIndex:n,fileId:e}}return t}function ms(t){function*e(){N(t.additional_kwargs?.reasoning)&&he(t.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:t.additional_kwargs.reasoning.summary.reduce((n,i)=>N(i)&&b(i.text)?`${n}${i.text}`:n,"")});const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r)if(x(n,"text")){const{text:i,annotations:a,...s}=n;Array.isArray(a)?yield{...s,type:"text",text:String(i),annotations:a.map(ic)}:yield{...s,type:"text",text:String(i)}}for(const n of t.tool_calls??[])yield{type:"tool_call",id:n.id,name:n.name,args:n.args};if(N(t.additional_kwargs)&&he(t.additional_kwargs.tool_outputs))for(const n of t.additional_kwargs.tool_outputs){if(x(n,"web_search_call")){const i={};if(N(n.action)&&b(n.action.query)&&(i.query=n.action.query),yield{id:n.id,type:"server_tool_call",name:"web_search",args:i},n.status==="completed"||n.status==="failed"){const a={};N(n.action)&&(a.action=n.action),yield{type:"server_tool_call_result",toolCallId:b(n.id)?n.id:"",status:n.status==="completed"?"success":"error",output:a}}continue}else if(x(n,"file_search_call")){yield{id:n.id,type:"server_tool_call",name:"file_search",args:{queries:he(n.queries)?n.queries:[]}},(n.status==="completed"||n.status==="failed")&&(yield{type:"server_tool_call_result",toolCallId:b(n.id)?n.id:"",status:n.status==="completed"?"success":"error",output:he(n.results)?{results:n.results}:{}});continue}else if(x(n,"computer_call")){yield{type:"non_standard",value:n};continue}else if(x(n,"code_interpreter_call")){if(b(n.code)&&(yield{id:n.id,type:"server_tool_call",name:"code_interpreter",args:{code:n.code}}),he(n.outputs)){const i=ke(()=>{if(n.status!=="in_progress"){if(n.status==="completed")return 0;if(n.status==="incomplete")return 127;if(n.status!=="interpreting"&&n.status==="failed")return 1}});for(const a of n.outputs)if(x(a,"logs")){yield{type:"server_tool_call_result",toolCallId:n.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:i??0,stderr:[0,void 0].includes(i)?void 0:String(a.logs),stdout:[0,void 0].includes(i)?String(a.logs):void 0}};continue}}continue}else if(x(n,"mcp_call")){yield{id:n.id,type:"server_tool_call",name:"mcp_call",args:n.input};continue}else if(x(n,"mcp_list_tools")){yield{id:n.id,type:"server_tool_call",name:"mcp_list_tools",args:n.input};continue}else if(x(n,"mcp_approval_request")){yield{type:"non_standard",value:n};continue}else if(x(n,"image_generation_call")){b(n.result)&&(yield{type:"image",mimeType:"image/png",data:n.result,id:b(n.id)?n.id:void 0,metadata:{status:b(n.status)?n.status:void 0}}),yield{type:"non_standard",value:n};continue}N(n)&&(yield{type:"non_standard",value:n})}}return Array.from(e())}function ac(t){function*e(){yield*ms(t);for(const r of t.tool_call_chunks??[])yield{type:"tool_call_chunk",id:r.id,name:r.name,args:r.args}}return Array.from(e())}const sc={translateContent:t=>typeof t.content=="string"?rc(t):ms(t),translateContentChunk:t=>typeof t.content=="string"?nc(t):ac(t)};function oc(t){return typeof t=="object"&&t!==null&&"type"in t&&"content"in t&&(typeof t.content=="string"||Array.isArray(t.content))}function cc(t,e="pretty"){return e==="pretty"?lc(t):JSON.stringify(t)}function lc(t){const e=[],r=` ${t.type.charAt(0).toUpperCase()+t.type.slice(1)} Message `,n=Math.floor((80-r.length)/2),i="=".repeat(n),a=r.length%2===0?i:`${i}=`;if(e.push(`${i}${r}${a}`),t.type==="ai"){const s=t;if(s.tool_calls&&s.tool_calls.length>0){e.push("Tool Calls:");for(const o of s.tool_calls){e.push(`  ${o.name} (${o.id})`),e.push(` Call ID: ${o.id}`),e.push("  Args:");for(const[c,l]of Object.entries(o.args))e.push(`    ${c}: ${typeof l=="object"?JSON.stringify(l):l}`)}}}if(t.type==="tool"){const s=t;s.name&&e.push(`Name: ${s.name}`)}return typeof t.content=="string"&&t.content.trim()&&(e.length>1&&e.push(""),e.push(t.content)),e.join(`
`)}const cr=Symbol.for("langchain.message");function uc(t,e){return typeof t=="string"?t===""?e:typeof e=="string"?t+e:Array.isArray(e)&&e.length===0?t:Array.isArray(e)&&e.some(r=>mt(r))?[{type:"text",source_type:"text",text:t},...e]:[{type:"text",text:t},...e]:Array.isArray(e)?Ft(t,e)??[...t,...e]:e===""?t:Array.isArray(t)&&t.some(r=>mt(r))?[...t,{type:"file",source_type:"text",text:e}]:[...t,{type:"text",text:e}]}function dc(t,e){function r(n,i){if(typeof n!="object"||n===null||n===void 0)return n;if(i>=e)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(s=>r(s,i+1));const a={};for(const s of Object.keys(n))a[s]=r(n[s],i+1);return a}return JSON.stringify(r(t,0),null,2)}var gs=class extends Ut{lc_namespace=["langchain_core","messages"];lc_serializable=!0;get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}[cr]=!0;id;name;content;additional_kwargs;response_metadata;_getType(){return this.type}getType(){return this._getType()}constructor(t){const e=typeof t=="string"||Array.isArray(t)?{content:t}:t;e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),this.name=e.name,e.content===void 0&&e.contentBlocks!==void 0?(this.content=e.contentBlocks,this.response_metadata={output_version:"v1",...e.response_metadata}):e.content!==void 0?(this.content=e.content??[],this.response_metadata=e.response_metadata):(this.content=[],this.response_metadata=e.response_metadata),this.additional_kwargs=e.additional_kwargs,this.id=e.id}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(t=>typeof t=="string"?t:t.type==="text"?t.text:"").join(""):""}get contentBlocks(){const t=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[Yo,Dn,Ko].reduce((e,r)=>r(e),t)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(t){return typeof t=="object"&&t!==null&&cr in t&&t[cr]===!0&&oc(t)}_updateId(t){this.id=t,this.lc_kwargs.id=t}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](t){if(t===null)return this;const e=dc(this._printableFields,Math.max(4,t));return`${this.constructor.lc_name()} ${e}`}toFormattedString(t="pretty"){return cc(this,t)}};const hc=["index","created","timestamp"];function Qt(t,e,r){const n=hc;if(t==null&&e==null)return;if(t==null||e==null)return t??e;const i={...t};for(const[a,s]of Object.entries(e))if(i[a]==null)i[a]=s;else{if(s==null)continue;if(typeof i[a]!=typeof s||Array.isArray(i[a])!==Array.isArray(s))throw new Error(`field[${a}] already exists in the message chunk, but with a different type.`);if(typeof i[a]=="string"){if(a==="type")continue;if(["id","name","output_version","model_provider"].includes(a))s&&(i[a]=s);else{if(n.includes(a))continue;i[a]+=s}}else if(typeof i[a]=="number"){if(n.includes(a))continue;i[a]=i[a]+s}else if(typeof i[a]=="object"&&!Array.isArray(i[a]))i[a]=Qt(i[a],s);else if(Array.isArray(i[a]))i[a]=Ft(i[a],s);else{if(i[a]===s)continue;console.warn(`field[${a}] already exists in this message chunk and value has unsupported type.`)}}return i}function fc(t){return typeof t=="number"||typeof t=="string"}function ci(t){return typeof t!="object"||t===null||!("index"in t)?!1:fc(t.index)}function Ft(t,e,r){if(!(t==null&&e==null)){if(t==null||e==null)return t||e;{const n=[...t];for(const i of e)if(ci(i)){const a=n.findIndex(s=>{if(!ci(s))return!1;const o=s.index===i.index,c=s.id!=null&&i.id!=null&&s.id===i.id,l=s.id==null||i.id==null;return o&&(c||l)});a!==-1&&typeof n[a]=="object"&&n[a]!==null?n[a]=Qt(n[a],i):n.push(i)}else{if(typeof i=="object"&&i!==null&&"text"in i&&i.text==="")continue;n.push(i)}return n}}}var pc=class _s extends gs{static isInstance(e){if(!super.isInstance(e))return!1;let r=Object.getPrototypeOf(e);for(;r!==null;){if(r===_s.prototype)return!0;r=Object.getPrototypeOf(r)}return!1}};function mc(t){const e=[],r=[];for(const n of t)if(n.function){const i=n.function.name;try{const a=JSON.parse(n.function.arguments);e.push({name:i||"",args:a||{},id:n.id})}catch{r.push({name:i,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[e,r]}function Un(t){switch(t){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function gc(t){if(N(t.document)&&N(t.document.source)){const e=Un(N(t.document)&&b(t.document.format)?t.document.format:"");if(N(t.document.source)){if(N(t.document.source.s3Location)&&b(t.document.source.s3Location.uri))return{type:"file",mimeType:e,fileId:t.document.source.s3Location.uri};if(jn(t.document.source.bytes))return{type:"file",mimeType:e,data:t.document.source.bytes};if(b(t.document.source.text))return{type:"file",mimeType:e,data:Buffer.from(t.document.source.text).toString("base64")};if(he(t.document.source.content))return{type:"file",mimeType:e,data:t.document.source.content.reduce((r,n)=>N(n)&&b(n.text)?r+n.text:r,"")}}}return{type:"non_standard",value:t}}function _c(t){if(x(t,"image")&&N(t.image)){const e=Un(N(t.image)&&b(t.image.format)?t.image.format:"");if(N(t.image.source)){if(N(t.image.source.s3Location)&&b(t.image.source.s3Location.uri))return{type:"image",mimeType:e,fileId:t.image.source.s3Location.uri};if(jn(t.image.source.bytes))return{type:"image",mimeType:e,data:t.image.source.bytes}}}return{type:"non_standard",value:t}}function yc(t){if(x(t,"video")&&N(t.video)){const e=Un(N(t.video)&&b(t.video.format)?t.video.format:"");if(N(t.video.source)){if(N(t.video.source.s3Location)&&b(t.video.source.s3Location.uri))return{type:"video",mimeType:e,fileId:t.video.source.s3Location.uri};if(jn(t.video.source.bytes))return{type:"video",mimeType:e,data:t.video.source.bytes}}}return{type:"non_standard",value:t}}function li(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(x(n,"cache_point")){yield{type:"non_standard",value:n};continue}else if(x(n,"citations_content")&&N(n.citationsContent)){yield{type:"text",text:he(n.citationsContent.content)?n.citationsContent.content.reduce((i,a)=>N(a)&&b(a.text)?i+a.text:i,""):"",annotations:he(n.citationsContent.citations)?n.citationsContent.citations.reduce((i,a)=>{if(N(a)){const s=he(a.sourceContent)?a.sourceContent.reduce((c,l)=>N(l)&&b(l.text)?c+l.text:c,""):"",o=ke(()=>{if(N(a.location)){const c=a.location.documentChar||a.location.documentPage||a.location.documentChunk;if(N(c))return{source:ye(c.documentIndex)?c.documentIndex.toString():void 0,startIndex:ye(c.start)?c.start:void 0,endIndex:ye(c.end)?c.end:void 0}}return{}});i.push({type:"citation",citedText:s,...o})}return i},[]):[]};continue}else if(x(n,"document")&&N(n.document)){yield gc(n);continue}else if(x(n,"guard_content")){yield{type:"non_standard",value:n};continue}else if(x(n,"image")&&N(n.image)){yield _c(n);continue}else if(x(n,"reasoning_content")&&b(n.reasoningText)){yield{type:"reasoning",reasoning:n.reasoningText};continue}else if(x(n,"text")&&b(n.text)){yield{type:"text",text:n.text};continue}else if(x(n,"tool_result")){yield{type:"non_standard",value:n};continue}else{if(x(n,"tool_call"))continue;if(x(n,"video")&&N(n.video)){yield yc(n);continue}}yield{type:"non_standard",value:n}}}return Array.from(e())}const wc={translateContent:li,translateContentChunk:li};function ui(t){const e=[],r=t.additional_kwargs?.reasoning_content;if(b(r)&&r.length>0&&e.push({type:"reasoning",reasoning:r}),typeof t.content=="string")t.content.length>0&&e.push({type:"text",text:t.content});else for(const n of t.content)typeof n=="object"&&"type"in n&&n.type==="text"&&"text"in n&&b(n.text)&&e.push({type:"text",text:n.text});for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}const vc={translateContent:ui,translateContentChunk:ui};function di(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(x(n,"text")&&b(n.text)){yield{type:"text",text:n.text};continue}else if(x(n,"thinking")&&b(n.thinking)){yield{type:"reasoning",reasoning:n.thinking,...n.signature?{signature:n.signature}:{}};continue}else if(x(n,"inlineData")&&N(n.inlineData)&&b(n.inlineData.mimeType)&&b(n.inlineData.data)){yield{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data};continue}else if(x(n,"functionCall")&&N(n.functionCall)&&b(n.functionCall.name)&&N(n.functionCall.args)){yield{type:"tool_call",id:t.id,name:n.functionCall.name,args:n.functionCall.args};continue}else if(x(n,"functionResponse")){yield{type:"non_standard",value:n};continue}else if(x(n,"fileData")&&N(n.fileData)&&b(n.fileData.mimeType)&&b(n.fileData.fileUri)){yield{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri};continue}else if(x(n,"executableCode")){yield{type:"non_standard",value:n};continue}else if(x(n,"codeExecutionResult")){yield{type:"non_standard",value:n};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const bc={translateContent:di,translateContentChunk:di};function hi(t){function*e(){const r=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const n of r){if(x(n,"reasoning")&&b(n.reasoning)){const i=ke(()=>{const a=r.indexOf(n);if(he(t.additional_kwargs?.signatures)&&a>=0)return t.additional_kwargs.signatures.at(a)});b(i)?yield{type:"reasoning",reasoning:n.reasoning,signature:i}:yield{type:"reasoning",reasoning:n.reasoning};continue}else if(x(n,"thinking")&&b(n.thinking)){yield{type:"reasoning",reasoning:n.thinking,...n.signature?{signature:n.signature}:{}};continue}else if(x(n,"text")&&b(n.text)){yield{type:"text",text:n.text};continue}else if(x(n,"image_url")){if(b(n.image_url))if(n.image_url.startsWith("data:")){const i=n.image_url.match(/^data:([^;]+);base64,(.+)$/);i?yield{type:"image",data:i[2],mimeType:i[1]}:yield{type:"image",url:n.image_url}}else yield{type:"image",url:n.image_url};continue}else if(x(n,"media")&&b(n.mimeType)&&b(n.data)){yield{type:"file",mimeType:n.mimeType,data:n.data};continue}yield{type:"non_standard",value:n}}}return Array.from(e())}const Ec={translateContent:hi,translateContentChunk:hi};function fi(t){const e=[],r=t.additional_kwargs?.reasoning;if(b(r)&&r.length>0&&e.push({type:"reasoning",reasoning:r}),typeof t.content=="string"){let n=t.content;const i=n.match(/<think>([\s\S]*?)<\/think>/);if(i){const a=i[1].trim();a.length>0&&e.push({type:"reasoning",reasoning:a}),n=n.replace(/<think>[\s\S]*?<\/think>/,"").trim()}n.length>0&&e.push({type:"text",text:n})}else for(const n of t.content)if(typeof n=="object"&&"type"in n&&n.type==="text"&&"text"in n&&b(n.text)){let i=n.text;const a=i.match(/<think>([\s\S]*?)<\/think>/);if(a){const s=a[1].trim();s.length>0&&e.push({type:"reasoning",reasoning:s}),i=i.replace(/<think>[\s\S]*?<\/think>/,"").trim()}i.length>0&&e.push({type:"text",text:i})}for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}const Sc={translateContent:fi,translateContentChunk:fi};function pi(t){const e=[],r=t.additional_kwargs?.reasoning_content;if(b(r)&&r.length>0&&e.push({type:"reasoning",reasoning:r}),typeof t.content=="string")t.content.length>0&&e.push({type:"text",text:t.content});else for(const n of t.content)typeof n=="object"&&"type"in n&&n.type==="text"&&"text"in n&&b(n.text)&&e.push({type:"text",text:n.text});for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}const Tc={translateContent:pi,translateContentChunk:pi};function mi(t){const e=[];if(N(t.additional_kwargs?.reasoning)){const n=t.additional_kwargs.reasoning;if(he(n.summary)){const i=n.summary.reduce((a,s)=>N(s)&&b(s.text)?`${a}${s.text}`:a,"");i.length>0&&e.push({type:"reasoning",reasoning:i})}}const r=t.additional_kwargs?.reasoning_content;if(b(r)&&r.length>0&&e.push({type:"reasoning",reasoning:r}),typeof t.content=="string")t.content.length>0&&e.push({type:"text",text:t.content});else for(const n of t.content)typeof n=="object"&&"type"in n&&n.type==="text"&&"text"in n&&b(n.text)&&e.push({type:"text",text:n.text});for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}const Ic={translateContent:mi,translateContentChunk:mi};function gi(t){function*e(){const r=ke(()=>typeof t.content=="string"?t.additional_kwargs.originalTextContentBlock?[{...t.additional_kwargs.originalTextContentBlock,type:"text"}]:[{type:"text",text:t.content}]:t.content);for(const n of r){const i=ke(()=>x(n,"text")&&b(n.text)?{type:"text",text:n.text}:x(n,"inlineData")&&N(n.inlineData)&&b(n.inlineData.mimeType)&&b(n.inlineData.data)?{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data}:x(n,"functionCall")&&N(n.functionCall)&&b(n.functionCall.name)&&N(n.functionCall.args)?{type:"tool_call",id:t.id,name:n.functionCall.name,args:n.functionCall.args}:x(n,"functionResponse")?{type:"non_standard",value:n}:x(n,"fileData")&&N(n.fileData)&&b(n.fileData.mimeType)&&b(n.fileData.fileUri)?{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri}:x(n,"executableCode")?{type:"non_standard",value:n}:x(n,"codeExecutionResult")?{type:"non_standard",value:n}:{type:"non_standard",value:n}),a=ke(()=>"thought"in n&&n.thought?{type:"reasoning",reasoning:i.type==="text"?i.text:"",reasoningContentBlock:i}:i),s={thought:n.thought,thoughtSignature:n.thoughtSignature,partMetadata:n.partMetadata,...a};for(const o in s)s[o]===void 0&&delete s[o];yield s}}return Array.from(e())}const Ac={translateContent:gi,translateContentChunk:gi};globalThis.lc_block_translators_registry??=new Map([["anthropic",Wo],["bedrock-converse",wc],["deepseek",vc],["google",Ac],["google-genai",bc],["google-vertexai",Ec],["groq",Sc],["ollama",Tc],["openai",sc],["xai",Ic]]);function ys(t){return globalThis.lc_block_translators_registry.get(t)}function xc(t,e){return Qt(t,e)??{}}function ws(t,e){const r={};return(t?.audio!==void 0||e?.audio!==void 0)&&(r.audio=(t?.audio??0)+(e?.audio??0)),(t?.image!==void 0||e?.image!==void 0)&&(r.image=(t?.image??0)+(e?.image??0)),(t?.video!==void 0||e?.video!==void 0)&&(r.video=(t?.video??0)+(e?.video??0)),(t?.document!==void 0||e?.document!==void 0)&&(r.document=(t?.document??0)+(e?.document??0)),(t?.text!==void 0||e?.text!==void 0)&&(r.text=(t?.text??0)+(e?.text??0)),r}function Rc(t,e){const r={...ws(t,e)};return(t?.cache_read!==void 0||e?.cache_read!==void 0)&&(r.cache_read=(t?.cache_read??0)+(e?.cache_read??0)),(t?.cache_creation!==void 0||e?.cache_creation!==void 0)&&(r.cache_creation=(t?.cache_creation??0)+(e?.cache_creation??0)),r}function Oc(t,e){const r={...ws(t,e)};return(t?.reasoning!==void 0||e?.reasoning!==void 0)&&(r.reasoning=(t?.reasoning??0)+(e?.reasoning??0)),r}function vs(t,e){return{input_tokens:(t?.input_tokens??0)+(e?.input_tokens??0),output_tokens:(t?.output_tokens??0)+(e?.output_tokens??0),total_tokens:(t?.total_tokens??0)+(e?.total_tokens??0),input_token_details:Rc(t?.input_token_details,e?.input_token_details),output_token_details:Oc(t?.output_token_details,e?.output_token_details)}}var Cc=class extends gs{type="ai";tool_calls=[];invalid_tool_calls=[];usage_metadata;get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(t){let e;if(typeof t=="string"||Array.isArray(t))e={content:t,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{e=t;const r=e.additional_kwargs?.tool_calls,n=e.tool_calls;r!=null&&r.length>0&&(n===void 0||n.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(r!=null&&n===void 0){const[i,a]=mc(r);e.tool_calls=i??[],e.invalid_tool_calls=a??[]}else e.tool_calls=e.tool_calls??[],e.invalid_tool_calls=e.invalid_tool_calls??[]}catch{e.tool_calls=[],e.invalid_tool_calls=[]}if(e.response_metadata!==void 0&&"output_version"in e.response_metadata&&e.response_metadata.output_version==="v1"&&(e.contentBlocks=e.content,e.content=void 0),e.contentBlocks!==void 0){e.tool_calls&&e.contentBlocks.push(...e.tool_calls.map(a=>({type:"tool_call",id:a.id,name:a.name,args:a.args})));const i=e.contentBlocks.filter(a=>a.type==="tool_call").filter(a=>!e.tool_calls?.some(s=>s.id===a.id&&s.name===a.name));i.length>0&&(e.tool_calls=i.map(a=>({type:"tool_call",id:a.id,name:a.name,args:a.args})))}}super(e),typeof e!="string"&&(this.tool_calls=e.tool_calls??this.tool_calls,this.invalid_tool_calls=e.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=e.usage_metadata}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const e=ys(this.response_metadata.model_provider);if(e)return e.translateContent(this)}const t=super.contentBlocks;if(this.tool_calls){const e=this.tool_calls.filter(r=>!t.some(n=>n.id===r.id&&n.name===r.name));t.push(...e.map(r=>({type:"tool_call",id:r.id,name:r.name,args:r.args})))}return t}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(t){return super.isInstance(t)&&t.type==="ai"}},bs=class extends pc{type="ai";tool_calls=[];invalid_tool_calls=[];tool_call_chunks=[];usage_metadata;constructor(t){let e;if(typeof t=="string"||Array.isArray(t))e={content:t,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(t.tool_call_chunks===void 0||t.tool_call_chunks.length===0)e={...t,tool_calls:t.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:t.usage_metadata!==void 0?t.usage_metadata:void 0};else{const r=$c(t.tool_call_chunks??[]);e={...t,tool_call_chunks:r.tool_call_chunks,tool_calls:r.tool_calls,invalid_tool_calls:r.invalid_tool_calls,usage_metadata:t.usage_metadata!==void 0?t.usage_metadata:void 0}}super(e),this.tool_call_chunks=e.tool_call_chunks??this.tool_call_chunks,this.tool_calls=e.tool_calls??this.tool_calls,this.invalid_tool_calls=e.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=e.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const e=ys(this.response_metadata.model_provider);if(e)return e.translateContent(this)}const t=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const e=this.content.filter(r=>r.type==="tool_call").map(r=>r.id);for(const r of this.tool_calls)r.id&&!e.includes(r.id)&&t.push({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})}return t}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(t){const e={content:uc(this.content,t.content),additional_kwargs:Qt(this.additional_kwargs,t.additional_kwargs),response_metadata:xc(this.response_metadata,t.response_metadata),tool_call_chunks:[],tool_calls:[],id:this.id??t.id};if(this.tool_call_chunks!==void 0||t.tool_call_chunks!==void 0){const n=Ft(this.tool_call_chunks,t.tool_call_chunks);n!==void 0&&n.length>0&&(e.tool_call_chunks=n)}if(this.tool_calls!==void 0||t.tool_calls!==void 0){const n=Ft(this.tool_calls,t.tool_calls);n!==void 0&&n.length>0&&(e.tool_calls=n)}(this.usage_metadata!==void 0||t.usage_metadata!==void 0)&&(e.usage_metadata=vs(this.usage_metadata,t.usage_metadata));const r=this.constructor;return new r(e)}static isInstance(t){return super.isInstance(t)&&t.type==="ai"}};function Nc(t,e="Human",r="AI"){const n=[];for(const i of t){let a;if(i.type==="human")a=e;else if(i.type==="ai")a=r;else if(i.type==="system")a="System";else if(i.type==="tool")a="Tool";else if(i.type==="generic")a=i.role;else throw new Error(`Got unsupported message type: ${i.type}`);const s=i.name?`${i.name}, `:"",o=i.text;let c=`${a}: ${s}${o}`;if(i.type==="ai"){const l=i;l.tool_calls&&l.tool_calls.length>0?c+=JSON.stringify(l.tool_calls):l.additional_kwargs&&"function_call"in l.additional_kwargs&&(c+=JSON.stringify(l.additional_kwargs.function_call))}n.push(c)}return n.join(`
`)}function $c(t){const e=t.reduce((i,a)=>{const s=i.findIndex(([o])=>"id"in a&&a.id&&"index"in a&&a.index!==void 0?a.id===o.id&&a.index===o.index:"id"in a&&a.id?a.id===o.id:"index"in a&&a.index!==void 0?a.index===o.index:!1);return s!==-1?i[s].push(a):i.push([a]),i},[]),r=[],n=[];for(const i of e){let a=null;const s=i[0]?.name??"",o=i.map(u=>u.args||"").join("").trim(),c=o.length?o:"{}",l=i[0]?.id;try{if(a=Go(c),!l||a===null||typeof a!="object"||Array.isArray(a))throw new Error("Malformed tool call chunk args.");r.push({name:s,args:a,id:l,type:"tool_call"})}catch{n.push({name:s,args:c,id:l,error:"Malformed args.",type:"invalid_tool_call"})}}return{tool_call_chunks:t,tool_calls:r,invalid_tool_calls:n}}var Pc={};const Lc=()=>typeof window<"u"&&typeof window.document<"u",kc=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Mc=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Fn=()=>typeof Deno<"u",jc=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Fn(),Dc=()=>{let t;return Lc()?t="browser":jc()?t="node":kc()?t="webworker":Mc()?t="jsdom":Fn()?t="deno":t="other",t};let lr;function Uc(){return lr===void 0&&(lr={library:"langchain-js",runtime:Dc()}),lr}function Qe(t){try{return typeof process<"u"?Pc?.[t]:Fn()?Deno?.env.get(t):void 0}catch{return}}const Fc=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function dt(t){return typeof t=="string"&&Fc.test(t)}function Bc(t){if(!dt(t))throw TypeError("Invalid UUID");var e,r=new Uint8Array(16);return r[0]=(e=parseInt(t.slice(0,8),16))>>>24,r[1]=e>>>16&255,r[2]=e>>>8&255,r[3]=e&255,r[4]=(e=parseInt(t.slice(9,13),16))>>>8,r[5]=e&255,r[6]=(e=parseInt(t.slice(14,18),16))>>>8,r[7]=e&255,r[8]=(e=parseInt(t.slice(19,23),16))>>>8,r[9]=e&255,r[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,r[11]=e/4294967296&255,r[12]=e>>>24&255,r[13]=e>>>16&255,r[14]=e>>>8&255,r[15]=e&255,r}var Y=[];for(var ur=0;ur<256;++ur)Y.push((ur+256).toString(16).slice(1));function Bn(t,e=0){return(Y[t[e+0]]+Y[t[e+1]]+Y[t[e+2]]+Y[t[e+3]]+"-"+Y[t[e+4]]+Y[t[e+5]]+"-"+Y[t[e+6]]+Y[t[e+7]]+"-"+Y[t[e+8]]+Y[t[e+9]]+"-"+Y[t[e+10]]+Y[t[e+11]]+Y[t[e+12]]+Y[t[e+13]]+Y[t[e+14]]+Y[t[e+15]]).toLowerCase()}var Et,zc=new Uint8Array(16);function Es(){if(!Et&&(Et=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Et))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Et(zc)}function qc(t){t=unescape(encodeURIComponent(t));for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e}var Gc="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Hc="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Vc(t,e,r){function n(i,a,s,o){var c;if(typeof i=="string"&&(i=qc(i)),typeof a=="string"&&(a=Bc(a)),((c=a)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var l=new Uint8Array(16+i.length);if(l.set(a),l.set(i,a.length),l=r(l),l[6]=l[6]&15|e,l[8]=l[8]&63|128,s){o=o||0;for(var u=0;u<16;++u)s[o+u]=l[u];return s}return Bn(l)}try{n.name=t}catch{}return n.DNS=Gc,n.URL=Hc,n}var Jc=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const _i={randomUUID:Jc};function ze(t,e,r){if(_i.randomUUID&&!t)return _i.randomUUID();t=t||{};var n=t.random||(t.rng||Es)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Bn(n)}function Zc(t,e,r,n){switch(t){case 0:return e&r^~e&n;case 1:return e^r^n;case 2:return e&r^e&n^r&n;case 3:return e^r^n}}function dr(t,e){return t<<e|t>>>32-e}function Kc(t){var e=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var n=unescape(encodeURIComponent(t));t=[];for(var i=0;i<n.length;++i)t.push(n.charCodeAt(i))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var a=t.length/4+2,s=Math.ceil(a/16),o=new Array(s),c=0;c<s;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=t[c*64+u*4]<<24|t[c*64+u*4+1]<<16|t[c*64+u*4+2]<<8|t[c*64+u*4+3];o[c]=l}o[s-1][14]=(t.length-1)*8/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=(t.length-1)*8&4294967295;for(var d=0;d<s;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var p=16;p<80;++p)h[p]=dr(h[p-3]^h[p-8]^h[p-14]^h[p-16],1);for(var m=r[0],g=r[1],_=r[2],w=r[3],y=r[4],E=0;E<80;++E){var S=Math.floor(E/20),L=dr(m,5)+Zc(S,g,_,w)+y+e[S]+h[E]>>>0;y=w,w=_,_=dr(g,30)>>>0,g=m,m=L}r[0]=r[0]+m>>>0,r[1]=r[1]+g>>>0,r[2]=r[2]+_>>>0,r[3]=r[3]+w>>>0,r[4]=r[4]+y>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var Wc=Vc("v5",80,Kc),yi=null,wi=null,me=0;function Pe(t,e,r){t=t||{};var n=0,i=new Uint8Array(16),a=t.random||(t.rng||Es)(),s=t.msecs!==void 0?t.msecs:Date.now(),o=t.seq!==void 0?t.seq:null,c=wi,l=yi;return s>me&&t.msecs===void 0&&(me=s,o!==null&&(c=null,l=null)),o!==null&&(o>2147483647&&(o=2147483647),c=o>>>19&4095,l=o&524287),(c===null||l===null)&&(c=a[6]&127,c=c<<8|a[7],l=a[8]&63,l=l<<8|a[9],l=l<<5|a[10]>>>3),s+1e4>me&&o===null?++l>524287&&(l=0,++c>4095&&(c=0,me++)):me=s,wi=c,yi=l,i[n++]=me/1099511627776&255,i[n++]=me/4294967296&255,i[n++]=me/16777216&255,i[n++]=me/65536&255,i[n++]=me/256&255,i[n++]=me&255,i[n++]=c>>>4&15|112,i[n++]=c&255,i[n++]=l>>>13&63|128,i[n++]=l>>>5&255,i[n++]=l<<3&255|a[10]&7,i[n++]=a[11],i[n++]=a[12],i[n++]=a[13],i[n++]=a[14],i[n++]=a[15],Bn(i)}var Xc=class{},Yt=class extends Xc{lc_serializable=!1;get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,cs(this.constructor)]}lc_kwargs;ignoreLLM=!1;ignoreChain=!1;ignoreAgent=!1;ignoreRetriever=!1;ignoreCustomEvent=!1;raiseError=!1;awaitHandlers=Qe("LANGCHAIN_CALLBACKS_BACKGROUND")==="false";constructor(t){super(),this.lc_kwargs=t||{},t&&(this.ignoreLLM=t.ignoreLLM??this.ignoreLLM,this.ignoreChain=t.ignoreChain??this.ignoreChain,this.ignoreAgent=t.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=t.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=t.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=t.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(t._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Ut.prototype.toJSON.call(this)}toJSONNotImplemented(){return Ut.prototype.toJSONNotImplemented.call(this)}static fromMethods(t){class e extends Yt{name=Pe();constructor(){super(),Object.assign(this,t)}}return new e}};const Qc=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},Yc="gen_ai.operation.name",el="gen_ai.system",vi="gen_ai.request.model",tl="gen_ai.response.model",bi="gen_ai.usage.input_tokens",Ei="gen_ai.usage.output_tokens",Si="gen_ai.usage.total_tokens",rl="gen_ai.request.max_tokens",nl="gen_ai.request.temperature",il="gen_ai.request.top_p",al="gen_ai.request.frequency_penalty",sl="gen_ai.request.presence_penalty",ol="gen_ai.response.finish_reasons",cl="gen_ai.prompt",ll="gen_ai.completion",ul="gen_ai.request.extra_query",dl="gen_ai.request.extra_body",hl="gen_ai.serialized.name",fl="gen_ai.serialized.signature",pl="gen_ai.serialized.doc",ml="gen_ai.response.id",gl="gen_ai.response.service_tier",_l="gen_ai.response.system_fingerprint",yl="gen_ai.usage.input_token_details",wl="gen_ai.usage.output_token_details",vl="langsmith.trace.session_id",bl="langsmith.trace.session_name",El="langsmith.span.kind",Sl="langsmith.trace.name",Tl="langsmith.metadata",Ti="langsmith.span.tags",Il="langsmith.request.streaming",Al="langsmith.request.headers",xl=(...t)=>fetch(...t),Ss=Symbol.for("ls:fetch_implementation"),Rl=()=>globalThis[Ss]===void 0,Ol=t=>async(...e)=>{if(t||ne("DEBUG")==="true"){const[n,i]=e;console.log(` ${i?.method||"GET"} ${n}`)}const r=await(globalThis[Ss]??xl)(...e);return(t||ne("DEBUG")==="true")&&console.log(` ${r.status} ${r.statusText} ${r.url}`),r},Ts=()=>ne("PROJECT")??Ae("LANGCHAIN_SESSION")??"default",Ii={};function Mt(t){Ii[t]||(console.warn(t),Ii[t]=!0)}const v=t=>BigInt(t),Is=v("0x9E3779B1"),As=v("0x85EBCA77"),Cl=v("0xC2B2AE3D"),je=v("0x9E3779B185EBCA87"),Ve=v("0xC2B2AE3D27D4EB4F"),xs=v("0x165667B19E3779F9"),zn=v("0x85EBCA77C2B2AE63"),Nl=v("0x27D4EB2F165667C5"),$l=v("0x165667919E3779F9"),Pl=v("0x9FB21C651E98DF25");function Ll(t){const e=new Uint8Array(t.length/2);for(let r=0;r<t.length;r+=2)e[r/2]=parseInt(t.substring(r,r+2),16);return e}const Te=Ll("b8fe6c3923a44bbe7c01812cf721ad1cded46de9839097db7240a4a4b7b3671fcb79e64eccc0e578825ad07dccff7221b8084674f743248ee03590e6813a264c3c2852bb91c300cb88d0658b1b532ea371644897a20df94e3819ef46a9deacd8a8fa763fe39c343ff9dcbbc7c70b4f1d8a51e04bcdb45931c89f7ec9d9787364eac5ac8334d3ebc3c581a0fffa1363eb170ddd51b7f0da49d316552629d4689e2b16be587d47a1fc8ff8b8d17ad031ce45cb3a8f95160428afd7fbcabb4b407e"),Ye=(v(1)<<v(128))-v(1),U=(v(1)<<v(64))-v(1),Bt=(v(1)<<v(32))-v(1),Re=64,Rs=Re/8,kl=8,St=4;function H(t,e=0){return new Uint8Array(t.buffer,t.byteOffset+e,t.length-e)}function J(t,e=0){return new DataView(t.buffer,t.byteOffset+e).getBigUint64(0,!0)}function Ke(t,e=0){return new DataView(t.buffer,t.byteOffset+e).getUint32(0,!0)}function hr(t,e=0){return t[e]}const Ml=t=>(t&v(255))<<v(56)|(t&v(65280))<<v(40)|(t&v(16711680))<<v(24)|(t&v(4278190080))<<v(8)|(t&v(0xff00000000))>>v(8)|(t&v(0xff0000000000))>>v(24)|(t&v(0xff000000000000))>>v(40)|(t&v(0xff00000000000000))>>v(56),jl=t=>(t=(t&v(65535))<<v(16)|(t&v(4294901760))>>v(16),t=(t&v(16711935))<<v(8)|(t&v(4278255360))>>v(8),t),Dl=(t,e)=>(t&Bt)*(e&Bt)&U,et=t=>{if(!t)throw new Error("Assert failed")};function Ul(t,e){return(t<<e|t>>v(32)-e)&Bt}function Os(t,e,r){for(let n=0;n<Rs;n++){const i=J(e,n*8),a=i^J(r,n*8);t[n^1]+=i,t[n]+=Dl(a,a>>v(32))}return t}function Ai(t,e,r,n){for(let i=0;i<n;i++)Os(t,H(e,i*Re),H(r,i*8));return t}function Fl(t,e){for(let r=0;r<Rs;r++){const n=J(e,r*8);let i=t[r];i=bn(i,v(47)),i^=n,i*=Is,t[r]=i&U}return t}function Tt(t,e){return Cs(t[0]^J(e,0),t[1]^J(e,kl))}function xi(t,e,r){let n=r;return n+=Tt(t.slice(0),H(e,0*St)),n+=Tt(t.slice(2),H(e,4*St)),n+=Tt(t.slice(4),H(e,8*St)),n+=Tt(t.slice(6),H(e,12*St)),Ie(n&U)}function Bl(t,e,r,n,i){const a=Math.floor((r.byteLength-Re)/8),s=Re*a,o=Math.floor((e.byteLength-1)/s);for(let c=0;c<o;c++)t=Ai(t,H(e,c*s),r,a),t=i(t,H(r,r.byteLength-Re));{const c=Math.floor((e.byteLength-1-s*o)/Re);t=Ai(t,H(e,o*s),r,c),t=n(t,H(e,e.byteLength-Re),H(r,r.byteLength-Re-7))}return t}function zl(t,e,r){let n=new BigUint64Array([Cl,je,Ve,xs,zn,As,Nl,Is]);et(t.length>128),n=Bl(n,t,e,Os,Fl),et(n.length*8==64);{const i=xi(n,H(e,11),v(t.byteLength)*je&U);return xi(n,H(e,e.byteLength-Re-11),~(v(t.byteLength)*Ve)&U)<<v(64)|i}}function Cs(t,e){const r=t*e&Ye;return r&U^r>>v(64)}function Ri(t,e,r){return Cs((J(t,0)^J(e,0)+r)&U,(J(t,8)^J(e,8)-r)&U)}function jt(t,e,r,n,i){let a=t&U,s=t>>v(64)&U;return a+=Ri(e,n,i),a^=J(r,0)+J(r,8),a&=U,s+=Ri(r,H(n,16),i),s^=J(e,0)+J(e,8),s&=U,s<<v(64)|a}function Ie(t){return t^=t>>v(37),t*=$l,t&=U,t^=t>>v(32),t}function zt(t){return t^=t>>v(33),t*=Ve,t&=U,t^=t>>v(29),t*=xs,t&=U,t^=t>>v(32),t}function ql(t,e,r){const n=t.byteLength;et(n>0&&n<=3);const i=v(hr(t,n-1))|v(n<<8)|v(hr(t,0)<<16)|v(hr(t,n>>1)<<24),a=(v(Ke(e,0))^v(Ke(e,4)))+r,s=(i^a)&U,o=(v(Ke(e,8))^v(Ke(e,12)))-r,c=(Ul(jl(i),v(13))^o)&U;return(zt(c)&U)<<v(64)|zt(s)}function bn(t,e){return t^t>>e}function Gl(t,e,r){const n=t.byteLength;et(n>=4&&n<=8);{const i=Ke(t,0),a=Ke(t,n-4),s=v(i)|v(a)<<v(32),o=(J(e,16)^J(e,24))+r&U;let l=(s^o)*(je+(v(n)<<v(2)))&Ye;return l+=(l&U)<<v(65),l&=Ye,l^=l>>v(67),bn(bn(l&U,v(35))*Pl&U,v(28))|Ie(l>>v(64))<<v(64)}}function Hl(t,e,r){const n=t.byteLength;et(n>=9&&n<=16);{const i=(J(e,32)^J(e,40))+r&U,a=(J(e,48)^J(e,56))-r&U,s=J(t);let o=J(t,n-8),c=(s^o^i)*je;const l=(c&U)+(v(n-1)<<v(54));c=c&(Ye^U)|l,o^=a,c+=o+(o&Bt)*(As-v(1))<<v(64),c&=Ye,c^=Ml(c>>v(64));let u=(c&U)*Ve;return u+=(c>>v(64))*Ve<<v(64),u&=Ye,Ie(u&U)|Ie(u>>v(64))<<v(64)}}function Vl(t,e){const r=t.byteLength;return et(r<=16),r>8?Hl(t,Te,e):r>=4?Gl(t,Te,e):r>0?ql(t,Te,e):zt(e^J(Te,64)^J(Te,72))|zt(e^J(Te,80)^J(Te,88))<<v(64)}function En(t){return~t+v(1)&U}function Jl(t,e,r){let n=v(t.byteLength)*je&U,i=v(t.byteLength-1)/v(32);for(;i>=0;){const o=Number(i);n=jt(n,H(t,16*o),H(t,t.byteLength-16*(o+1)),H(e,32*o),r),i--}let a=n+(n>>v(64))&U;a=Ie(a);let s=(n&U)*je+(n>>v(64))*zn+(v(t.byteLength)-r&U)*Ve;return s&=U,s=En(Ie(s)),a|s<<v(64)}function Zl(t,e,r){let n=v(t.byteLength)*je&U;for(let s=32;s<160;s+=32)n=jt(n,H(t,s-32),H(t,s-16),H(e,s-32),r);n=Ie(n&U)|Ie(n>>v(64))<<v(64);for(let s=160;s<=t.byteLength;s+=32)n=jt(n,H(t,s-32),H(t,s-16),H(e,3+s-160),r);n=jt(n,H(t,t.byteLength-16),H(t,t.byteLength-32),H(e,103),En(r));let i=n+(n>>v(64))&U;i=Ie(i);let a=(n&U)*je+(n>>v(64))*zn+(v(t.byteLength)-r&U)*Ve;return a&=U,a=En(Ie(a)),i|a<<v(64)}function Kl(t,e=v(0)){const r=t.byteLength;return r<=16?Vl(t,e):r<=128?Jl(t,Te,e):r<=240?Zl(t,Te,e):zl(t,Te)}function Wl(t){const e=new Uint8Array(16),r=new DataView(e.buffer),n=t&U,i=t>>v(64);return r.setBigUint64(0,i,!1),r.setBigUint64(8,n,!1),e}const Ns=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function M(t,e){if(!Ns.test(t)){const r=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(r)}return t}function Xl(t){const e=typeof t=="string"?Date.parse(t):t;return Pe({msecs:e,seq:0})}function Ql(t){if(!Ns.test(t))return null;const e=t[14];return parseInt(e,16)}function Yl(t){const e=t.replace(/-/g,""),r=new Uint8Array(16);for(let n=0;n<16;n++)r[n]=parseInt(e.slice(n*2,n*2+2),16);return r}function eu(t){const e=Array.from(t).map(r=>r.toString(16).padStart(2,"0")).join("");return`${e.slice(0,8)}-${e.slice(8,12)}-${e.slice(12,16)}-${e.slice(16,20)}-${e.slice(20)}`}const tu=new TextEncoder;function ru(t){const e=tu.encode(t),r=Kl(e);return Wl(r)}function It(t,e){const r=`${t}:${e}`,n=ru(r),i=new Uint8Array(16);if(Ql(t)===7){const s=Yl(t);i.set(s.slice(0,6),0)}else{const s=Date.now();i[0]=s/1099511627776&255,i[1]=s/4294967296&255,i[2]=s/16777216&255,i[3]=s/65536&255,i[4]=s/256&255,i[5]=s&255}return i[6]=112|n[0]&15,i[7]=n[1],i[8]=128|n[2]&63,i.set(n.slice(3,10),9),eu(i)}function nu(t,e){throw new Error("dump() is not supported in browser environments.")}function iu(t){throw new Error("load() is not supported in browser environments.")}function au(t,e){return e===null?!1:Date.now()-t.createdAt>e*1e3}class su{constructor(e={}){Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"maxSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ttlSeconds",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"refreshIntervalSeconds",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"refreshTimer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_metrics",{enumerable:!0,configurable:!0,writable:!0,value:{hits:0,misses:0,refreshes:0,refreshErrors:0}}),this.configure(e)}get metrics(){return{...this._metrics}}get totalRequests(){return this._metrics.hits+this._metrics.misses}get hitRate(){const e=this.totalRequests;return e>0?this._metrics.hits/e:0}resetMetrics(){this._metrics={hits:0,misses:0,refreshes:0,refreshErrors:0}}get(e,r){if(this.maxSize===0)return;const n=this.cache.get(e);if(!n){this._metrics.misses+=1;return}return this.cache.delete(e),this.cache.set(e,{...n,refreshFunc:r}),this._metrics.hits+=1,n.value}set(e,r,n){if(this.maxSize===0)return;if(this.refreshTimer===void 0&&this.startRefreshLoop(),!this.cache.has(e)&&this.cache.size>=this.maxSize){const a=this.cache.keys().next().value;a!==void 0&&this.cache.delete(a)}const i={value:r,createdAt:Date.now(),refreshFunc:n};this.cache.delete(e),this.cache.set(e,i)}invalidate(e){this.cache.delete(e)}clear(){this.cache.clear()}get size(){return this.cache.size}stop(){this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=void 0)}dump(e){for(const[r,n]of this.cache.entries())n.value;nu()}load(e){const r=iu();if(!r)return 0;let n=0;const i=Date.now();for(const[a,s]of Object.entries(r)){if(this.cache.size>=this.maxSize)break;const o={value:s,createdAt:i};this.cache.set(a,o),n+=1}return n}startRefreshLoop(){this.stop(),this.ttlSeconds!==null&&(this.refreshTimer=setInterval(()=>{this.refreshStaleEntries().catch(e=>{console.warn("Unexpected error in cache refresh loop:",e)})},this.refreshIntervalSeconds*1e3),this.refreshTimer.unref&&this.refreshTimer.unref())}getStaleEntries(){const e=[];for(const[r,n]of this.cache.entries())au(n,this.ttlSeconds)&&e.push([r,n]);return e}async refreshStaleEntries(){const e=this.getStaleEntries();if(e.length!==0){for(const[r,n]of e)if(n.refreshFunc!==void 0)try{const i=await n.refreshFunc();this.set(r,i,n.refreshFunc),this._metrics.refreshes+=1}catch(i){this._metrics.refreshErrors+=1,console.warn(`Failed to refresh cache entry ${r}:`,i)}}}configure(e){this.stop(),this.refreshIntervalSeconds=e.refreshIntervalSeconds??60,this.maxSize=e.maxSize??100,this.ttlSeconds=e.ttlSeconds??300}}const Oi=new su,$s="0.5.6";var Sn={};let Se;const ou=()=>typeof window<"u"&&typeof window.document<"u",cu=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",lu=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Ps=()=>typeof Deno<"u",uu=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Ps(),Ls=()=>Se||(typeof Bun<"u"?Se="bun":ou()?Se="browser":uu()?Se="node":cu()?Se="webworker":lu()?Se="jsdom":Ps()?Se="deno":Se="other",Se);let fr;function ks(){if(fr===void 0){const t=Ls(),e=hu();fr={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:$s,...e}}return fr}function Ms(){const t=du(),e={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,i]of Object.entries(t))typeof i=="string"&&!r.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=i:e[n]=i);return e}function du(){const t={};try{if(typeof process<"u"&&Sn)for(const[e,r]of Object.entries(Sn))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&r!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof r=="string"?t[e]=r.slice(0,2)+"*".repeat(r.length-4)+r.slice(-2):t[e]=r)}catch{}return t}function Ae(t){try{return typeof process<"u"?Sn?.[t]:void 0}catch{return}}function ne(t){return Ae(`LANGSMITH_${t}`)||Ae(`LANGCHAIN_${t}`)}let pr;function hu(){if(pr!==void 0)return pr;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const r of t){const n=Ae(r);n!==void 0&&(e[r]=n)}return pr=e,e}function js(){return Ae("OTEL_ENABLED")==="true"||ne("OTEL_ENABLED")==="true"}class fu{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...r){!this.hasWarned&&js()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(r.length===1&&typeof r[0]=="function"?n=r[0]:r.length===2&&typeof r[1]=="function"?n=r[1]:r.length===3&&typeof r[2]=="function"&&(n=r[2]),typeof n=="function")return n()}}class pu{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new fu})}getTracer(e,r){return this.mockTracer}getActiveSpan(){}setSpan(e,r){return e}getSpan(e){}setSpanContext(e,r){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class mu{active(){return{}}with(e,r){return r()}}const mr=Symbol.for("ls:otel_trace"),gr=Symbol.for("ls:otel_context"),Ci=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),gu=new pu,_u=new mu;class yu{getTraceInstance(){return globalThis[mr]??gu}getContextInstance(){return globalThis[gr]??_u}initializeGlobalInstances(e){globalThis[mr]===void 0&&(globalThis[mr]=e.trace),globalThis[gr]===void 0&&(globalThis[gr]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[Ci]=e}getDefaultOTLPTracerComponents(){return globalThis[Ci]??void 0}}const qn=new yu;function Ds(){return qn.getTraceInstance()}function wu(){return qn.getContextInstance()}function vu(){return qn.getDefaultOTLPTracerComponents()}const bu={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function Eu(t){return bu[t]||t}class Su{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,r){for(const n of e)try{if(!n.run)continue;if(n.operation==="post"){const i=this.createSpanForRun(n,n.run,r.get(n.id));i&&!n.run.end_time&&this.spans.set(n.id,i)}else this.updateSpanForRun(n,n.run)}catch(i){console.error(`Error processing operation ${n.id}:`,i)}}createSpanForRun(e,r,n){const i=n&&Ds().getSpan(n);if(i)try{return this.finishSpanSetup(i,r,e)}catch(a){console.error(`Failed to create span for run ${e.id}:`,a);return}}finishSpanSetup(e,r,n){return this.setSpanAttributes(e,r,n),r.error?(e.setStatus({code:2}),e.recordException(new Error(r.error))):e.setStatus({code:1}),r.end_time&&e.end(new Date(r.end_time)),e}updateSpanForRun(e,r){try{const n=this.spans.get(e.id);if(!n){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(n,r,e),r.error?(n.setStatus({code:2}),n.recordException(new Error(r.error))):n.setStatus({code:1});const i=r.end_time;i&&(n.end(new Date(i)),this.spans.delete(e.id))}catch(n){console.error(`Failed to update span for run ${e.id}:`,n)}}extractModelName(e){if(e.extra?.metadata){const r=e.extra.metadata;if(r.ls_model_name)return r.ls_model_name;if(r.invocation_params){const n=r.invocation_params;if(n.model)return n.model;if(n.model_name)return n.model_name}}}setSpanAttributes(e,r,n){if("run_type"in r&&r.run_type){e.setAttribute(El,r.run_type);const o=Eu(r.run_type||"chain");e.setAttribute(Yc,o)}"name"in r&&r.name&&e.setAttribute(Sl,r.name),"session_id"in r&&r.session_id&&e.setAttribute(vl,r.session_id),"session_name"in r&&r.session_name&&e.setAttribute(bl,r.session_name),this.setGenAiSystem(e,r);const i=this.extractModelName(r);i&&e.setAttribute(vi,i),"prompt_tokens"in r&&typeof r.prompt_tokens=="number"&&e.setAttribute(bi,r.prompt_tokens),"completion_tokens"in r&&typeof r.completion_tokens=="number"&&e.setAttribute(Ei,r.completion_tokens),"total_tokens"in r&&typeof r.total_tokens=="number"&&e.setAttribute(Si,r.total_tokens),this.setInvocationParameters(e,r);const a=r.extra?.metadata||{};for(const[o,c]of Object.entries(a))c!=null&&e.setAttribute(`${Tl}.${o}`,String(c));const s=r.tags;if(s&&Array.isArray(s)?e.setAttribute(Ti,s.join(", ")):s&&e.setAttribute(Ti,String(s)),"serialized"in r&&typeof r.serialized=="object"){const o=r.serialized;o.name&&e.setAttribute(hl,String(o.name)),o.signature&&e.setAttribute(fl,String(o.signature)),o.doc&&e.setAttribute(pl,String(o.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,r){let n="langchain";const i=this.extractModelName(r);if(i){const a=i.toLowerCase();a.includes("anthropic")||a.startsWith("claude")?n="anthropic":a.includes("bedrock")?n="aws.bedrock":a.includes("azure")&&a.includes("openai")?n="az.ai.openai":a.includes("azure")&&a.includes("inference")?n="az.ai.inference":a.includes("cohere")?n="cohere":a.includes("deepseek")?n="deepseek":a.includes("gemini")?n="gemini":a.includes("groq")?n="groq":a.includes("watson")||a.includes("ibm")?n="ibm.watsonx.ai":a.includes("mistral")?n="mistral_ai":a.includes("gpt")||a.includes("openai")?n="openai":a.includes("perplexity")||a.includes("sonar")?n="perplexity":a.includes("vertex")?n="vertex_ai":(a.includes("xai")||a.includes("grok"))&&(n="xai")}e.setAttribute(el,n)}setInvocationParameters(e,r){if(!r.extra?.metadata?.invocation_params)return;const n=r.extra.metadata.invocation_params;n.max_tokens!==void 0&&e.setAttribute(rl,n.max_tokens),n.temperature!==void 0&&e.setAttribute(nl,n.temperature),n.top_p!==void 0&&e.setAttribute(il,n.top_p),n.frequency_penalty!==void 0&&e.setAttribute(al,n.frequency_penalty),n.presence_penalty!==void 0&&e.setAttribute(sl,n.presence_penalty)}setIOAttributes(e,r){if(r.run.inputs)try{const n=r.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(vi,n.model),n.stream!==void 0&&e.setAttribute(Il,n.stream),n.extra_headers&&e.setAttribute(Al,JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute(ul,JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute(dl,JSON.stringify(n.extra_body))),e.setAttribute(cl,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${r.id}`,n)}if(r.run.outputs)try{const n=r.run.outputs,i=this.getUnifiedRunTokens(n);if(i&&(e.setAttribute(bi,i[0]),e.setAttribute(Ei,i[1]),e.setAttribute(Si,i[0]+i[1])),n&&typeof n=="object"){if(n.model&&e.setAttribute(tl,String(n.model)),n.id&&e.setAttribute(ml,n.id),n.choices&&Array.isArray(n.choices)){const a=n.choices.map(s=>s.finish_reason).filter(s=>s).map(String);a.length>0&&e.setAttribute(ol,a.join(", "))}if(n.service_tier&&e.setAttribute(gl,n.service_tier),n.system_fingerprint&&e.setAttribute(_l,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){const a=n.usage_metadata;a.input_token_details&&e.setAttribute(yl,JSON.stringify(a.input_token_details)),a.output_token_details&&e.setAttribute(wl,JSON.stringify(a.output_token_details))}}e.setAttribute(ll,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${r.id}`,n)}}getUnifiedRunTokens(e){if(!e)return null;let r=this.extractUnifiedRunTokens(e.usage_metadata);if(r)return r;const n=Object.keys(e);for(const s of n){const o=e[s];if(!(!o||typeof o!="object")&&(r=this.extractUnifiedRunTokens(o.usage_metadata),r||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(r=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),r)))return r}const i=e.generations||[];if(!Array.isArray(i))return null;const a=Array.isArray(i[0])?i.flat():i;for(const s of a)if(typeof s=="object"&&s.message&&typeof s.message=="object"&&s.message.kwargs&&typeof s.message.kwargs=="object"&&(r=this.extractUnifiedRunTokens(s.message.kwargs.usage_metadata),r))return r;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}const Tu=Object.prototype.toString,Iu=t=>Tu.call(t)==="[object Error]",Au=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function xu(t){if(!(t&&Iu(t)&&t.name==="TypeError"&&typeof t.message=="string"))return!1;const{message:r,stack:n}=t;return r==="Load failed"?n===void 0||"__sentry_captured__"in t:r.startsWith("error sending request for url")?!0:Au.has(r)}function Ru(t){if(typeof t=="number"){if(t<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(t))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(t!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function At(t,e,{min:r=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${t}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${t}\` to be a finite number.`);if(e<r)throw new TypeError(`Expected \`${t}\` to be  ${r}.`)}}let Ou=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};function Cu(t,e){const r=Math.max(1,t+1),n=e.randomize?Math.random()+1:1;let i=Math.round(n*e.minTimeout*e.factor**(r-1));return i=Math.min(i,e.maxTimeout),i}function Ni(t,e){return Number.isFinite(e)?e-(performance.now()-t):e}async function Nu({error:t,attemptNumber:e,retriesConsumed:r,startTime:n,options:i}){const a=t instanceof Error?t:new TypeError(`Non-error was thrown: "${t}". You should only throw errors.`);if(a instanceof Ou)throw a.originalError;const s=Number.isFinite(i.retries)?Math.max(0,i.retries-r):i.retries,o=i.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:a,attemptNumber:e,retriesLeft:s,retriesConsumed:r});if(await i.onFailedAttempt(c),Ni(n,o)<=0)throw a;const l=await i.shouldConsumeRetry(c),u=Ni(n,o);if(u<=0||s<=0)throw a;if(a instanceof TypeError&&!xu(a)){if(l)throw a;return i.signal?.throwIfAborted(),!1}if(!await i.shouldRetry(c))throw a;if(!l)return i.signal?.throwIfAborted(),!1;const d=Cu(r,i),h=Math.min(d,u);return h>0&&await new Promise((f,p)=>{const m=()=>{clearTimeout(g),i.signal?.removeEventListener("abort",m),p(i.signal.reason)},g=setTimeout(()=>{i.signal?.removeEventListener("abort",m),f()},h);i.unref&&g.unref?.(),i.signal?.addEventListener("abort",m,{once:!0})}),i.signal?.throwIfAborted(),!0}async function $u(t,e={}){if(e={...e},Ru(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,At("factor",e.factor,{min:0,allowInfinity:!1}),At("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),At("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),At("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let r=0,n=0;const i=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){r++;try{e.signal?.throwIfAborted();const a=await t(r);return e.signal?.throwIfAborted(),a}catch(a){await Nu({error:a,attemptNumber:r,retriesConsumed:n,startTime:i,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var xt={},_r={exports:{}},$i;function Pu(){return $i||($i=1,(function(t){var e=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function i(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function a(c,l,u,d,h){if(typeof u!="function")throw new TypeError("The listener must be a function");var f=new i(u,d||c,h),p=r?r+l:l;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],f]:c._events[p].push(f):(c._events[p]=f,c._eventsCount++),c}function s(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function o(){this._events=new n,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],u,d;if(this._eventsCount===0)return l;for(d in u=this._events)e.call(u,d)&&l.push(r?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},o.prototype.listeners=function(l){var u=r?r+l:l,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,p=new Array(f);h<f;h++)p[h]=d[h].fn;return p},o.prototype.listenerCount=function(l){var u=r?r+l:l,d=this._events[u];return d?d.fn?1:d.length:0},o.prototype.emit=function(l,u,d,h,f,p){var m=r?r+l:l;if(!this._events[m])return!1;var g=this._events[m],_=arguments.length,w,y;if(g.fn){switch(g.once&&this.removeListener(l,g.fn,void 0,!0),_){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,u),!0;case 3:return g.fn.call(g.context,u,d),!0;case 4:return g.fn.call(g.context,u,d,h),!0;case 5:return g.fn.call(g.context,u,d,h,f),!0;case 6:return g.fn.call(g.context,u,d,h,f,p),!0}for(y=1,w=new Array(_-1);y<_;y++)w[y-1]=arguments[y];g.fn.apply(g.context,w)}else{var E=g.length,S;for(y=0;y<E;y++)switch(g[y].once&&this.removeListener(l,g[y].fn,void 0,!0),_){case 1:g[y].fn.call(g[y].context);break;case 2:g[y].fn.call(g[y].context,u);break;case 3:g[y].fn.call(g[y].context,u,d);break;case 4:g[y].fn.call(g[y].context,u,d,h);break;default:if(!w)for(S=1,w=new Array(_-1);S<_;S++)w[S-1]=arguments[S];g[y].fn.apply(g[y].context,w)}}return!0},o.prototype.on=function(l,u,d){return a(this,l,u,d,!1)},o.prototype.once=function(l,u,d){return a(this,l,u,d,!0)},o.prototype.removeListener=function(l,u,d,h){var f=r?r+l:l;if(!this._events[f])return this;if(!u)return s(this,f),this;var p=this._events[f];if(p.fn)p.fn===u&&(!h||p.once)&&(!d||p.context===d)&&s(this,f);else{for(var m=0,g=[],_=p.length;m<_;m++)(p[m].fn!==u||h&&!p[m].once||d&&p[m].context!==d)&&g.push(p[m]);g.length?this._events[f]=g.length===1?g[0]:g:s(this,f)}return this},o.prototype.removeAllListeners=function(l){var u;return l?(u=r?r+l:l,this._events[u]&&s(this,u)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,t.exports=o})(_r)),_r.exports}var st={exports:{}},yr,Pi;function Lu(){return Pi||(Pi=1,yr=(t,e)=>(e=e||(()=>{}),t.then(r=>new Promise(n=>{n(e())}).then(()=>r),r=>new Promise(n=>{n(e())}).then(()=>{throw r})))),yr}var Li;function ku(){if(Li)return st.exports;Li=1;const t=Lu();class e extends Error{constructor(i){super(i),this.name="TimeoutError"}}const r=(n,i,a)=>new Promise((s,o)=>{if(typeof i!="number"||i<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(i===1/0){s(n);return}const c=setTimeout(()=>{if(typeof a=="function"){try{s(a())}catch(d){o(d)}return}const l=typeof a=="string"?a:`Promise timed out after ${i} milliseconds`,u=a instanceof Error?a:new e(l);typeof n.cancel=="function"&&n.cancel(),o(u)},i);t(n.then(s,o),()=>{clearTimeout(c)})});return st.exports=r,st.exports.default=r,st.exports.TimeoutError=e,st.exports}var Rt={},Ot={},ki;function Mu(){if(ki)return Ot;ki=1,Object.defineProperty(Ot,"__esModule",{value:!0});function t(e,r,n){let i=0,a=e.length;for(;a>0;){const s=a/2|0;let o=i+s;n(e[o],r)<=0?(i=++o,a-=s+1):a=s}return i}return Ot.default=t,Ot}var Mi;function ju(){if(Mi)return Rt;Mi=1,Object.defineProperty(Rt,"__esModule",{value:!0});const t=Mu();class e{constructor(){this._queue=[]}enqueue(n,i){i=Object.assign({priority:0},i);const a={priority:i.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=i.priority){this._queue.push(a);return}const s=t.default(this._queue,a,(o,c)=>c.priority-o.priority);this._queue.splice(s,0,a)}dequeue(){const n=this._queue.shift();return n?.run}filter(n){return this._queue.filter(i=>i.priority===n.priority).map(i=>i.run)}get size(){return this._queue.length}}return Rt.default=e,Rt}var ji;function Du(){if(ji)return xt;ji=1,Object.defineProperty(xt,"__esModule",{value:!0});const t=Pu(),e=ku(),r=ju(),n=()=>{},i=new e.TimeoutError;class a extends t{constructor(o){var c,l,u,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=n,this._resolveIdle=n,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(l=(c=o.intervalCap)===null||c===void 0?void 0:c.toString())!==null&&l!==void 0?l:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(u=o.interval)===null||u===void 0?void 0:u.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=n,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=n,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const c=this._intervalEnd-o;if(c<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},c)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const c=this._queue.dequeue();return c?(this.emit("active"),c(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,c={}){return new Promise((l,u)=>{const d=async()=>{this._pendingCount++,this._intervalCount++;try{const h=this._timeout===void 0&&c.timeout===void 0?o():e.default(Promise.resolve(o()),c.timeout===void 0?this._timeout:c.timeout,()=>{(c.throwOnTimeout===void 0?this._throwOnTimeout:c.throwOnTimeout)&&u(i)});l(await h)}catch(h){u(h)}this._next()};this._queue.enqueue(d,c),this._tryToStartAnother(),this.emit("add")})}async addAll(o,c){return Promise.all(o.map(async l=>this.add(l,c)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const c=this._resolveEmpty;this._resolveEmpty=()=>{c(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const c=this._resolveIdle;this._resolveIdle=()=>{c(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return xt.default=a,xt}var Uu=Du();const Oe=Xt(Uu),Fu="default"in Oe?Oe.default:Oe,Bu=[408,425,429,500,502,503,504];let Di=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxQueueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.maxQueueSizeBytes=e.maxQueueSizeBytes,this.queue=new Fu({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...r){return this.callWithOptions({},e,...r)}callWithOptions(e,r,...n){const i=e.sizeBytes??0;if(this.maxQueueSizeBytes!==void 0&&i>0&&this.queueSizeBytes+i>this.maxQueueSizeBytes)return Promise.reject(new Error(`Queue size limit (${this.maxQueueSizeBytes} bytes) exceeded. Current queue size: ${this.queueSizeBytes} bytes, attempted addition: ${i} bytes.`));i>0&&(this.queueSizeBytes+=i);const a=this.onFailedResponseHook;let s=this.queue.add(()=>$u(()=>r(...n).catch(o=>{throw o instanceof Error?o:new Error(o)}),{async onFailedAttempt({error:o}){if(typeof o!="object"||o==null)throw o;const c="message"in o&&typeof o.message=="string"?o.message:void 0;if(c?.startsWith("Cancel")||c?.startsWith("TimeoutError")||c?.startsWith("AbortError")||"name"in o&&o.name==="TimeoutError"||"code"in o&&o.code==="ECONNABORTED")throw o;const l="response"in o?o.response:void 0;if(a&&await a(l))return;const u=l?.status??("status"in o?o.status:void 0);if(u!=null&&(typeof u=="number"||typeof u=="string")&&!Bu.includes(+u))throw o},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0});return i>0&&(s=s.finally(()=>{this.queueSizeBytes-=i})),e.signal?Promise.race([s,new Promise((o,c)=>{e.signal?.addEventListener("abort",()=>{c(new Error("AbortError"))})})]):s}};function Ui(t){return typeof t?._getType=="function"}function Fi(t){const e={type:t._getType(),data:{content:t.content}};return t?.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}var Ct={exports:{}},wr,Bi;function er(){if(Bi)return wr;Bi=1;const t="2.0.0",e=256,r=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,i=e-6;return wr={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:i,MAX_SAFE_INTEGER:r,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:t,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},wr}var vr,zi;function tr(){if(zi)return vr;zi=1;var t={};return vr=typeof process=="object"&&t&&t.NODE_DEBUG&&/\bsemver\b/i.test(t.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{},vr}var qi;function wt(){return qi||(qi=1,(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:i}=er(),a=tr();e=t.exports={};const s=e.re=[],o=e.safeRe=[],c=e.src=[],l=e.safeSrc=[],u=e.t={};let d=0;const h="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",i],[h,n]],p=g=>{for(const[_,w]of f)g=g.split(`${_}*`).join(`${_}{0,${w}}`).split(`${_}+`).join(`${_}{1,${w}}`);return g},m=(g,_,w)=>{const y=p(_),E=d++;a(g,E,_),u[g]=E,c[E]=_,l[E]=y,s[E]=new RegExp(_,w?"g":void 0),o[E]=new RegExp(y,w?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),m("MAINVERSION",`(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${c[u.NONNUMERICIDENTIFIER]}|${c[u.NUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${c[u.NONNUMERICIDENTIFIER]}|${c[u.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASE",`(?:-(${c[u.PRERELEASEIDENTIFIER]}(?:\\.${c[u.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${c[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[u.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${h}+`),m("BUILD",`(?:\\+(${c[u.BUILDIDENTIFIER]}(?:\\.${c[u.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${c[u.MAINVERSION]}${c[u.PRERELEASE]}?${c[u.BUILD]}?`),m("FULL",`^${c[u.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${c[u.MAINVERSIONLOOSE]}${c[u.PRERELEASELOOSE]}?${c[u.BUILD]}?`),m("LOOSE",`^${c[u.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${c[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${c[u.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:${c[u.PRERELEASE]})?${c[u.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:${c[u.PRERELEASELOOSE]})?${c[u.BUILD]}?)?)?`),m("XRANGE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),m("COERCE",`${c[u.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",c[u.COERCEPLAIN]+`(?:${c[u.PRERELEASE]})?(?:${c[u.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",c[u.COERCE],!0),m("COERCERTLFULL",c[u.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${c[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",m("TILDE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${c[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",m("CARET",`^${c[u.LONECARET]}${c[u.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${c[u.LONECARET]}${c[u.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${c[u.GTLT]}\\s*(${c[u.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]}|${c[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${c[u.XRANGEPLAIN]})\\s+-\\s+(${c[u.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${c[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[u.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Ct,Ct.exports)),Ct.exports}var br,Gi;function Gn(){if(Gi)return br;Gi=1;const t=Object.freeze({loose:!0}),e=Object.freeze({});return br=n=>n?typeof n!="object"?t:n:e,br}var Er,Hi;function Us(){if(Hi)return Er;Hi=1;const t=/^[0-9]+$/,e=(n,i)=>{if(typeof n=="number"&&typeof i=="number")return n===i?0:n<i?-1:1;const a=t.test(n),s=t.test(i);return a&&s&&(n=+n,i=+i),n===i?0:a&&!s?-1:s&&!a?1:n<i?-1:1};return Er={compareIdentifiers:e,rcompareIdentifiers:(n,i)=>e(i,n)},Er}var Sr,Vi;function ae(){if(Vi)return Sr;Vi=1;const t=tr(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:r}=er(),{safeRe:n,t:i}=wt(),a=Gn(),{compareIdentifiers:s}=Us();class o{constructor(l,u){if(u=a(u),l instanceof o){if(l.loose===!!u.loose&&l.includePrerelease===!!u.includePrerelease)return l;l=l.version}else if(typeof l!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof l}".`);if(l.length>e)throw new TypeError(`version is longer than ${e} characters`);t("SemVer",l,u),this.options=u,this.loose=!!u.loose,this.includePrerelease=!!u.includePrerelease;const d=l.trim().match(u.loose?n[i.LOOSE]:n[i.FULL]);if(!d)throw new TypeError(`Invalid Version: ${l}`);if(this.raw=l,this.major=+d[1],this.minor=+d[2],this.patch=+d[3],this.major>r||this.major<0)throw new TypeError("Invalid major version");if(this.minor>r||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>r||this.patch<0)throw new TypeError("Invalid patch version");d[4]?this.prerelease=d[4].split(".").map(h=>{if(/^[0-9]+$/.test(h)){const f=+h;if(f>=0&&f<r)return f}return h}):this.prerelease=[],this.build=d[5]?d[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(l){if(t("SemVer.compare",this.version,this.options,l),!(l instanceof o)){if(typeof l=="string"&&l===this.version)return 0;l=new o(l,this.options)}return l.version===this.version?0:this.compareMain(l)||this.comparePre(l)}compareMain(l){return l instanceof o||(l=new o(l,this.options)),this.major<l.major?-1:this.major>l.major?1:this.minor<l.minor?-1:this.minor>l.minor?1:this.patch<l.patch?-1:this.patch>l.patch?1:0}comparePre(l){if(l instanceof o||(l=new o(l,this.options)),this.prerelease.length&&!l.prerelease.length)return-1;if(!this.prerelease.length&&l.prerelease.length)return 1;if(!this.prerelease.length&&!l.prerelease.length)return 0;let u=0;do{const d=this.prerelease[u],h=l.prerelease[u];if(t("prerelease compare",u,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return s(d,h)}while(++u)}compareBuild(l){l instanceof o||(l=new o(l,this.options));let u=0;do{const d=this.build[u],h=l.build[u];if(t("build compare",u,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return s(d,h)}while(++u)}inc(l,u,d){if(l.startsWith("pre")){if(!u&&d===!1)throw new Error("invalid increment argument: identifier is empty");if(u){const h=`-${u}`.match(this.options.loose?n[i.PRERELEASELOOSE]:n[i.PRERELEASE]);if(!h||h[1]!==u)throw new Error(`invalid identifier: ${u}`)}}switch(l){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",u,d);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",u,d);break;case"prepatch":this.prerelease.length=0,this.inc("patch",u,d),this.inc("pre",u,d);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",u,d),this.inc("pre",u,d);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const h=Number(d)?1:0;if(this.prerelease.length===0)this.prerelease=[h];else{let f=this.prerelease.length;for(;--f>=0;)typeof this.prerelease[f]=="number"&&(this.prerelease[f]++,f=-2);if(f===-1){if(u===this.prerelease.join(".")&&d===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(h)}}if(u){let f=[u,h];d===!1&&(f=[u]),s(this.prerelease[0],u)===0?isNaN(this.prerelease[1])&&(this.prerelease=f):this.prerelease=f}break}default:throw new Error(`invalid increment argument: ${l}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return Sr=o,Sr}var Tr,Ji;function rt(){if(Ji)return Tr;Ji=1;const t=ae();return Tr=(r,n,i=!1)=>{if(r instanceof t)return r;try{return new t(r,n)}catch(a){if(!i)return null;throw a}},Tr}var Ir,Zi;function zu(){if(Zi)return Ir;Zi=1;const t=rt();return Ir=(r,n)=>{const i=t(r,n);return i?i.version:null},Ir}var Ar,Ki;function qu(){if(Ki)return Ar;Ki=1;const t=rt();return Ar=(r,n)=>{const i=t(r.trim().replace(/^[=v]+/,""),n);return i?i.version:null},Ar}var xr,Wi;function Gu(){if(Wi)return xr;Wi=1;const t=ae();return xr=(r,n,i,a,s)=>{typeof i=="string"&&(s=a,a=i,i=void 0);try{return new t(r instanceof t?r.version:r,i).inc(n,a,s).version}catch{return null}},xr}var Rr,Xi;function Hu(){if(Xi)return Rr;Xi=1;const t=rt();return Rr=(r,n)=>{const i=t(r,null,!0),a=t(n,null,!0),s=i.compare(a);if(s===0)return null;const o=s>0,c=o?i:a,l=o?a:i,u=!!c.prerelease.length;if(!!l.prerelease.length&&!u){if(!l.patch&&!l.minor)return"major";if(l.compareMain(c)===0)return l.minor&&!l.patch?"minor":"patch"}const h=u?"pre":"";return i.major!==a.major?h+"major":i.minor!==a.minor?h+"minor":i.patch!==a.patch?h+"patch":"prerelease"},Rr}var Or,Qi;function Vu(){if(Qi)return Or;Qi=1;const t=ae();return Or=(r,n)=>new t(r,n).major,Or}var Cr,Yi;function Ju(){if(Yi)return Cr;Yi=1;const t=ae();return Cr=(r,n)=>new t(r,n).minor,Cr}var Nr,ea;function Zu(){if(ea)return Nr;ea=1;const t=ae();return Nr=(r,n)=>new t(r,n).patch,Nr}var $r,ta;function Ku(){if(ta)return $r;ta=1;const t=rt();return $r=(r,n)=>{const i=t(r,n);return i&&i.prerelease.length?i.prerelease:null},$r}var Pr,ra;function ve(){if(ra)return Pr;ra=1;const t=ae();return Pr=(r,n,i)=>new t(r,i).compare(new t(n,i)),Pr}var Lr,na;function Wu(){if(na)return Lr;na=1;const t=ve();return Lr=(r,n,i)=>t(n,r,i),Lr}var kr,ia;function Xu(){if(ia)return kr;ia=1;const t=ve();return kr=(r,n)=>t(r,n,!0),kr}var Mr,aa;function Hn(){if(aa)return Mr;aa=1;const t=ae();return Mr=(r,n,i)=>{const a=new t(r,i),s=new t(n,i);return a.compare(s)||a.compareBuild(s)},Mr}var jr,sa;function Qu(){if(sa)return jr;sa=1;const t=Hn();return jr=(r,n)=>r.sort((i,a)=>t(i,a,n)),jr}var Dr,oa;function Yu(){if(oa)return Dr;oa=1;const t=Hn();return Dr=(r,n)=>r.sort((i,a)=>t(a,i,n)),Dr}var Ur,ca;function rr(){if(ca)return Ur;ca=1;const t=ve();return Ur=(r,n,i)=>t(r,n,i)>0,Ur}var Fr,la;function Vn(){if(la)return Fr;la=1;const t=ve();return Fr=(r,n,i)=>t(r,n,i)<0,Fr}var Br,ua;function Fs(){if(ua)return Br;ua=1;const t=ve();return Br=(r,n,i)=>t(r,n,i)===0,Br}var zr,da;function Bs(){if(da)return zr;da=1;const t=ve();return zr=(r,n,i)=>t(r,n,i)!==0,zr}var qr,ha;function Jn(){if(ha)return qr;ha=1;const t=ve();return qr=(r,n,i)=>t(r,n,i)>=0,qr}var Gr,fa;function Zn(){if(fa)return Gr;fa=1;const t=ve();return Gr=(r,n,i)=>t(r,n,i)<=0,Gr}var Hr,pa;function zs(){if(pa)return Hr;pa=1;const t=Fs(),e=Bs(),r=rr(),n=Jn(),i=Vn(),a=Zn();return Hr=(o,c,l,u)=>{switch(c){case"===":return typeof o=="object"&&(o=o.version),typeof l=="object"&&(l=l.version),o===l;case"!==":return typeof o=="object"&&(o=o.version),typeof l=="object"&&(l=l.version),o!==l;case"":case"=":case"==":return t(o,l,u);case"!=":return e(o,l,u);case">":return r(o,l,u);case">=":return n(o,l,u);case"<":return i(o,l,u);case"<=":return a(o,l,u);default:throw new TypeError(`Invalid operator: ${c}`)}},Hr}var Vr,ma;function ed(){if(ma)return Vr;ma=1;const t=ae(),e=rt(),{safeRe:r,t:n}=wt();return Vr=(a,s)=>{if(a instanceof t)return a;if(typeof a=="number"&&(a=String(a)),typeof a!="string")return null;s=s||{};let o=null;if(!s.rtl)o=a.match(s.includePrerelease?r[n.COERCEFULL]:r[n.COERCE]);else{const f=s.includePrerelease?r[n.COERCERTLFULL]:r[n.COERCERTL];let p;for(;(p=f.exec(a))&&(!o||o.index+o[0].length!==a.length);)(!o||p.index+p[0].length!==o.index+o[0].length)&&(o=p),f.lastIndex=p.index+p[1].length+p[2].length;f.lastIndex=-1}if(o===null)return null;const c=o[2],l=o[3]||"0",u=o[4]||"0",d=s.includePrerelease&&o[5]?`-${o[5]}`:"",h=s.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${c}.${l}.${u}${d}${h}`,s)},Vr}var Jr,ga;function td(){if(ga)return Jr;ga=1;class t{constructor(){this.max=1e3,this.map=new Map}get(r){const n=this.map.get(r);if(n!==void 0)return this.map.delete(r),this.map.set(r,n),n}delete(r){return this.map.delete(r)}set(r,n){if(!this.delete(r)&&n!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(r,n)}return this}}return Jr=t,Jr}var Zr,_a;function be(){if(_a)return Zr;_a=1;const t=/\s+/g;class e{constructor(T,$){if($=i($),T instanceof e)return T.loose===!!$.loose&&T.includePrerelease===!!$.includePrerelease?T:new e(T.raw,$);if(T instanceof a)return this.raw=T.value,this.set=[[T]],this.formatted=void 0,this;if(this.options=$,this.loose=!!$.loose,this.includePrerelease=!!$.includePrerelease,this.raw=T.trim().replace(t," "),this.set=this.raw.split("||").map(O=>this.parseRange(O.trim())).filter(O=>O.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const O=this.set[0];if(this.set=this.set.filter(P=>!m(P[0])),this.set.length===0)this.set=[O];else if(this.set.length>1){for(const P of this.set)if(P.length===1&&g(P[0])){this.set=[P];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let T=0;T<this.set.length;T++){T>0&&(this.formatted+="||");const $=this.set[T];for(let O=0;O<$.length;O++)O>0&&(this.formatted+=" "),this.formatted+=$[O].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(T){const O=((this.options.includePrerelease&&f)|(this.options.loose&&p))+":"+T,P=n.get(O);if(P)return P;const C=this.options.loose,j=C?c[l.HYPHENRANGELOOSE]:c[l.HYPHENRANGE];T=T.replace(j,Ce(this.options.includePrerelease)),s("hyphen replace",T),T=T.replace(c[l.COMPARATORTRIM],u),s("comparator trim",T),T=T.replace(c[l.TILDETRIM],d),s("tilde trim",T),T=T.replace(c[l.CARETTRIM],h),s("caret trim",T);let z=T.split(" ").map(K=>w(K,this.options)).join(" ").split(/\s+/).map(K=>fe(K,this.options));C&&(z=z.filter(K=>(s("loose invalid filter",K,this.options),!!K.match(c[l.COMPARATORLOOSE])))),s("range list",z);const F=new Map,V=z.map(K=>new a(K,this.options));for(const K of V){if(m(K))return[K];F.set(K.value,K)}F.size>1&&F.has("")&&F.delete("");const ee=[...F.values()];return n.set(O,ee),ee}intersects(T,$){if(!(T instanceof e))throw new TypeError("a Range is required");return this.set.some(O=>_(O,$)&&T.set.some(P=>_(P,$)&&O.every(C=>P.every(j=>C.intersects(j,$)))))}test(T){if(!T)return!1;if(typeof T=="string")try{T=new o(T,this.options)}catch{return!1}for(let $=0;$<this.set.length;$++)if(sr(this.set[$],T,this.options))return!0;return!1}}Zr=e;const r=td(),n=new r,i=Gn(),a=nr(),s=tr(),o=ae(),{safeRe:c,t:l,comparatorTrimReplace:u,tildeTrimReplace:d,caretTrimReplace:h}=wt(),{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:p}=er(),m=A=>A.value==="<0.0.0-0",g=A=>A.value==="",_=(A,T)=>{let $=!0;const O=A.slice();let P=O.pop();for(;$&&O.length;)$=O.every(C=>P.intersects(C,T)),P=O.pop();return $},w=(A,T)=>(A=A.replace(c[l.BUILD],""),s("comp",A,T),A=L(A,T),s("caret",A),A=E(A,T),s("tildes",A),A=I(A,T),s("xrange",A),A=se(A,T),s("stars",A),A),y=A=>!A||A.toLowerCase()==="x"||A==="*",E=(A,T)=>A.trim().split(/\s+/).map($=>S($,T)).join(" "),S=(A,T)=>{const $=T.loose?c[l.TILDELOOSE]:c[l.TILDE];return A.replace($,(O,P,C,j,z)=>{s("tilde",A,O,P,C,j,z);let F;return y(P)?F="":y(C)?F=`>=${P}.0.0 <${+P+1}.0.0-0`:y(j)?F=`>=${P}.${C}.0 <${P}.${+C+1}.0-0`:z?(s("replaceTilde pr",z),F=`>=${P}.${C}.${j}-${z} <${P}.${+C+1}.0-0`):F=`>=${P}.${C}.${j} <${P}.${+C+1}.0-0`,s("tilde return",F),F})},L=(A,T)=>A.trim().split(/\s+/).map($=>k($,T)).join(" "),k=(A,T)=>{s("caret",A,T);const $=T.loose?c[l.CARETLOOSE]:c[l.CARET],O=T.includePrerelease?"-0":"";return A.replace($,(P,C,j,z,F)=>{s("caret",A,P,C,j,z,F);let V;return y(C)?V="":y(j)?V=`>=${C}.0.0${O} <${+C+1}.0.0-0`:y(z)?C==="0"?V=`>=${C}.${j}.0${O} <${C}.${+j+1}.0-0`:V=`>=${C}.${j}.0${O} <${+C+1}.0.0-0`:F?(s("replaceCaret pr",F),C==="0"?j==="0"?V=`>=${C}.${j}.${z}-${F} <${C}.${j}.${+z+1}-0`:V=`>=${C}.${j}.${z}-${F} <${C}.${+j+1}.0-0`:V=`>=${C}.${j}.${z}-${F} <${+C+1}.0.0-0`):(s("no pr"),C==="0"?j==="0"?V=`>=${C}.${j}.${z}${O} <${C}.${j}.${+z+1}-0`:V=`>=${C}.${j}.${z}${O} <${C}.${+j+1}.0-0`:V=`>=${C}.${j}.${z} <${+C+1}.0.0-0`),s("caret return",V),V})},I=(A,T)=>(s("replaceXRanges",A,T),A.split(/\s+/).map($=>X($,T)).join(" ")),X=(A,T)=>{A=A.trim();const $=T.loose?c[l.XRANGELOOSE]:c[l.XRANGE];return A.replace($,(O,P,C,j,z,F)=>{s("xRange",A,O,P,C,j,z,F);const V=y(C),ee=V||y(j),K=ee||y(z),at=K;return P==="="&&at&&(P=""),F=T.includePrerelease?"-0":"",V?P===">"||P==="<"?O="<0.0.0-0":O="*":P&&at?(ee&&(j=0),z=0,P===">"?(P=">=",ee?(C=+C+1,j=0,z=0):(j=+j+1,z=0)):P==="<="&&(P="<",ee?C=+C+1:j=+j+1),P==="<"&&(F="-0"),O=`${P+C}.${j}.${z}${F}`):ee?O=`>=${C}.0.0${F} <${+C+1}.0.0-0`:K&&(O=`>=${C}.${j}.0${F} <${C}.${+j+1}.0-0`),s("xRange return",O),O})},se=(A,T)=>(s("replaceStars",A,T),A.trim().replace(c[l.STAR],"")),fe=(A,T)=>(s("replaceGTE0",A,T),A.trim().replace(c[T.includePrerelease?l.GTE0PRE:l.GTE0],"")),Ce=A=>(T,$,O,P,C,j,z,F,V,ee,K,at)=>(y(O)?$="":y(P)?$=`>=${O}.0.0${A?"-0":""}`:y(C)?$=`>=${O}.${P}.0${A?"-0":""}`:j?$=`>=${$}`:$=`>=${$}${A?"-0":""}`,y(V)?F="":y(ee)?F=`<${+V+1}.0.0-0`:y(K)?F=`<${V}.${+ee+1}.0-0`:at?F=`<=${V}.${ee}.${K}-${at}`:A?F=`<${V}.${ee}.${+K+1}-0`:F=`<=${F}`,`${$} ${F}`.trim()),sr=(A,T,$)=>{for(let O=0;O<A.length;O++)if(!A[O].test(T))return!1;if(T.prerelease.length&&!$.includePrerelease){for(let O=0;O<A.length;O++)if(s(A[O].semver),A[O].semver!==a.ANY&&A[O].semver.prerelease.length>0){const P=A[O].semver;if(P.major===T.major&&P.minor===T.minor&&P.patch===T.patch)return!0}return!1}return!0};return Zr}var Kr,ya;function nr(){if(ya)return Kr;ya=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(u,d){if(d=r(d),u instanceof e){if(u.loose===!!d.loose)return u;u=u.value}u=u.trim().split(/\s+/).join(" "),s("comparator",u,d),this.options=d,this.loose=!!d.loose,this.parse(u),this.semver===t?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(u){const d=this.options.loose?n[i.COMPARATORLOOSE]:n[i.COMPARATOR],h=u.match(d);if(!h)throw new TypeError(`Invalid comparator: ${u}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=t}toString(){return this.value}test(u){if(s("Comparator.test",u,this.options.loose),this.semver===t||u===t)return!0;if(typeof u=="string")try{u=new o(u,this.options)}catch{return!1}return a(u,this.operator,this.semver,this.options)}intersects(u,d){if(!(u instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(u.value,d).test(this.value):u.operator===""?u.value===""?!0:new c(this.value,d).test(u.semver):(d=r(d),d.includePrerelease&&(this.value==="<0.0.0-0"||u.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||u.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&u.operator.startsWith(">")||this.operator.startsWith("<")&&u.operator.startsWith("<")||this.semver.version===u.semver.version&&this.operator.includes("=")&&u.operator.includes("=")||a(this.semver,"<",u.semver,d)&&this.operator.startsWith(">")&&u.operator.startsWith("<")||a(this.semver,">",u.semver,d)&&this.operator.startsWith("<")&&u.operator.startsWith(">")))}}Kr=e;const r=Gn(),{safeRe:n,t:i}=wt(),a=zs(),s=tr(),o=ae(),c=be();return Kr}var Wr,wa;function ir(){if(wa)return Wr;wa=1;const t=be();return Wr=(r,n,i)=>{try{n=new t(n,i)}catch{return!1}return n.test(r)},Wr}var Xr,va;function rd(){if(va)return Xr;va=1;const t=be();return Xr=(r,n)=>new t(r,n).set.map(i=>i.map(a=>a.value).join(" ").trim().split(" ")),Xr}var Qr,ba;function nd(){if(ba)return Qr;ba=1;const t=ae(),e=be();return Qr=(n,i,a)=>{let s=null,o=null,c=null;try{c=new e(i,a)}catch{return null}return n.forEach(l=>{c.test(l)&&(!s||o.compare(l)===-1)&&(s=l,o=new t(s,a))}),s},Qr}var Yr,Ea;function id(){if(Ea)return Yr;Ea=1;const t=ae(),e=be();return Yr=(n,i,a)=>{let s=null,o=null,c=null;try{c=new e(i,a)}catch{return null}return n.forEach(l=>{c.test(l)&&(!s||o.compare(l)===1)&&(s=l,o=new t(s,a))}),s},Yr}var en,Sa;function ad(){if(Sa)return en;Sa=1;const t=ae(),e=be(),r=rr();return en=(i,a)=>{i=new e(i,a);let s=new t("0.0.0");if(i.test(s)||(s=new t("0.0.0-0"),i.test(s)))return s;s=null;for(let o=0;o<i.set.length;++o){const c=i.set[o];let l=null;c.forEach(u=>{const d=new t(u.semver.version);switch(u.operator){case">":d.prerelease.length===0?d.patch++:d.prerelease.push(0),d.raw=d.format();case"":case">=":(!l||r(d,l))&&(l=d);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${u.operator}`)}}),l&&(!s||r(s,l))&&(s=l)}return s&&i.test(s)?s:null},en}var tn,Ta;function sd(){if(Ta)return tn;Ta=1;const t=be();return tn=(r,n)=>{try{return new t(r,n).range||"*"}catch{return null}},tn}var rn,Ia;function Kn(){if(Ia)return rn;Ia=1;const t=ae(),e=nr(),{ANY:r}=e,n=be(),i=ir(),a=rr(),s=Vn(),o=Zn(),c=Jn();return rn=(u,d,h,f)=>{u=new t(u,f),d=new n(d,f);let p,m,g,_,w;switch(h){case">":p=a,m=o,g=s,_=">",w=">=";break;case"<":p=s,m=c,g=a,_="<",w="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(i(u,d,f))return!1;for(let y=0;y<d.set.length;++y){const E=d.set[y];let S=null,L=null;if(E.forEach(k=>{k.semver===r&&(k=new e(">=0.0.0")),S=S||k,L=L||k,p(k.semver,S.semver,f)?S=k:g(k.semver,L.semver,f)&&(L=k)}),S.operator===_||S.operator===w||(!L.operator||L.operator===_)&&m(u,L.semver))return!1;if(L.operator===w&&g(u,L.semver))return!1}return!0},rn}var nn,Aa;function od(){if(Aa)return nn;Aa=1;const t=Kn();return nn=(r,n,i)=>t(r,n,">",i),nn}var an,xa;function cd(){if(xa)return an;xa=1;const t=Kn();return an=(r,n,i)=>t(r,n,"<",i),an}var sn,Ra;function ld(){if(Ra)return sn;Ra=1;const t=be();return sn=(r,n,i)=>(r=new t(r,i),n=new t(n,i),r.intersects(n,i)),sn}var on,Oa;function ud(){if(Oa)return on;Oa=1;const t=ir(),e=ve();return on=(r,n,i)=>{const a=[];let s=null,o=null;const c=r.sort((h,f)=>e(h,f,i));for(const h of c)t(h,n,i)?(o=h,s||(s=h)):(o&&a.push([s,o]),o=null,s=null);s&&a.push([s,null]);const l=[];for(const[h,f]of a)h===f?l.push(h):!f&&h===c[0]?l.push("*"):f?h===c[0]?l.push(`<=${f}`):l.push(`${h} - ${f}`):l.push(`>=${h}`);const u=l.join(" || "),d=typeof n.raw=="string"?n.raw:String(n);return u.length<d.length?u:n},on}var cn,Ca;function dd(){if(Ca)return cn;Ca=1;const t=be(),e=nr(),{ANY:r}=e,n=ir(),i=ve(),a=(d,h,f={})=>{if(d===h)return!0;d=new t(d,f),h=new t(h,f);let p=!1;e:for(const m of d.set){for(const g of h.set){const _=c(m,g,f);if(p=p||_!==null,_)continue e}if(p)return!1}return!0},s=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],c=(d,h,f)=>{if(d===h)return!0;if(d.length===1&&d[0].semver===r){if(h.length===1&&h[0].semver===r)return!0;f.includePrerelease?d=s:d=o}if(h.length===1&&h[0].semver===r){if(f.includePrerelease)return!0;h=o}const p=new Set;let m,g;for(const I of d)I.operator===">"||I.operator===">="?m=l(m,I,f):I.operator==="<"||I.operator==="<="?g=u(g,I,f):p.add(I.semver);if(p.size>1)return null;let _;if(m&&g){if(_=i(m.semver,g.semver,f),_>0)return null;if(_===0&&(m.operator!==">="||g.operator!=="<="))return null}for(const I of p){if(m&&!n(I,String(m),f)||g&&!n(I,String(g),f))return null;for(const X of h)if(!n(I,String(X),f))return!1;return!0}let w,y,E,S,L=g&&!f.includePrerelease&&g.semver.prerelease.length?g.semver:!1,k=m&&!f.includePrerelease&&m.semver.prerelease.length?m.semver:!1;L&&L.prerelease.length===1&&g.operator==="<"&&L.prerelease[0]===0&&(L=!1);for(const I of h){if(S=S||I.operator===">"||I.operator===">=",E=E||I.operator==="<"||I.operator==="<=",m){if(k&&I.semver.prerelease&&I.semver.prerelease.length&&I.semver.major===k.major&&I.semver.minor===k.minor&&I.semver.patch===k.patch&&(k=!1),I.operator===">"||I.operator===">="){if(w=l(m,I,f),w===I&&w!==m)return!1}else if(m.operator===">="&&!n(m.semver,String(I),f))return!1}if(g){if(L&&I.semver.prerelease&&I.semver.prerelease.length&&I.semver.major===L.major&&I.semver.minor===L.minor&&I.semver.patch===L.patch&&(L=!1),I.operator==="<"||I.operator==="<="){if(y=u(g,I,f),y===I&&y!==g)return!1}else if(g.operator==="<="&&!n(g.semver,String(I),f))return!1}if(!I.operator&&(g||m)&&_!==0)return!1}return!(m&&E&&!g&&_!==0||g&&S&&!m&&_!==0||k||L)},l=(d,h,f)=>{if(!d)return h;const p=i(d.semver,h.semver,f);return p>0?d:p<0||h.operator===">"&&d.operator===">="?h:d},u=(d,h,f)=>{if(!d)return h;const p=i(d.semver,h.semver,f);return p<0?d:p>0||h.operator==="<"&&d.operator==="<="?h:d};return cn=a,cn}var ln,Na;function hd(){if(Na)return ln;Na=1;const t=wt(),e=er(),r=ae(),n=Us(),i=rt(),a=zu(),s=qu(),o=Gu(),c=Hu(),l=Vu(),u=Ju(),d=Zu(),h=Ku(),f=ve(),p=Wu(),m=Xu(),g=Hn(),_=Qu(),w=Yu(),y=rr(),E=Vn(),S=Fs(),L=Bs(),k=Jn(),I=Zn(),X=zs(),se=ed(),fe=nr(),Ce=be(),sr=ir(),A=rd(),T=nd(),$=id(),O=ad(),P=sd(),C=Kn(),j=od(),z=cd(),F=ld(),V=ud(),ee=dd();return ln={parse:i,valid:a,clean:s,inc:o,diff:c,major:l,minor:u,patch:d,prerelease:h,compare:f,rcompare:p,compareLoose:m,compareBuild:g,sort:_,rsort:w,gt:y,lt:E,eq:S,neq:L,gte:k,lte:I,cmp:X,coerce:se,Comparator:fe,Range:Ce,satisfies:sr,toComparators:A,maxSatisfying:T,minSatisfying:$,minVersion:O,validRange:P,outside:C,gtr:j,ltr:z,intersects:F,simplifyRange:V,subset:ee,SemVer:r,re:t.re,src:t.src,tokens:t.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},ln}hd();function Ne(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,r]=t.split(":"),n=r||"latest";if(e.includes("/")){const[i,a]=e.split("/",2);if(!i||!a)throw new Error(`Invalid identifier format: ${t}`);return[i,a,n]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,n]}}class fd extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}class pd extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithNotFoundError",this.status=404}}function $a(t){return t!=null&&typeof t=="object"&&"name"in t&&t?.name==="LangSmithNotFoundError"}async function R(t,e,r){let n;if(t.ok){r&&(n=await t.text());return}if(t.status===403)try{(await t.json())?.error==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${t.status} ${t.statusText}`);throw o.status=t?.status,o}if(n===void 0)try{n=await t.text()}catch{n=""}const i=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Message: ${n}`;if(t.status===404)throw new pd(i);if(t.status===409)throw new fd(i);const a=new Error(i);throw a.status=t.status,a}const qs="ERR_CONFLICTING_ENDPOINTS";class md extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:qs}),this.name="ConflictingEndpointsError"}}function gd(t){return typeof t=="object"&&t!==null&&t.code===qs}var Pa="[...]",_d={result:"[Circular]"},qt=[],We=[];const yd=new TextEncoder;function wd(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Nt(t){return yd.encode(t)}function Gs(t){if(t&&typeof t=="object"&&t!==null){if(t instanceof Map)return Object.fromEntries(t);if(t instanceof Set)return Array.from(t);if(t instanceof Date)return t.toISOString();if(t instanceof RegExp)return t.toString();if(t instanceof Error)return{name:t.name,message:t.message}}else if(typeof t=="bigint")return t.toString();return t}function vd(t){return function(e,r){return Gs(r)}}function de(t,e,r,n,i){try{const a=JSON.stringify(t,vd(r),n);return Nt(a)}catch(a){if(!a.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),Nt("[Unserializable]");ne("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof i>"u"&&(i=wd()),Tn(t,"",0,[],void 0,0,i);let s;try{We.length===0?s=JSON.stringify(t,r,n):s=JSON.stringify(t,bd(r),n)}catch{return Nt("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;qt.length!==0;){const o=qt.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return Nt(s)}}function un(t,e,r,n){var i=Object.getOwnPropertyDescriptor(n,r);i.get!==void 0?i.configurable?(Object.defineProperty(n,r,{value:t}),qt.push([n,r,e,i])):We.push([e,r,t]):(n[r]=t,qt.push([n,r,e]))}function Tn(t,e,r,n,i,a,s){a+=1;var o;if(typeof t=="object"&&t!==null){for(o=0;o<n.length;o++)if(n[o]===t){un(_d,t,e,i);return}if(typeof s.depthLimit<"u"&&a>s.depthLimit){un(Pa,t,e,i);return}if(typeof s.edgesLimit<"u"&&r+1>s.edgesLimit){un(Pa,t,e,i);return}if(n.push(t),Array.isArray(t))for(o=0;o<t.length;o++)Tn(t[o],o,o,n,t,a,s);else{t=Gs(t);var c=Object.keys(t);for(o=0;o<c.length;o++){var l=c[o];Tn(t[l],l,o,n,t,a,s)}}n.pop()}}function bd(t){return t=typeof t<"u"?t:function(e,r){return r},function(e,r){if(We.length>0)for(var n=0;n<We.length;n++){var i=We[n];if(i[1]===e&&i[0]===r){r=i[2],We.splice(n,1);break}}return t.call(this,e,r)}}function La(t,e,r){if(r)return t;const n=ks(),i=e??Ms(),a=t.extra??{},s=a.metadata;return t.extra={...a,runtime:{...n,...a?.runtime},metadata:{...i,...i.revision_id||"revision_id"in t&&t.revision_id?{revision_id:("revision_id"in t?t.revision_id:void 0)??i.revision_id}:{},...s}},t}const Ed=t=>{const e=t?.toString()??ne("TRACING_SAMPLING_RATE");if(e===void 0)return;const r=parseFloat(e);if(r<0||r>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r},Sd=t=>{const r=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return r==="localhost"||r==="127.0.0.1"||r==="::1"};async function Td(t){const e=[];for await(const r of t)e.push(r);return e}function $t(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Id=async t=>{if(t?.status===429){const e=parseInt(t.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(r=>setTimeout(r,e)),!0}return!1};function ka(t){return typeof t=="number"?Number(t.toFixed(4)):t}const Ad=24*1024*1024,Hs=1024*1024*1024,xd=1e4,Rd=100,Ma="https://api.smith.langchain.com";class Od{constructor(e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSizeBytes=e??Hs}peek(){return this.items[0]}push(e){let r;const n=new Promise(a=>{r=a}),i=de(e.item,`Serializing run with id: ${e.item.id}`).length;return this.sizeBytes+i>this.maxSizeBytes&&this.items.length>0?(console.warn(`AutoBatchQueue size limit (${this.maxSizeBytes} bytes) exceeded. Dropping run with id: ${e.item.id}. Current queue size: ${this.sizeBytes} bytes, attempted addition: ${i} bytes.`),r(),n):(this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:r,itemPromise:n,size:i}),this.sizeBytes+=i,n)}pop({upToSizeBytes:e,upToSize:r}){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let i=0;for(;i+(this.peek()?.size??0)<e&&this.items.length>0&&n.length<r;){const a=this.items.shift();a&&(n.push(a),i+=a.size,this.sizeBytes-=a.size)}if(n.length===0&&this.items.length>0){const a=this.items.shift();n.push(a),i+=a.size,this.sizeBytes-=a.size}return[n.map(a=>({action:a.action,item:a.payload,otelContext:a.otelContext,apiKey:a.apiKey,apiUrl:a.apiUrl,size:a.size})),()=>n.forEach(a=>a.itemPromiseResolve())]}}class gt{get _fetch(){return this.fetchImplementation||Ol(this.debug)}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitTracedRuntimeInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Ae("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_promptCache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_multipartDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_runCompressionDisabled",{enumerable:!0,configurable:!0,writable:!0,value:ne("DISABLE_RUN_COMPRESSION")==="true"}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Ae("LANGSMITH_DEBUG")==="true"});const r=gt.getDefaultClientConfig();if(this.tracingSampleRate=Ed(e.tracingSamplingRate),this.apiUrl=$t(e.apiUrl??r.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=$t(e.apiKey??r.apiKey),this.webUrl=$t(e.webUrl??r.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=$t(e.workspaceId??ne("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Di({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation;const n=e.maxIngestMemoryBytes??Hs;this.batchIngestCaller=new Di({maxRetries:4,maxConcurrency:this.traceBatchConcurrency,maxQueueSizeBytes:n,...e.callerOptions??{},onFailedResponseHook:Id,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??r.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??r.hideOutputs,this.omitTracedRuntimeInfo=e.omitTracedRuntimeInfo??!1,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.autoBatchQueue=new Od(n),this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,js()&&(this.langSmithToOTELTranslator=new Su),this.cachedLSEnvVarsForMetadata=Ms(),e.cache!==void 0&&e.disablePromptCache&&Mt("Both 'cache' and 'disablePromptCache' were provided. The 'cache' parameter is deprecated and will be removed in a future version. Using 'cache' parameter value."),e.cache!==void 0?(Mt("The 'cache' parameter is deprecated and will be removed in a future version. Use 'configureGlobalPromptCache()' to configure the global cache, or 'disablePromptCache: true' to disable caching for this client."),e.cache===!1?this._promptCache=void 0:e.cache===!0?this._promptCache=Oi:this._promptCache=e.cache):e.disablePromptCache||(this._promptCache=Oi)}static getDefaultClientConfig(){const e=ne("API_KEY"),r=ne("ENDPOINT")??Ma,n=ne("HIDE_INPUTS")==="true",i=ne("HIDE_OUTPUTS")==="true";return{apiUrl:r,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:i}}getHostUrl(){return this.webUrl?this.webUrl:Sd(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${$s}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const r={...e};return r.inputs!==void 0&&(r.inputs=await this.processInputs(r.inputs)),r.outputs!==void 0&&(r.outputs=await this.processOutputs(r.outputs)),r}async _getResponse(e,r){const n=r?.toString()??"",i=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{const s=await this._fetch(i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(s,`fetch ${e}`),s})}async _get(e,r){return(await this._getResponse(e,r)).json()}async*_getPaginated(e,r=new URLSearchParams,n){let i=Number(r.get("offset"))||0;const a=Number(r.get("limit"))||100;for(;;){r.set("offset",String(i)),r.set("limit",String(a));const s=`${this.apiUrl}${e}?${r}`,o=await this.caller.call(async()=>{const l=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(l,`fetch ${e}`),l}),c=n?n(await o.json()):await o.json();if(c.length===0||(yield c,c.length<a))break;i+=c.length}}async*_getCursorPaginatedList(e,r=null,n="POST",i="runs"){const a=r?{...r}:{};for(;;){const s=JSON.stringify(a),c=await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await R(u,`fetch ${e}`),u})).json();if(!c||!c[i])break;yield c[i];const l=c.cursors;if(!l||!l.next)break;a.cursor=l.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,r=!1){if(this.tracingSampleRate===void 0)return e;if(r){const n=[];for(const i of e)this.filteredPostUuids.has(i.trace_id)?i.id===i.trace_id&&this.filteredPostUuids.delete(i.trace_id):n.push(i);return n}else{const n=[];for(const i of e){const a=i.trace_id??i.id;this.filteredPostUuids.has(a)||(i.id===a?this._shouldSample()?n.push(i):this.filteredPostUuids.add(a):n.push(i))}return n}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e?.batch_ingest_config?.size_limit_bytes??Ad}async _getBatchSizeLimit(){const e=await this._ensureServerInfo();return this.batchSizeLimit??e?.batch_ingest_config?.size_limit??Rd}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:r}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[i,a]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:r});if(!i.length){a();break}const s=i.reduce((l,u)=>{const d=u.apiUrl??this.apiUrl,h=u.apiKey??this.apiKey,p=u.apiKey===this.apiKey&&u.apiUrl===this.apiUrl?"default":`${d}|${h}`;return l[p]||(l[p]=[]),l[p].push(u),l},{}),o=[];for(const[l,u]of Object.entries(s)){const d=this._processBatch(u,{apiUrl:l==="default"?void 0:l.split("|")[0],apiKey:l==="default"?void 0:l.split("|")[1]});o.push(d)}const c=Promise.all(o).finally(a);n.push(c)}return Promise.all(n)}async _processBatch(e,r){if(!e.length)return;const n=e.reduce((i,a)=>i+(a.size??0),0);try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const i={runCreates:e.filter(o=>o.action==="create").map(o=>o.item),runUpdates:e.filter(o=>o.action==="update").map(o=>o.item)},a=await this._ensureServerInfo();if(!this._multipartDisabled&&(a?.batch_ingest_config?.use_multipart_endpoint??!0)){const o=!this._runCompressionDisabled&&a?.instance_flags?.gzip_body_enabled;try{await this.multipartIngestRuns(i,{...r,useGzip:o,sizeBytes:n})}catch(c){if($a(c))this._multipartDisabled=!0,await this.batchIngestRuns(i,{...r,sizeBytes:n});else throw c}}else await this.batchIngestRuns(i,{...r,sizeBytes:n})}}catch(i){console.error("Error exporting batch:",i)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const r=new Map,n=[];for(const i of e)i.item.id&&i.otelContext&&(r.set(i.item.id,i.otelContext),i.action==="create"?n.push({operation:"post",id:i.item.id,trace_id:i.item.trace_id??i.item.id,run:i.item}):n.push({operation:"patch",id:i.item.id,trace_id:i.item.trace_id??i.item.id,run:i.item}));this.langSmithToOTELTranslator.exportBatch(n,r)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=La(e.item,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);const r=this.autoBatchQueue.push(e);if(this.manualFlushMode)return r;const n=await this._getBatchSizeLimitBytes(),i=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>i)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:i}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:i})},this.autoBatchAggregationDelayMs)),r}async _getServerInfo(){const r=await(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(xd),...this.fetchOptions});return await R(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(r,null,2)+`
`),r}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),r=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:r})}_cloneCurrentOTELContext(){const e=Ds(),r=wu();if(this.langSmithToOTELTranslator!==void 0){const n=e.getActiveSpan();if(n)return e.setSpan(r.active(),n)}}async createRun(e,r){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},i=e.project_name;delete e.project_name;const a=await this.prepareRunCreateOrUpdateInputs({session_name:i,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:a,otelContext:c,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error);return}const s=La(a,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);r?.apiKey!==void 0&&(n["x-api-key"]=r.apiKey),r?.workspaceId!==void 0&&(n["x-tenant-id"]=r.workspaceId);const o=de(s,`Creating run with id: ${s.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await R(c,"create run",!0),c})}async batchIngestRuns({runCreates:e,runUpdates:r},n){if(e===void 0&&r===void 0)return;let i=await Promise.all(e?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[]),a=await Promise.all(r?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[]);if(i.length>0&&a.length>0){const c=i.reduce((u,d)=>(d.id&&(u[d.id]=d),u),{}),l=[];for(const u of a)u.id!==void 0&&c[u.id]?c[u.id]={...c[u.id],...u}:l.push(u);i=Object.values(c),a=l}const s={post:i,patch:a};if(!s.post.length&&!s.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const l=c,u=s[l].reverse();let d=u.pop();for(;d!==void 0;)o[l].push(d),d=u.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(l=>l.id).concat(o.patch.map(l=>l.id)).join(",");await this._postBatchIngestRuns(de(o,`Ingesting runs with ids: ${c}`),n)}}async _postBatchIngestRuns(e,r){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};r?.apiKey!==void 0&&(n["x-api-key"]=r.apiKey),await this.batchIngestCaller.callWithOptions({sizeBytes:r?.sizeBytes},async()=>{const i=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await R(i,"batch create run",!0),i})}async multipartIngestRuns({runCreates:e,runUpdates:r},n){if(e===void 0&&r===void 0)return;const i={};let a=[];for(const d of e??[]){const h=await this.prepareRunCreateOrUpdateInputs(d);h.id!==void 0&&h.attachments!==void 0&&(i[h.id]=h.attachments),delete h.attachments,a.push(h)}let s=[];for(const d of r??[])s.push(await this.prepareRunCreateOrUpdateInputs(d));if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){const d=a.reduce((f,p)=>(p.id&&(f[p.id]=p),f),{}),h=[];for(const f of s)f.id!==void 0&&d[f.id]?d[f.id]={...d[f.id],...f}:h.push(f);a=Object.values(d),s=h}if(a.length===0&&s.length===0)return;const l=[],u=[];for(const[d,h]of[["post",a],["patch",s]])for(const f of h){const{inputs:p,outputs:m,events:g,extra:_,error:w,serialized:y,attachments:E,...S}=f,L={inputs:p,outputs:m,events:g,extra:_,error:w,serialized:y},k=de(S,`Serializing for multipart ingestion of run with id: ${S.id}`);u.push({name:`${d}.${S.id}`,payload:new Blob([k],{type:`application/json; length=${k.length}`})});for(const[I,X]of Object.entries(L)){if(X===void 0)continue;const se=de(X,`Serializing ${I} for multipart ingestion of run with id: ${S.id}`);u.push({name:`${d}.${S.id}.${I}`,payload:new Blob([se],{type:`application/json; length=${se.length}`})})}if(S.id!==void 0){const I=i[S.id];if(I){delete i[S.id];for(const[X,se]of Object.entries(I)){let fe,Ce;if(Array.isArray(se)?[fe,Ce]=se:(fe=se.mimeType,Ce=se.data),X.includes(".")){console.warn(`Skipping attachment '${X}' for run ${S.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}u.push({name:`attachment.${S.id}.${X}`,payload:new Blob([Ce],{type:`${fe}; length=${Ce.byteLength}`})})}}}l.push(`trace=${S.trace_id},id=${S.id}`)}await this._sendMultipartRequest(u,l.join("; "),n)}async _createNodeFetchBody(e,r){const n=[];for(const s of e)n.push(new Blob([`--${r}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${s.name}"\r
`,`Content-Type: ${s.payload.type}\r
\r
`])),n.push(s.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${r}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(e,r){const n=new TextEncoder;return new ReadableStream({async start(a){const s=async o=>{typeof o=="string"?a.enqueue(n.encode(o)):a.enqueue(o)};for(const o of e){await s(`--${r}\r
`),await s(`Content-Disposition: form-data; name="${o.name}"\r
`),await s(`Content-Type: ${o.payload.type}\r
\r
`);const l=o.payload.stream().getReader();try{let u;for(;!(u=await l.read()).done;)a.enqueue(u.value)}finally{l.releaseLock()}await s(`\r
`)}await s(`--${r}--\r
`),a.close()}})}async _sendMultipartRequest(e,r,n){const i="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=()=>this._createNodeFetchBody(e,i),s=()=>this._createMultipartStream(e,i),o=async c=>this.batchIngestCaller.callWithOptions({sizeBytes:n?.sizeBytes},async()=>{const l=await c(),u={...this.headers,"Content-Type":`multipart/form-data; boundary=${i}`};n?.apiKey!==void 0&&(u["x-api-key"]=n.apiKey);let d=l;n?.useGzip&&typeof l=="object"&&"pipeThrough"in l&&(d=l.pipeThrough(new CompressionStream("gzip")),u["Content-Encoding"]="gzip");const h=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:u,body:d,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(h,"Failed to send multipart request",!0),h});try{let c,l=!1;Rl()&&!this.multipartStreamingDisabled&&Ls()!=="bun"?(l=!0,c=await o(s)):c=await o(a),(!this.multipartStreamingDisabled||l)&&c.status===422&&(n?.apiUrl??this.apiUrl)!==Ma&&(console.warn(`Streaming multipart upload to ${n?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${r}".`),this.multipartStreamingDisabled=!0,c=await o(a))}catch(c){if($a(c))throw c;console.warn(`${c.message.trim()}

Context: ${r}`)}}async updateRun(e,r,n){M(e),r.inputs&&(r.inputs=await this.processInputs(r.inputs)),r.outputs&&(r.outputs=await this.processOutputs(r.outputs));const i={...r,id:e};if(!this._filterForSampling([i],!0).length)return;if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(r.end_time!==void 0&&i.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:i,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:i,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"};n?.apiKey!==void 0&&(a["x-api-key"]=n.apiKey),n?.workspaceId!==void 0&&(a["x-tenant-id"]=n.workspaceId);const s=de(r,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await R(o,"update run",!0),o})}async readRun(e,{loadChildRuns:r}={loadChildRuns:!1}){M(e);let n=await this._get(`/runs/${e}`);return r&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:r,projectOpts:n}){if(r!==void 0){let i;r.session_id?i=r.session_id:n?.projectName?i=(await this.readProject({projectName:n?.projectName})).id:n?.projectId?i=n?.projectId:i=(await this.readProject({projectName:ne("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${i}/r/${r.id}?poll=true`}else if(e!==void 0){const i=await this.readRun(e);if(!i.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${i.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const r=await Td(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},i={};r.sort((a,s)=>(a?.dotted_order??"").localeCompare(s?.dotted_order??""));for(const a of r){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.dotted_order?.startsWith(e.dotted_order??"")&&a.id!==e.id&&(a.parent_run_id in n||(n[a.parent_run_id]=[]),n[a.parent_run_id].push(a),i[a.id]=a)}e.child_runs=n[e.id]||[];for(const a in n)a!==e.id&&(i[a].child_runs=n[a]);return e}async*listRuns(e){const{projectId:r,projectName:n,parentRunId:i,traceId:a,referenceExampleId:s,startTime:o,executionOrder:c,isRoot:l,runType:u,error:d,id:h,query:f,filter:p,traceFilter:m,treeFilter:g,limit:_,select:w,order:y}=e;let E=[];if(r&&(E=Array.isArray(r)?r:[r]),n){const I=Array.isArray(n)?n:[n],X=await Promise.all(I.map(se=>this.readProject({projectName:se}).then(fe=>fe.id)));E.push(...X)}const S=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],L={session:E.length?E:null,run_type:u,reference_example:s,query:f,filter:p,trace_filter:m,tree_filter:g,execution_order:c,parent_run:i,start_time:o?o.toISOString():null,error:d,id:h,limit:_,trace:a,select:w||S,is_root:l,order:y};L.select.includes("child_run_ids")&&Mt("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let k=0;for await(const I of this._getCursorPaginatedList("/runs/query",L))if(_){if(k>=_)break;if(I.length+k>_){yield*I.slice(0,_-k);break}k+=I.length,yield*I}else yield*I}async*listGroupRuns(e){const{projectId:r,projectName:n,groupBy:i,filter:a,startTime:s,endTime:o,limit:c,offset:l}=e,d={session_id:r||(await this.readProject({projectName:n})).id,group_by:i,filter:a,start_time:s?s.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let h=Number(l)||0;const f="/runs/group",p=`${this.apiUrl}${f}`;for(;;){const m={...d,offset:h},g=Object.fromEntries(Object.entries(m).filter(([L,k])=>k!==void 0)),_=JSON.stringify(g),y=await(await this.caller.call(async()=>{const L=await this._fetch(p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:_});return await R(L,`Failed to fetch ${f}`),L})).json(),{groups:E,total:S}=y;if(E.length===0)break;for(const L of E)yield L;if(h+=E.length,h>=S)break}}async getRunStats({id:e,trace:r,parentRun:n,runType:i,projectNames:a,projectIds:s,referenceExampleIds:o,startTime:c,endTime:l,error:u,query:d,filter:h,traceFilter:f,treeFilter:p,isRoot:m,dataSourceType:g}){let _=s||[];a&&(_=[...s||[],...await Promise.all(a.map(k=>this.readProject({projectName:k}).then(I=>I.id)))]);const y=Object.fromEntries(Object.entries({id:e,trace:r,parent_run:n,run_type:i,session:_,reference_example:o,start_time:c,end_time:l,error:u,query:d,filter:h,trace_filter:f,tree_filter:p,is_root:m,data_source_type:g}).filter(([k,I])=>I!==void 0)),E=JSON.stringify(y);return await(await this.caller.call(async()=>{const k=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:E});return await R(k,"get run stats"),k})).json()}async shareRun(e,{shareId:r}={}){const n={run_id:e,share_token:r||ze()};M(e);const i=JSON.stringify(n),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await R(o,"share run"),o})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){M(e),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(r,"unshare run",!0),r})}async readRunSharedLink(e){M(e);const n=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(i,"read run shared link"),i})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:r}={}){const n=new URLSearchParams({share_token:e});if(r!==void 0)for(const s of r)n.append("id",s);return M(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(s,"list shared runs"),s})).json()}async readDatasetSharedSchema(e,r){if(!e&&!r)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:r})).id),M(e);const i=await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(a,"read dataset shared schema"),a})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async shareDataset(e,r){if(!e&&!r)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:r})).id);const n={dataset_id:e};M(e);const i=JSON.stringify(n),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await R(o,"share dataset"),o})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){M(e),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(r,"unshare dataset",!0),r})}async readSharedDataset(e){return M(e),await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(i,"read shared dataset"),i})).json()}async listSharedExamples(e,r){const n={};r?.exampleIds&&(n.id=r.exampleIds);const i=new URLSearchParams;Object.entries(n).forEach(([o,c])=>{Array.isArray(c)?c.forEach(l=>i.append(o,l)):i.append(o,c)});const a=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${i.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(o,"list shared examples"),o}),s=await a.json();if(!a.ok)throw"detail"in s?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${Array.isArray(s.detail)?s.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return s.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:r=null,metadata:n=null,upsert:i=!1,projectExtra:a=null,referenceDatasetId:s=null}){const o=i?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,l=a||{};n&&(l.metadata=n);const u={name:e,extra:l,description:r};s!==null&&(u.reference_dataset_id=s);const d=JSON.stringify(u);return await(await this.caller.call(async()=>{const p=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await R(p,"create project"),p})).json()}async updateProject(e,{name:r=null,description:n=null,metadata:i=null,projectExtra:a=null,endTime:s=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=a;i&&(c={...c||{},metadata:i});const l=JSON.stringify({name:r,extra:c,description:n,end_time:s?new Date(s).toISOString():null});return await(await this.caller.call(async()=>{const h=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await R(h,"update project"),h})).json()}async hasProject({projectId:e,projectName:r}){let n="/sessions";const i=new URLSearchParams;if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)M(e),n+=`/${e}`;else if(r!==void 0)i.append("name",r);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${n}?${i}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(s,"has project"),s});try{const s=await a.json();return a.ok?Array.isArray(s)?s.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:r,includeStats:n}){let i="/sessions";const a=new URLSearchParams;if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)M(e),i+=`/${e}`;else if(r!==void 0)a.append("name",r);else throw new Error("Must provide projectName or projectId");n!==void 0&&a.append("include_stats",n.toString());const s=await this._get(i,a);let o;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${e}, name=${r}] not found`);o=s[0]}else o=s;return o}async getProjectUrl({projectId:e,projectName:r}){if(e===void 0&&r===void 0)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:r}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:r}){if(e===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:r}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const r of this._getPaginated("/sessions",e))return this._tenantId=r[0].tenant_id,r[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:r,nameContains:n,referenceDatasetId:i,referenceDatasetName:a,includeStats:s,datasetVersion:o,referenceFree:c,metadata:l}={}){const u=new URLSearchParams;if(e!==void 0)for(const d of e)u.append("id",d);if(r!==void 0&&u.append("name",r),n!==void 0&&u.append("name_contains",n),i!==void 0)u.append("reference_dataset",i);else if(a!==void 0){const d=await this.readDataset({datasetName:a});u.append("reference_dataset",d.id)}s!==void 0&&u.append("include_stats",s.toString()),o!==void 0&&u.append("dataset_version",o),c!==void 0&&u.append("reference_free",c.toString()),l!==void 0&&u.append("metadata",JSON.stringify(l));for await(const d of this._getPaginated("/sessions",u))yield*d}async deleteProject({projectId:e,projectName:r}){let n;if(e===void 0&&r===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:r})).id:n=e,M(n),await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(i,`delete session ${n} (${r})`,!0),i})}async uploadCsv({csvFile:e,fileName:r,inputKeys:n,outputKeys:i,description:a,dataType:s,name:o}){const c=`${this.apiUrl}/datasets/upload`,l=new FormData,u=new Blob([e],{type:"text/csv"});return l.append("file",u,r),n.forEach(f=>{l.append("input_keys",f)}),i.forEach(f=>{l.append("output_keys",f)}),a&&l.append("description",a),s&&l.append("data_type",s),o&&l.append("name",o),await(await this.caller.call(async()=>{const f=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await R(f,"upload CSV"),f})).json()}async createDataset(e,{description:r,dataType:n,inputsSchema:i,outputsSchema:a,metadata:s}={}){const o={name:e,description:r,extra:s?{metadata:s}:void 0};n&&(o.data_type=n),i&&(o.inputs_schema_definition=i),a&&(o.outputs_schema_definition=a);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await R(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:r}){let n="/datasets";const i=new URLSearchParams({limit:"1"});if(e&&r)throw new Error("Must provide either datasetName or datasetId, not both");if(e)M(e),n+=`/${e}`;else if(r)i.append("name",r);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(n,i);let s;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${r}] not found`);s=a[0]}else s=a;return s}async hasDataset({datasetId:e,datasetName:r}){try{return await this.readDataset({datasetId:e,datasetName:r}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:e,datasetName:r,fromVersion:n,toVersion:i}){let a=e;if(a===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:r})).id);const s=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof i=="string"?i:i.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:r}){const n="/datasets";if(e===void 0)if(r!==void 0)e=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:r=0,datasetIds:n,datasetName:i,datasetNameContains:a,metadata:s}={}){const o="/datasets",c=new URLSearchParams({limit:e.toString(),offset:r.toString()});if(n!==void 0)for(const l of n)c.append("id",l);i!==void 0&&c.append("name",i),a!==void 0&&c.append("name_contains",a),s!==void 0&&c.append("metadata",JSON.stringify(s));for await(const l of this._getPaginated(o,c))yield*l}async updateDataset(e){const{datasetId:r,datasetName:n,...i}=e;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const a=r??(await this.readDataset({datasetName:n})).id;M(a);const s=JSON.stringify(i);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await R(c,"update dataset"),c})).json()}async updateDatasetTag(e){const{datasetId:r,datasetName:n,asOf:i,tag:a}=e;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const s=r??(await this.readDataset({datasetName:n})).id;M(s);const o=JSON.stringify({as_of:typeof i=="string"?i:i.toISOString(),tag:a});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await R(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:e,datasetName:r}){let n="/datasets",i=e;if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(r!==void 0&&(i=(await this.readDataset({datasetName:r})).id),i!==void 0)M(i),n+=`/${i}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const a=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(a,`delete ${n}`,!0),a})}async indexDataset({datasetId:e,datasetName:r,tag:n}){let i=e;if(!i&&!r)throw new Error("Must provide either datasetName or datasetId");if(i&&r)throw new Error("Must provide either datasetName or datasetId, not both");i||(i=(await this.readDataset({datasetName:r})).id),M(i);const s=JSON.stringify({tag:n});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await R(c,"index dataset"),c})).json()}async similarExamples(e,r,n,{filter:i}={}){const a={limit:n,inputs:e};i!==void 0&&(a.filter=i),M(r);const s=JSON.stringify(a);return(await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${r}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:s});return await R(l,"fetch similar examples"),l})).json()).examples}async createExample(e,r,n){if(ja(e)&&(r!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let i=r?n?.datasetId:e.dataset_id;const a=r?n?.datasetName:e.dataset_name;if(i===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:a})).id);const s=(r?n?.createdAt:e.created_at)||new Date;let o;ja(e)?o=e:o={inputs:e,outputs:r,created_at:s?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};const c=await this._uploadExamplesMultipart(i,[o]);return await this.readExample(c.example_ids?.[0]??ze())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const w=e;let y=w[0].dataset_id;const E=w[0].dataset_name;if(y===void 0&&E===void 0)throw new Error("Must provide either datasetName or datasetId");if(y!==void 0&&E!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");y===void 0&&(y=(await this.readDataset({datasetName:E})).id);const S=await this._uploadExamplesMultipart(y,w);return await Promise.all(S.example_ids.map(k=>this.readExample(k)))}const{inputs:r,outputs:n,metadata:i,splits:a,sourceRunIds:s,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:l,exampleIds:u,datasetId:d,datasetName:h}=e;if(r===void 0)throw new Error("Must provide inputs when using legacy parameters");let f=d;const p=h;if(f===void 0&&p===void 0)throw new Error("Must provide either datasetName or datasetId");if(f!==void 0&&p!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");f===void 0&&(f=(await this.readDataset({datasetName:p})).id);const m=r.map((w,y)=>({dataset_id:f,inputs:w,outputs:n?.[y],metadata:i?.[y],split:a?.[y],id:u?.[y],attachments:l?.[y],source_run_id:s?.[y],use_source_run_io:o?.[y],use_source_run_attachments:c?.[y]})),g=await this._uploadExamplesMultipart(f,m);return await Promise.all(g.example_ids.map(w=>this.readExample(w)))}async createLLMExample(e,r,n){return this.createExample({input:e},{output:r},n)}async createChatExample(e,r,n){const i=e.map(s=>Ui(s)?Fi(s):s),a=Ui(r)?Fi(r):r;return this.createExample({input:i},{output:a},n)}async readExample(e){M(e);const r=`/examples/${e}`,n=await this._get(r),{attachment_urls:i,...a}=n,s=a;return i&&(s.attachments=Object.entries(i).reduce((o,[c,l])=>(o[c.slice(11)]={presigned_url:l.presigned_url,mime_type:l.mime_type},o),{})),s}async*listExamples({datasetId:e,datasetName:r,exampleIds:n,asOf:i,splits:a,inlineS3Urls:s,metadata:o,limit:c,offset:l,filter:u,includeAttachments:d}={}){let h;if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(r!==void 0)h=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide a datasetName or datasetId");const f=new URLSearchParams({dataset:h}),p=i?typeof i=="string"?i:i?.toISOString():void 0;p&&f.append("as_of",p);const m=s??!0;if(f.append("inline_s3_urls",m.toString()),n!==void 0)for(const _ of n)f.append("id",_);if(a!==void 0)for(const _ of a)f.append("splits",_);if(o!==void 0){const _=JSON.stringify(o);f.append("metadata",_)}c!==void 0&&f.append("limit",c.toString()),l!==void 0&&f.append("offset",l.toString()),u!==void 0&&f.append("filter",u),d===!0&&["attachment_urls","outputs","metadata"].forEach(_=>f.append("select",_));let g=0;for await(const _ of this._getPaginated("/examples",f)){for(const w of _){const{attachment_urls:y,...E}=w,S=E;y&&(S.attachments=Object.entries(y).reduce((L,[k,I])=>(L[k.slice(11)]={presigned_url:I.presigned_url,mime_type:I.mime_type||void 0},L),{})),yield S,g++}if(c!==void 0&&g>=c)break}}async deleteExample(e){M(e);const r=`/examples/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(n,`delete ${r}`,!0),n})}async deleteExamples(e,r){if(e.forEach(n=>M(n)),r?.hardDelete){const n=this._getPlatformEndpointPath("datasets/examples/delete");await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${n}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({example_ids:e,hard_delete:!0}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(i,"hard delete examples",!0),i})}else{const n=new URLSearchParams;e.forEach(i=>n.append("example_ids",i)),await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/examples?${n.toString()}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(i,"delete examples",!0),i})}}async updateExample(e,r){let n;r?n=e:n=e.id,M(n);let i;r?i={id:n,...r}:i=e;let a;return i.dataset_id!==void 0?a=i.dataset_id:a=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(a,[i])}async updateExamples(e){let r;return e[0].dataset_id===void 0?r=(await this.readExample(e[0].id)).dataset_id:r=e[0].dataset_id,this._updateExamplesMultipart(r,e)}async readDatasetVersion({datasetId:e,datasetName:r,asOf:n,tag:i}){let a;if(e?a=e:a=(await this.readDataset({datasetName:r})).id,M(a),n&&i||!n&&!i)throw new Error("Exactly one of asOf and tag must be specified.");const s=new URLSearchParams;return n!==void 0&&s.append("as_of",typeof n=="string"?n:n.toISOString()),i!==void 0&&s.append("tag",i),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:e,datasetName:r,asOf:n}){let i;if(e===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:r})).id:i=e,M(i);const a=new URLSearchParams,s=n?typeof n=="string"?n:n?.toISOString():void 0;return s&&a.append("as_of",s),await this._get(`/datasets/${i}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:r,splitName:n,exampleIds:i,remove:a=!1}){let s;if(e===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:r})).id:s=e,M(s);const o={split_name:n,examples:i.map(l=>(M(l),l)),remove:a},c=JSON.stringify(o);await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await R(l,"update dataset splits",!0),l})}async createFeedback(e,r,{score:n,value:i,correction:a,comment:s,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:l,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:f,sessionId:p,startTime:m}){if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const g={type:c??"api",metadata:o??{}};l!==void 0&&g?.metadata!==void 0&&!g.metadata.__run&&(g.metadata.__run={run_id:l}),g?.metadata!==void 0&&g.metadata.__run?.run_id!==void 0&&M(g.metadata.__run.run_id);const _={id:u??ze(),run_id:e,key:r,score:ka(n),value:i,correction:a,comment:s,feedback_source:g,comparative_experiment_id:f,feedbackConfig:d,session_id:p??h,start_time:m},w=JSON.stringify(_),y=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const E=await this._fetch(y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:w});return await R(E,"create feedback",!0),E}),_}async updateFeedback(e,{score:r,value:n,correction:i,comment:a}){const s={};r!=null&&(s.score=ka(r)),n!=null&&(s.value=n),i!=null&&(s.correction=i),a!=null&&(s.comment=a),M(e);const o=JSON.stringify(s);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await R(c,"update feedback",!0),c})}async readFeedback(e){M(e);const r=`/feedback/${e}`;return await this._get(r)}async deleteFeedback(e){M(e);const r=`/feedback/${e}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(n,`delete ${r}`,!0),n})}async*listFeedback({runIds:e,feedbackKeys:r,feedbackSourceTypes:n}={}){const i=new URLSearchParams;if(e)for(const a of e)M(a),i.append("run",a);if(r)for(const a of r)i.append("key",a);if(n)for(const a of n)i.append("source",a);for await(const a of this._getPaginated("/feedback",i))yield*a}async createPresignedFeedbackToken(e,r,{expiration:n,feedbackConfig:i}={}){const a={run_id:e,feedback_key:r,feedback_config:i};n?typeof n=="string"?a.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(a.expires_in=n):a.expires_in={hours:3};const s=JSON.stringify(a);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await R(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:e,experimentIds:r,referenceDatasetId:n,createdAt:i,description:a,metadata:s,id:o}){if(r.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:r[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:r,reference_dataset_id:n,description:a,created_at:(i??new Date)?.toISOString(),extra:{}};s&&(c.extra.metadata=s);const l=JSON.stringify(c);return(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await R(d,"create comparative experiment"),d})).json()}async*listPresignedFeedbackTokens(e){M(e);const r=new URLSearchParams({run_id:e});for await(const n of this._getPaginated("/feedback/tokens",r))yield*n}_selectEvalResults(e){let r;return"results"in e?r=e.results:Array.isArray(e)?r=e:r=[e],r}async _logEvaluationFeedback(e,r,n){const i=this._selectEvalResults(e),a=[];for(const s of i){let o=n||{};s.evaluatorInfo&&(o={...s.evaluatorInfo,...o});let c=null;s.targetRunId?c=s.targetRunId:r&&(c=r.id),a.push(await this.createFeedback(c,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model",sessionId:r?.session_id,startTime:r?.start_time}))}return[i,a]}async logEvaluationFeedback(e,r,n){const[i]=await this._logEvaluationFeedback(e,r,n);return i}async createFeedbackConfig(e){const{feedbackKey:r,feedbackConfig:n,isLowerScoreBetter:i=!1}=e,a={feedback_key:r,feedback_config:n,is_lower_score_better:i};return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/feedback-configs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)});return await R(o,"create feedback config"),o})).json()}async*listFeedbackConfigs(e={}){const{feedbackKeys:r,nameContains:n,limit:i}=e,a=new URLSearchParams;r&&r.forEach(o=>{a.append("key",o)}),n&&a.append("name_contains",n),a.append("limit",(i!==void 0?Math.min(i,100):100).toString());let s=0;for await(const o of this._getPaginated("/feedback-configs",a))if(yield*o,s+=o.length,i!==void 0&&s>=i)break}async updateFeedbackConfig(e,r={}){const{feedbackConfig:n,isLowerScoreBetter:i}=r,a={feedback_key:e};return n!==void 0&&(a.feedback_config=n),i!==void 0&&(a.is_lower_score_better=i),(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/feedback-configs`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)});return await R(o,"update feedback config"),o})).json()}async deleteFeedbackConfig(e){const r=new URLSearchParams({feedback_key:e});await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/feedback-configs?${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(n,"delete feedback config",!0),n})}async*listAnnotationQueues(e={}){const{queueIds:r,name:n,nameContains:i,limit:a}=e,s=new URLSearchParams;r&&r.forEach((c,l)=>{M(c,`queueIds[${l}]`),s.append("ids",c)}),n&&s.append("name",n),i&&s.append("name_contains",i),s.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",s))if(yield*c,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(e){const{name:r,description:n,queueId:i,rubricInstructions:a,rubricItems:s}=e,o={name:r,description:n,id:i||ze(),rubric_instructions:a,rubric_items:s},c=JSON.stringify(Object.fromEntries(Object.entries(o).filter(([u,d])=>d!==void 0)));return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await R(u,"create annotation queue"),u})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${M(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(e,r){const{name:n,description:i,rubricInstructions:a,rubricItems:s}=r,o={};n!==void 0&&(o.name=n),i!==void 0&&(o.description=i),a!==void 0&&(o.rubric_instructions=a),s!==void 0&&(o.rubric_items=s);const c=JSON.stringify(o);await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/annotation-queues/${M(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await R(l,"update annotation queue",!0),l})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${M(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(r,"delete annotation queue",!0),r})}async addRunsToAnnotationQueue(e,r){const n=JSON.stringify(r.map((i,a)=>M(i,`runIds[${a}]`).toString()));await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/annotation-queues/${M(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await R(i,"add runs to annotation queue",!0),i})}async getRunFromAnnotationQueue(e,r){const n=`/annotation-queues/${M(e,"queueId")}/run`;return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(a,"get run from annotation queue"),a})).json()}async deleteRunFromAnnotationQueue(e,r){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${M(e,"queueId")}/runs/${M(r,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${M(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(e){const r=await this._getSettings();return e=="-"||r.tenant_handle===e}async _ownerConflictError(e,r){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${r}`)}async _getLatestCommitHash(e){const n=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(i,"get latest commit hash"),i})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,r){const[n,i,a]=Ne(e),s=JSON.stringify({like:r});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${n}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await R(c,`${r?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(e){const[r,n,i]=Ne(e);if(await this._currentTenantIsOwner(r)){const a=await this._getSettings();return i!=="latest"?`${this.getHostUrl()}/prompts/${n}/${i.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${a.id}`}else return i!=="latest"?`${this.getHostUrl()}/hub/${r}/${n}/${i.substring(0,8)}`:`${this.getHostUrl()}/hub/${r}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const r of this._getPaginated(`/commits/${e}/`,new URLSearchParams,n=>n.commits))yield*r}async*listPrompts(e){const r=new URLSearchParams;r.append("sort_field",e?.sortField??"updated_at"),r.append("sort_direction","desc"),r.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&r.append("is_public",e.isPublic.toString()),e?.query&&r.append("query",e.query);for await(const n of this._getPaginated("/repos",r,i=>i.repos))yield*n}async getPrompt(e){const[r,n,i]=Ne(e),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return o?.status===404?null:(await R(o,"get prompt"),o)}))?.json();return s?.repo?s.repo:null}async createPrompt(e,r){const n=await this._getSettings();if(r?.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[i,a,s]=Ne(e);if(!await this._currentTenantIsOwner(i))throw await this._ownerConflictError("create a prompt",i);const o={repo_handle:a,...r?.description&&{description:r.description},...r?.readme&&{readme:r.readme},...r?.tags&&{tags:r.tags},is_public:!!r?.isPublic},c=JSON.stringify(o),l=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await R(d,"create prompt"),d}),{repo:u}=await l.json();return u}async createCommit(e,r,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[i,a,s]=Ne(e),o=n?.parentCommitHash==="latest"||!n?.parentCommitHash?await this._getLatestCommitHash(`${i}/${a}`):n?.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(r)),parent_commit:o},l=JSON.stringify(c),d=await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/commits/${i}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await R(h,"create commit"),h})).json();return this._getPromptUrl(`${i}/${a}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,r=[]){return this._updateExamplesMultipart(e,r)}async _updateExamplesMultipart(e,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const s of r){const o=s.id,c={...s.metadata&&{metadata:s.metadata},...s.split&&{split:s.split}},l=de(c,`Serializing body for example with id: ${o}`),u=new Blob([l],{type:"application/json"});if(n.append(o,u),s.inputs){const d=de(s.inputs,`Serializing inputs for example with id: ${o}`),h=new Blob([d],{type:"application/json"});n.append(`${o}.inputs`,h)}if(s.outputs){const d=de(s.outputs,`Serializing outputs whle updating example with id: ${o}`),h=new Blob([d],{type:"application/json"});n.append(`${o}.outputs`,h)}if(s.attachments)for(const[d,h]of Object.entries(s.attachments)){let f,p;Array.isArray(h)?[f,p]=h:(f=h.mimeType,p=h.data);const m=new Blob([p],{type:`${f}; length=${p.byteLength}`});n.append(`${o}.attachment.${d}`,m)}if(s.attachments_operations){const d=de(s.attachments_operations,`Serializing attachments while updating example with id: ${o}`),h=new Blob([d],{type:"application/json"});n.append(`${o}.attachments_operations`,h)}}const i=e??r[0]?.dataset_id;return(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${i}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await R(s,"update examples"),s})).json()}async uploadExamplesMultipart(e,r=[]){return this._uploadExamplesMultipart(e,r)}async _uploadExamplesMultipart(e,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const a of r){const s=(a.id??ze()).toString(),o={created_at:a.created_at,...a.metadata&&{metadata:a.metadata},...a.split&&{split:a.split},...a.source_run_id&&{source_run_id:a.source_run_id},...a.use_source_run_io&&{use_source_run_io:a.use_source_run_io},...a.use_source_run_attachments&&{use_source_run_attachments:a.use_source_run_attachments}},c=de(o,`Serializing body for uploaded example with id: ${s}`),l=new Blob([c],{type:"application/json"});if(n.append(s,l),a.inputs){const u=de(a.inputs,`Serializing inputs for uploaded example with id: ${s}`),d=new Blob([u],{type:"application/json"});n.append(`${s}.inputs`,d)}if(a.outputs){const u=de(a.outputs,`Serializing outputs for uploaded example with id: ${s}`),d=new Blob([u],{type:"application/json"});n.append(`${s}.outputs`,d)}if(a.attachments)for(const[u,d]of Object.entries(a.attachments)){let h,f;Array.isArray(d)?[h,f]=d:(h=d.mimeType,f=d.data);const p=new Blob([f],{type:`${h}; length=${f.byteLength}`});n.append(`${s}.attachment.${u}`,p)}}return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await R(a,"upload examples"),a})).json()}async updatePrompt(e,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,i]=Ne(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const a={};if(r?.description!==void 0&&(a.description=r.description),r?.readme!==void 0&&(a.readme=r.readme),r?.tags!==void 0&&(a.tags=r.tags),r?.isPublic!==void 0&&(a.is_public=r.isPublic),r?.isArchived!==void 0&&(a.is_archived=r.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const s=JSON.stringify(a);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${n}/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await R(c,"update prompt"),c})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,n,i]=Ne(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("delete a prompt",r);return(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(s,"delete prompt"),s})).json()}_getPromptCacheKey(e,r){return`${e}${r?":with_model":""}`}async _fetchPromptFromApi(e,r){const[n,i,a]=Ne(e),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${n}/${i}/${a}${r?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await R(c,"pull prompt commit"),c})).json();return{owner:n,repo:i,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async pullPromptCommit(e,r){const n=this._fetchPromptFromApi.bind(this,e,r);if(!r?.skipCache&&this._promptCache){const i=this._getPromptCacheKey(e,r?.includeModel),a=this._promptCache.get(i,n);if(a)return a;const s=await n();return this._promptCache.set(i,s,n),s}return this._fetchPromptFromApi(e,r)}async _pullPrompt(e,r){const n=await this.pullPromptCommit(e,{includeModel:r?.includeModel,skipCache:r?.skipCache});return JSON.stringify(n.manifest)}async pushPrompt(e,r){return await this.promptExists(e)?r&&Object.keys(r).some(i=>i!=="object")&&await this.updatePrompt(e,{description:r?.description,readme:r?.readme,tags:r?.tags,isPublic:r?.isPublic}):await this.createPrompt(e,{description:r?.description,readme:r?.readme,tags:r?.tags,isPublic:r?.isPublic}),r?.object?await this.createCommit(e,r?.object,{parentCommitHash:r?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,r={}){const{sourceApiUrl:n=this.apiUrl,datasetName:i}=r,[a,s]=this.parseTokenOrUrl(e,n),o=new gt({apiUrl:a,apiKey:"placeholder"}),c=await o.readSharedDataset(s),l=i||c.name;try{if(await this.hasDataset({datasetId:l})){console.log(`Dataset ${l} already exists in your tenant. Skipping.`);return}}catch{}const u=await o.listSharedExamples(s),d=await this.createDataset(l,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map(h=>h.inputs),outputs:u.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),h}}parseTokenOrUrl(e,r,n=2,i="dataset"){try{return M(e),[r,e]}catch{}try{const s=new URL(e).pathname.split("/").filter(o=>o!=="");if(s.length>=n){const o=s[s.length-n];return[r,o]}else throw new Error(`Invalid public ${i} URL: ${e}`)}catch{throw new Error(`Invalid public ${i} URL or token: ${e}`)}}cleanup(){this._promptCache&&this._promptCache.stop()}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await new Promise(e=>setTimeout(e,1)),await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await vu()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}}function ja(t){return"dataset_id"in t||"dataset_name"in t}const Cd=t=>!!["TRACING_V2","TRACING"].find(r=>ne(r)==="true"),Me=Symbol.for("lc:context_variables"),dn=Symbol.for("langsmith:replica_trace_roots");function Da(t,e){if(Me in t)return t[Me][e]}function Nd(t,e,r){const n=Me in t?t[Me]:{};n[e]=r,t[Me]=n}const $d="6ba7b810-9dad-11d1-80b4-00c04fd430c8";function Ua(t){const r=Object.keys(t).sort().map(n=>`${n}:${t[n]??""}`).join("|");return Wc(r,$d)}function Pd(t){return t.replace(/[-:.]/g,"")}function Vs(t,e=1){const r=e.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(t).toISOString().slice(0,-1)}${r}Z`}function Js(t,e,r=1){const n=Vs(t,r);return{dottedOrder:Pd(n)+e,microsecondPrecisionDatestring:n}}const Ld=new Set(["projectName","updates","reroot"]);function kd(t){const e={};for(const r of Object.keys(t))Ld.has(r)&&(e[r]=t[r]);return e}class Gt{constructor(e,r,n,i){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=r,this.project_name=n,this.replicas=i}static fromHeader(e){const r=e.split(",");let n={},i=[],a,s;for(const o of r){const[c,l]=o.split("="),u=decodeURIComponent(l);c==="langsmith-metadata"?n=JSON.parse(u):c==="langsmith-tags"?i=u.split(","):c==="langsmith-project"?a=u:c==="langsmith-replicas"&&(s=JSON.parse(u).map(h=>Array.isArray(h)?h:kd(h)))}return new Gt(n,i,a,s)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class ce{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"distributedParentId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_awaitInputsOnPost",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Md(e)){Object.assign(this,{...e});return}const r=ce.getDefaultConfig(),{metadata:n,...i}=e,a=i.client??ce.getSharedClient(),s={...n,...i?.extra?.metadata};if(i.extra={...i.extra,metadata:s},"id"in i&&i.id==null&&delete i.id,Object.assign(this,{...r,...i,client:a}),this.execution_order??=1,this.child_execution_order??=1,this.dotted_order||(this._serialized_start_time=Vs(this.start_time,this.execution_order)),this.id||(this.id=Xl(this._serialized_start_time??this.start_time)),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=Fd(this.replicas),!this.dotted_order){const{dottedOrder:o}=Js(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){const e=Date.now();return{run_type:"chain",project_name:Ts(),child_runs:[],api_url:Ae("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Ae("LANGCHAIN_API_KEY"),caller_options:{},start_time:e,serialized:{},inputs:{},extra:{}}}static getSharedClient(){return ce.sharedClient||(ce.sharedClient=new gt),ce.sharedClient}createChild(e){const r=this.child_execution_order+1,n=this.replicas?.map(u=>{const{reroot:d,...h}=u;return h}),i=e.replicas??n,a=new ce({...e,parent_run:this,project_name:this.project_name,replicas:i,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:r,child_execution_order:r});Me in this&&(a[Me]=this[Me]);const s=Symbol.for("lc:child_config"),o=e.extra?.[s]??this.extra[s];if(Dd(o)){const u={...o},d=jd(u.callbacks)?u.callbacks.copy?.():void 0;d&&(Object.assign(d,{_parentRunId:a.id}),d.handlers?.find(Zs)?.updateFromRunTree?.(a),u.callbacks=d),a.extra[s]=u}const c=new Set;let l=this;for(;l!=null&&!c.has(l.id);)c.add(l.id),l.child_execution_order=Math.max(l.child_execution_order,r),l=l.parent_run;return this.child_runs.push(a),a}async end(e,r,n=Date.now(),i){this.outputs=this.outputs??e,this.error=this.error??r,this.end_time=this.end_time??n,i&&Object.keys(i).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...i}}:{metadata:i})}_convertToCreate(e,r,n=!0){const i=e.extra??{};if(i?.runtime?.library===void 0&&(i.runtime||(i.runtime={}),r))for(const[o,c]of Object.entries(r))i.runtime[o]||(i.runtime[o]=c);let a,s;return n?(s=e.parent_run?.id??e.parent_run_id,a=[]):(a=e.child_runs.map(o=>this._convertToCreate(o,r,n)),s=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:i,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:s,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_sliceParentId(e,r){if(r.dotted_order){const n=r.dotted_order.split(".");let i=null;for(let a=0;a<n.length;a++)if(n[a].slice(-36)===e){i=a;break}if(i!==null){const a=n.slice(i+1);r.dotted_order=a.join("."),a.length>0?r.trace_id=a[0].slice(-36):r.trace_id=r.id}}r.parent_run_id===e&&(r.parent_run_id=void 0)}_setReplicaTraceRoot(e,r){const n=Da(this,dn)??{};n[e]=r,Nd(this,dn,n);for(const i of this.child_runs)i._setReplicaTraceRoot(e,r)}_remapForProject(e){const{projectName:r,runtimeEnv:n,excludeChildRuns:i=!0,reroot:a=!1,distributedParentId:s,apiUrl:o,apiKey:c,workspaceId:l}=e,u=this._convertToCreate(this,n,i);if(r===this.project_name)return{...u,session_name:r};if(a){if(s)this._sliceParentId(s,u);else if(u.parent_run_id=void 0,u.dotted_order){const w=u.dotted_order.split(".");w.length>0&&(u.dotted_order=w[w.length-1],u.trace_id=u.id)}const _=Ua({projectName:r,apiUrl:o,apiKey:c,workspaceId:l});this._setReplicaTraceRoot(_,u.id)}let d;if(!a){const _=Da(this,dn)??{},w=Ua({projectName:r,apiUrl:o,apiKey:c,workspaceId:l});if(d=_[w],d&&(u.trace_id=d,u.dotted_order)){const y=u.dotted_order.split(".");let E=null;for(let S=0;S<y.length;S++)if(y[S].slice(-36)===d){E=S;break}if(E!==null){const S=y.slice(E);u.dotted_order=S.join(".")}}}const h=u.id,f=It(h,r);let p;u.trace_id?p=It(u.trace_id,r):p=f;let m;u.parent_run_id&&(m=It(u.parent_run_id,r));let g;return u.dotted_order&&(g=u.dotted_order.split(".").map(y=>{const E=y.slice(-36),S=It(E,r);return y.slice(0,-36)+S}).join(".")),{...u,id:f,trace_id:p,parent_run_id:m,dotted_order:g,session_name:r}}async postRun(e=!0){this._awaitInputsOnPost&&(this.inputs=await this.inputs);try{const r=ks();if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:i,apiUrl:a,workspaceId:s,reroot:o}of this.replicas){const c=this._remapForProject({projectName:n??this.project_name,runtimeEnv:r,excludeChildRuns:!0,reroot:o,distributedParentId:this.distributedParentId,apiUrl:a,apiKey:i,workspaceId:s});await this.client.createRun(c,{apiKey:i,apiUrl:a,workspaceId:s})}else{const n=this._convertToCreate(this,r,e);await this.client.createRun(n)}if(!e){Mt("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const n of this.child_runs)await n.postRun(!1)}this.child_runs=[]}catch(r){console.error(`Error in postRun for run ${this.id}:`,r)}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:n,apiUrl:i,workspaceId:a,updates:s,reroot:o}of this.replicas){const c=this._remapForProject({projectName:r??this.project_name,runtimeEnv:void 0,excludeChildRuns:!0,reroot:o,distributedParentId:this.distributedParentId,apiUrl:i,apiKey:n,workspaceId:a}),l={id:c.id,name:c.name,run_type:c.run_type,start_time:c.start_time,outputs:c.outputs,error:c.error,parent_run_id:c.parent_run_id,session_name:c.session_name,reference_example_id:c.reference_example_id,end_time:c.end_time,dotted_order:c.dotted_order,trace_id:c.trace_id,events:c.events,tags:c.tags,extra:c.extra,attachments:this.attachments,...s};e?.excludeInputs||(l.inputs=c.inputs),await this.client.updateRun(c.id,l,{apiKey:n,apiUrl:i,workspaceId:a})}else try{const r={name:this.name,run_type:this.run_type,start_time:this._serialized_start_time??this.start_time,end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(r.inputs=this.inputs),await this.client.updateRun(this.id,r)}catch(r){console.error(`Error in patchRun for run ${this.id}`,r)}this.child_runs=[]}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,r){const n=e?.callbacks;let i,a,s,o=Cd();if(n){const l=n?.getParentRunId?.()??"",u=n?.handlers?.find(d=>d?.name=="langchain_tracer");i=u?.getRun?.(l),a=u?.projectName,s=u?.client,o=o||!!u}return i?new ce({name:i.name,id:i.id,trace_id:i.trace_id,dotted_order:i.dotted_order,client:s,tracingEnabled:o,project_name:a,tags:[...new Set((i?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...i?.extra?.metadata,...e?.metadata}}}).createChild(r):new ce({...r,client:s,tracingEnabled:o,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,r){const n="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,i=n["langsmith-trace"];if(!i||typeof i!="string")return;const a=i.trim(),s=a.split(".").map(u=>{const[d,h]=u.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=s[0].uuid,c={...r,name:r?.name??"parent",run_type:r?.run_type??"chain",start_time:r?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:o,dotted_order:a};if(n.baggage&&typeof n.baggage=="string"){const u=Gt.fromHeader(n.baggage);c.metadata=u.metadata,c.tags=u.tags,c.project_name=u.project_name,c.replicas=u.replicas}const l=new ce(c);return l.distributedParentId=l.id,l}toHeaders(e){const r={"langsmith-trace":this.dotted_order,baggage:new Gt(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[n,i]of Object.entries(r))e.set(n,i);return r}}Object.defineProperty(ce,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function Md(t){return t!=null&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function Zs(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function Fa(t){return Array.isArray(t)&&t.some(e=>Zs(e))}function jd(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function Dd(t){const e=t?.callbacks;return t!=null&&typeof e=="object"&&(Fa(e?.handlers)||Fa(e))}function Ud(){const t=Ae("LANGSMITH_RUNS_ENDPOINTS");if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e)){const r=[];for(const n of e){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}r.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return r}else if(typeof e=="object"&&e!==null){Bd(e);const r=[];for(const[n,i]of Object.entries(e)){const a=n.replace(/\/$/,"");if(typeof i=="string")r.push({apiUrl:a,apiKey:i});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof i}`);continue}}return r}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(gd(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function Fd(t){return t?t.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):Ud()}function Bd(t){if(Object.keys(t).length>0&&ne("ENDPOINT"))throw new md}const zd=t=>{if(t)return t.events=t.events??[],t.child_runs=t.child_runs??[],t};function In(t,e){if(t)return new ce({...t,start_time:t._serialized_start_time??t.start_time,parent_run:In(e),child_runs:t.child_runs.map(r=>In(r)).filter(r=>r!==void 0),extra:{...t.extra,runtime:Uc()},tracingEnabled:!1})}function hn(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function ot(t){return typeof t._addRunToRunMap=="function"}var vt=class extends Yt{runMap=new Map;runTreeMap=new Map;usesRunTreeMap=!1;constructor(t){super(...arguments)}copy(){return this}getRunById(t){if(t!==void 0)return this.usesRunTreeMap?zd(this.runTreeMap.get(t)):this.runMap.get(t)}stringifyError(t){return t instanceof Error?t.message+(t?.stack?`

${t.stack}`:""):typeof t=="string"?t:`${t}`}_addChildRun(t,e){t.child_runs.push(e)}_addRunToRunMap(t){const{dottedOrder:e,microsecondPrecisionDatestring:r}=Js(new Date(t.start_time).getTime(),t.id,t.execution_order),n={...t},i=this.getRunById(n.parent_run_id);if(n.parent_run_id!==void 0?i?(this._addChildRun(i,n),i.child_execution_order=Math.max(i.child_execution_order,n.child_execution_order),n.trace_id=i.trace_id,i.dotted_order!==void 0&&(n.dotted_order=[i.dotted_order,e].join("."),n._serialized_start_time=r)):n.parent_run_id=void 0:(n.trace_id=n.id,n.dotted_order=e,n._serialized_start_time=r),this.usesRunTreeMap){const a=In(n,i);a!==void 0&&this.runTreeMap.set(n.id,a)}else this.runMap.set(n.id,n);return n}async _endTrace(t){const e=t.parent_run_id!==void 0&&this.getRunById(t.parent_run_id);e?e.child_execution_order=Math.max(e.child_execution_order,t.child_execution_order):await this.persistRun(t),await this.onRunUpdate?.(t),this.usesRunTreeMap?this.runTreeMap.delete(t.id):this.runMap.delete(t.id)}_getExecutionOrder(t){const e=t!==void 0&&this.getRunById(t);return e?e.child_execution_order+1:1}_createRunForLLMStart(t,e,r,n,i,a,s,o){const c=this._getExecutionOrder(n),l=Date.now(),u=s?{...i,metadata:s}:i,d={id:r,name:o??t.id[t.id.length-1],parent_run_id:n,start_time:l,serialized:t,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:e},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:a||[]};return this._addRunToRunMap(d)}async handleLLMStart(t,e,r,n,i,a,s,o){const c=this.getRunById(r)??this._createRunForLLMStart(t,e,r,n,i,a,s,o);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}_createRunForChatModelStart(t,e,r,n,i,a,s,o){const c=this._getExecutionOrder(n),l=Date.now(),u=s?{...i,metadata:s}:i,d={id:r,name:o??t.id[t.id.length-1],parent_run_id:n,start_time:l,serialized:t,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:e},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:a||[]};return this._addRunToRunMap(d)}async handleChatModelStart(t,e,r,n,i,a,s,o){const c=this.getRunById(r)??this._createRunForChatModelStart(t,e,r,n,i,a,s,o);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}async handleLLMEnd(t,e,r,n,i){const a=this.getRunById(e);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=t,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMEnd?.(a),await this._endTrace(a),a}async handleLLMError(t,e,r,n,i){const a=this.getRunById(e);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(t),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMError?.(a),await this._endTrace(a),a}_createRunForChainStart(t,e,r,n,i,a,s,o,c){const l=this._getExecutionOrder(n),u=Date.now(),d={id:r,name:o??t.id[t.id.length-1],parent_run_id:n,start_time:u,serialized:t,events:[{name:"start",time:new Date(u).toISOString()}],inputs:e,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:a?{...c,metadata:a}:{...c},tags:i||[]};return this._addRunToRunMap(d)}async handleChainStart(t,e,r,n,i,a,s,o){const c=this.getRunById(r)??this._createRunForChainStart(t,e,r,n,i,a,s,o);return await this.onRunCreate?.(c),await this.onChainStart?.(c),c}async handleChainEnd(t,e,r,n,i){const a=this.getRunById(e);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=hn(t,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=hn(i.inputs,"input")),await this.onChainEnd?.(a),await this._endTrace(a),a}async handleChainError(t,e,r,n,i){const a=this.getRunById(e);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(t),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=hn(i.inputs,"input")),await this.onChainError?.(a),await this._endTrace(a),a}_createRunForToolStart(t,e,r,n,i,a,s){const o=this._getExecutionOrder(n),c=Date.now(),l={id:r,name:s??t.id[t.id.length-1],parent_run_id:n,start_time:c,serialized:t,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:e},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleToolStart(t,e,r,n,i,a,s){const o=this.getRunById(r)??this._createRunForToolStart(t,e,r,n,i,a,s);return await this.onRunCreate?.(o),await this.onToolStart?.(o),o}async handleToolEnd(t,e){const r=this.getRunById(e);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:t},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(t,e){const r=this.getRunById(e);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(t),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(t,e){const r=this.getRunById(e);if(!r||r?.run_type!=="chain")return;const n=r;n.actions=n.actions||[],n.actions.push(t),n.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:t}}),await this.onAgentAction?.(r)}async handleAgentEnd(t,e){const r=this.getRunById(e);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:t}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(t,e,r,n,i,a,s){const o=this._getExecutionOrder(n),c=Date.now(),l={id:r,name:s??t.id[t.id.length-1],parent_run_id:n,start_time:c,serialized:t,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:e},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(t,e,r,n,i,a,s){const o=this.getRunById(r)??this._createRunForRetrieverStart(t,e,r,n,i,a,s);return await this.onRunCreate?.(o),await this.onRetrieverStart?.(o),o}async handleRetrieverEnd(t,e){const r=this.getRunById(e);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:t},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(t,e){const r=this.getRunById(e);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(t),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(t,e){const r=this.getRunById(e);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:t}}),await this.onText?.(r))}async handleLLMNewToken(t,e,r,n,i,a){const s=this.getRunById(r);if(!s||s?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:t,idx:e,chunk:a?.chunk}}),await this.onLLMNewToken?.(s,t,{chunk:a?.chunk}),s}},Dt={exports:{}};Dt.exports;var Ba;function qd(){return Ba||(Ba=1,(function(t){const r=(a=0)=>s=>`\x1B[${38+a};5;${s}m`,n=(a=0)=>(s,o,c)=>`\x1B[${38+a};2;${s};${o};${c}m`;function i(){const a=new Map,s={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};s.color.gray=s.color.blackBright,s.bgColor.bgGray=s.bgColor.bgBlackBright,s.color.grey=s.color.blackBright,s.bgColor.bgGrey=s.bgColor.bgBlackBright;for(const[o,c]of Object.entries(s)){for(const[l,u]of Object.entries(c))s[l]={open:`\x1B[${u[0]}m`,close:`\x1B[${u[1]}m`},c[l]=s[l],a.set(u[0],u[1]);Object.defineProperty(s,o,{value:c,enumerable:!1})}return Object.defineProperty(s,"codes",{value:a,enumerable:!1}),s.color.close="\x1B[39m",s.bgColor.close="\x1B[49m",s.color.ansi256=r(),s.color.ansi16m=n(),s.bgColor.ansi256=r(10),s.bgColor.ansi16m=n(10),Object.defineProperties(s,{rgbToAnsi256:{value:(o,c,l)=>o===c&&c===l?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(l/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:l}=c.groups;l.length===3&&(l=l.split("").map(d=>d+d).join(""));const u=Number.parseInt(l,16);return[u>>16&255,u>>8&255,u&255]},enumerable:!1},hexToAnsi256:{value:o=>s.rgbToAnsi256(...s.hexToRgb(o)),enumerable:!1}}),s}Object.defineProperty(t,"exports",{enumerable:!0,get:i})})(Dt)),Dt.exports}var Gd=qd();const Ks=Xt(Gd);function te(t,e){return`${t.open}${e}${t.close}`}function pe(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function za(t){return typeof t=="string"?t.trim():t==null?t:pe(t,t.toString())}function $e(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:oe}=Ks;var qa=class extends vt{name="console_callback_handler";persistRun(t){return Promise.resolve()}getParents(t){const e=[];let r=t;for(;r.parent_run_id;){const n=this.runMap.get(r.parent_run_id);if(n)e.push(n),r=n;else break}return e}getBreadcrumbs(t){const e=[...this.getParents(t).reverse(),t].map((r,n,i)=>{const a=`${r.execution_order}:${r.run_type}:${r.name}`;return n===i.length-1?te(Ks.bold,a):a}).join(" > ");return te(oe.grey,e)}onChainStart(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.green,"[chain/start]")} [${e}] Entering Chain run with input: ${pe(t.inputs,"[inputs]")}`)}onChainEnd(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.cyan,"[chain/end]")} [${e}] [${$e(t)}] Exiting Chain run with output: ${pe(t.outputs,"[outputs]")}`)}onChainError(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.red,"[chain/error]")} [${e}] [${$e(t)}] Chain run errored with error: ${pe(t.error,"[error]")}`)}onLLMStart(t){const e=this.getBreadcrumbs(t),r="prompts"in t.inputs?{prompts:t.inputs.prompts.map(n=>n.trim())}:t.inputs;console.log(`${te(oe.green,"[llm/start]")} [${e}] Entering LLM run with input: ${pe(r,"[inputs]")}`)}onLLMEnd(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.cyan,"[llm/end]")} [${e}] [${$e(t)}] Exiting LLM run with output: ${pe(t.outputs,"[response]")}`)}onLLMError(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.red,"[llm/error]")} [${e}] [${$e(t)}] LLM run errored with error: ${pe(t.error,"[error]")}`)}onToolStart(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.green,"[tool/start]")} [${e}] Entering Tool run with input: "${za(t.inputs.input)}"`)}onToolEnd(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.cyan,"[tool/end]")} [${e}] [${$e(t)}] Exiting Tool run with output: "${za(t.outputs?.output)}"`)}onToolError(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.red,"[tool/error]")} [${e}] [${$e(t)}] Tool run errored with error: ${pe(t.error,"[error]")}`)}onRetrieverStart(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.green,"[retriever/start]")} [${e}] Entering Retriever run with input: ${pe(t.inputs,"[inputs]")}`)}onRetrieverEnd(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.cyan,"[retriever/end]")} [${e}] [${$e(t)}] Exiting Retriever run with output: ${pe(t.outputs,"[outputs]")}`)}onRetrieverError(t){const e=this.getBreadcrumbs(t);console.log(`${te(oe.red,"[retriever/error]")} [${e}] [${$e(t)}] Retriever run errored with error: ${pe(t.error,"[error]")}`)}onAgentAction(t){const e=t,r=this.getBreadcrumbs(t);console.log(`${te(oe.blue,"[agent/action]")} [${r}] Agent selected action: ${pe(e.actions[e.actions.length-1],"[action]")}`)}};let fn;const Hd=()=>(fn===void 0&&(fn=new gt(Qe("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{})),fn);let Vd=class{getStore(){}run(e,r){return r()}};const pn=Symbol.for("ls:tracing_async_local_storage"),Jd=new Vd;let Zd=class{getInstance(){return globalThis[pn]??Jd}initializeGlobalInstance(e){globalThis[pn]===void 0&&(globalThis[pn]=e)}};const Kd=new Zd;function Wd(t=!1){const e=Kd.getInstance().getStore();if(!t&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function Wn(t){return typeof t=="function"&&"langsmith:traceable"in t}function Xd(t){let e;for(const r of t)for(const n of r)Cc.isInstance(n.message)&&n.message.usage_metadata!==void 0&&(e=vs(e,n.message.usage_metadata));return e}var mn=class Ws extends vt{name="langchain_tracer";projectName;exampleId;client;replicas;usesRunTreeMap=!0;constructor(e={}){super(e);const{exampleId:r,projectName:n,client:i,replicas:a}=e;this.projectName=n??Ts(),this.replicas=a,this.exampleId=r,this.client=i??Hd();const s=Ws.getTraceableRunTree();s&&this.updateFromRunTree(s)}async persistRun(e){}async onRunCreate(e){e.extra?.lc_defers_inputs||await this.getRunTreeWithTracingConfig(e.id)?.postRun()}async onRunUpdate(e){const r=this.getRunTreeWithTracingConfig(e.id);e.extra?.lc_defers_inputs?await r?.postRun():await r?.patchRun()}onLLMEnd(e){const r=e.outputs;if(r?.generations){const n=Xd(r.generations);if(n!==void 0){e.extra=e.extra??{};const i=e.extra.metadata??{};i.usage_metadata=n,e.extra.metadata=i}}}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let r=e;const n=new Set;for(;r.parent_run&&!(n.has(r.id)||(n.add(r.id),!r.parent_run));)r=r.parent_run;n.clear();const i=[r];for(;i.length>0;){const a=i.shift();!a||n.has(a.id)||(n.add(a.id),this.runTreeMap.set(a.id,a),a.child_runs&&i.push(...a.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){const r=this.runTreeMap.get(e);if(r)return new ce({...r,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return Wd(!0)}catch{return}}};let ht;function Qd(){return new("default"in Oe?Oe.default:Oe)({autoStart:!0,concurrency:1})}function Yd(){return typeof ht>"u"&&(ht=Qd()),ht}async function W(t,e){if(e===!0){const r=pt();r!==void 0?await r.run(void 0,async()=>t()):await t()}else ht=Yd(),ht.add(async()=>{const r=pt();r!==void 0?await r.run(void 0,async()=>t()):await t()})}const eh=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(e=>Qe(e)==="true");function Xs(t){const e=pt();if(e!==void 0)return e.getStore()?.[kt]?.[t]}const th=Symbol("lc:configure_hooks"),rh=()=>Xs(th)||[];var nh=class{setHandler(t){return this.setHandlers([t])}},ar=class{constructor(t,e,r,n,i,a,s,o){this.runId=t,this.handlers=e,this.inheritableHandlers=r,this.tags=n,this.inheritableTags=i,this.metadata=a,this.inheritableMetadata=s,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(t){await Promise.all(this.handlers.map(e=>W(async()=>{try{await e.handleText?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleCustomEvent(t,e,r,n,i){await Promise.all(this.handlers.map(a=>W(async()=>{try{await a.handleCustomEvent?.(t,e,this.runId,this.tags,this.metadata)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}},ih=class extends ar{getChild(t){const e=new nt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleRetrieverEnd(t){await Promise.all(this.handlers.map(e=>W(async()=>{if(!e.ignoreRetriever)try{await e.handleRetrieverEnd?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw r}},e.awaitHandlers)))}async handleRetrieverError(t){await Promise.all(this.handlers.map(e=>W(async()=>{if(!e.ignoreRetriever)try{await e.handleRetrieverError?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${r}`),e.raiseError)throw t}},e.awaitHandlers)))}},Ga=class extends ar{async handleLLMNewToken(t,e,r,n,i,a){await Promise.all(this.handlers.map(s=>W(async()=>{if(!s.ignoreLLM)try{await s.handleLLMNewToken?.(t,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleLLMNewToken: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleLLMError(t,e,r,n,i){await Promise.all(this.handlers.map(a=>W(async()=>{if(!a.ignoreLLM)try{await a.handleLLMError?.(t,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMError: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}async handleLLMEnd(t,e,r,n,i){await Promise.all(this.handlers.map(a=>W(async()=>{if(!a.ignoreLLM)try{await a.handleLLMEnd?.(t,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMEnd: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}},ah=class extends ar{getChild(t){const e=new nt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleChainError(t,e,r,n,i){await Promise.all(this.handlers.map(a=>W(async()=>{if(!a.ignoreChain)try{await a.handleChainError?.(t,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainError: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}async handleChainEnd(t,e,r,n,i){await Promise.all(this.handlers.map(a=>W(async()=>{if(!a.ignoreChain)try{await a.handleChainEnd?.(t,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainEnd: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}async handleAgentAction(t){await Promise.all(this.handlers.map(e=>W(async()=>{if(!e.ignoreAgent)try{await e.handleAgentAction?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleAgentEnd(t){await Promise.all(this.handlers.map(e=>W(async()=>{if(!e.ignoreAgent)try{await e.handleAgentEnd?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},sh=class extends ar{getChild(t){const e=new nt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleToolError(t){await Promise.all(this.handlers.map(e=>W(async()=>{if(!e.ignoreAgent)try{await e.handleToolError?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleToolEvent(t){await Promise.all(this.handlers.map(e=>W(async()=>{if(!e.ignoreAgent)try{await e.handleToolEvent?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if(e.raiseError)throw r}},e.awaitHandlers)))}async handleToolEnd(t){await Promise.all(this.handlers.map(e=>W(async()=>{if(!e.ignoreAgent)try{await e.handleToolEnd?.(t,this.runId,this._parentRunId,this.tags)}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},nt=class lt extends nh{handlers=[];inheritableHandlers=[];tags=[];inheritableTags=[];metadata={};inheritableMetadata={};name="callback_manager";_parentRunId;constructor(e,r){super(),this.handlers=r?.handlers??this.handlers,this.inheritableHandlers=r?.inheritableHandlers??this.inheritableHandlers,this.tags=r?.tags??this.tags,this.inheritableTags=r?.inheritableTags??this.inheritableTags,this.metadata=r?.metadata??this.metadata,this.inheritableMetadata=r?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,r,n=void 0,i=void 0,a=void 0,s=void 0,o=void 0,c=void 0){return Promise.all(r.map(async(l,u)=>{const d=u===0&&n?n:Pe();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return ot(h)&&h._createRunForLLMStart(e,[l],d,this._parentRunId,a,this.tags,this.metadata,c),W(async()=>{try{await h.handleLLMStart?.(e,[l],d,this._parentRunId,a,this.tags,this.metadata,c)}catch(f){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`),h.raiseError)throw f}},h.awaitHandlers)})),new Ga(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,r,n=void 0,i=void 0,a=void 0,s=void 0,o=void 0,c=void 0){return Promise.all(r.map(async(l,u)=>{const d=u===0&&n?n:Pe();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return ot(h)&&h._createRunForChatModelStart(e,[l],d,this._parentRunId,a,this.tags,this.metadata,c),W(async()=>{try{if(h.handleChatModelStart)await h.handleChatModelStart?.(e,[l],d,this._parentRunId,a,this.tags,this.metadata,c);else if(h.handleLLMStart){const f=Nc(l);await h.handleLLMStart?.(e,[f],d,this._parentRunId,a,this.tags,this.metadata,c)}}catch(f){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`),h.raiseError)throw f}},h.awaitHandlers)})),new Ga(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,r,n=Pe(),i=void 0,a=void 0,s=void 0,o=void 0,c=void 0,l=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return ot(u)&&u._createRunForChainStart(e,r,n,this._parentRunId,this.tags,this.metadata,i,o,l),W(async()=>{try{await u.handleChainStart?.(e,r,n,this._parentRunId,this.tags,this.metadata,i,o,l)}catch(d){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${d}`),u.raiseError)throw d}},u.awaitHandlers)})),new ah(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,r,n=Pe(),i=void 0,a=void 0,s=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreAgent)return ot(l)&&l._createRunForToolStart(e,r,n,this._parentRunId,this.tags,this.metadata,o),W(async()=>{try{await l.handleToolStart?.(e,r,n,this._parentRunId,this.tags,this.metadata,o,c)}catch(u){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleToolStart: ${u}`),l.raiseError)throw u}},l.awaitHandlers)})),new sh(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,r,n=Pe(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreRetriever)return ot(c)&&c._createRunForRetrieverStart(e,r,n,this._parentRunId,this.tags,this.metadata,o),W(async()=>{try{await c.handleRetrieverStart?.(e,r,n,this._parentRunId,this.tags,this.metadata,o)}catch(l){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${l}`),c.raiseError)throw l}},c.awaitHandlers)})),new ih(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,r,n,i,a){await Promise.all(this.handlers.map(s=>W(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(e,r,n,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(e,r=!0){this.handlers.push(e),r&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(r=>r!==e),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==e)}setHandlers(e,r=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,r)}addTags(e,r=!0){this.removeTags(e),this.tags.push(...e),r&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(r=>!e.includes(r)),this.inheritableTags=this.inheritableTags.filter(r=>!e.includes(r))}addMetadata(e,r=!0){this.metadata={...this.metadata,...e},r&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const r of Object.keys(e))delete this.metadata[r],delete this.inheritableMetadata[r]}copy(e=[],r=!0){const n=new lt(this._parentRunId);for(const i of this.handlers){const a=this.inheritableHandlers.includes(i);n.addHandler(i,a)}for(const i of this.tags){const a=this.inheritableTags.includes(i);n.addTags([i],a)}for(const i of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(i);n.addMetadata({[i]:this.metadata[i]},a)}for(const i of e)n.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||n.addHandler(i,r);return n}static fromHandlers(e){class r extends Yt{name=Pe();constructor(){super(),Object.assign(this,e)}}const n=new this;return n.addHandler(new r),n}static configure(e,r,n,i,a,s,o){return this._configureSync(e,r,n,i,a,s,o)}static _configureSync(e,r,n,i,a,s,o){let c;(e||r)&&(Array.isArray(e)||!e?(c=new lt,c.setHandlers(e?.map(Ht)??[],!0)):c=e,c=c.copy(Array.isArray(r)?r.map(Ht):r?.handlers,!1));const l=Qe("LANGCHAIN_VERBOSE")==="true"||o?.verbose,u=mn.getTraceableRunTree()?.tracingEnabled??eh(),d=u||(Qe("LANGCHAIN_TRACING")??!1);if(l||d){if(c||(c=new lt),l&&!c.handlers.some(h=>h.name===qa.prototype.name)){const h=new qa;c.addHandler(h,!0)}if(d&&!c.handlers.some(h=>h.name==="langchain_tracer")&&u){const h=new mn;c.addHandler(h,!0)}if(u){const h=mn.getTraceableRunTree();h&&c._parentRunId===void 0&&(c._parentRunId=h.id,c.handlers.find(f=>f.name==="langchain_tracer")?.updateFromRunTree(h))}}for(const{contextVar:h,inheritable:f=!0,handlerClass:p,envVar:m}of rh()){const g=m&&Qe(m)==="true"&&p;let _;const w=h!==void 0?Xs(h):void 0;w&&Qc(w)?_=w:g&&(_=new p({})),_!==void 0&&(c||(c=new lt),c.handlers.some(y=>y.name===_.name)||c.addHandler(_,f))}return(n||i)&&c&&(c.addTags(n??[]),c.addTags(i??[],!1)),(a||s)&&c&&(c.addMetadata(a??{}),c.addMetadata(s??{},!1)),c}};function Ht(t){return"name"in t?t:Yt.fromMethods(t)}var oh=class{getStore(){}run(t,e){return e()}enterWith(t){}};const ch=new oh,Ha=Symbol.for("lc:child_config");var lh=class{getInstance(){return pt()??ch}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[Ha]}runWithConfig(t,e,r){const n=nt._configureSync(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),i=this.getInstance(),a=i.getStore(),s=n?.getParentRunId(),o=n?.handlers?.find(l=>l?.name==="langchain_tracer");let c;return o&&s?c=o.getRunTreeWithTracingConfig(s):r||(c=new ce({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[Ha]:t}),a!==void 0&&a[kt]!==void 0&&(c===void 0&&(c={}),c[kt]=a[kt]),i.run(c,e)}initializeGlobalInstance(t){pt()===void 0&&Bo(t)}};const De=new lh,gn=25;async function we(t){return nt._configureSync(t?.callbacks,void 0,t?.tags,void 0,t?.metadata)}function Va(...t){const e={};for(const r of t.filter(n=>!!n))for(const n of Object.keys(r))if(n==="metadata")e[n]={...e[n],...r[n]};else if(n==="tags"){const i=e[n]??[];e[n]=[...new Set(i.concat(r[n]??[]))]}else if(n==="configurable")e[n]={...e[n],...r[n]};else if(n==="timeout")e.timeout===void 0?e.timeout=r.timeout:r.timeout!==void 0&&(e.timeout=Math.min(e.timeout,r.timeout));else if(n==="signal")e.signal===void 0?e.signal=r.signal:r.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,r.signal]):e.signal=r.signal);else if(n==="callbacks"){const i=e.callbacks,a=r.callbacks;if(Array.isArray(a))if(!i)e.callbacks=a;else if(Array.isArray(i))e.callbacks=i.concat(a);else{const s=i.copy();for(const o of a)s.addHandler(Ht(o),!0);e.callbacks=s}else if(a)if(!i)e.callbacks=a;else if(Array.isArray(i)){const s=a.copy();for(const o of i)s.addHandler(Ht(o),!0);e.callbacks=s}else e.callbacks=new nt(a._parentRunId,{handlers:i.handlers.concat(a.handlers),inheritableHandlers:i.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(i.tags.concat(a.tags))),inheritableTags:Array.from(new Set(i.inheritableTags.concat(a.inheritableTags))),metadata:{...i.metadata,...a.metadata}})}else{const i=n;e[i]=r[i]??e[i]}return e}const uh=new Set(["string","number","boolean"]);function G(t){const e=De.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:n,runName:i,...a}=e;r=Object.entries(a).reduce((s,[o,c])=>(c!==void 0&&(s[o]=c),s),r)}if(t&&(r=Object.entries(t).reduce((n,[i,a])=>(a!==void 0&&(n[i]=a),n),r)),r?.configurable)for(const n of Object.keys(r.configurable))uh.has(typeof r.configurable[n])&&!r.metadata?.[n]&&(r.metadata||(r.metadata={}),r.metadata[n]=r.configurable[n]);if(r.timeout!==void 0){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const n=r.timeout,i=AbortSignal.timeout(n);r.metadata||(r.metadata={}),r.metadata.timeoutMs===void 0&&(r.metadata.timeoutMs=n),r.signal!==void 0?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,i])):r.signal=i,delete r.timeout}return r}function ie(t={},{callbacks:e,maxConcurrency:r,recursionLimit:n,runName:i,configurable:a,runId:s}={}){const o=G(t);return e!==void 0&&(delete o.runName,o.callbacks=e),n!==void 0&&(o.recursionLimit=n),r!==void 0&&(o.maxConcurrency=r),i!==void 0&&(o.runName=i),a!==void 0&&(o.configurable={...o.configurable,...a}),s!==void 0&&delete o.runId,o}function tt(t){if(t)return{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal,store:t.store}}async function Ue(t,e){if(e===void 0)return t;let r;return Promise.race([t.catch(n=>{if(!e?.aborted)throw n}),new Promise((n,i)=>{r=()=>{i(Vt(e))},e.addEventListener("abort",r,{once:!0}),e.aborted&&i(Vt(e))})]).finally(()=>e.removeEventListener("abort",r))}function Vt(t){return t?.reason instanceof Error?t.reason:typeof t?.reason=="string"?new Error(t.reason):new Error("Aborted")}var xe=class An extends ReadableStream{reader;ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const r=e.getReader();return new An({start(n){return i();function i(){return r.read().then(({done:a,value:s})=>{if(a){n.close();return}return n.enqueue(s),i()})}},cancel(){r.releaseLock()}})}static fromAsyncGenerator(e){return new An({async pull(r){const{value:n,done:i}=await e.next();i&&r.close(),r.enqueue(n)},async cancel(r){await e.return(r)}})}};function Qs(t,e=2){const r=Array.from({length:e},()=>[]);return r.map(async function*(i){for(;;)if(i.length===0){const a=await t.next();for(const s of r)s.push(a)}else{if(i[0].done)return;yield i.shift().value}})}function Ys(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const r={...t};for(const[n,i]of Object.entries(e))n in r&&!Array.isArray(r[n])?r[n]=Ys(r[n],i):r[n]=i;return r}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}var it=class{generator;setup;config;signal;firstResult;firstResultUsed=!1;constructor(t){this.generator=t.generator,this.config=t.config,this.signal=t.signal??this.config?.signal,this.setup=new Promise((e,r)=>{De.runWithConfig(tt(t.config),async()=>{this.firstResult=t.generator.next(),t.startSetup?this.firstResult.then(t.startSetup).then(e,r):this.firstResult.then(n=>e(void 0),r)},!0)})}async next(...t){return this.signal?.throwIfAborted(),this.firstResultUsed?De.runWithConfig(tt(this.config),this.signal?async()=>Ue(this.generator.next(...t),this.signal):async()=>this.generator.next(...t),!0):(this.firstResultUsed=!0,this.firstResult)}async return(t){return this.generator.return(t)}async throw(t){return this.generator.throw(t)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function dh(t,e,r,n,...i){const a=new it({generator:e,startSetup:r,signal:n}),s=await a.setup;return{output:t(a,s,...i),setup:s}}const hh=Object.prototype.hasOwnProperty;function fh(t,e){return hh.call(t,e)}function ph(t){if(Array.isArray(t)){const r=new Array(t.length);for(let n=0;n<r.length;n++)r[n]=""+n;return r}if(Object.keys)return Object.keys(t);let e=[];for(let r in t)fh(t,r)&&e.push(r);return e}function Je(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function xn(t){let e=0;const r=t.length;let n;for(;e<r;){if(n=t.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function mh(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function Rn(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let r=0,n=t.length;r<n;r++)if(Rn(t[r]))return!0}else if(typeof t=="object"){const r=ph(t),n=r.length;for(var e=0;e<n;e++)if(Rn(t[r[e]]))return!0}}return!1}function Ja(t,e){const r=[t];for(const n in e){const i=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof i<"u"&&r.push(`${n}: ${i}`)}return r.join(`
`)}var gh=class extends Error{constructor(t,e,r,n,i){super(Ja(t,{name:e,index:r,operation:n,tree:i})),this.name=e,this.index=r,this.operation=n,this.tree=i,Object.setPrototypeOf(this,new.target.prototype),this.message=Ja(t,{name:e,index:r,operation:n,tree:i})}},_h=Ao({JsonPatchError:()=>Z,_areEquals:()=>yt,applyOperation:()=>He,applyPatch:()=>_t,applyReducer:()=>vh,deepClone:()=>yh,getValueByPointer:()=>Jt,validate:()=>eo,validator:()=>Zt});const Z=gh,yh=Je,Xe={add:function(t,e,r){if(e==="__proto__"||e==="constructor")throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor` prop is banned for security reasons");return t[e]=this.value,{newDocument:r}},remove:function(t,e,r){if(e==="__proto__"||e==="constructor")throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor` prop is banned for security reasons");var n=t[e];return delete t[e],{newDocument:r,removed:n}},replace:function(t,e,r){if(e==="__proto__"||e==="constructor")throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor` prop is banned for security reasons");var n=t[e];return t[e]=this.value,{newDocument:r,removed:n}},move:function(t,e,r){let n=Jt(r,this.path);n&&(n=Je(n));const i=He(r,{op:"remove",path:this.from}).removed;return He(r,{op:"add",path:this.path,value:i}),{newDocument:r,removed:n}},copy:function(t,e,r){const n=Jt(r,this.from);return He(r,{op:"add",path:this.path,value:Je(n)}),{newDocument:r}},test:function(t,e,r){return{newDocument:r,test:yt(t[e],this.value)}},_get:function(t,e,r){return this.value=t[e],{newDocument:r}}};var wh={add:function(t,e,r){return xn(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:r,index:e}},remove:function(t,e,r){return{newDocument:r,removed:t.splice(e,1)[0]}},replace:function(t,e,r){var n=t[e];return t[e]=this.value,{newDocument:r,removed:n}},move:Xe.move,copy:Xe.copy,test:Xe.test,_get:Xe._get};function Jt(t,e){if(e=="")return t;var r={op:"_get",path:e};return He(t,r),r.value}function He(t,e,r=!1,n=!0,i=!0,a=0){if(r&&(typeof r=="function"?r(e,0,t,e.path):Zt(e,0)),e.path===""){let s={newDocument:t};if(e.op==="add")return s.newDocument=e.value,s;if(e.op==="replace")return s.newDocument=e.value,s.removed=t,s;if(e.op==="move"||e.op==="copy")return s.newDocument=Jt(t,e.from),e.op==="move"&&(s.removed=t),s;if(e.op==="test"){if(s.test=yt(t,e.value),s.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return s.newDocument=t,s}else{if(e.op==="remove")return s.removed=t,s.newDocument=null,s;if(e.op==="_get")return e.value=t,s;if(r)throw new Z("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,t);return s}}else{n||(t=Je(t));const s=(e.path||"").split("/");let o=t,c=1,l=s.length,u,d,h;for(typeof r=="function"?h=r:h=Zt;;){if(d=s[c],d&&d.indexOf("~")!=-1&&(d=mh(d)),i&&(d=="__proto__"||d=="prototype"&&c>0&&s[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&u===void 0&&(o[d]===void 0?u=s.slice(0,c).join("/"):c==l-1&&(u=e.path),u!==void 0&&h(e,0,t,u)),c++,Array.isArray(o)){if(d==="-")d=o.length;else{if(r&&!xn(d))throw new Z("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,t);xn(d)&&(d=~~d)}if(c>=l){if(r&&e.op==="add"&&d>o.length)throw new Z("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,t);const f=wh[e.op].call(e,o,d,t);if(f.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return f}}else if(c>=l){const f=Xe[e.op].call(e,o,d,t);if(f.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return f}if(o=o[d],r&&c<l&&(!o||typeof o!="object"))throw new Z("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,t)}}}function _t(t,e,r,n=!0,i=!0){if(r&&!Array.isArray(e))throw new Z("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(t=Je(t));const a=new Array(e.length);for(let s=0,o=e.length;s<o;s++)a[s]=He(t,e[s],r,!0,i,s),t=a[s].newDocument;return a.newDocument=t,a}function vh(t,e,r){const n=He(t,e);if(n.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",r,e,t);return n.newDocument}function Zt(t,e,r,n){if(typeof t!="object"||t===null||Array.isArray(t))throw new Z("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,r);if(Xe[t.op]){if(typeof t.path!="string")throw new Z("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,r);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new Z('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,r);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new Z("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,r);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new Z("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,r);if((t.op==="add"||t.op==="replace"||t.op==="test")&&Rn(t.value))throw new Z("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,r);if(r){if(t.op=="add"){var i=t.path.split("/").length,a=n.split("/").length;if(i!==a+1&&i!==a)throw new Z("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,r)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==n)throw new Z("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,r)}else if(t.op==="move"||t.op==="copy"){var s=eo([{op:"_get",path:t.from,value:void 0}],r);if(s&&s.name==="OPERATION_PATH_UNRESOLVABLE")throw new Z("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,r)}}}else throw new Z("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,r)}function eo(t,e,r){try{if(!Array.isArray(t))throw new Z("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)_t(Je(e),Je(t),r||!0);else{r=r||Zt;for(var n=0;n<t.length;n++)r(t[n],n,e,void 0)}}catch(i){if(i instanceof Z)return i;throw i}}function yt(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var r=Array.isArray(t),n=Array.isArray(e),i,a,s;if(r&&n){if(a=t.length,a!=e.length)return!1;for(i=a;i--!==0;)if(!yt(t[i],e[i]))return!1;return!0}if(r!=n)return!1;var o=Object.keys(t);if(a=o.length,a!==Object.keys(e).length)return!1;for(i=a;i--!==0;)if(!e.hasOwnProperty(o[i]))return!1;for(i=a;i--!==0;)if(s=o[i],!yt(t[s],e[s]))return!1;return!0}return t!==t&&e!==e}({..._h});var Le=class{ops;constructor(t){this.ops=t.ops??[]}concat(t){const e=this.ops.concat(t.ops),r=_t({},e);return new to({ops:e,state:r[r.length-1].newDocument})}},to=class On extends Le{state;constructor(e){super(e),this.state=e.state}concat(e){const r=this.ops.concat(e.ops),n=_t(this.state,e.ops);return new On({ops:r,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const r=_t({},e.ops);return new On({ops:e.ops,state:r[r.length-1].newDocument})}};const bh=t=>t.name==="log_stream_tracer";async function Za(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=t;if(["retriever","llm","prompt"].includes(t.run_type))return r;if(!(Object.keys(r).length===1&&r?.input===""))return r.input}async function Ka(t,e){const{outputs:r}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?r:r!==void 0&&Object.keys(r).length===1&&r?.output!==void 0?r.output:r}function Eh(t){return t!==void 0&&t.message!==void 0}var Wa=class extends vt{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;_schemaFormat="original";rootId;keyMapByRunId={};counterMapByRunName={};transformStream;writer;receiveStream;name="log_stream_tracer";lc_prefer_streaming=!0;constructor(t){super({_awaitHandler:!0,...t}),this.autoClose=t?.autoClose??!0,this.includeNames=t?.includeNames,this.includeTypes=t?.includeTypes,this.includeTags=t?.includeTags,this.excludeNames=t?.excludeNames,this.excludeTypes=t?.excludeTypes,this.excludeTags=t?.excludeTags,this._schemaFormat=t?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=xe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(t){}_includeRun(t){if(t.id===this.rootId)return!1;const e=t.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t.run_type)),this.includeTags!==void 0&&(r=r||e.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t.run_type)),this.excludeTags!==void 0&&(r=r&&e.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(t,e){for await(const r of e){if(t!==this.rootId){const n=this.keyMapByRunId[t];n&&await this.writer.write(new Le({ops:[{op:"add",path:`/logs/${n}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(t){if(this.rootId===void 0&&(this.rootId=t.id,await this.writer.write(new Le({ops:[{op:"replace",path:"",value:{id:t.id,name:t.name,type:t.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(t))return;this.counterMapByRunName[t.name]===void 0&&(this.counterMapByRunName[t.name]=0),this.counterMapByRunName[t.name]+=1;const e=this.counterMapByRunName[t.name];this.keyMapByRunId[t.id]=e===1?t.name:`${t.name}:${e}`;const r={id:t.id,name:t.name,type:t.run_type,tags:t.tags??[],metadata:t.extra?.metadata??{},start_time:new Date(t.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Za(t,this._schemaFormat)),await this.writer.write(new Le({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[t.id]}`,value:r}]}))}async onRunUpdate(t){try{const e=this.keyMapByRunId[t.id];if(e===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${e}/inputs`,value:await Za(t,this._schemaFormat)}),r.push({op:"add",path:`/logs/${e}/final_output`,value:await Ka(t,this._schemaFormat)}),t.end_time!==void 0&&r.push({op:"add",path:`/logs/${e}/end_time`,value:new Date(t.end_time).toISOString()});const n=new Le({ops:r});await this.writer.write(n)}finally{if(t.id===this.rootId){const e=new Le({ops:[{op:"replace",path:"/final_output",value:await Ka(t,this._schemaFormat)}]});await this.writer.write(e),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(t,e,r){const n=this.keyMapByRunId[t.id];if(n===void 0)return;const i=t.inputs.messages!==void 0;let a;i?Eh(r?.chunk)?a=r?.chunk:a=new bs({id:`run-${t.id}`,content:e}):a=e;const s=new Le({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:e},{op:"add",path:`/logs/${n}/streamed_output/-`,value:a}]});await this.writer.write(s)}},Xa=class ro{text;generationInfo;constructor(e){this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new ro({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}};function Pt({name:t,serialized:e}){return t!==void 0?t:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}const Sh=t=>t.name==="event_stream_tracer";var Th=class extends vt{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;runInfoMap=new Map;tappedPromises=new Map;transformStream;writer;receiveStream;readableStreamClosed=!1;name="event_stream_tracer";lc_prefer_streaming=!0;constructor(t){super({_awaitHandler:!0,...t}),this.autoClose=t?.autoClose??!0,this.includeNames=t?.includeNames,this.includeTypes=t?.includeTypes,this.includeTags=t?.includeTags,this.excludeNames=t?.excludeNames,this.excludeTypes=t?.excludeTypes,this.excludeTags=t?.excludeTags,this.transformStream=new TransformStream({flush:()=>{this.readableStreamClosed=!0}}),this.writer=this.transformStream.writable.getWriter(),this.receiveStream=xe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(t){}_includeRun(t){const e=t.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t.runType)),this.includeTags!==void 0&&(r=r||e.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t.runType)),this.excludeTags!==void 0&&(r=r&&e.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(t,e){const r=await e.next();if(r.done)return;const n=this.runInfoMap.get(t);if(n===void 0){yield r.value;return}function i(s,o){return s==="llm"&&typeof o=="string"?new Xa({text:o}):o}let a=this.tappedPromises.get(t);if(a===void 0){let s;a=new Promise(o=>{s=o}),this.tappedPromises.set(t,a);try{const o={event:`on_${n.runType}_stream`,run_id:t,name:n.name,tags:n.tags,metadata:n.metadata,data:{}};await this.send({...o,data:{chunk:i(n.runType,r.value)}},n),yield r.value;for await(const c of e)n.runType!=="tool"&&n.runType!=="retriever"&&await this.send({...o,data:{chunk:i(n.runType,c)}},n),yield c}finally{s?.()}}else{yield r.value;for await(const s of e)yield s}}async send(t,e){this.readableStreamClosed||this._includeRun(e)&&await this.writer.write(t)}async sendEndEvent(t,e){const r=this.tappedPromises.get(t.run_id);r!==void 0?r.then(()=>{this.send(t,e)}):await this.send(t,e)}async onLLMStart(t){const e=Pt(t),r=t.inputs.messages!==void 0?"chat_model":"llm",n={tags:t.tags??[],metadata:t.extra?.metadata??{},name:e,runType:r,inputs:t.inputs};this.runInfoMap.set(t.id,n);const i=`on_${r}_start`;await this.send({event:i,data:{input:t.inputs},name:e,tags:t.tags??[],run_id:t.id,metadata:t.extra?.metadata??{}},n)}async onLLMNewToken(t,e,r){const n=this.runInfoMap.get(t.id);let i,a;if(n===void 0)throw new Error(`onLLMNewToken: Run ID ${t.id} not found in run map.`);if(this.runInfoMap.size!==1){if(n.runType==="chat_model")a="on_chat_model_stream",r?.chunk===void 0?i=new bs({content:e,id:`run-${t.id}`}):i=r.chunk.message;else if(n.runType==="llm")a="on_llm_stream",r?.chunk===void 0?i=new Xa({text:e}):i=r.chunk;else throw new Error(`Unexpected run type ${n.runType}`);await this.send({event:a,data:{chunk:i},run_id:t.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(t){const e=this.runInfoMap.get(t.id);this.runInfoMap.delete(t.id);let r;if(e===void 0)throw new Error(`onLLMEnd: Run ID ${t.id} not found in run map.`);const n=t.outputs?.generations;let i;if(e.runType==="chat_model"){for(const a of n??[]){if(i!==void 0)break;i=a[0]?.message}r="on_chat_model_end"}else if(e.runType==="llm")i={generations:n?.map(a=>a.map(s=>({text:s.text,generationInfo:s.generationInfo}))),llmOutput:t.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${e.runType}`);await this.sendEndEvent({event:r,data:{output:i,input:e.inputs},run_id:t.id,name:e.name,tags:e.tags,metadata:e.metadata},e)}async onChainStart(t){const e=Pt(t),r=t.run_type??"chain",n={tags:t.tags??[],metadata:t.extra?.metadata??{},name:e,runType:t.run_type};let i={};t.inputs.input===""&&Object.keys(t.inputs).length===1?(i={},n.inputs={}):t.inputs.input!==void 0?(i.input=t.inputs.input,n.inputs=t.inputs.input):(i.input=t.inputs,n.inputs=t.inputs),this.runInfoMap.set(t.id,n),await this.send({event:`on_${r}_start`,data:i,name:e,tags:t.tags??[],run_id:t.id,metadata:t.extra?.metadata??{}},n)}async onChainEnd(t){const e=this.runInfoMap.get(t.id);if(this.runInfoMap.delete(t.id),e===void 0)throw new Error(`onChainEnd: Run ID ${t.id} not found in run map.`);const r=`on_${t.run_type}_end`,n=t.inputs??e.inputs??{},i={output:t.outputs?.output??t.outputs,input:n};n.input&&Object.keys(n).length===1&&(i.input=n.input,e.inputs=n.input),await this.sendEndEvent({event:r,data:i,run_id:t.id,name:e.name,tags:e.tags,metadata:e.metadata??{}},e)}async onToolStart(t){const e=Pt(t),r={tags:t.tags??[],metadata:t.extra?.metadata??{},name:e,runType:"tool",inputs:t.inputs??{}};this.runInfoMap.set(t.id,r),await this.send({event:"on_tool_start",data:{input:t.inputs??{}},name:e,run_id:t.id,tags:t.tags??[],metadata:t.extra?.metadata??{}},r)}async onToolEnd(t){const e=this.runInfoMap.get(t.id);if(this.runInfoMap.delete(t.id),e===void 0)throw new Error(`onToolEnd: Run ID ${t.id} not found in run map.`);if(e.inputs===void 0)throw new Error(`onToolEnd: Run ID ${t.id} is a tool call, and is expected to have traced inputs.`);const r=t.outputs?.output===void 0?t.outputs:t.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:e.inputs},run_id:t.id,name:e.name,tags:e.tags,metadata:e.metadata},e)}async onToolError(t){const e=this.runInfoMap.get(t.id);if(this.runInfoMap.delete(t.id),e===void 0)throw new Error(`onToolEnd: Run ID ${t.id} not found in run map.`);if(e.inputs===void 0)throw new Error(`onToolEnd: Run ID ${t.id} is a tool call, and is expected to have traced inputs.`);await this.sendEndEvent({event:"on_tool_error",data:{input:e.inputs,error:t.error},run_id:t.id,name:e.name,tags:e.tags,metadata:e.metadata},e)}async onRetrieverStart(t){const e=Pt(t),r={tags:t.tags??[],metadata:t.extra?.metadata??{},name:e,runType:"retriever",inputs:{query:t.inputs.query}};this.runInfoMap.set(t.id,r),await this.send({event:"on_retriever_start",data:{input:{query:t.inputs.query}},name:e,tags:t.tags??[],run_id:t.id,metadata:t.extra?.metadata??{}},r)}async onRetrieverEnd(t){const e=this.runInfoMap.get(t.id);if(this.runInfoMap.delete(t.id),e===void 0)throw new Error(`onRetrieverEnd: Run ID ${t.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:t.outputs?.documents??t.outputs,input:e.inputs},run_id:t.id,name:e.name,tags:e.tags,metadata:e.metadata},e)}async handleCustomEvent(t,e,r){const n=this.runInfoMap.get(r);if(n===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:t,tags:n.tags,metadata:n.metadata,data:e},n)}async finish(){const t=[...this.tappedPromises.values()];Promise.all(t).finally(()=>{this.writer.close()})}};const Ih=Object.prototype.toString,Ah=t=>Ih.call(t)==="[object Error]",xh=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function Rh(t){if(!(t&&Ah(t)&&t.name==="TypeError"&&typeof t.message=="string"))return!1;const{message:e,stack:r}=t;return e==="Load failed"?r===void 0||"__sentry_captured__"in t:e.startsWith("error sending request for url")?!0:xh.has(e)}function Oh(t){if(typeof t=="number"){if(t<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(t))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(t!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Lt(t,e,{min:r=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${t}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${t}\` to be a finite number.`);if(e<r)throw new TypeError(`Expected \`${t}\` to be  ${r}.`)}}var Ch=class extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,{message:t}=t):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}};function Nh(t,e){const r=Math.max(1,t+1),n=e.randomize?Math.random()+1:1;let i=Math.round(n*e.minTimeout*e.factor**(r-1));return i=Math.min(i,e.maxTimeout),i}function Qa(t,e){return Number.isFinite(e)?e-(performance.now()-t):e}async function $h({error:t,attemptNumber:e,retriesConsumed:r,startTime:n,options:i}){const a=t instanceof Error?t:new TypeError(`Non-error was thrown: "${t}". You should only throw errors.`);if(a instanceof Ch)throw a.originalError;const s=Number.isFinite(i.retries)?Math.max(0,i.retries-r):i.retries,o=i.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:a,attemptNumber:e,retriesLeft:s,retriesConsumed:r});if(await i.onFailedAttempt(c),Qa(n,o)<=0)throw a;const l=await i.shouldConsumeRetry(c),u=Qa(n,o);if(u<=0||s<=0)throw a;if(a instanceof TypeError&&!Rh(a)){if(l)throw a;return i.signal?.throwIfAborted(),!1}if(!await i.shouldRetry(c))throw a;if(!l)return i.signal?.throwIfAborted(),!1;const d=Nh(r,i),h=Math.min(d,u);return h>0&&await new Promise((f,p)=>{const m=()=>{clearTimeout(g),i.signal?.removeEventListener("abort",m),p(i.signal.reason)},g=setTimeout(()=>{i.signal?.removeEventListener("abort",m),f()},h);i.unref&&g.unref?.(),i.signal?.addEventListener("abort",m,{once:!0})}),i.signal?.throwIfAborted(),!0}async function Cn(t,e={}){if(e={...e},Oh(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,Lt("factor",e.factor,{min:0,allowInfinity:!1}),Lt("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Lt("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Lt("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let r=0,n=0;const i=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){r++;try{e.signal?.throwIfAborted();const a=await t(r);return e.signal?.throwIfAborted(),a}catch(a){await $h({error:a,attemptNumber:r,retriesConsumed:n,startTime:i,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}const Ph=[400,401,402,403,404,405,406,407,409],Lh=t=>{if(typeof t!="object"||t===null)return;if("message"in t&&typeof t.message=="string"&&(t.message.startsWith("Cancel")||t.message.startsWith("AbortError"))||"name"in t&&typeof t.name=="string"&&t.name==="AbortError"||"code"in t&&typeof t.code=="string"&&t.code==="ECONNABORTED")throw t;const e="response"in t&&typeof t.response=="object"&&t.response!==null&&"status"in t.response&&typeof t.response.status=="number"?t.response.status:void 0,r="status"in t&&typeof t.status=="number"?t.status:void 0,n=e??r;if(n&&Ph.includes(+n))throw t;if(("error"in t&&typeof t.error=="object"&&t.error!==null&&"code"in t.error&&typeof t.error.code=="string"?t.error.code:void 0)==="insufficient_quota"){const i=new Error("message"in t&&typeof t.message=="string"?t.message:"Insufficient quota");throw i.name="InsufficientQuotaError",i}};var kh=class{maxConcurrency;maxRetries;onFailedAttempt;queue;constructor(t){this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,this.onFailedAttempt=t.onFailedAttempt??Lh,this.queue=new("default"in Oe?Oe.default:Oe)({concurrency:this.maxConcurrency})}async call(t,...e){return this.queue.add(()=>Cn(()=>t(...e).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:({error:r})=>this.onFailedAttempt?.(r),retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,e,...r){if(t.signal){let n;return Promise.race([this.call(e,...r),new Promise((i,a)=>{n=()=>{a(Vt(t.signal))},t.signal?.addEventListener("abort",n,{once:!0})})]).finally(()=>{t.signal&&n&&t.signal.removeEventListener("abort",n)})}return this.call(e,...r)}fetch(...t){return this.call(()=>fetch(...t).then(e=>e.ok?e:Promise.reject(e)))}},no=class extends vt{name="RootListenersTracer";rootId;config;argOnStart;argOnEnd;argOnError;constructor({config:t,onStart:e,onEnd:r,onError:n}){super({_awaitHandler:!0}),this.config=t,this.argOnStart=e,this.argOnEnd=r,this.argOnError=n}persistRun(t){return Promise.resolve()}async onRunCreate(t){this.rootId||(this.rootId=t.id,this.argOnStart&&await this.argOnStart(t,this.config))}async onRunUpdate(t){t.id===this.rootId&&(t.error?this.argOnError&&await this.argOnError(t,this.config):this.argOnEnd&&await this.argOnEnd(t,this.config))}};function Xn(t){return t?t.lc_runnable:!1}var Mh=class{includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;constructor(t){this.includeNames=t.includeNames,this.includeTypes=t.includeTypes,this.includeTags=t.includeTags,this.excludeNames=t.excludeNames,this.excludeTypes=t.excludeTypes,this.excludeTags=t.excludeTags}includeEvent(t,e){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const n=t.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e)),this.includeTags!==void 0&&(r=r||n.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(r=r&&n.every(i=>!this.excludeTags?.includes(i))),r}};const jh=t=>btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");function Ee(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_zod"in e))return!1;const r=e._zod;return typeof r=="object"&&r!==null&&"def"in r}function Fe(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_def"in e)||"_zod"in e)return!1;const r=e._def;return typeof r=="object"&&r!=null&&"typeName"in r}function Dh(t){return!t||typeof t!="object"||Array.isArray(t)?!1:!!(Ee(t)||Fe(t))}async function Uh(t,e){if(Ee(t))return await bo(t,e);if(Fe(t))return await t.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Fh(t){if(Ee(t))return qe.get(t)?.description;if(Fe(t)||"description"in t&&typeof t.description=="string")return t.description}function Bh(t){return Dh(t)?Fe(t)?t._def.typeName==="ZodString":Ee(t)?t._zod.def.type==="string":!1:!1}function ft(t){return Ee(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="object":!1}function io(t){return Ee(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="array":!1}function zh(t){return Ee(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="optional":!1}function qh(t){return Ee(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="nullable":!1}function Nn(t,e=!1){if(Fe(t))return t.strict();if(ft(t)){const r=t._zod.def.shape;if(e)for(const[a,s]of Object.entries(t._zod.def.shape)){if(ft(s))r[a]=Nn(s,e);else if(io(s)){let c=s._zod.def.element;ft(c)&&(c=Nn(c,e)),r[a]=Ze(s,{...s._zod.def,element:c})}else r[a]=s;const o=qe.get(s);o&&qe.add(r[a],o)}const n=Ze(t,{...t._zod.def,shape:r,catchall:Eo(So)}),i=qe.get(t);return i&&qe.add(n,i),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Gh(t){return Fe(t)&&"typeName"in t._def&&t._def.typeName==="ZodEffects"}function Hh(t){return Ee(t)&&t._zod.def.type==="pipe"}function Be(t,e,r){const n=r.get(t);if(n!==void 0)return n;if(Fe(t))return Gh(t)?Be(t._def.schema,e,r):t;if(Ee(t)){let i=t;if(Hh(t)&&(i=Be(t._zod.def.in,e,r)),e){if(ft(i)){const s={};for(const[o,c]of Object.entries(i._zod.def.shape))s[o]=Be(c,e,r);i=Ze(i,{...i._zod.def,shape:s})}else if(io(i)){const s=Be(i._zod.def.element,e,r);i=Ze(i,{...i._zod.def,element:s})}else if(zh(i)){const s=Be(i._zod.def.innerType,e,r);i=Ze(i,{...i._zod.def,innerType:s})}else if(qh(i)){const s=Be(i._zod.def.innerType,e,r);i=Ze(i,{...i._zod.def,innerType:s})}}const a=qe.get(t);return a&&qe.add(i,a),r.set(t,i),i}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Vh(t,e=!1){return Be(t,e,new WeakMap)}function _n(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const Jh=["*","_","`"];function Zh(t){let e="";for(const[r,n]of Object.entries(t))e+=`	classDef ${r} ${n};
`;return e}function Kh(t,e,r){const{firstNode:n,lastNode:i,nodeColors:a,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let l=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){const p="default",m={[p]:"{0}({1})"};n!==void 0&&(m[n]="{0}([{1}]):::first"),i!==void 0&&(m[i]="{0}([{1}]):::last");for(const[g,_]of Object.entries(t)){const w=_.name.split(":").pop()??"";let y=Jh.some(S=>w.startsWith(S)&&w.endsWith(S))?`<p>${w}</p>`:w;Object.keys(_.metadata??{}).length&&(y+=`<hr/><small><em>${Object.entries(_.metadata??{}).map(([S,L])=>`${S} = ${L}`).join(`
`)}</em></small>`);const E=(m[g]??m[p]).replace("{0}",_n(g)).replace("{1}",y);l+=`	${E}
`}}const u={};for(const p of e){const m=p.source.split(":"),g=p.target.split(":"),_=m.filter((w,y)=>w===g[y]).join(":");u[_]||(u[_]=[]),u[_].push(p)}const d=new Set;function h(p){return[...p].sort((m,g)=>m.split(":").length-g.split(":").length)}function f(p,m){const g=p.length===1&&p[0].source===p[0].target;if(m&&!g){const w=m.split(":").pop();if(d.has(m))throw new Error(`Found duplicate subgraph '${w}' at '${m} -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(m),l+=`	subgraph ${w}
`}const _=h(Object.keys(u).filter(w=>w.startsWith(`${m}:`)&&w!==m&&w.split(":").length===m.split(":").length+1));for(const w of _)f(u[w],w);for(const w of p){const{source:y,target:E,data:S,conditional:L}=w;let k="";if(S!==void 0){let I=S;const X=I.split(" ");X.length>c&&(I=Array.from({length:Math.ceil(X.length/c)},(se,fe)=>X.slice(fe*c,(fe+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),k=L?` -. &nbsp;${I}&nbsp; .-> `:` -- &nbsp;${I}&nbsp; --> `}else k=L?" -.-> ":" --> ";l+=`	${_n(y)}${k}${_n(E)};
`}m&&!g&&(l+=`	end
`)}f(u[""]??[],"");for(const p in u)!p.includes(":")&&p!==""&&f(u[p],p);return s&&(l+=Zh(a??{})),l}async function Wh(t,e){let r=e?.backgroundColor??"white";const n=e?.imageType??"png",i=jh(t);r!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const a=`https://mermaid.ink/img/${i}?bgColor=${r}&type=${n}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}const Xh=Symbol("Let zodToJsonSchema decide on which parser to use"),Qh={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Yh=t=>({...Qh,...t}),ef=t=>{const e=Yh(t),r=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,i])=>[i._def,{def:i._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}},ao=(t,e)=>{let r=0;for(;r<t.length&&r<e.length&&t[r]===e[r];r++);return[(t.length-r).toString(),...e.slice(r)].join("/")};function ue(t){if(t.target!=="openAi")return{};const e=[...t.basePath,t.definitionPath,t.openAiAnyTypeName];return t.flags.hasReferencedOpenAiAnyType=!0,{$ref:t.$refStrategy==="relative"?ao(e,t.currentPath):e.join("/")}}function so(t,e,r,n){n?.errorMessages&&r&&(t.errorMessage={...t.errorMessage,[e]:r})}function q(t,e,r,n,i){t[e]=r,so(t,e,n,i)}function tf(t,e){const r={type:"array"};return t.type?._def&&t.type?._def?.typeName!==D.ZodAny&&(r.items=B(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&q(r,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&q(r,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(q(r,"minItems",t.exactLength.value,t.exactLength.message,e),q(r,"maxItems",t.exactLength.value,t.exactLength.message,e)),r}function rf(t,e){const r={type:"integer",format:"int64"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?q(r,"minimum",n.value,n.message,e):q(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),q(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?q(r,"maximum",n.value,n.message,e):q(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),q(r,"maximum",n.value,n.message,e));break;case"multipleOf":q(r,"multipleOf",n.value,n.message,e);break}return r}function nf(){return{type:"boolean"}}function oo(t,e){return B(t.type._def,e)}const af=(t,e)=>B(t.innerType._def,e);function co(t,e,r){const n=r??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(i=>co(t,e,i))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return sf(t,e)}}const sf=(t,e)=>{const r={type:"integer",format:"unix-time"};if(e.target==="openApi3")return r;for(const n of t.checks)switch(n.kind){case"min":q(r,"minimum",n.value,n.message,e);break;case"max":q(r,"maximum",n.value,n.message,e);break}return r};function of(t,e){return{...B(t.innerType._def,e),default:t.defaultValue()}}function cf(t,e){return e.effectStrategy==="input"?B(t.schema._def,e):ue(e)}function lf(t){return{type:"string",enum:Array.from(t.values)}}const uf=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function df(t,e){const r=[B(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),B(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const i=[];return r.forEach(a=>{if(uf(a))i.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let s=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...c}=a;s=c}else n=void 0;i.push(s)}}),i.length?{allOf:i,...n}:void 0}function hf(t,e){const r=typeof t.value;return r!=="bigint"&&r!=="number"&&r!=="boolean"&&r!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:r==="bigint"?"integer":r,enum:[t.value]}:{type:r==="bigint"?"integer":r,const:t.value}}let yn;const ge={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(yn===void 0&&(yn=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),yn),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function lo(t,e){const r={type:"string"};if(t.checks)for(const n of t.checks)switch(n.kind){case"min":q(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,e);break;case"max":q(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,e);break;case"email":switch(e.emailStrategy){case"format:email":_e(r,"email",n.message,e);break;case"format:idn-email":_e(r,"idn-email",n.message,e);break;case"pattern:zod":re(r,ge.email,n.message,e);break}break;case"url":_e(r,"uri",n.message,e);break;case"uuid":_e(r,"uuid",n.message,e);break;case"regex":re(r,n.regex,n.message,e);break;case"cuid":re(r,ge.cuid,n.message,e);break;case"cuid2":re(r,ge.cuid2,n.message,e);break;case"startsWith":re(r,RegExp(`^${wn(n.value,e)}`),n.message,e);break;case"endsWith":re(r,RegExp(`${wn(n.value,e)}$`),n.message,e);break;case"datetime":_e(r,"date-time",n.message,e);break;case"date":_e(r,"date",n.message,e);break;case"time":_e(r,"time",n.message,e);break;case"duration":_e(r,"duration",n.message,e);break;case"length":q(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,e),q(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,e);break;case"includes":re(r,RegExp(wn(n.value,e)),n.message,e);break;case"ip":n.version!=="v6"&&_e(r,"ipv4",n.message,e),n.version!=="v4"&&_e(r,"ipv6",n.message,e);break;case"base64url":re(r,ge.base64url,n.message,e);break;case"jwt":re(r,ge.jwt,n.message,e);break;case"cidr":n.version!=="v6"&&re(r,ge.ipv4Cidr,n.message,e),n.version!=="v4"&&re(r,ge.ipv6Cidr,n.message,e);break;case"emoji":re(r,ge.emoji(),n.message,e);break;case"ulid":re(r,ge.ulid,n.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":_e(r,"binary",n.message,e);break;case"contentEncoding:base64":q(r,"contentEncoding","base64",n.message,e);break;case"pattern:zod":re(r,ge.base64,n.message,e);break}break;case"nanoid":re(r,ge.nanoid,n.message,e);break}return r}function wn(t,e){return e.patternStrategy==="escape"?pf(t):t}const ff=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function pf(t){let e="";for(let r=0;r<t.length;r++)ff.has(t[r])||(e+="\\"),e+=t[r];return e}function _e(t,e,r,n){t.format||t.anyOf?.some(i=>i.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&n.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...r&&n.errorMessages&&{errorMessage:{format:r}}})):q(t,"format",e,r,n)}function re(t,e,r,n){t.pattern||t.allOf?.some(i=>i.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&n.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:Ya(e,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):q(t,"pattern",Ya(e,n),r,n)}function Ya(t,e){if(!e.applyRegexFlags||!t.flags)return t.source;const r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},n=r.i?t.source.toLowerCase():t.source;let i="",a=!1,s=!1,o=!1;for(let c=0;c<n.length;c++){if(a){i+=n[c],a=!1;continue}if(r.i){if(s){if(n[c].match(/[a-z]/)){o?(i+=n[c],i+=`${n[c-2]}-${n[c]}`.toUpperCase(),o=!1):n[c+1]==="-"&&n[c+2]?.match(/[a-z]/)?(i+=n[c],o=!0):i+=`${n[c]}${n[c].toUpperCase()}`;continue}}else if(n[c].match(/[a-z]/)){i+=`[${n[c]}${n[c].toUpperCase()}]`;continue}}if(r.m){if(n[c]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(n[c]==="$"){i+=`($|(?=[\r
]))`;continue}}if(r.s&&n[c]==="."){i+=s?`${n[c]}\r
`:`[${n[c]}\r
]`;continue}i+=n[c],n[c]==="\\"?a=!0:s&&n[c]==="]"?s=!1:!s&&n[c]==="["&&(s=!0)}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return i}function uo(t,e){if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&t.keyType?._def.typeName===D.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((n,i)=>({...n,[i]:B(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",i]})??ue(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const r={type:"object",additionalProperties:B(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return r;if(t.keyType?._def.typeName===D.ZodString&&t.keyType._def.checks?.length){const{type:n,...i}=lo(t.keyType._def,e);return{...r,propertyNames:i}}else{if(t.keyType?._def.typeName===D.ZodEnum)return{...r,propertyNames:{enum:t.keyType._def.values}};if(t.keyType?._def.typeName===D.ZodBranded&&t.keyType._def.type._def.typeName===D.ZodString&&t.keyType._def.type._def.checks?.length){const{type:n,...i}=oo(t.keyType._def,e);return{...r,propertyNames:i}}}return r}function mf(t,e){return e.mapStrategy==="record"?uo(t,e):{type:"array",maxItems:125,items:{type:"array",items:[B(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||ue(e),B(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||ue(e)],minItems:2,maxItems:2}}}function gf(t){const e=t.values,r=Object.keys(t.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),n=Array.from(new Set(r.map(i=>typeof i)));return{type:n.length===1?n[0]==="string"?"string":"number":["string","number"],enum:r}}function _f(t){return t.target==="openAi"?void 0:{not:ue({...t,currentPath:[...t.currentPath,"not"]})}}function yf(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Kt={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function wf(t,e){if(e.target==="openApi3")return es(t,e);const r=t.options instanceof Map?Array.from(t.options.values()):t.options;if(r.every(n=>n._def.typeName in Kt&&(!n._def.checks||!n._def.checks.length))){const n=r.reduce((i,a)=>{const s=Kt[a._def.typeName];return s&&!i.includes(s)?[...i,s]:i},[]);return{type:n.length>1?n:n[0]}}else if(r.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=r.reduce((i,a)=>{const s=typeof a._def.value;switch(s){case"string":case"number":case"boolean":return[...i,s];case"bigint":return[...i,"integer"];case"object":return a._def.value===null?[...i,"null"]:i;default:return i}},[]);if(n.length===r.length){const i=n.filter((a,s,o)=>o.indexOf(a)===s);return{type:i.length>1?i:i[0],enum:r.reduce((a,s)=>a.includes(s._def.value)?a:[...a,s._def.value],[])}}}else if(r.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:r.reduce((n,i)=>[...n,...i._def.values.filter(a=>!n.includes(a))],[])};return es(t,e)}const es=(t,e)=>{const r=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((n,i)=>B(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${i}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return r.length?{anyOf:r}:void 0};function vf(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:Kt[t.innerType._def.typeName],nullable:!0}:{type:[Kt[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=B(t.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const r=B(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function bf(t,e){const r={type:"number"};if(!t.checks)return r;for(const n of t.checks)switch(n.kind){case"int":r.type="integer",so(r,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?q(r,"minimum",n.value,n.message,e):q(r,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(r.exclusiveMinimum=!0),q(r,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?q(r,"maximum",n.value,n.message,e):q(r,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(r.exclusiveMaximum=!0),q(r,"maximum",n.value,n.message,e));break;case"multipleOf":q(r,"multipleOf",n.value,n.message,e);break}return r}function Ef(t,e){const r=e.target==="openAi",n={type:"object",properties:{}},i=[],a=t.shape();for(const o in a){let c=a[o];if(c===void 0||c._def===void 0)continue;let l=Tf(c);l&&r&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),l=!1);const u=B(c._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});u!==void 0&&(n.properties[o]=u,l||i.push(o))}i.length&&(n.required=i);const s=Sf(t,e);return s!==void 0&&(n.additionalProperties=s),n}function Sf(t,e){if(t.catchall._def.typeName!=="ZodNever")return B(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(t.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function Tf(t){try{return t.isOptional()}catch{return!0}}const If=(t,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return B(t.innerType._def,e);const r=B(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return r?{anyOf:[{not:ue(e)},r]}:ue(e)},Af=(t,e)=>{if(e.pipeStrategy==="input")return B(t.in._def,e);if(e.pipeStrategy==="output")return B(t.out._def,e);const r=B(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]});return{allOf:[r,B(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",r?"1":"0"]})].filter(n=>n!==void 0)}};function xf(t,e){return B(t.type._def,e)}function Rf(t,e){const r={type:"array",uniqueItems:!0,items:B(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&q(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&q(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function Of(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((r,n)=>B(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[]),additionalItems:B(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((r,n)=>B(r._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[])}}function Cf(t){return{not:ue(t)}}function Nf(t){return ue(t)}const $f=(t,e)=>B(t.innerType._def,e),Pf=(t,e,r)=>{switch(e){case D.ZodString:return lo(t,r);case D.ZodNumber:return bf(t,r);case D.ZodObject:return Ef(t,r);case D.ZodBigInt:return rf(t,r);case D.ZodBoolean:return nf();case D.ZodDate:return co(t,r);case D.ZodUndefined:return Cf(r);case D.ZodNull:return yf(r);case D.ZodArray:return tf(t,r);case D.ZodUnion:case D.ZodDiscriminatedUnion:return wf(t,r);case D.ZodIntersection:return df(t,r);case D.ZodTuple:return Of(t,r);case D.ZodRecord:return uo(t,r);case D.ZodLiteral:return hf(t,r);case D.ZodEnum:return lf(t);case D.ZodNativeEnum:return gf(t);case D.ZodNullable:return vf(t,r);case D.ZodOptional:return If(t,r);case D.ZodMap:return mf(t,r);case D.ZodSet:return Rf(t,r);case D.ZodLazy:return()=>t.getter()._def;case D.ZodPromise:return xf(t,r);case D.ZodNaN:case D.ZodNever:return _f(r);case D.ZodEffects:return cf(t,r);case D.ZodAny:return ue(r);case D.ZodUnknown:return Nf(r);case D.ZodDefault:return of(t,r);case D.ZodBranded:return oo(t,r);case D.ZodReadonly:return $f(t,r);case D.ZodCatch:return af(t,r);case D.ZodPipeline:return Af(t,r);case D.ZodFunction:case D.ZodVoid:case D.ZodSymbol:return;default:return(n=>{})()}};function B(t,e,r=!1){const n=e.seen.get(t);if(e.override){const o=e.override?.(t,e,n,r);if(o!==Xh)return o}if(n&&!r){const o=Lf(n,e);if(o!==void 0)return o}const i={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,i);const a=Pf(t,t.typeName,e),s=typeof a=="function"?B(a(),e):a;if(s&&kf(t,e,s),e.postProcess){const o=e.postProcess(s,t,e);return i.jsonSchema=s,o}return i.jsonSchema=s,s}const Lf=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:ao(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((r,n)=>e.currentPath[n]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),ue(e)):e.$refStrategy==="seen"?ue(e):void 0}},kf=(t,e,r)=>(t.description&&(r.description=t.description,e.markdownDescription&&(r.markdownDescription=t.description)),r),Mf=(t,e)=>{const r=ef(e);let n=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((o,[c,l])=>({...o,[c]:B(l._def,{...r,currentPath:[...r.basePath,r.definitionPath,c]},!0)??ue(r)}),{}):void 0;const i=typeof e=="string"?e:e?.name,a=B(t._def,r,!1)??ue(r);r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:r.$refStrategy==="relative"?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const s=i===void 0?n?{...a,[r.definitionPath]:n}:a:{$ref:[...r.$refStrategy==="relative"?[]:r.basePath,r.definitionPath,i].join("/"),[r.definitionPath]:{...n,[i]:a}};return r.target==="jsonSchema7"?s.$schema="http://json-schema.org/draft-07/schema#":(r.target==="jsonSchema2019-09"||r.target==="openAi")&&(s.$schema="https://json-schema.org/draft/2019-09/schema#"),r.target==="openAi"&&("anyOf"in s||"oneOf"in s||"allOf"in s||"type"in s&&Array.isArray(s.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),s};function jf(t,e){if(Ee(t)){const r=Vh(t,!0);return ft(r)?Yn(Nn(r,!0),e):Yn(t,e)}return Fe(t)?Mf(t):t}function Df(t,e){if(t!==void 0&&!dt(t))return t;if(Xn(e))try{let r=e.getName();return r=r.startsWith("Runnable")?r.slice(8):r,r}catch{return e.getName()}else return e.name??"UnknownSchema"}function Uf(t){return Xn(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...jf(t.data.schema),title:t.data.name}}}var ho=class fo{nodes={};edges=[];constructor(e){this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((r,n)=>{e[r.id]=dt(r.id)?n:r.id}),{nodes:Object.values(this.nodes).map(r=>({id:e[r.id],...Uf(r)})),edges:this.edges.map(r=>{const n={source:e[r.source],target:e[r.target]};return typeof r.data<"u"&&(n.data=r.data),typeof r.conditional<"u"&&(n.conditional=r.conditional),n})}}addNode(e,r,n){if(r!==void 0&&this.nodes[r]!==void 0)throw new Error(`Node with id ${r} already exists`);const i=r??ze(),a={id:i,data:e,name:Df(r,e),metadata:n};return this.nodes[i]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(r=>r.source!==e.id&&r.target!==e.id)}addEdge(e,r,n,i){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[r.id]===void 0)throw new Error(`Target node ${r.id} not in graph`);const a={source:e.id,target:r.id,data:n,conditional:i};return this.edges.push(a),a}firstNode(){return ts(this)}lastNode(){return rs(this)}extend(e,r=""){let n=r;Object.values(e.nodes).map(c=>c.id).every(dt)&&(n="");const i=c=>n?`${n}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[i(c)]={...l,id:i(c)}});const a=e.edges.map(c=>({...c,source:i(c.source),target:i(c.target)}));this.edges=[...this.edges,...a];const s=e.firstNode(),o=e.lastNode();return[s?{id:i(s.id),data:s.data}:void 0,o?{id:i(o.id),data:o.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&ts(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&rs(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(i=>[i.id,i.name])),r=new Map;Object.values(e).forEach(i=>{r.set(i,(r.get(i)||0)+1)});const n=i=>{const a=e[i];return dt(i)&&r.get(a)===1?a:i};return new fo({nodes:Object.fromEntries(Object.entries(this.nodes).map(([i,a])=>[n(i),{...a,id:n(i)}])),edges:this.edges.map(i=>({...i,source:n(i.source),target:n(i.target)}))})}drawMermaid(e){const{withStyles:r,curveStyle:n,nodeColors:i={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},s=this.reid(),o=s.firstNode(),c=s.lastNode();return Kh(s.nodes,s.edges,{firstNode:o?.id,lastNode:c?.id,withStyles:r,curveStyle:n,nodeColors:i,wrapLabelNWords:a})}async drawMermaidPng(e){return Wh(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}};function ts(t,e=[]){const r=new Set(t.edges.filter(i=>!e.includes(i.source)).map(i=>i.target)),n=[];for(const i of Object.values(t.nodes))!e.includes(i.id)&&!r.has(i.id)&&n.push(i);return n.length===1?n[0]:void 0}function rs(t,e=[]){const r=new Set(t.edges.filter(i=>!e.includes(i.target)).map(i=>i.source)),n=[];for(const i of Object.values(t.nodes))!e.includes(i.id)&&!r.has(i.id)&&n.push(i);return n.length===1?n[0]:void 0}function Ff(t){const e=new TextEncoder,r=new ReadableStream({async start(n){for await(const i of t)n.enqueue(e.encode(`event: data
data: ${JSON.stringify(i)}

`));n.enqueue(e.encode(`event: end

`)),n.close()}});return xe.fromReadableStream(r)}function ns(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const Bf=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function $n(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*is(t,e){for(;;){const{value:r,done:n}=De.runWithConfig(tt(t),e.next.bind(e),!0);if(n)break;yield r}}async function*Pn(t,e){const r=e[Symbol.asyncIterator]();for(;;){const{value:n,done:i}=await De.runWithConfig(tt(t),r.next.bind(e),!0);if(i)break;yield n}}function Q(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}var le=class extends Ut{lc_runnable=!0;name;getName(t){const e=this.name??this.constructor.lc_name()??this.constructor.name;return t?`${e}${t}`:e}withRetry(t){return new mo({bound:this,kwargs:{},config:{},maxAttemptNumber:t?.stopAfterAttempt,...t})}withConfig(t){return new Wt({bound:this,config:t,kwargs:{}})}withFallbacks(t){const e=Array.isArray(t)?t:t.fallbacks;return new Gf({runnable:this,fallbacks:e})}_getOptionsList(t,e=0){if(Array.isArray(t)&&t.length!==e)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${t.length} options for ${e} inputs`);if(Array.isArray(t))return t.map(G);if(e>1&&!Array.isArray(t)&&t.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(t).filter(([n])=>n!=="runId"));return Array.from({length:e},(n,i)=>G(i===0?t:r))}return Array.from({length:e},()=>G(t))}async batch(t,e,r){const n=this._getOptionsList(e??{},t.length),i=new kh({maxConcurrency:n[0]?.maxConcurrency??r?.maxConcurrency,onFailedAttempt:s=>{throw s}}),a=t.map((s,o)=>i.call(async()=>{try{return await this.invoke(s,n[o])}catch(c){if(r?.returnExceptions)return c;throw c}}));return Promise.all(a)}async*_streamIterator(t,e){yield this.invoke(t,e)}async stream(t,e){const r=G(e),n=new it({generator:this._streamIterator(t,r),config:r});return await n.setup,xe.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(t){let e;t===void 0?e=G(t):e=G({callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,runName:t.runName,configurable:t.configurable,recursionLimit:t.recursionLimit,maxConcurrency:t.maxConcurrency,runId:t.runId,timeout:t.timeout,signal:t.signal});const r={...t};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[e,r]}async _callWithConfig(t,e,r){const n=G(r),i=await(await we(n))?.handleChainStart(this.toJSON(),Q(e,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName());delete n.runId;let a;try{a=await Ue(t.call(this,e,n,i),r?.signal)}catch(s){throw await i?.handleChainError(s),s}return await i?.handleChainEnd(Q(a,"output")),a}async _batchWithConfig(t,e,r,n){const i=this._getOptionsList(r??{},e.length),a=await Promise.all(i.map(we)),s=await Promise.all(a.map(async(c,l)=>{const u=await c?.handleChainStart(this.toJSON(),Q(e[l],"input"),i[l].runId,i[l].runType,void 0,void 0,i[l].runName??this.getName());return delete i[l].runId,u}));let o;try{o=await Ue(t.call(this,e,i,s,n),i?.[0]?.signal)}catch(c){throw await Promise.all(s.map(l=>l?.handleChainError(c))),c}return await Promise.all(s.map(c=>c?.handleChainEnd(Q(o,"output")))),o}_concatOutputChunks(t,e){return Ys(t,e)}async*_transformStreamWithConfig(t,e,r){let n,i=!0,a,s=!0;const o=G(r),c=await we(o),l=this;async function*u(){for await(const h of t){if(i)if(n===void 0)n=h;else try{n=l._concatOutputChunks(n,h)}catch{n=void 0,i=!1}yield h}}let d;try{const h=await dh(e.bind(this),u(),async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName(),void 0,{lc_defers_inputs:!0}),r?.signal,o);delete o.runId,d=h.setup;const f=d?.handlers.find(Sh);let p=h.output;f!==void 0&&d!==void 0&&(p=f.tapOutputIterable(d.runId,p));const m=d?.handlers.find(bh);m!==void 0&&d!==void 0&&(p=m.tapOutputIterable(d.runId,p));for await(const g of p)if(yield g,s)if(a===void 0)a=g;else try{a=this._concatOutputChunks(a,g)}catch{a=void 0,s=!1}}catch(h){throw await d?.handleChainError(h,void 0,void 0,void 0,{inputs:Q(n,"input")}),h}await d?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:Q(n,"input")})}getGraph(t){const e=new ho,r=e.addNode({name:`${this.getName()}Input`,schema:ei()}),n=e.addNode(this),i=e.addNode({name:`${this.getName()}Output`,schema:ei()});return e.addEdge(r,n),e.addEdge(n,i),e}pipe(t){return new go({first:this,last:Ge(t)})}pick(t){return this.pipe(new Vf(t))}assign(t){return this.pipe(new Hf(new Qn({steps:t})))}async*transform(t,e){let r;for await(const n of t)r===void 0?r=n:r=this._concatOutputChunks(r,n);yield*this._streamIterator(r,G(e))}async*streamLog(t,e,r){const n=new Wa({...r,autoClose:!1,_schemaFormat:"original"}),i=G(e);yield*this._streamLog(t,n,i)}async*_streamLog(t,e,r){const{callbacks:n}=r;if(n===void 0)r.callbacks=[e];else if(Array.isArray(n))r.callbacks=n.concat([e]);else{const o=n.copy();o.addHandler(e,!0),r.callbacks=o}const i=this.stream(t,r);async function a(){try{const o=await i;for await(const c of o){const l=new Le({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await e.writer.write(l)}}finally{await e.writer.close()}}const s=a();try{for await(const o of e)yield o}finally{await s}}streamEvents(t,e,r){let n;if(e.version==="v1")n=this._streamEventsV1(t,e,r);else if(e.version==="v2")n=this._streamEventsV2(t,e,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return e.encoding==="text/event-stream"?Ff(n):xe.fromAsyncGenerator(n)}async*_streamEventsV2(t,e,r){const n=new Th({...r,autoClose:!1}),i=G(e),a=i.runId??ze();i.runId=a;const s=i.callbacks;if(s===void 0)i.callbacks=[n];else if(Array.isArray(s))i.callbacks=s.concat(n);else{const f=s.copy();f.addHandler(n,!0),i.callbacks=f}const o=new AbortController,c=this;async function l(){let f,p=null;try{e?.signal?"any"in AbortSignal?f=AbortSignal.any([o.signal,e.signal]):(f=e.signal,p=()=>{o.abort()},e.signal.addEventListener("abort",p,{once:!0})):f=o.signal;const m=await c.stream(t,{...i,signal:f}),g=n.tapOutputIterable(a,m);for await(const _ of g)if(o.signal.aborted)break}finally{await n.finish(),f&&p&&f.removeEventListener("abort",p)}}const u=l();let d=!1,h;try{for await(const f of n){if(!d){f.data.input=t,d=!0,h=f.run_id,yield f;continue}f.run_id===h&&f.event.endsWith("_end")&&f.data?.input&&delete f.data.input,yield f}}finally{o.abort(),await u}}async*_streamEventsV1(t,e,r){let n,i=!1;const a=G(e),s=a.tags??[],o=a.metadata??{},c=a.runName??this.getName(),l=new Wa({...r,autoClose:!1,_schemaFormat:"streaming_events"}),u=new Mh({...r}),d=this._streamLog(t,l,a);for await(const f of d){if(n?n=n.concat(f):n=to.fromRunLogPatch(f),n.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const _={...n.state},w={run_id:_.id,event:`on_${_.type}_start`,name:c,tags:s,metadata:o,data:{input:t}};u.includeEvent(w,_.type)&&(yield w)}const p=f.ops.filter(_=>_.path.startsWith("/logs/")).map(_=>_.path.split("/")[2]),m=[...new Set(p)];for(const _ of m){let w,y={};const E=n.state.logs[_];if(E.end_time===void 0?E.streamed_output.length>0?w="stream":w="start":w="end",w==="start")E.inputs!==void 0&&(y.input=E.inputs);else if(w==="end")E.inputs!==void 0&&(y.input=E.inputs),y.output=E.final_output;else if(w==="stream"){const S=E.streamed_output.length;if(S!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${S} instead. Encountered in: "${E.name}"`);y={chunk:E.streamed_output[0]},E.streamed_output=[]}yield{event:`on_${E.type}_${w}`,name:E.name,run_id:E.id,tags:E.tags,metadata:E.metadata,data:y}}const{state:g}=n;if(g.streamed_output.length>0){const _=g.streamed_output.length;if(_!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${_} instead. Encountered in: "${g.name}"`);const w={chunk:g.streamed_output[0]};g.streamed_output=[];const y={event:`on_${g.type}_stream`,run_id:g.id,tags:s,metadata:o,name:c,data:w};u.includeEvent(y,g.type)&&(yield y)}}const h=n?.state;if(h!==void 0){const f={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:s,metadata:o,data:{output:h.final_output}};u.includeEvent(f,h.type)&&(yield f)}}static isRunnable(t){return Xn(t)}withListeners({onStart:t,onEnd:e,onError:r}){return new Wt({bound:this,config:{},configFactories:[n=>({callbacks:[new no({config:n,onStart:t,onEnd:e,onError:r})]})]})}asTool(t){return Jf(this,t)}},Wt=class po extends le{static lc_name(){return"RunnableBinding"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;bound;config;kwargs;configFactories;constructor(e){super(e),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const r=Va(this.config,...e);return Va(r,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(r))):[])}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new mo({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,r){return this.bound.invoke(e,await this._mergeConfig(r,this.kwargs))}async batch(e,r,n){const i=Array.isArray(r)?await Promise.all(r.map(async a=>this._mergeConfig(G(a),this.kwargs))):await this._mergeConfig(G(r),this.kwargs);return this.bound.batch(e,i,n)}_concatOutputChunks(e,r){return this.bound._concatOutputChunks(e,r)}async*_streamIterator(e,r){yield*this.bound._streamIterator(e,await this._mergeConfig(G(r),this.kwargs))}async stream(e,r){return this.bound.stream(e,await this._mergeConfig(G(r),this.kwargs))}async*transform(e,r){yield*this.bound.transform(e,await this._mergeConfig(G(r),this.kwargs))}streamEvents(e,r,n){const i=this,a=async function*(){yield*i.bound.streamEvents(e,{...await i._mergeConfig(G(r),i.kwargs),version:r.version},n)};return xe.fromAsyncGenerator(a())}static isRunnableBinding(e){return e.bound&&le.isRunnable(e.bound)}withListeners({onStart:e,onEnd:r,onError:n}){return new po({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new no({config:i,onStart:e,onEnd:r,onError:n})]})]})}},mo=class extends Wt{static lc_name(){return"RunnableRetry"}lc_namespace=["langchain_core","runnables"];maxAttemptNumber=3;onFailedAttempt=()=>{};constructor(t){super(t),this.maxAttemptNumber=t.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=t.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(t,e,r){const n=t>1?`retry:attempt:${t}`:void 0;return ie(e,{callbacks:r?.getChild(n)})}async _invoke(t,e,r){return Cn(n=>super.invoke(t,this._patchConfigForRetry(n,e,r)),{onFailedAttempt:({error:n})=>this.onFailedAttempt(n,t),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(t,e){return this._callWithConfig(this._invoke.bind(this),t,e)}async _batch(t,e,r,n){const i={};try{await Cn(async a=>{const s=t.map((d,h)=>h).filter(d=>i[d.toString()]===void 0||i[d.toString()]instanceof Error),o=s.map(d=>t[d]),c=s.map(d=>this._patchConfigForRetry(a,e?.[d],r?.[d])),l=await super.batch(o,c,{...n,returnExceptions:!0});let u;for(let d=0;d<l.length;d+=1){const h=l[d],f=s[d];h instanceof Error&&u===void 0&&(u=h,u.input=o[d]),i[f.toString()]=h}if(u)throw u;return l},{onFailedAttempt:({error:a})=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if(n?.returnExceptions!==!0)throw a}return Object.keys(i).sort((a,s)=>parseInt(a,10)-parseInt(s,10)).map(a=>i[parseInt(a,10)])}async batch(t,e,r){return this._batchWithConfig(this._batch.bind(this),t,e,r)}},go=class ut extends le{static lc_name(){return"RunnableSequence"}first;middle=[];last;omitSequenceTags=!1;lc_serializable=!0;lc_namespace=["langchain_core","runnables"];constructor(e){super(e),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,r){const n=G(r),i=await(await we(n))?.handleChainStart(this.toJSON(),Q(e,"input"),n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let a=e,s;try{const o=[this.first,...this.middle];for(let c=0;c<o.length;c+=1)a=await Ue(o[c].invoke(a,ie(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`)})),r?.signal);if(r?.signal?.aborted)throw Vt(r.signal);s=await this.last.invoke(a,ie(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(Q(s,"output")),s}async batch(e,r,n){const i=this._getOptionsList(r??{},e.length),a=await Promise.all(i.map(we)),s=await Promise.all(a.map(async(c,l)=>{const u=await c?.handleChainStart(this.toJSON(),Q(e[l],"input"),i[l].runId,void 0,void 0,void 0,i[l].runName);return delete i[l].runId,u}));let o=e;try{for(let c=0;c<this.steps.length;c+=1)o=await Ue(this.steps[c].batch(o,s.map((l,u)=>{const d=l?.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return ie(i[u],{callbacks:d})}),n),i[0]?.signal)}catch(c){throw await Promise.all(s.map(l=>l?.handleChainError(c))),c}return await Promise.all(s.map(c=>c?.handleChainEnd(Q(o,"output")))),o}_concatOutputChunks(e,r){return this.last._concatOutputChunks(e,r)}async*_streamIterator(e,r){const n=await we(r),{runId:i,...a}=r??{},s=await n?.handleChainStart(this.toJSON(),Q(e,"input"),i,void 0,void 0,void 0,a?.runName),o=[this.first,...this.middle,this.last];let c=!0,l;async function*u(){yield e}try{let d=o[0].transform(u(),ie(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let h=1;h<o.length;h+=1)d=await o[h].transform(d,ie(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${h+1}`)}));for await(const h of d)if(r?.signal?.throwIfAborted(),yield h,c)if(l===void 0)l=h;else try{l=this._concatOutputChunks(l,h)}catch{l=void 0,c=!1}}catch(d){throw await s?.handleChainError(d),d}await s?.handleChainEnd(Q(l,"output"))}getGraph(e){const r=new ho;let n=null;return this.steps.forEach((i,a)=>{const s=i.getGraph(e);a!==0&&s.trimFirstNode(),a!==this.steps.length-1&&s.trimLastNode(),r.extend(s);const o=s.firstNode();if(!o)throw new Error(`Runnable ${i} has no first node`);n&&r.addEdge(n,o),n=s.lastNode()}),r}pipe(e){return ut.isRunnableSequence(e)?new ut({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new ut({first:this.first,middle:[...this.middle,this.last],last:Ge(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&le.isRunnable(e)}static from([e,...r],n){let i={};return typeof n=="string"?i.name=n:n!==void 0&&(i=n),new ut({...i,first:Ge(e),middle:r.slice(0,-1).map(Ge),last:Ge(r[r.length-1])})}},Qn=class _o extends le{static lc_name(){return"RunnableMap"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;steps;getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),this.steps={};for(const[r,n]of Object.entries(e.steps))this.steps[r]=Ge(n)}static from(e){return new _o({steps:e})}async invoke(e,r){const n=G(r),i=await(await we(n))?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;const a={};try{const s=Object.entries(this.steps).map(async([o,c])=>{a[o]=await c.invoke(e,ie(n,{callbacks:i?.getChild(`map:key:${o}`)}))});await Ue(Promise.all(s),r?.signal)}catch(s){throw await i?.handleChainError(s),s}return await i?.handleChainEnd(a),a}async*_transform(e,r,n){const i={...this.steps},a=Qs(e,Object.keys(i).length),s=new Map(Object.entries(i).map(([o,c],l)=>{const u=c.transform(a[l],ie(n,{callbacks:r?.getChild(`map:key:${o}`)}));return[o,u.next().then(d=>({key:o,gen:u,result:d}))]}));for(;s.size;){const{key:o,result:c,gen:l}=await Ue(Promise.race(s.values()),n?.signal);s.delete(o),c.done||(yield{[o]:c.value},s.set(o,l.next().then(u=>({key:o,gen:l,result:u}))))}}transform(e,r){return this._transformStreamWithConfig(e,this._transform.bind(this),r)}async stream(e,r){async function*n(){yield e}const i=G(r),a=new it({generator:this.transform(n(),i),config:i});return await a.setup,xe.fromAsyncGenerator(a)}},zf=class yo extends le{lc_serializable=!1;lc_namespace=["langchain_core","runnables"];func;constructor(e){if(super(e),!Wn(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,r){const[n]=this._getOptionsList(r??{},1),i=await we(n);return Ue(this.func(ie(n,{callbacks:i}),e),n?.signal)}async*_streamIterator(e,r){const[n]=this._getOptionsList(r??{},1),i=await this.invoke(e,r);if($n(i)){for await(const a of i)n?.signal?.throwIfAborted(),yield a;return}if(Bf(i)){for(;;){n?.signal?.throwIfAborted();const a=i.next();if(a.done)break;yield a.value}return}yield i}static from(e){return new yo({func:e})}};function qf(t){if(Wn(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var wo=class vo extends le{static lc_name(){return"RunnableLambda"}lc_namespace=["langchain_core","runnables"];func;constructor(e){if(Wn(e.func))return zf.from(e.func);super(e),qf(e.func),this.func=e.func}static from(e){return new vo({func:e})}async _invoke(e,r,n){return new Promise((i,a)=>{const s=ie(r,{callbacks:n?.getChild(),recursionLimit:(r?.recursionLimit??gn)-1});De.runWithConfig(tt(s),async()=>{try{let o=await this.func(e,{...s});if(o&&le.isRunnable(o)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...s,recursionLimit:(s.recursionLimit??gn)-1})}else if($n(o)){let c;for await(const l of Pn(s,o))if(r?.signal?.throwIfAborted(),c===void 0)c=l;else try{c=this._concatOutputChunks(c,l)}catch{c=l}o=c}else if(ns(o)){let c;for(const l of is(s,o))if(r?.signal?.throwIfAborted(),c===void 0)c=l;else try{c=this._concatOutputChunks(c,l)}catch{c=l}o=c}i(o)}catch(o){a(o)}})})}async invoke(e,r){return this._callWithConfig(this._invoke.bind(this),e,r)}async*_transform(e,r,n){let i;for await(const o of e)if(i===void 0)i=o;else try{i=this._concatOutputChunks(i,o)}catch{i=o}const a=ie(n,{callbacks:r?.getChild(),recursionLimit:(n?.recursionLimit??gn)-1}),s=await new Promise((o,c)=>{De.runWithConfig(tt(a),async()=>{try{o(await this.func(i,{...a,config:a}))}catch(l){c(l)}})});if(s&&le.isRunnable(s)){if(n?.recursionLimit===0)throw new Error("Recursion limit reached.");const o=await s.stream(i,a);for await(const c of o)yield c}else if($n(s))for await(const o of Pn(a,s))n?.signal?.throwIfAborted(),yield o;else if(ns(s))for(const o of is(a,s))n?.signal?.throwIfAborted(),yield o;else yield s}transform(e,r){return this._transformStreamWithConfig(e,this._transform.bind(this),r)}async stream(e,r){async function*n(){yield e}const i=G(r),a=new it({generator:this.transform(n(),i),config:i});return await a.setup,xe.fromAsyncGenerator(a)}},Gf=class extends le{static lc_name(){return"RunnableWithFallbacks"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;runnable;fallbacks;constructor(t){super(t),this.runnable=t.runnable,this.fallbacks=t.fallbacks}*runnables(){yield this.runnable;for(const t of this.fallbacks)yield t}async invoke(t,e){const r=G(e),n=await we(r),{runId:i,...a}=r,s=await n?.handleChainStart(this.toJSON(),Q(t,"input"),i,void 0,void 0,void 0,a?.runName),o=ie(a,{callbacks:s?.getChild()});return await De.runWithConfig(o,async()=>{let c;for(const l of this.runnables()){r?.signal?.throwIfAborted();try{const u=await l.invoke(t,o);return await s?.handleChainEnd(Q(u,"output")),u}catch(u){c===void 0&&(c=u)}}throw c===void 0?new Error("No error stored at end of fallback."):(await s?.handleChainError(c),c)})}async*_streamIterator(t,e){const r=G(e),n=await we(r),{runId:i,...a}=r,s=await n?.handleChainStart(this.toJSON(),Q(t,"input"),i,void 0,void 0,void 0,a?.runName);let o,c;for(const u of this.runnables()){r?.signal?.throwIfAborted();const d=ie(a,{callbacks:s?.getChild()});try{c=Pn(d,await u.stream(t,d));break}catch(h){o===void 0&&(o=h)}}if(c===void 0){const u=o??new Error("No error stored at end of fallback.");throw await s?.handleChainError(u),u}let l;try{for await(const u of c){yield u;try{l=l===void 0?l:this._concatOutputChunks(l,u)}catch{l=void 0}}}catch(u){throw await s?.handleChainError(u),u}await s?.handleChainEnd(Q(l,"output"))}async batch(t,e,r){if(r?.returnExceptions)throw new Error("Not implemented.");const n=this._getOptionsList(e??{},t.length),i=await Promise.all(n.map(o=>we(o))),a=await Promise.all(i.map(async(o,c)=>{const l=await o?.handleChainStart(this.toJSON(),Q(t[c],"input"),n[c].runId,void 0,void 0,void 0,n[c].runName);return delete n[c].runId,l}));let s;for(const o of this.runnables()){n[0].signal?.throwIfAborted();try{const c=await o.batch(t,a.map((l,u)=>ie(n[u],{callbacks:l?.getChild()})),r);return await Promise.all(a.map((l,u)=>l?.handleChainEnd(Q(c[u],"output")))),c}catch(c){s===void 0&&(s=c)}}throw s?(await Promise.all(a.map(o=>o?.handleChainError(s))),s):new Error("No error stored at end of fallbacks.")}};function Ge(t){if(typeof t=="function")return new wo({func:t});if(le.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[r,n]of Object.entries(t))e[r]=Ge(n);return new Qn({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var Hf=class extends le{static lc_name(){return"RunnableAssign"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;mapper;constructor(t){t instanceof Qn&&(t={mapper:t}),super(t),this.mapper=t.mapper}async invoke(t,e){const r=await this.mapper.invoke(t,e);return{...t,...r}}async*_transform(t,e,r){const n=this.mapper.getStepsKeys(),[i,a]=Qs(t),s=this.mapper.transform(a,ie(r,{callbacks:e?.getChild()})),o=s.next();for await(const c of i){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([u])=>!n.includes(u)));Object.keys(l).length>0&&(yield l)}yield(await o).value;for await(const c of s)yield c}transform(t,e){return this._transformStreamWithConfig(t,this._transform.bind(this),e)}async stream(t,e){async function*r(){yield t}const n=G(e),i=new it({generator:this.transform(r(),n),config:n});return await i.setup,xe.fromAsyncGenerator(i)}},Vf=class extends le{static lc_name(){return"RunnablePick"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;keys;constructor(t){(typeof t=="string"||Array.isArray(t))&&(t={keys:t}),super(t),this.keys=t.keys}async _pick(t){if(typeof this.keys=="string")return t[this.keys];{const e=this.keys.map(r=>[r,t[r]]).filter(r=>r[1]!==void 0);return e.length===0?void 0:Object.fromEntries(e)}}async invoke(t,e){return this._callWithConfig(this._pick.bind(this),t,e)}async*_transform(t){for await(const e of t){const r=await this._pick(e);r!==void 0&&(yield r)}}transform(t,e){return this._transformStreamWithConfig(t,this._transform.bind(this),e)}async stream(t,e){async function*r(){yield t}const n=G(e),i=new it({generator:this.transform(r(),n),config:n});return await i.setup,xe.fromAsyncGenerator(i)}},as=class extends Wt{name;description;schema;constructor(t){const e=go.from([wo.from(async r=>{let n;if(Ro(r))try{n=await Uh(this.schema,r.args)}catch{throw new Oo("Received tool input did not match expected schema",JSON.stringify(r.args))}else n=r;return n}).withConfig({runName:`${t.name}:parse_input`}),t.bound]).withConfig({runName:t.name});super({bound:e,config:t.config??{}}),this.name=t.name,this.description=t.description,this.schema=t.schema}static lc_name(){return"RunnableToolLike"}};function Jf(t,e){const r=e.name??t.getName(),n=e.description??Fh(e.schema);return Bh(e.schema)?new as({name:r,description:n,schema:To({input:Io()}).transform(i=>i.input),bound:t}):new as({name:r,description:n,schema:e.schema,bound:t})}var Zf=class extends le{lc_namespace=["langchain_core","documents","transformers"];invoke(t,e){return this.transformDocuments(t)}},ct={},ss;function Kf(){if(ss)return ct;ss=1,ct.byteLength=o,ct.toByteArray=l,ct.fromByteArray=h;for(var t=[],e=[],r=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,a=n.length;i<a;++i)t[i]=n[i],e[n.charCodeAt(i)]=i;e[45]=62,e[95]=63;function s(f){var p=f.length;if(p%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var m=f.indexOf("=");m===-1&&(m=p);var g=m===p?0:4-m%4;return[m,g]}function o(f){var p=s(f),m=p[0],g=p[1];return(m+g)*3/4-g}function c(f,p,m){return(p+m)*3/4-m}function l(f){var p,m=s(f),g=m[0],_=m[1],w=new r(c(f,g,_)),y=0,E=_>0?g-4:g,S;for(S=0;S<E;S+=4)p=e[f.charCodeAt(S)]<<18|e[f.charCodeAt(S+1)]<<12|e[f.charCodeAt(S+2)]<<6|e[f.charCodeAt(S+3)],w[y++]=p>>16&255,w[y++]=p>>8&255,w[y++]=p&255;return _===2&&(p=e[f.charCodeAt(S)]<<2|e[f.charCodeAt(S+1)]>>4,w[y++]=p&255),_===1&&(p=e[f.charCodeAt(S)]<<10|e[f.charCodeAt(S+1)]<<4|e[f.charCodeAt(S+2)]>>2,w[y++]=p>>8&255,w[y++]=p&255),w}function u(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function d(f,p,m){for(var g,_=[],w=p;w<m;w+=3)g=(f[w]<<16&16711680)+(f[w+1]<<8&65280)+(f[w+2]&255),_.push(u(g));return _.join("")}function h(f){for(var p,m=f.length,g=m%3,_=[],w=16383,y=0,E=m-g;y<E;y+=w)_.push(d(f,y,y+w>E?E:y+w));return g===1?(p=f[m-1],_.push(t[p>>2]+t[p<<4&63]+"==")):g===2&&(p=(f[m-2]<<8)+f[m-1],_.push(t[p>>10]+t[p>>4&63]+t[p<<2&63]+"=")),_.join("")}return ct}var Wf=Kf();const Xf=Xt(Wf);var Qf=Object.defineProperty,Yf=(t,e,r)=>e in t?Qf(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ep=(t,e,r)=>(Yf(t,e+"",r),r);function tp(t,e){let r=Array.from({length:t.length},(n,i)=>({start:i,end:i+1}));for(;r.length>1;){let n=null;for(let i=0;i<r.length-1;i++){const a=t.slice(r[i].start,r[i+1].end),s=e.get(a.join(","));s!=null&&(n==null||s<n[0])&&(n=[s,i])}if(n!=null){const i=n[1];r[i]={start:r[i].start,end:r[i+1].end},r.splice(i+1,1)}else break}return r}function rp(t,e){return t.length===1?[e.get(t.join(","))]:tp(t,e).map(r=>e.get(t.slice(r.start,r.end).join(","))).filter(r=>r!=null)}function np(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Ln=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(t,e){this.patStr=t.pat_str;const r=t.bpe_ranks.split(`
`).filter(Boolean).reduce((n,i)=>{const[a,s,...o]=i.split(" "),c=Number.parseInt(s,10);return o.forEach((l,u)=>n[l]=c+u),n},{});for(const[n,i]of Object.entries(r)){const a=Xf.toByteArray(n);this.rankMap.set(a.join(","),i),this.textMap.set(i,a)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[i,a])=>(n[a]=this.textEncoder.encode(i),n),{})}encode(t,e=[],r="all"){const n=new RegExp(this.patStr,"ug"),i=Ln.specialTokenRegex(Object.keys(this.specialTokens)),a=[],s=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(r==="all"?Object.keys(this.specialTokens).filter(l=>!s.has(l)):r);if(o.size>0){const l=Ln.specialTokenRegex([...o]),u=t.match(l);if(u!=null)throw new Error(`The text contains a special token that is not allowed: ${u[0]}`)}let c=0;for(;;){let l=null,u=c;for(;i.lastIndex=u,l=i.exec(t),!(l==null||s.has(l[0]));)u=l.index+1;const d=l?.index??t.length;for(const f of t.substring(c,d).matchAll(n)){const p=this.textEncoder.encode(f[0]),m=this.rankMap.get(p.join(","));if(m!=null){a.push(m);continue}a.push(...rp(p,this.rankMap))}if(l==null)break;let h=this.specialTokens[l[0]];a.push(h),c=l.index+l[0].length}return a}decode(t){const e=[];let r=0;for(let a=0;a<t.length;++a){const s=t[a],o=this.textMap.get(s)??this.inverseSpecialTokens[s];o!=null&&(e.push(o),r+=o.length)}const n=new Uint8Array(r);let i=0;for(const a of e)n.set(a,i),i+=a.length;return this.textDecoder.decode(n)}},ip=Ln;ep(ip,"specialTokenRegex",t=>new RegExp(t.map(e=>np(e)).join("|"),"g"));var ap=class extends Zf{lc_namespace=["langchain","document_transformers","text_splitters"];chunkSize=1e3;chunkOverlap=200;keepSeparator=!1;lengthFunction;constructor(t){if(super(t),this.chunkSize=t?.chunkSize??this.chunkSize,this.chunkOverlap=t?.chunkOverlap??this.chunkOverlap,this.keepSeparator=t?.keepSeparator??this.keepSeparator,this.lengthFunction=t?.lengthFunction??(e=>e.length),this.chunkOverlap>=this.chunkSize)throw new Error("Cannot have chunkOverlap >= chunkSize")}async transformDocuments(t,e={}){return this.splitDocuments(t,e)}splitOnSeparator(t,e){let r;if(e)if(this.keepSeparator){const n=e.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");r=t.split(new RegExp(`(?=${n})`))}else r=t.split(e);else r=t.split("");return r.filter(n=>n!=="")}async createDocuments(t,e=[],r={}){const n=e.length>0?e:[...Array(t.length)].map(()=>({})),{chunkHeader:i="",chunkOverlapHeader:a="(cont'd) ",appendChunkOverlapHeader:s=!1}=r,o=new Array;for(let c=0;c<t.length;c+=1){const l=t[c];let u=1,d=null,h=-1;for(const f of await this.splitText(l)){let p=i;const m=l.indexOf(f,h+1);if(d===null){const y=this.numberOfNewLines(l,0,m);u+=y}else{const y=h+await this.lengthFunction(d);if(y<m){const E=this.numberOfNewLines(l,y,m);u+=E}else if(y>m){const E=this.numberOfNewLines(l,m,y);u-=E}s&&(p+=a)}const g=this.numberOfNewLines(f),_=n[c].loc&&typeof n[c].loc=="object"?{...n[c].loc}:{};_.lines={from:u,to:u+g};const w={...n[c],loc:_};p+=f,o.push(new xo({pageContent:p,metadata:w})),u+=g,d=f,h=m}}return o}numberOfNewLines(t,e,r){return(t.slice(e,r).match(/\n/g)||[]).length}async splitDocuments(t,e={}){const r=t.filter(a=>a.pageContent!==void 0),n=r.map(a=>a.pageContent),i=r.map(a=>a.metadata);return this.createDocuments(n,i,e)}joinDocs(t,e){const r=t.join(e).trim();return r===""?null:r}async mergeSplits(t,e){const r=[],n=[];let i=0;for(const s of t){const o=await this.lengthFunction(s);if(i+o+n.length*e.length>this.chunkSize&&(i>this.chunkSize&&console.warn(`Created a chunk of size ${i}, +
which is longer than the specified ${this.chunkSize}`),n.length>0)){const c=this.joinDocs(n,e);for(c!==null&&r.push(c);i>this.chunkOverlap||i+o+n.length*e.length>this.chunkSize&&i>0;)i-=await this.lengthFunction(n[0]),n.shift()}n.push(s),i+=o}const a=this.joinDocs(n,e);return a!==null&&r.push(a),r}},hp=class kn extends ap{static lc_name(){return"RecursiveCharacterTextSplitter"}separators=[`

`,`
`," ",""];constructor(e){super(e),this.separators=e?.separators??this.separators,this.keepSeparator=e?.keepSeparator??!0}async _splitText(e,r){const n=[];let i=r[r.length-1],a;for(let l=0;l<r.length;l+=1){const u=r[l];if(u===""){i=u;break}if(e.includes(u)){i=u,a=r.slice(l+1);break}}const s=this.splitOnSeparator(e,i);let o=[];const c=this.keepSeparator?"":i;for(const l of s)if(await this.lengthFunction(l)<this.chunkSize)o.push(l);else{if(o.length){const u=await this.mergeSplits(o,c);n.push(...u),o=[]}if(!a)n.push(l);else{const u=await this._splitText(l,a);n.push(...u)}}if(o.length){const l=await this.mergeSplits(o,c);n.push(...l)}return n}async splitText(e){return this._splitText(e,this.separators)}static fromLanguage(e,r){return new kn({...r,separators:kn.getSeparatorsForLanguage(e)})}static getSeparatorsForLanguage(e){if(e==="cpp")return[`
class `,`
void `,`
int `,`
float `,`
double `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="go")return[`
func `,`
var `,`
const `,`
type `,`
if `,`
for `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="java")return[`
class `,`
public `,`
protected `,`
private `,`
static `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="js")return[`
function `,`
const `,`
let `,`
var `,`
class `,`
if `,`
for `,`
while `,`
switch `,`
case `,`
default `,`

`,`
`," ",""];if(e==="php")return[`
function `,`
class `,`
if `,`
foreach `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="proto")return[`
message `,`
service `,`
enum `,`
option `,`
import `,`
syntax `,`

`,`
`," ",""];if(e==="python")return[`
class `,`
def `,`
	def `,`

`,`
`," ",""];if(e==="rst")return[`
===
`,`
---
`,`
***
`,`
.. `,`

`,`
`," ",""];if(e==="ruby")return[`
def `,`
class `,`
if `,`
unless `,`
while `,`
for `,`
do `,`
begin `,`
rescue `,`

`,`
`," ",""];if(e==="rust")return[`
fn `,`
const `,`
let `,`
if `,`
while `,`
for `,`
loop `,`
match `,`
const `,`

`,`
`," ",""];if(e==="scala")return[`
class `,`
object `,`
def `,`
val `,`
var `,`
if `,`
for `,`
while `,`
match `,`
case `,`

`,`
`," ",""];if(e==="swift")return[`
func `,`
class `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="markdown")return[`
## `,`
### `,`
#### `,`
##### `,`
###### `,"```\n\n",`

***

`,`

---

`,`

___

`,`

`,`
`," ",""];if(e==="latex")return[`
\\chapter{`,`
\\section{`,`
\\subsection{`,`
\\subsubsection{`,`
\\begin{enumerate}`,`
\\begin{itemize}`,`
\\begin{description}`,`
\\begin{list}`,`
\\begin{quote}`,`
\\begin{quotation}`,`
\\begin{verse}`,`
\\begin{verbatim}`,`
\\begin{align}`,"$$","$",`

`,`
`," ",""];if(e==="html")return["<body>","<div>","<p>","<br>","<li>","<h1>","<h2>","<h3>","<h4>","<h5>","<h6>","<span>","<table>","<tr>","<td>","<th>","<ul>","<ol>","<header>","<footer>","<nav>","<head>","<style>","<script>","<meta>","<title>"," ",""];if(e==="sol")return[`
pragma `,`
using `,`
contract `,`
interface `,`
library `,`
constructor `,`
type `,`
function `,`
event `,`
modifier `,`
error `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do while `,`
assembly `,`

`,`
`," ",""];throw new Error(`Language ${e} is not supported.`)}};export{hp as RecursiveCharacterTextSplitter,ap as TextSplitter};
