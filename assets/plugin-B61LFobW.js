import{aC as je,S as St,z as Be,x as bt,o as T,a as w,g as Ee,av as Re,w as ee,f as Fe,B as Dt,a4 as Ct,e as S,c as B,l as be,r as Rt,h as x,ak as nt,ae as he,az as It,a3 as F,a2 as De,ab as Le,C as Pt,u as Ot,_ as We,v as Et,P as xt,n as me,ad as Mt}from"./rx-query-helper-B5IGKrLX.js";import{m as L,t as fe,g as $e,w as st,f as Qe,s as se,e as xe,l as it,h as ot,I as Tt,u as At,x as Nt,O as Ht}from"./broadcast-channel-C4zYqVB1.js";import{U as W,a6 as J,_ as jt,b as Bt,p as Ft,ac as Lt,f as ct,ad as Wt,ae as $t,d as Qt,i as ut,af as Vt,ag as qt,g as de,M as ve,z as ie,N as k,H as Ut,a8 as Ye,j as P,a9 as Kt,a7 as Jt,k as zt,s as Gt,V as ce,Q as te,A as Y,J as Yt,h as Ce,I as N,G as z,B as re,S as ne,a3 as ht,aa as Xt,q as Ie,c as ae,L as Zt,Y as er,ah as tr,R as rr,T as Xe}from"./rx-query-FXZmDUEV.js";function pe(e,r){if(e===r)return!0;if(e&&r&&typeof e=="object"&&typeof r=="object"){if(e.constructor!==r.constructor)return!1;var a,t;if(Array.isArray(e)){if(a=e.length,a!==r.length)return!1;for(t=a;t--!==0;)if(!pe(e[t],r[t]))return!1;return!0}if(e.constructor===RegExp)return e.source===r.source&&e.flags===r.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===r.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===r.toString();var n=Object.keys(e);if(a=n.length,a!==Object.keys(r).length)return!1;for(t=a;t--!==0;)if(!Object.prototype.hasOwnProperty.call(r,n[t]))return!1;for(t=a;t--!==0;){var s=n[t];if(!pe(e[s],r[s]))return!1}return!0}return e!==e&&r!==r}var Ve=(function(){function e(a,t){this.jsonSchema=a,this.hashFunction=t,this.indexes=ar(this.jsonSchema),this.primaryPath=Fe(this.jsonSchema.primaryKey),this.finalFields=Dt(this.jsonSchema)}var r=e.prototype;return r.validateChange=function(t,n){this.finalFields.forEach(s=>{if(!pe(t[s],n[s]))throw w("DOC9",{dataBefore:t,dataAfter:n,fieldName:s,schema:this.jsonSchema})})},r.getDocumentPrototype=function(){var t={},n=Ee(this.jsonSchema,"");return Object.keys(n).forEach(s=>{var i=s;t.__defineGetter__(s,function(){if(!(!this.get||typeof this.get!="function")){var c=this.get(i);return c}}),Object.defineProperty(t,s+"$",{get:function(){return this.get$(i)},enumerable:!1,configurable:!1}),Object.defineProperty(t,s+"$$",{get:function(){return this.get$$(i)},enumerable:!1,configurable:!1}),Object.defineProperty(t,s+"_",{get:function(){return this.populate(i)},enumerable:!1,configurable:!1})}),Re(this,"getDocumentPrototype",()=>t),t},r.getPrimaryOfDocumentData=function(t){return ee(this.jsonSchema,t)},je(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var a={};return Object.entries(this.jsonSchema.properties).filter(([,t])=>Object.prototype.hasOwnProperty.call(t,"default")).forEach(([t,n])=>a[t]=n.default),Re(this,"defaultValues",a)}},{key:"hash",get:function(){return Re(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])})();function ar(e){return(e.indexes||[]).map(r=>St(r)?r:[r])}function Zr(e){var r=e.version?e.version:0,a=0;return new Array(r).fill(0).map(()=>a++)}function nr(e,r,a=!0){a&&W("preCreateRxSchema",e);var t=Be(e);t=bt(t),T.deepFreezeWhenDevMode(t);var n=new Ve(t,r);return W("createRxSchema",n),n}function ea(e){return e instanceof Ve}function ta(e){return e}var sr=Array.isArray,ir=Object.getPrototypeOf,or=Object.prototype,cr=Object.keys;function ur(e){if(e.length===1){var r=e[0];if(sr(r))return{args:r,keys:null};if(hr(r)){var a=cr(r);return{args:a.map(function(t){return r[t]}),keys:a}}}return{args:e,keys:null}}function hr(e){return e&&typeof e=="object"&&ir(e)===or}var lr=Array.isArray;function mr(e,r){return lr(r)?e.apply(void 0,jt([],Bt(r))):e(r)}function fr(e){return J(function(r){return mr(e,r)})}function dr(e,r){return e.reduce(function(a,t,n){return a[t]=r[n],a},{})}function vr(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var a=Ft(e),t=Lt(e),n=ur(e),s=n.args,i=n.keys;if(s.length===0)return ct([],a);var c=new Wt(pr(s,a,i?function(o){return dr(i,o)}:ut));return t?c.pipe(fr(t)):c}function pr(e,r,a){return a===void 0&&(a=ut),function(t){Ze(r,function(){for(var n=e.length,s=new Array(n),i=n,c=n,o=function(h){Ze(r,function(){var d=ct(e[h],r),u=!1;d.subscribe(Qt(t,function(m){s[h]=m,u||(u=!0,c--),c||t.next(a(s.slice()))},function(){--i||t.complete()}))},t)},l=0;l<n;l++)o(l)},t)}}function Ze(e,r,a){e?$t(a,e,r):r()}var yr=Vt(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function ye(e,r){return new Promise(function(a,t){var n=new qt({next:function(s){a(s),n.unsubscribe()},error:t,complete:function(){t(new yr)}});e.subscribe(n)})}var wr=(function(){function e(a,t,n,s){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=a,this.primaryPath=t,this.preWrite=n,this.postWrite=s}var r=e.prototype;return r.addWrite=function(t,n){var s=t[this.primaryPath],i=de(this.queueByDocId,s,()=>[]),c=new Promise((o,l)=>{var h={lastKnownDocumentState:t,modifier:n,resolve:o,reject:l};S(i).push(h),this.triggerRun()});return c},r.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var t=[],n=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(n.entries()).map(async([i,c])=>{var o=gr(c.map(d=>d.lastKnownDocumentState)),l=o;for(var h of c)try{l=await h.modifier(B(l))}catch(d){h.reject(d),h.reject=()=>{},h.resolve=()=>{}}try{await this.preWrite(l,o)}catch(d){c.forEach(u=>u.reject(d));return}t.push({previous:o,document:l})}));var s=t.length>0?await this.storageInstance.bulkWrite(t,"incremental-write"):{error:[]};return await Promise.all(L(this.primaryPath,t,s).map(i=>{var c=i[this.primaryPath];this.postWrite(i);var o=ve(n,c);o.forEach(l=>l.resolve(i))})),s.error.forEach(i=>{var c=i.documentId,o=ve(n,c),l=be(i);if(l){var h=de(this.queueByDocId,c,()=>[]);o.reverse().forEach(u=>{u.lastKnownDocumentState=S(l.documentInDb),S(h).unshift(u)})}else{var d=Rt(i);o.forEach(u=>u.reject(d))}}),this.isRunning=!1,this.triggerRun()}},e})();function et(e){var r=async a=>{var t=Ct(a);t._deleted=a._deleted;var n=await e(t),s=Object.assign({},n,{_meta:a._meta,_attachments:a._attachments,_rev:a._rev,_deleted:typeof n._deleted<"u"?n._deleted:a._deleted});return typeof s._deleted>"u"&&(s._deleted=!1),s};return r}function gr(e){var r=e[0],a=ie(r._rev);return e.forEach(t=>{var n=ie(t._rev);n>a&&(r=t,a=n)}),r}var qe={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(J(r=>r._data._deleted))},get deleted$$(){var e=this,r=e.collection.database.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this;return e.collection.$.pipe(P(r=>!r.isLocal),P(r=>r.documentId===this.primary),J(r=>zt(r)),Kt(e.collection._docCache.getLatestDocumentData(this.primary)),Ye((r,a)=>r._rev===a._rev),J(r=>this.collection._docCache.getCachedRxDocument(r)),Jt(It))},get $$(){var e=this,r=e.collection.database.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(T.isDevMode()){if(e.includes(".item."))throw w("DOC1",{path:e});if(e===this.primaryPath)throw w("DOC2");if(this.collection.schema.finalFields.includes(e))throw w("DOC3",{path:e});var r=Ee(this.collection.schema.jsonSchema,e);if(!r)throw w("DOC4",{path:e})}return this.$.pipe(J(a=>nt(a,e)),Ye())},get$$(e){var r=this.get$(e),a=this.collection.database.getReactivityFactory();return a.fromObservable(r,this.getLatest().get(e),this.collection.database)},populate(e){var r=Ee(this.collection.schema.jsonSchema,e),a=this.get(e);if(!a)return Ut;if(!r)throw w("DOC5",{path:e});if(!r.ref)throw w("DOC6",{path:e,schemaObj:r});var t=this.collection.database.collections[r.ref];if(!t)throw w("DOC7",{ref:r.ref,path:e,schemaObj:r});return r.type==="array"?t.findByIds(a).exec().then(n=>{var s=n.values();return Array.from(s)}):t.findOne(a).exec()},get(e){return mt(this,e)},toJSON(e=!1){if(e)return T.deepFreezeWhenDevMode(this._data);var r=x(this._data);return delete r._rev,delete r._attachments,delete r._deleted,delete r._meta,T.deepFreezeWhenDevMode(r)},toMutableJSON(e=!1){return B(this.toJSON(e))},update(e){throw k("update")},incrementalUpdate(e){throw k("update")},updateCRDT(e){throw k("crdt")},putAttachment(){throw k("attachments")},getAttachment(){throw k("attachments")},allAttachments(){throw k("attachments")},get allAttachments$(){throw k("attachments")},async modify(e,r){var a=this._data,t=await et(e)(a);return this._saveData(t,a)},incrementalModify(e,r){return this.collection.incrementalWriteQueue.addWrite(this._data,et(e)).then(a=>this.collection._docCache.getCachedRxDocument(a))},patch(e){var r=this._data,a=B(r);return Object.entries(e).forEach(([t,n])=>{a[t]=n}),this._saveData(a,r)},incrementalPatch(e){return this.incrementalModify(r=>(Object.entries(e).forEach(([a,t])=>{r[a]=t}),r))},async _saveData(e,r){if(e=x(e),this._data._deleted)throw w("DOC11",{id:this.primary,document:this});await lt(this.collection,e,r);var a=[{previous:r,document:e}],t=await this.collection.storageInstance.bulkWrite(a,"rx-document-save-data"),n=t.error[0];return fe(this.collection,this.primary,e,n),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(L(this.collection.schema.primaryPath,a,t)[0])},remove(){var e=this.collection;if(this.deleted)return Promise.reject(w("DOC13",{document:this,id:this.primary}));var r=x(this._data),a;return e._runHooks("pre","remove",r,this).then(async()=>{r._deleted=!0;var t=[{previous:this._data,document:r}],n=await e.storageInstance.bulkWrite(t,"rx-document-remove"),s=n.error[0];return fe(e,this.primary,r,s),L(this.collection.schema.primaryPath,t,n)[0]}).then(t=>(a=t,this.collection._runHooks("post","remove",r,this))).then(()=>this.collection._docCache.getCachedRxDocument(a))},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},destroy(){throw w("DOC14")}};function _r(e=qe){var r=function(t,n){this.collection=t,this._data=n,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return r.prototype=e,r}function kr(e,r,a){var t=new e(r,a);return W("createRxDocument",t),t}function ra(e){return typeof e=="object"&&e!==null&&"isInstanceOfRxDocument"in e}function lt(e,r,a){return r._meta=Object.assign({},a._meta,r._meta),T.isDevMode()&&e.schema.validateChange(a,r),e._runHooks("pre","save",r,a)}function mt(e,r){return de(e._propertyCache,r,()=>{var a=nt(e._data,r);if(typeof a!="object"||a===null||Array.isArray(a))return T.deepFreezeWhenDevMode(a);var t=new Proxy(x(a),{get(n,s){if(typeof s!="string")return n[s];var i=s.charAt(s.length-1);if(i==="$")if(s.endsWith("$$")){var c=s.slice(0,-2);return e.get$$(he(r+"."+c))}else{var o=s.slice(0,-1);return e.get$(he(r+"."+o))}else if(i==="_"){var l=s.slice(0,-1);return e.populate(he(r+"."+l))}else{var h=n[s];return typeof h=="number"||typeof h=="string"||typeof h=="boolean"?h:mt(e,he(r+"."+s))}}});return t})}var G="collection",Ue="storage-token",Sr="rx-migration-status",br="RxInternalDocument",Ke=Be({version:0,title:br,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[G,Ue,Sr,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function oe(e,r){return ee(Ke,{key:e,context:r})}async function ft(e){var r=Gt(e.schema,{selector:{context:G,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),a=await e.query(r),t=a.documents;return t}var dt="storageToken",Dr=oe(dt,Ue);async function Cr(e){var r=Le(10),a=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,t={id:Dr,context:Ue,key:dt,data:{rxdbVersion:e.rxdbVersion,token:r,instanceToken:e.token,passwordHash:a},_deleted:!1,_meta:De(),_rev:F(),_attachments:{}},n=[{document:t}],s=await e.internalStore.bulkWrite(n,"internal-add-storage-token");if(!s.error[0])return L("id",n,s)[0];var i=S(s.error[0]);if(i.isError&&be(i)){var c=i;if(!Rr(c.documentInDb.data.rxdbVersion,e.rxdbVersion))throw w("DM5",{args:{database:e.name,databaseStateVersion:c.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(a&&a!==c.documentInDb.data.passwordHash)throw w("DB1",{passwordHash:a,existingPasswordHash:c.documentInDb.data.passwordHash});var o=c.documentInDb;return S(o)}throw i}function Rr(e,r){if(!e||r.includes("beta")&&r!==e)return!1;var a=e.split(".")[0],t=r.split(".")[0];return a===t}async function aa(e,r,a){if(e.schema.version!==a.version)throw w("SNH",{schema:a,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:r}});for(var t=we(e.name,e.schema.jsonSchema),n=oe(t,G);;){var s=await $e(e.database.internalStore,n),i=B(S(s)),c=i.data.connectedStorages.find(o=>o.collectionName===r&&o.schema.version===a.version);if(c)return;i.data.connectedStorages.push({collectionName:r,schema:a});try{await st(e.database.internalStore,{previous:S(s),document:i},"add-connected-storage-to-collection")}catch(o){if(!be(o))throw o}}}async function na(e,r,a){if(e.schema.version!==a.version)throw w("SNH",{schema:a,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:r}});for(var t=we(e.name,e.schema.jsonSchema),n=oe(t,G);;){var s=await $e(e.database.internalStore,n),i=B(S(s)),c=i.data.connectedStorages.find(o=>o.collectionName===r&&o.schema.version===a.version);if(!c)return;i.data.connectedStorages=i.data.connectedStorages.filter(o=>o.collectionName!==r);try{await st(e.database.internalStore,{previous:S(s),document:i},"remove-connected-storage-from-collection")}catch(o){if(!be(o))throw o}}}function we(e,r){return e+"-"+r.version}function le(e,r){return r=x(r),r=Pt(e,r),typeof e.jsonSchema.primaryKey!="string"&&(r=Ot(e.primaryPath,e.jsonSchema,r)),r._meta=De(),Object.prototype.hasOwnProperty.call(r,"_deleted")||(r._deleted=!1),Object.prototype.hasOwnProperty.call(r,"_attachments")||(r._attachments={}),Object.prototype.hasOwnProperty.call(r,"_rev")||(r._rev=F()),r}async function Ir(e,r){r.multiInstance=e.multiInstance;var a=await e.storage.createStorageInstance(r);return a}async function vt(e,r,a,t,n,s,i){var c=await ft(r),o=c.filter(u=>u.data.name===n),l=[];o.forEach(u=>{l.push({collectionName:u.data.name,schema:u.data.schema,isCollection:!0}),u.data.connectedStorages.forEach(m=>l.push({collectionName:m.collectionName,isCollection:!1,schema:m.schema}))});var h=new Set;if(l=l.filter(u=>{var m=u.collectionName+"||"+u.schema.version;return h.has(m)?!1:(h.add(m),!0)}),await Promise.all(l.map(async u=>{var m=await e.createStorageInstance({collectionName:u.collectionName,databaseInstanceToken:a,databaseName:t,multiInstance:!1,options:{},schema:u.schema,password:s,devMode:T.isDevMode()});await m.remove(),u.isCollection&&await ce("postRemoveRxCollection",{storage:e,databaseName:t,collectionName:n})})),i){var d=o.map(u=>{var m=Qe(u);return m._deleted=!0,m._meta.lwt=te(),m._rev=Y(a,u),{previous:u,document:m}});await r.bulkWrite(d,"rx-database-remove-collection-all")}}function M(e){if(e.destroyed)throw w("COL21",{collection:e.name,version:e.schema.version})}var Pr=(function(){function e(a){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=a,this.subs.push(this.collection.database.eventBulks$.pipe(P(t=>t.collectionName===this.collection.name),P(t=>{var n=t.events[0];return!n.isLocal})).subscribe(t=>{this.tasks.add(()=>this._handleChangeEvents(t.events)),this.tasks.size<=1&&Yt().then(()=>{this.processTasks()})}))}var r=e.prototype;return r.processTasks=function(){if(this.tasks.size!==0){var t=Array.from(this.tasks);t.forEach(n=>n()),this.tasks.clear()}},r._handleChangeEvents=function(t){var n=this.counter;this.counter=this.counter+t.length,t.length>this.limit?this.buffer=t.slice(t.length*-1):(We(this.buffer,t),this.buffer=this.buffer.slice(this.limit*-1));for(var s=n+1,i=this.eventCounterMap,c=0;c<t.length;c++){var o=t[c];i.set(o,s+c)}},r.getCounter=function(){return this.processTasks(),this.counter},r.getBuffer=function(){return this.processTasks(),this.buffer},r.getArrayIndexByPointer=function(t){this.processTasks();var n=this.buffer[0],s=this.eventCounterMap.get(n);if(t<s)return null;var i=t-s;return i},r.getFrom=function(t){this.processTasks();var n=[],s=this.getArrayIndexByPointer(t);if(s===null)return null;for(;;){var i=this.buffer[s];if(s++,i)n.push(i);else return n}},r.runFrom=function(t,n){this.processTasks();var s=this.getFrom(t);if(s===null)throw new Error("out of bounds");s.forEach(i=>n(i))},r.reduceByLastOfDoc=function(t){return this.processTasks(),t.slice(0)},r.destroy=function(){this.tasks.clear(),this.subs.forEach(t=>t.unsubscribe())},e})();function Or(e){return new Pr(e)}var Er=new WeakMap;function xr(e){var r=e.schema.getDocumentPrototype(),a=Ar(e),t=qe,n={};return[r,a,t].forEach(s=>{var i=Object.getOwnPropertyNames(s);i.forEach(c=>{var o=Object.getOwnPropertyDescriptor(s,c),l=!0;(c.startsWith("_")||c.endsWith("_")||c.startsWith("$")||c.endsWith("$"))&&(l=!1),typeof o.value=="function"?Object.defineProperty(n,c,{get(){return o.value.bind(this)},enumerable:l,configurable:!1}):(o.enumerable=l,o.configurable=!1,o.writable&&(o.writable=!1),Object.defineProperty(n,c,o))})}),n}function Mr(e){return de(Er,e,()=>_r(xr(e)))}function Tr(e,r,a){var t=kr(r,e,T.deepFreezeWhenDevMode(a));return e._runHooksSync("post","create",a,t),W("postCreateRxDocument",t),t}function Ar(e){var r={};return Object.entries(e.methods).forEach(([a,t])=>{r[a]=t}),r}async function ge(e,r){var a=ee(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:r}),t=await e.input.metaInstance.findDocumentsById([a],!1),n=t[0];if(e.lastCheckpointDoc[r]=n,n)return n.checkpointData}async function _e(e,r,a){e.checkpointQueue=e.checkpointQueue.then(async()=>{var t=e.lastCheckpointDoc[r];if(a&&!e.events.canceled.getValue()&&(!t||JSON.stringify(t.checkpointData)!==JSON.stringify(a))){var n={id:"",isCheckpoint:"1",itemId:r,_deleted:!1,_attachments:{},checkpointData:a,_meta:De(),_rev:F()};for(n.id=ee(e.input.metaInstance.schema,n);!e.events.canceled.getValue();){if(t&&(n.checkpointData=se([t.checkpointData,n.checkpointData])),n._meta.lwt=te(),n._rev=Y(await e.checkpointKey,t),e.events.canceled.getValue())return;var s=[{previous:t,document:n}],i=await e.input.metaInstance.bulkWrite(s,"replication-set-checkpoint"),c=L(e.primaryPath,s,i)[0];if(c){e.lastCheckpointDoc[r]=c;return}else{var o=i.error[0];if(o.status!==409)throw o;t=S(o.documentInDb),n._rev=Y(await e.checkpointKey,t)}}}}),await e.checkpointQueue}async function Nr(e){var r=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+r}function tt(e,r,a,t,n){var s=Object.assign({},t,{_attachments:r&&t._attachments?t._attachments:{},_meta:a?t._meta:Object.assign({},n?n._meta:{},{lwt:te()}),_rev:a?t._rev:F()});return s._rev||(s._rev=Y(e,n)),s}function U(e,r,a){var t=x(e);return r||delete t._attachments,a||(delete t._meta,delete t._rev),t}function Me(e,r){return e.hasAttachments?r.map(a=>{var t=B(a.document);return t.docData=xe(t.docData),{document:t,previous:a.previous}}):r}function Te(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var Hr="RxReplicationProtocolMetaData";function sa(e,r){var a=Et(e),t={title:Hr,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:a+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:a>4?a:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};r&&(t.encrypted=["docData"]);var n=Be(t);return n}function pt(e,r){return e.input.metaInstance.findDocumentsById(r.map(a=>{var t=ee(e.input.metaInstance.schema,{itemId:a,isCheckpoint:"0"});return t}),!0).then(a=>{var t={};return Object.values(a).forEach(n=>{t[n.itemId]={docData:n.docData,metaDocument:n}}),t})}async function ke(e,r,a,t){var n=r[e.primaryPath],s=a?Qe(a):{id:"",isCheckpoint:"0",itemId:n,docData:r,_attachments:{},_deleted:!1,_rev:F(),_meta:{lwt:0}};s.docData=r,t&&(s.isResolvedConflict=t),s._meta.lwt=te(),s.id=ee(e.input.metaInstance.schema,s),s._rev=Y(await e.checkpointKey,a);var i={previous:a,document:s};return i}async function jr(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var r=await ge(e,"down");r||await _e(e,"down",e.input.initialCheckpoint.downstream)}var a=await e.input.hashFunction(e.input.identifier),t=e.input.replicationHandler,n=0,s=[];function i(f){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var v={time:n++,task:f};s.push(v),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var p=[];s.length>0;){e.events.active.down.next(!0);var y=S(s.shift());if(!(y.time<o)){if(y.task==="RESYNC")if(p.length===0){p.push(y.task);break}else break;p.push(y.task)}}if(p.length!==0)return p[0]==="RESYNC"?l():h(p)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(i("RESYNC"),!e.events.canceled.getValue()){var c=t.masterChangeStream$.pipe(Ce(async f=>(await ye(e.events.active.up.pipe(P(v=>!v))),f))).subscribe(f=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,i(f)});ye(e.events.canceled.pipe(P(f=>!!f))).then(()=>c.unsubscribe())}var o=-1;async function l(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>ge(e,"down"));for(var f=await e.checkpointQueue,v=[];!e.events.canceled.getValue();){o=n++;var p=await t.masterChangesSince(f,e.input.pullBatchSize);if(p.documents.length===0||(f=se([f,p.checkpoint]),v.push(m(p.documents,f)),p.documents.length<e.input.pullBatchSize))break}await Promise.all(v)}}function h(f){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var v=[],p=null;return f.forEach(y=>{if(y==="RESYNC")throw new Error("SNH");We(v,y.documents),p=se([p,y.checkpoint])}),m(v,S(p))}var d=N,u={docs:{}};function m(f,v){var p=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,f.forEach(y=>{var D=y[p];u.docs[D]=y}),u.checkpoint=v,d=d.then(()=>{var y=u.docs;u.docs={};var D=u.checkpoint,$=Object.keys(y);if(e.events.canceled.getValue()||$.length===0)return N;var K=[],X={},ue={},Q=[];return Promise.all([e.input.forkInstance.findDocumentsById($,!0),pt(e,$)]).then(([H,V])=>{var A=new Map;return H.forEach(O=>A.set(O[p],O)),Promise.all($.map(async O=>{var b=A.get(O),j=b?U(b,e.hasAttachments,!1):void 0,E=y[O],C=V[O];C&&b&&C.metaDocument.isResolvedConflict===b._rev&&await e.streamQueue.up;var Z=!C||!j?!1:await e.input.conflictHandler({realMasterState:C.docData,newDocumentState:j},"downstream-check-if-equal-0").then(q=>q.isEqual);if(!Z&&C&&C.docData._rev&&b&&b._meta[e.input.identifier]&&ie(b._rev)===b._meta[e.input.identifier]&&(Z=!0),b&&C&&Z===!1||b&&!C)return N;var g=j?await e.input.conflictHandler({realMasterState:E,newDocumentState:j},"downstream-check-if-equal-1").then(q=>q.isEqual):!1;if(j&&g)return(!C||Z===!1)&&Q.push(await ke(e,j,C?C.metaDocument:void 0)),N;var R=Object.assign({},E,b?{_meta:x(b._meta),_attachments:e.hasAttachments&&E._attachments?E._attachments:{},_rev:F()}:{_meta:{lwt:te()},_rev:F(),_attachments:e.hasAttachments&&E._attachments?E._attachments:{}});if(E._rev){var I=b?ie(b._rev)+1:1;R._meta[e.input.identifier]=I,e.input.keepMeta&&(R._rev=E._rev)}e.input.keepMeta&&E._meta&&(R._meta=E._meta);var _={previous:b,document:R};_.document._rev=_.document._rev?_.document._rev:Y(a,_.previous),K.push(_),X[O]=_,ue[O]=await ke(e,E,C?C.metaDocument:void 0)}))}).then(async()=>{if(K.length>0)return e.input.forkInstance.bulkWrite(K,await e.downstreamBulkWriteFlag).then(H=>{var V=L(e.primaryPath,K,H);V.forEach(A=>{var O=A[p];e.events.processed.down.next(X[O]),Q.push(ue[O])}),H.error.forEach(A=>{A.status!==409&&e.events.error.next(w("RC_PULL",{writeError:A}))})})}).then(()=>{if(Q.length>0)return e.input.metaInstance.bulkWrite(Me(e,Q),"replication-down-write-meta").then(H=>{H.error.forEach(V=>{e.events.error.next(w("RC_PULL",{id:V.documentId,writeError:V}))})})}).then(()=>{_e(e,"down",D)})}).catch(y=>e.events.error.next(y)),d}}var yt=function(e,r){var a=xe(e.newDocumentState),t=xe(e.realMasterState);return pe(a,t)?Promise.resolve({isEqual:!0}):Promise.resolve({isEqual:!1,documentData:e.realMasterState})};async function Br(e,r,a){var t=e.input.conflictHandler,n=await t(r,"replication-resolve-conflict");if(!n.isEqual){var s=Object.assign({},n.documentData,{_meta:x(a._meta),_rev:F(),_attachments:x(a._attachments)});return s._meta.lwt=te(),s._rev=Y(await e.checkpointKey,a),{resolvedDoc:s,output:n}}}async function Ae(e,r,a,t){if(!a._attachments||t&&!t._attachments)throw new Error("_attachments missing");var n=a[e],s=new Set(t&&t._attachments?Object.keys(t._attachments):[]);return await Promise.all(Object.entries(a._attachments).map(async([i,c])=>{if((!s.has(i)||t&&S(t._attachments)[i].digest!==c.digest)&&!c.data){var o=await r.getAttachmentData(n,i,c.digest);c.data=o}})),a}async function Fr(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var r=await ge(e,"up");r||await _e(e,"up",e.input.initialCheckpoint.upstream)}var a=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>l().then(()=>{h()}));var t=0,n=-1,s=[],i=z,c={docs:{}},o=e.input.forkInstance.changeStream().subscribe(async u=>{if(u.context!==await e.downstreamBulkWriteFlag)return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,s.push({task:u,time:t++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>h()):h()});ye(e.events.canceled.pipe(P(u=>!!u))).then(()=>o.unsubscribe());async function l(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>ge(e,"up"));for(var u=await e.checkpointQueue,m=new Set,f=async function(){n=t++,m.size>3&&await Promise.race(Array.from(m));var y=await it(e.input.forkInstance,e.input.pushBatchSize,u);if(y.documents.length===0)return 1;u=se([u,y.checkpoint]);var D=d(y.documents,S(u));m.add(D),D.catch().then(()=>m.delete(D))};!e.events.canceled.getValue()&&!await f(););var v=await Promise.all(m),p=v.find(y=>!!y);p?await l():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function h(){if(e.events.canceled.getValue()||s.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(()=>{for(var u=[],m={};s.length>0;){var f=S(s.shift());f.time<n||(We(u,f.task.events.map(p=>p.documentData)),m=se([m,f.task.checkpoint]))}var v=u.length===0?z:d(u,m);return v.then(()=>{s.length===0?e.events.active.up.next(!1):h()})})}function d(u,m){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,u.forEach(f=>{var v=f[e.primaryPath];c.docs[v]=f}),c.checkpoint=m,i=i.then(async()=>{if(e.events.canceled.getValue())return!1;var f=c.docs;c.docs={};var v=c.checkpoint,p=Object.keys(f);if(p.length===0)return!1;var y=await pt(e,p),D={},$=[],K={},X={};if(await Promise.all(p.map(async g=>{var R=f[g];X[g]=R;var I=U(R,e.hasAttachments,!!e.input.keepMeta),_=y[g];_&&_.metaDocument.isResolvedConflict!==R._rev&&(await e.input.conflictHandler({realMasterState:_.docData,newDocumentState:I},"upstream-check-if-equal")).isEqual||_&&_.docData._rev&&ie(R._rev)===R._meta[e.input.identifier]||($.push(g),D[g]={assumedMasterState:_?_.docData:void 0,newDocumentState:I},K[g]=await ke(e,I,_?_.metaDocument:void 0))})),$.length===0)return!1;var ue=Object.values(D),Q=new Set,H={},V=xt(ue,e.input.pushBatchSize);await Promise.all(V.map(async g=>{e.hasAttachments&&await Promise.all(g.map(async I=>{I.newDocumentState=await Ae(e.primaryPath,e.input.forkInstance,B(I.newDocumentState),I.assumedMasterState)}));var R=await a.masterWrite(g);R.forEach(I=>{var _=I[e.primaryPath];Q.add(_),H[_]=I})}));var A=[];if($.forEach(g=>{Q.has(g)||(e.events.processed.up.next(D[g]),A.push(K[g]))}),e.events.canceled.getValue())return!1;A.length>0&&await e.input.metaInstance.bulkWrite(Me(e,A),"replication-up-write-meta");var O=!1;if(Q.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var b=[],j={};if(await Promise.all(Object.entries(H).map(([g,R])=>{var I=D[g],_={newDocumentState:I.newDocumentState,assumedMasterState:I.assumedMasterState,realMasterState:R};return Br(e,_,X[g]).then(async q=>{if(q){e.events.resolvedConflicts.next({input:_,output:q.output}),b.push({previous:X[g],document:q.resolvedDoc});var Ge=y[g];j[g]=await ke(e,S(R),Ge?Ge.metaDocument:void 0,q.resolvedDoc._rev)}})})),b.length>0){O=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var E=await e.input.forkInstance.bulkWrite(b,"replication-up-write-conflict"),C=[],Z=L(e.primaryPath,b,E);Z.forEach(g=>{var R=g[e.primaryPath];C.push(j[R])}),C.length>0&&await e.input.metaInstance.bulkWrite(Me(e,C),"replication-up-write-conflict-meta")}}return _e(e,"up",v),O}).catch(f=>(e.events.error.next(f),!1)),i}}function ia(e){e=x(e),e.forkInstance=Te(e.forkInstance),e.metaInstance=Te(e.metaInstance);var r=Nr(e),a={primaryPath:Fe(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:r,downstreamBulkWriteFlag:r.then(t=>"replication-downstream-"+t),events:{canceled:new re(!1),active:{down:new re(!0),up:new re(!0)},processed:{down:new ne,up:new ne},resolvedConflicts:new ne,error:new ne},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new re(!1),up:new re(!1)},streamQueue:{down:N,up:N},checkpointQueue:N,lastCheckpointDoc:{}};return jr(a),Fr(a),a}function Lr(e){return ye(vr([e.firstSyncDone.down.pipe(P(r=>!!r)),e.firstSyncDone.up.pipe(P(r=>!!r))])).then(()=>{})}function oa(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}async function ca(e){for(await Lr(e);;){var{down:r,up:a}=e.streamQueue;if(await Promise.all([a,r]),r===e.streamQueue.down&&a===e.streamQueue.up)return}}function ua(e,r,a,t=!1){e=Te(e);var n=!!e.schema.attachments,s=Fe(e.schema.primaryKey),i={masterChangeStream$:e.changeStream().pipe(Ce(async c=>{var o={checkpoint:c.checkpoint,documents:await Promise.all(c.events.map(async l=>{var h=U(l.documentData,n,t);return n&&(h=await Ae(s,e,B(h),void 0)),h}))};return o})),masterChangesSince(c,o){return it(e,o,c).then(async l=>({checkpoint:l.documents.length>0?l.checkpoint:c,documents:await Promise.all(l.documents.map(async h=>{var d=U(h,n,t);return n&&(d=await Ae(s,e,B(d),void 0)),d}))}))},async masterWrite(c){var o={};c.forEach(v=>{var p=v.newDocumentState[s];o[p]=v});var l=Object.keys(o),h=await e.findDocumentsById(l,!0),d=new Map;h.forEach(v=>d.set(v[s],v));var u=[],m=[];if(await Promise.all(Object.entries(o).map(async([v,p])=>{var y=d.get(v);y?y&&!p.assumedMasterState?u.push(U(y,n,t)):(await r({realMasterState:U(y,n,t),newDocumentState:S(p.assumedMasterState)},"rxStorageInstanceToReplicationHandler-masterWrite")).isEqual===!0?m.push({previous:y,document:tt(a,n,t,p.newDocumentState,y)}):u.push(U(y,n,t)):m.push({document:tt(a,n,t,p.newDocumentState)})})),m.length>0){var f=await e.bulkWrite(m,"replication-master-write");f.error.forEach(v=>{if(v.status!==409)throw new Error("non conflict error");u.push(U(S(v.documentInDb),n,t))})}return u}};return i}async function ha(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}var wt=["pre","post"],gt=["insert","save","remove","create"],rt=!1,Je=(function(){function e(a,t,n,s,i={},c={},o={},l={},h={},d=ht,u={},m=yt){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=er(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.onDestroy=[],this.destroyed=!1,this.onRemove=[],this.database=a,this.name=t,this.schema=n,this.internalStorageInstance=s,this.instanceCreationOptions=i,this.migrationStrategies=c,this.methods=o,this.attachments=l,this.options=h,this.cacheReplacementPolicy=d,this.statics=u,this.conflictHandler=m,Wr(this.asRxCollection)}var r=e.prototype;return r.prepare=async function(){this.storageInstance=ot(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new wr(this.storageInstance,this.schema.primaryPath,(o,l)=>lt(this,o,l),o=>this._runHooks("post","save",o));var t=this.database.eventBulks$.pipe(P(o=>o.collectionName===this.name));this.$=t.pipe(Ce(o=>o.events)),this.checkpoint$=t.pipe(J(o=>o.checkpoint)),this._changeEventBuffer=Or(this.asRxCollection);var n;this._docCache=new Xt(this.schema.primaryPath,this.database.eventBulks$.pipe(P(o=>o.collectionName===this.name&&!o.events[0].isLocal),J(o=>o.events)),o=>(n||(n=Mr(this.asRxCollection)),Tr(this.asRxCollection,n,o)));var s=this.database.internalStore.changeStream().pipe(P(o=>{var l=this.name+"-"+this.schema.version,h=o.events.find(d=>d.documentData.context==="collection"&&d.documentData.key===l&&d.operation==="DELETE");return!!h})).subscribe(async()=>{await this.destroy(),await Promise.all(this.onRemove.map(o=>o()))});this._subs.push(s);var i=await this.database.storageToken,c=this.storageInstance.changeStream().subscribe(o=>{for(var l=new Array(o.events.length),h=o.events,d=this.name,u=T.deepFreezeWhenDevMode,m=0;m<h.length;m++){var f=h[m];l[m]={documentId:f.documentId,collectionName:d,isLocal:!1,operation:f.operation,documentData:u(f.documentData),previousDocumentData:u(f.previousDocumentData)}}var v={id:o.id,internal:!1,collectionName:this.name,storageToken:i,events:l,databaseToken:this.database.token,checkpoint:o.checkpoint,context:o.context,endTime:o.endTime,startTime:o.startTime};this.database.$emit(v)});return this._subs.push(c),this._subs.push(this.storageInstance.conflictResultionTasks().subscribe(o=>{this.conflictHandler(o.input,o.context).then(l=>{this.storageInstance.resolveConflictResultionTask({id:o.id,output:l})})})),N},r.cleanup=function(t){throw M(this),k("cleanup")},r.migrationNeeded=function(){throw k("migration-schema")},r.getMigrationState=function(){throw k("migration-schema")},r.startMigration=function(t=10){return M(this),this.getMigrationState().startMigration(t)},r.migratePromise=function(t=10){return this.getMigrationState().migratePromise(t)},r.insert=async function(t){M(this);var n=await this.bulkInsert([t]),s=n.error[0];fe(this,t[this.schema.primaryPath],t,s);var i=S(n.success[0]);return i},r.bulkInsert=async function(t){if(M(this),t.length===0)return{success:[],error:[]};var n=this.schema.primaryPath,s=new Set,i;if(this.hasHooks("pre","insert"))i=await Promise.all(t.map(p=>{var y=le(this.schema,p);return this._runHooks("pre","insert",y).then(()=>(s.add(y[n]),{document:y}))}));else{i=new Array(t.length);for(var c=this.schema,o=0;o<t.length;o++){var l=t[o],h=le(c,l);s.add(h[n]),i[o]={document:h}}}if(s.size!==t.length)throw w("COL22",{collection:this.name,args:{documents:t}});var d=await this.storageInstance.bulkWrite(i,"rx-collection-bulk-insert"),u,m=this,f={get success(){if(!u){var p=L(m.schema.primaryPath,i,d);u=tr(m._docCache,p)}return u},error:d.error};if(this.hasHooks("post","insert")){var v=new Map;i.forEach(p=>{var y=p.document;v.set(y[n],y)}),await Promise.all(f.success.map(p=>this._runHooks("post","insert",v.get(p.primary),p)))}return f},r.bulkRemove=async function(t){M(this);var n=this.schema.primaryPath;if(t.length===0)return{success:[],error:[]};var s=await this.findByIds(t).exec(),i=[],c=new Map;Array.from(s.values()).forEach(m=>{var f=m.toMutableJSON(!0);i.push(f),c.set(m.primary,f)}),await Promise.all(i.map(m=>{var f=m[this.schema.primaryPath];return this._runHooks("pre","remove",m,s.get(f))}));var o=i.map(m=>{var f=x(m);return f._deleted=!0,{previous:m,document:f}}),l=await this.storageInstance.bulkWrite(o,"rx-collection-bulk-remove"),h=L(this.schema.primaryPath,o,l),d=h.map(m=>m[n]);await Promise.all(d.map(m=>this._runHooks("post","remove",c.get(m),s.get(m))));var u=d.map(m=>ve(s,m));return{success:u,error:l.error}},r.bulkUpsert=async function(t){M(this);var n=[],s=new Map;t.forEach(l=>{var h=le(this.schema,l),d=h[this.schema.primaryPath];if(!d)throw w("COL3",{primaryPath:this.schema.primaryPath,data:h,schema:this.schema.jsonSchema});s.set(d,h),n.push(h)});var i=await this.bulkInsert(n),c=i.success.slice(0),o=[];return await Promise.all(i.error.map(async l=>{if(l.status!==409)o.push(l);else{var h=l.documentId,d=ve(s,h),u=S(l.documentInDb),m=this._docCache.getCachedRxDocuments([u])[0],f=await m.incrementalModify(()=>d);c.push(f)}})),{error:o,success:c}},r.upsert=async function(t){M(this);var n=await this.bulkUpsert([t]);return fe(this.asRxCollection,t[this.schema.primaryPath],t,n.error[0]),n.success[0]},r.incrementalUpsert=function(t){M(this);var n=le(this.schema,t),s=n[this.schema.primaryPath];if(!s)throw w("COL4",{data:t});var i=this._incrementalUpsertQueues.get(s);return i||(i=N),i=i.then(()=>Qr(this,s,n)).then(c=>c.inserted?c.doc:$r(c.doc,n)),this._incrementalUpsertQueues.set(s,i),i},r.find=function(t){if(M(this),typeof t=="string")throw w("COL5",{queryObj:t});t||(t=Ie());var n=ae("find",t,this);return n},r.findOne=function(t){if(M(this),typeof t=="number"||Array.isArray(t))throw me("COL6",{queryObj:t});var n;if(typeof t=="string")n=ae("findOne",{selector:{[this.schema.primaryPath]:t},limit:1},this);else{if(t||(t=Ie()),t.limit)throw w("QU6");t=x(t),t.limit=1,n=ae("findOne",t,this)}return n},r.count=function(t){M(this),t||(t=Ie());var n=ae("count",t,this);return n},r.findByIds=function(t){M(this);var n={selector:{[this.schema.primaryPath]:{$in:t.slice(0)}}},s=ae("findByIds",n,this);return s},r.exportJSON=function(){throw k("json-dump")},r.importJSON=function(t){throw k("json-dump")},r.insertCRDT=function(t){throw k("crdt")},r.addPipeline=function(t){throw k("pipeline")},r.addHook=function(t,n,s,i=!1){if(typeof s!="function")throw me("COL7",{key:n,when:t});if(!wt.includes(t))throw me("COL8",{key:n,when:t});if(!gt.includes(n))throw w("COL9",{key:n});if(t==="post"&&n==="create"&&i===!0)throw w("COL10",{when:t,key:n,parallel:i});var c=s.bind(this),o=i?"parallel":"series";this.hooks[n]=this.hooks[n]||{},this.hooks[n][t]=this.hooks[n][t]||{series:[],parallel:[]},this.hooks[n][t][o].push(c)},r.getHooks=function(t,n){return!this.hooks[n]||!this.hooks[n][t]?{series:[],parallel:[]}:this.hooks[n][t]},r.hasHooks=function(t,n){if(!this.hooks[n]||!this.hooks[n][t])return!1;var s=this.getHooks(t,n);return s?s.series.length>0||s.parallel.length>0:!1},r._runHooks=function(t,n,s,i){var c=this.getHooks(t,n);if(!c)return N;var o=c.series.map(l=>()=>l(s,i));return Zt(o).then(()=>Promise.all(c.parallel.map(l=>l(s,i))))},r._runHooksSync=function(t,n,s,i){if(this.hasHooks(t,n)){var c=this.getHooks(t,n);c&&c.series.forEach(o=>o(s,i))}},r.promiseWait=function(t){var n=new Promise(s=>{var i=setTimeout(()=>{this.timeouts.delete(i),s()},t);this.timeouts.add(i)});return n},r.destroy=async function(){return this.destroyed?z:(await Promise.all(this.onDestroy.map(t=>t())),this.destroyed=!0,Array.from(this.timeouts).forEach(t=>clearTimeout(t)),this._changeEventBuffer&&this._changeEventBuffer.destroy(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(t=>t.unsubscribe()),delete this.database.collections[this.name],ce("postDestroyRxCollection",this).then(()=>!0))))},r.remove=async function(){await this.destroy(),await Promise.all(this.onRemove.map(t=>t())),await vt(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.password,this.database.hashFunction)},je(e,[{key:"insert$",get:function(){return this.$.pipe(P(a=>a.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(P(a=>a.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(P(a=>a.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])})();function Wr(e){if(!rt){rt=!0;var r=Object.getPrototypeOf(e);gt.forEach(a=>{wt.map(t=>{var n=t+Mt(a);r[n]=function(s,i){return this.addHook(t,a,s,i)}})})}}function $r(e,r){return e.incrementalModify(a=>r)}function Qr(e,r,a){var t=e._docCache.getLatestDocumentDataIfExists(r);return t?Promise.resolve({doc:e._docCache.getCachedRxDocuments([t])[0],inserted:!1}):e.findOne(r).exec().then(n=>n?{doc:n,inserted:!1}:e.insert(a).then(s=>({doc:s,inserted:!0})))}function Vr({database:e,name:r,schema:a,instanceCreationOptions:t={},migrationStrategies:n={},autoMigrate:s=!0,statics:i={},methods:c={},attachments:o={},options:l={},localDocuments:h=!1,cacheReplacementPolicy:d=ht,conflictHandler:u=yt}){var m={databaseInstanceToken:e.token,databaseName:e.name,collectionName:r,schema:a.jsonSchema,options:t,multiInstance:e.multiInstance,password:e.password,devMode:T.isDevMode()};return W("preCreateRxStorageInstance",m),Ir(e,m).then(f=>{var v=new Je(e,r,a,f,t,n,c,o,l,d,i,u);return v.prepare().then(()=>{Object.entries(i).forEach(([y,D])=>{Object.defineProperty(v,y,{get:()=>D.bind(v)})});var p=N;return s&&v.schema.version!==0&&(p=v.migratePromise()),p}).then(()=>(W("createRxCollection",{collection:v,creator:{name:r,schema:a,storageInstance:f,instanceCreationOptions:t,migrationStrategies:n,methods:c,attachments:o,options:l,cacheReplacementPolicy:d,localDocuments:h,statics:i}}),v)).catch(p=>f.close().then(()=>Promise.reject(p)))})}function la(e){return e instanceof Je}var _t=function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=r||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};_t.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,Ne(this)},wrapCall:function(r){var a=this;this.lock();var t;try{t=r()}catch(n){throw this.unlock(),n}return!t.then||typeof t.then!="function"?(this.unlock(),t):t.then(function(n){return a.unlock(),n}).catch(function(n){throw a.unlock(),n})},requestIdlePromise:function(r){var a=this;r=r||{};var t,n=new Promise(function(c){return t=c}),s=function(){Pe(a,n),t()};if(n._manRes=s,r.timeout){var i=setTimeout(function(){n._manRes()},r.timeout);n._timeoutObj=i}return this._iC.add(n),Ne(this),n},cancelIdlePromise:function(r){Pe(this,r)},requestIdleCallback:function(r,a){var t=this._lHN++,n=this.requestIdlePromise(a);return this._hPM.set(t,n),this._pHM.set(n,t),n.then(function(){return r()}),t},cancelIdleCallback:function(r){var a=this._hPM.get(r);this.cancelIdlePromise(a)},clear:function(){var r=this;this._iC.forEach(function(a){return Pe(r,a)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function qr(e){if(e._iC.size!==0){var r=e._iC.values(),a=r.next().value;a._manRes(),setTimeout(function(){return Ne(e)},0)}}function Pe(e,r){if(r){if(r._timeoutObj&&clearTimeout(r._timeoutObj),e._pHM.has(r)){var a=e._pHM.get(r);e._hPM.delete(a),e._pHM.delete(r)}e._iC.delete(r)}}function Ne(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}qr(e),e._tryIR=!1},0)},0))}var Se=new Set,He=0,ze=(function(){function e(a,t,n,s,i,c,o=!1,l={},h,d,u,m,f){this.idleQueue=new _t,this.rxdbVersion=Nt,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onDestroy=[],this.destroyed=!1,this.collections={},this.states={},this.eventBulks$=new ne,this.observable$=this.eventBulks$.pipe(Ce(v=>v.events)),this.storageToken=z,this.storageTokenDocument=z,this.emittedEventBulkIds=new Ht(60*1e3),this.name=a,this.token=t,this.storage=n,this.instanceCreationOptions=s,this.password=i,this.multiInstance=c,this.eventReduce=o,this.options=l,this.internalStore=h,this.hashFunction=d,this.cleanupPolicy=u,this.allowSlowCount=m,this.reactivity=f,He++,this.name!=="pseudoInstance"&&(this.internalStore=ot(this.asRxDatabase,h,Ke),this.storageTokenDocument=Cr(this.asRxDatabase).catch(v=>this.startupErrors.push(v)),this.storageToken=this.storageTokenDocument.then(v=>v.data.token).catch(v=>this.startupErrors.push(v)))}var r=e.prototype;return r.getReactivityFactory=function(){if(!this.reactivity)throw w("DB14",{database:this.name});return this.reactivity},r.$emit=function(t){this.emittedEventBulkIds.has(t.id)||(this.emittedEventBulkIds.add(t.id),this.eventBulks$.next(t))},r.removeCollectionDoc=async function(t,n){var s=await $e(this.internalStore,oe(we(t,n),G));if(!s)throw w("SNH",{name:t,schema:n});var i=Qe(s);i._deleted=!0,await this.internalStore.bulkWrite([{document:i,previous:s}],"rx-database-remove-collection")},r.addCollections=async function(t){var n={},s={},i=[],c={};await Promise.all(Object.entries(t).map(async([h,d])=>{var u=h,m=d.schema;n[u]=m;var f=nr(m,this.hashFunction);if(s[u]=f,this.collections[h])throw w("DB3",{name:h});var v=we(h,m),p={id:oe(v,G),key:v,context:G,data:{name:u,schemaHash:await f.hash,schema:f.jsonSchema,version:f.version,connectedStorages:[]},_deleted:!1,_meta:De(),_rev:F(),_attachments:{}};i.push({document:p});var y=Object.assign({},d,{name:u,schema:f,database:this}),D=x(d);D.database=this,D.name=h,W("preCreateRxCollection",D),y.conflictHandler=D.conflictHandler,c[u]=y}));var o=await this.internalStore.bulkWrite(i,"rx-database-add-collection");await Jr(this),await Promise.all(o.error.map(async h=>{if(h.status!==409)throw w("DB12",{database:this.name,writeError:h});var d=S(h.documentInDb),u=d.data.name,m=s[u];if(d.data.schemaHash!==await m.hash)throw w("DB6",{database:this.name,collection:u,previousSchemaHash:d.data.schemaHash,schemaHash:await m.hash,previousSchema:d.data.schema,schema:S(n[u])})}));var l={};return await Promise.all(Object.keys(t).map(async h=>{var d=c[h],u=await Vr(d);l[h]=u,this.collections[h]=u,this[h]||Object.defineProperty(this,h,{get:()=>this.collections[h]})})),l},r.lockedRun=function(t){return this.idleQueue.wrapCall(t)},r.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},r.exportJSON=function(t){throw k("json-dump")},r.addState=function(t){throw k("state")},r.importJSON=function(t){throw k("json-dump")},r.backup=function(t){throw k("backup")},r.leaderElector=function(){throw k("leader-election")},r.isLeader=function(){throw k("leader-election")},r.waitForLeadership=function(){throw k("leader-election")},r.migrationStates=function(){throw k("migration-schema")},r.destroy=async function(){return this.destroyed?z:(this.destroyed=!0,await ce("preDestroyRxDatabase",this),this.eventBulks$.complete(),He--,this._subs.map(t=>t.unsubscribe()),this.name==="pseudoInstance"?z:this.requestIdlePromise().then(()=>Promise.all(this.onDestroy.map(t=>t()))).then(()=>Promise.all(Object.keys(this.collections).map(t=>this.collections[t]).map(t=>t.destroy()))).then(()=>this.internalStore.close()).then(()=>Se.delete(this.storage.name+"|"+this.name)).then(()=>!0))},r.remove=function(){return this.destroy().then(()=>Kr(this.name,this.storage,this.password))},je(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])})();function Ur(e,r){var a=r.name+"|"+e;if(Se.has(a))throw w("DB8",{name:e,storage:r.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}async function kt(e,r,a,t,n,s){var i=await r.createStorageInstance({databaseInstanceToken:e,databaseName:a,collectionName:Tt,schema:Ke,options:t,multiInstance:n,password:s,devMode:T.isDevMode()});return i}function ma({storage:e,instanceCreationOptions:r,name:a,password:t,multiInstance:n=!0,eventReduce:s=!0,ignoreDuplicate:i=!1,options:c={},cleanupPolicy:o,allowSlowCount:l=!1,localDocuments:h=!1,hashFunction:d=At,reactivity:u}){W("preCreateRxDatabase",{storage:e,instanceCreationOptions:r,name:a,password:t,multiInstance:n,eventReduce:s,ignoreDuplicate:i,options:c,localDocuments:h}),i||Ur(a,e),Se.add(e.name+"|"+a);var m=Le(10);return kt(m,e,a,r,n,t).catch(f=>{throw Se.delete(e.name+"|"+a),f}).then(f=>{var v=new ze(a,m,e,r,t,n,s,c,f,d,o,l,u);return ce("createRxDatabase",{database:v,creator:{storage:e,instanceCreationOptions:r,name:a,password:t,multiInstance:n,eventReduce:s,ignoreDuplicate:i,options:c,localDocuments:h}}).then(()=>v)})}async function Kr(e,r,a){var t=Le(10),n=await kt(t,r,e,{},!1,a),s=await ft(n),i=new Set;s.forEach(o=>i.add(o.data.name));var c=Array.from(i);return await Promise.all(c.map(o=>vt(r,n,t,e,o,a))),await ce("postRemoveRxDatabase",{databaseName:e,storage:r}),await n.remove(),c}function fa(e){return e instanceof ze}function da(){return He}async function va(e){var r=await e.storageTokenDocument;return r.data.instanceToken===e.token}async function Jr(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var zr={RxSchema:Ve.prototype,RxDocument:qe,RxQuery:rr.prototype,RxCollection:Je.prototype,RxDatabase:ze.prototype},Oe=new Set,at=new Set;function pa(e){if(W("preAddRxPlugin",{plugin:e,plugins:Oe}),!Oe.has(e)){{if(at.has(e.name))throw w("PL3",{name:e.name,plugin:e});Oe.add(e),at.add(e.name)}if(!e.rxdb)throw me("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([r,a])=>a(zr[r])),e.overwritable&&Object.assign(T,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([r,a])=>{a.after&&Xe[r].push(a.after),a.before&&Xe[r].unshift(a.before)})}}export{_e as $,M as A,qe as B,_r as C,kr as D,ra as E,lt as F,xr as G,Mr as H,G as I,Tr as J,Ar as K,Ve as L,ar as M,Zr as N,nr as O,ea as P,ta as Q,ze as R,dt as S,ia as T,Lr as U,oa as V,ca as W,ua as X,ha as Y,ge as Z,we as _,pa as a,Nr as a0,jr as a1,Fr as a2,Hr as a3,sa as a4,pt as a5,ke as a6,yt as a7,Br as a8,tt as a9,U as aa,Me as ab,Te as ac,pe as ad,wr as ae,ma as b,kt as c,da as d,va as e,ye as f,Jr as g,Ue as h,fa as i,Sr as j,br as k,Ke as l,oe as m,ft as n,Dr as o,Cr as p,Rr as q,Kr as r,aa as s,na as t,Je as u,Vr as v,la as w,le as x,Ir as y,vt as z};
