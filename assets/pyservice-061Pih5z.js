const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BCZo6mcT.js","assets/main-BEYAOB-D.js","assets/main-DCTlflHk.css"])))=>i.map(i=>d[i]);
import{L as n,M as o,w as d,_ as u}from"./main-BEYAOB-D.js";function p(i){return new Worker("/assets/pyworker-Drd8fvVW.js",{type:"module",name:i?.name})}let c=null;async function h(){return c||(c=u(()=>import("./index-BCZo6mcT.js").then(i=>i.i),__vite__mapDeps([0,1,2]))),c}let w=0;class y{constructor(){this.pendingMessages=new Map}async init(e,t){this.workspace=e,this.vars=t??{},this.worker=new p,this.worker.onmessage=s=>{this.handleWorkerMessage(s.data)},this.worker.onerror=s=>{console.error("Python Worker error:",s)},await this.sendMessage("init",{vars:this.vars}),await this.mountWorkspace(),await this.installDependencies()}handleWorkerMessage(e){if(e.id==="interrupt-buffer"){e.type==="success"?this.interruptBuffer=new Uint8Array(e.payload):this.interruptBuffer=void 0;return}if(e.type==="inputRequest"){const s=e.payload.prompt||"Input:",a=window.prompt(s);this.worker.postMessage({id:e.id,type:"inputResponse",payload:{value:a,cancelled:a===null}});return}if(e.type==="stdout"){this.stdoutCallback?this.stdoutCallback(e.payload):console.info(e.payload);return}if(e.type==="stderr"){this.stderrCallback?this.stderrCallback(e.payload):console.error(e.payload);return}if(e.type==="console"){const{level:s,message:a}=e.payload;typeof window<"u"&&window.logToTerminal&&window.logToTerminal("Python Worker",a,s);return}const t=this.pendingMessages.get(e.id);t&&(this.pendingMessages.delete(e.id),e.type==="success"?t.resolve(e.payload):e.type==="error"&&t.reject(new Error(e.payload.message)))}async sendMessage(e,t){if(!this.worker)throw new Error("PyEnv not initialized yet: see init()");const s=`msg-${w++}`,a={id:s,type:e,payload:t};return new Promise((r,l)=>{this.pendingMessages.set(s,{resolve:r,reject:l}),this.worker.postMessage(a)})}setStdoutCallback(e){this.stdoutCallback=e}setStderrCallback(e){this.stderrCallback=e}async runFunction(e,t){const s=await this.sendMessage("runFunction",{name:e,args:t});return n(o,this.workspace),s}async setGlobal(e,t){await this.sendMessage("setGlobal",{key:e,value:t})}async mountWorkspace(e="/workspace"){const t=await d.getWorkspace();await this.sendMessage("mountWorkspace",{handle:t.getHandle(),mountPoint:e})}async installDependencies(){const e=await this.workspace?.getResource("requirements.txt");if(e){const t=(await e.getContents()).replaceAll("\r",""),{parsePipRequirementsFile:s}=await h(),a=s(t).filter(r=>"name"in r).map(r=>r.name);await this.loadPackages(a)}}async loadPackages(e){e.length>0&&await this.sendMessage("loadPackages",{packages:e})}async syncWorkspace(){await this.sendMessage("syncWorkspace"),n(o,this.workspace)}async execCode(e){const t=await this.sendMessage("execCode",{code:e});return n(o,this.workspace),t}async execScript(e){const t=e.split(".")[0],s=e.includes(":")?e.split(":").reverse()[0]:void 0;return await this.execModule(t,s)}async execModule(e,t){const s=await this.sendMessage("execModule",{moduleName:e,entryName:t,vars:this.vars});return n(o,this.workspace),s}async getVersion(){return await this.sendMessage("getVersion")}canInterrupt(){return this.interruptBuffer!==void 0}interrupt(){this.interruptBuffer&&(this.interruptBuffer[0]=2)}close(){this.worker&&(this.worker.terminate(),this.worker=void 0),this.pendingMessages.clear()}}export{y as P};
